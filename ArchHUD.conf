name: ArchHud - Archaegeo v1.358 (Minified)
slots:
  core:
    class: CoreUnit
  radar:
    class: RadarPVPUnit
    select: manual
  antigrav:
    class: AntiGravityGeneratorUnit
  warpdrive:
    class: WarpDriveUnit
  gyro:
    class: GyroUnit
  weapon:
    class: WeaponUnit
    select: manual
  dbHud:
    class: databank
    select: manual
  telemeter:
    class: TelemeterUnit
    select: manual
  vBooster:
    class: VerticalBooster
  hover:
    class: Hovercraft
  door:
    class: DoorUnit
    select: manual
  switch:
    class: ManualSwitchUnit
    select: manual
  forcefield:
    class: ForceFieldUnit
    select: manual
  atmofueltank:
    class: AtmoFuelContainer
    select: manual
  spacefueltank:
    class: SpaceFuelContainer
    select: manual
  rocketfueltank:
    class: RocketFuelContainer
    select: manual
handlers:
  unit:
    start:
      lua: |
        -- error handling code added by wrap.lua
        __wrap_lua__stopped = false
        __wrap_lua__stopOnError = false
        __wrap_lua__rethrowErrorAlways = false
        __wrap_lua__rethrowErrorIfStopped = true
        __wrap_lua__printError = true
        __wrap_lua__showErrorOnScreens = true
        
        function __wrap_lua__error (message)
          if __wrap_lua__stopped then return end
        
          -- make the traceback more readable and escape HTML syntax characters
          message = tostring(message):gsub('"%-%- |STDERROR%-EVENTHANDLER[^"]*"', 'chunk'):gsub("&", "&amp;"):gsub("<", "&lt;"):gsub(">", "&gt;")
        
          local unit = unit or self or {}
        
          if __wrap_lua__showErrorOnScreens then
            for _, value in pairs(unit) do
              if type(value) == "table" and value.setCenteredText and value.setHTML then -- value is a screen
                if message:match("\n") then
                  value.setHTML([[
        <pre style="color: white; background-color: black; font-family: Consolas,monospace; font-size: 4vh; white-space: pre-wrap; margin: 1em">
        Error: ]] .. message .. [[
        </pre>]])
                else
                  value.setCenteredText(message)
                end
              end
            end
          end
        
          if __wrap_lua__printError and system and system.print then
            system.print("Error: " .. message:gsub("\n", "<br>"))
          end
        
          if __wrap_lua__stopOnError then
            __wrap_lua__stopped = true
          end
        
          if __wrap_lua__stopped and unit and unit.exit then
            unit.exit()
          end
        
          if __wrap_lua__rethrowErrorAlways or (__wrap_lua__stopped and __wrap_lua__rethrowErrorIfStopped) then
            error(message)
          end
        end
        
        -- in case traceback is removed or renamed
        __wrap_lua__traceback = traceback or (debug and debug.traceback) or function (arg1, arg2) return arg2 or arg1 end
        
        local ok, message = xpcall(function ()
        
        -- script code
        
        useTheseSettings = false --export:
        userControlScheme = "virtual joystick" --export:
        soundFolder = "archHUD" --export:
        freeLookToggle = true --export:
        BrakeToggleDefault = true --export:
        RemoteFreeze = false --export:
        RemoteHud = true --export:
        brightHud = false --export:
        VanillaRockets = false --export:
        InvertMouse = false --export:
        autoRollPreference = false --export:
        turnAssist = true --export:
        ExternalAGG = false --export:
        UseSatNav = false --export:
        ShouldCheckDamage = true --export:
        CalculateBrakeLandingSpeed = false --export:
        AtmoSpeedAssist = true --export:
        ForceAlignment = false --export:
        DisplayDeadZone = true --export:
        showHud = true --export: 
        ShowOdometer = true --export:
        hideHudOnToggleWidgets = true --export:
        ShiftShowsRemoteButtons = true --export:
        DisplayOrbit = true --export: 
        SetWaypointOnExit = false --export:
        IntruderAlertSystem = false --export:
        AlwaysVSpd = false --export:
        BarFuelDisplay = true --export:
        showHelp = true --export:
        Cockpit = false --export:
        voices = true --export:
        alerts = true --export:
        CollisionSystem = true --export:
        YawStallAngle = 35 --export:
        PitchStallAngle = 35 --export:
        brakeLandingRate = 30 --export:
        MaxPitch = 30 --export:
        LockPitchTarget = 0 --export:
        TargetOrbitRadius = 1.4 --export:
        LowOrbitHeight = 1000 --export:
        AtmoSpeedLimit = 1050 --export:
        SpaceSpeedLimit = 30000 --export:
        AutoTakeoffAltitude = 1000 --export:
        TargetHoverHeight = 50 --export:
        LandingGearGroundHeight = 0 --export:
        ReEntryHeight = 5000 --export:
        MaxGameVelocity = 8333.00 --export:
        AutopilotInterplanetaryThrottle = 1.0 --export:
        warmup = 32 --export:
        fuelTankHandlingAtmo = 0 --export:
        fuelTankHandlingSpace = 0 --export:
        fuelTankHandlingRocket = 0 --export:
        ContainerOptimization = 0 --export:
        FuelTankOptimization = 0 --export:
        ResolutionX = 1920 --export:
        ResolutionY = 1080 --export:
        circleRad = 400 --export:
        SafeR = 130 --export:
        SafeG = 224 --export:
        SafeB = 255 --export:
        PvPR = 255 --export:
        PvPG = 0 --export:
        PvPB = 0 --export:
        centerX = 960 --export:
        centerY = 540 --export:
        throtPosX = 1300 --export:
        throtPosY = 540 --export:
        vSpdMeterX = 1525  --export:
        vSpdMeterY = 325 --export:
        altMeterX = 550  --export:
        altMeterY = 540 --export:
        fuelX = 30 --export:
        fuelY = 700 --export:
        DeadZone = 50 --export:
        OrbitMapSize = 250 --export:
        OrbitMapX = 75 --export:
        OrbitMapY = 0 --export:
        soundVolume = 100 --export:
        speedChangeLarge = 5 --export:
        speedChangeSmall = 1 --export:
        MouseXSensitivity = 0.003 --export:
        MouseYSensitivity = 0.003 --export:
        autoRollFactor = 2 --export:
        rollSpeedFactor = 1.5 --export:
        autoRollRollThreshold = 180 --export:
        minRollVelocity = 150 --export:
        turnAssistFactor = 2 --export:
        TrajectoryAlignmentStrength = 0.002 --export:
        torqueFactor = 2 --export:
        pitchSpeedFactor = 0.8 --export:
        yawSpeedFactor = 1 --export:
        brakeSpeedFactor = 3 --export:
        brakeFlatFactor = 1 --export:
        DampingMultiplier = 40 --export:
        apTickRate = 0.0166667 --export:
        hudTickRate = 0.0666667 --export:
        ExtraLongitudeTags = "none" --export:
        ExtraLateralTags = "none" --export:
        ExtraVerticalTags = "none" --export:
        local a=Navigator.new(system,core,unit)script={}VERSION_NUMBER=1.358;BrakeToggleStatus=BrakeToggleDefault;VertTakeOffEngine=false;BrakeIsOn=false;RetrogradeIsOn=false;ProgradeIsOn=false;Autopilot=false;TurnBurn=false;AltitudeHold=false;BrakeLanding=false;AutoTakeoff=false;Reentry=false;VertTakeOff=false;HoldAltitude=1000;AutopilotAccelerating=false;AutopilotRealigned=false;AutopilotBraking=false;AutopilotCruising=false;AutopilotEndSpeed=0;AutopilotStatus="Aligning"AutopilotPlanetGravity=0;PrevViewLock=1;AutopilotTargetName="None"AutopilotTargetCoords=nil;AutopilotTargetIndex=0;GearExtended=nil;TotalDistanceTravelled=0.0;TotalFlightTime=0;SavedLocations={}VectorToTarget=false;LocationIndex=0;LastMaxBrake=0;LockPitch=nil;LastMaxBrakeInAtmo=0;AntigravTargetAltitude=1000;LastStartTime=0;SpaceTarget=false;LeftAmount=0;IntoOrbit=false;safeMass=0;iphCondition="All"stablized=true;local b={"VertTakeOff","VertTakeOffEngine","SpaceTarget","BrakeToggleStatus","BrakeIsOn","RetrogradeIsOn","ProgradeIsOn","Autopilot","TurnBurn","AltitudeHold","BrakeLanding","Reentry","AutoTakeoff","HoldAltitude","AutopilotAccelerating","AutopilotBraking","AutopilotCruising","AutopilotRealigned","AutopilotEndSpeed","AutopilotStatus","AutopilotPlanetGravity","PrevViewLock","AutopilotTargetName","AutopilotTargetCoords","AutopilotTargetIndex","TotalDistanceTravelled","TotalFlightTime","SavedLocations","VectorToTarget","LocationIndex","LastMaxBrake","LockPitch","LastMaxBrakeInAtmo","AntigravTargetAltitude","LastStartTime","safeMass","iphCondition","stablized"}local c=math.abs;local d=math.floor;local e=string.format;local f=json.decode;local g=json.encode;local h=core.getElementMaxHitPointsById;local j=unit.getAtmosphereDensity;local k=core.getElementMassById;local l=a.control.isRemoteControlled;local m=math.atan;local n=string.match;local o=utils.round;local p=system.getTime;local vec3=vec3;local q=utils.clamp;local r=a.axisCommandManager;local s=system.destroyWidgetPanel;local t=system.updateData;local u=system.addDataToWidget;local v=system.lockView;local w=system.isViewLocked;local z=math.sqrt;local A=tonumber;local core=core;local function B(C,D)local mult=10^(D or 0)return d(C*mult+0.5)/mult end;local E=p()local F=p()local G=16;local H=13;local I=SafeR;local J=SafeB;local K=SafeG;local L=0;local M=0;local N=false;local O=0;local P=false;local Q=false;local R=55;local S=false;local T=false;local U=0;local V=0;local W=0;local X=0;local Y=0;local Z=0;local a0=0;local a1=false;local a2=false;local a3="empty"local a4=5;local a5=5;local a6=a4;local a7=a5;local a8=false;local a9,aa=0;local ab,ac=0;local ad=nil;local ae=0;local af=0;local ag=0;local ah=0;local ai=0;local aj=3;local ak=0;local al=""local am=0;local an=false;local ao=false;local ap=false;local aq=-1;local ar=""local as=j()>0;local at=j()local au=core.getAltitude()local av=core.getElementIdList()local aw=p()local ax=core.getConstructMass()local ay=false;local az=nil;local aA=[[rgb(]]..d(I+0.5)..","..d(K+0.5)..","..d(J+0.5)..[[)]]local aB=[[rgb(]]..d(I*0.9+0.5)..","..d(K*0.9+0.5)..","..d(J*0.9+0.5)..[[)]]local aC={}local aD=0;local aE=0;local aF=""local aG=true;local aH={}local aI=ResolutionX;local aJ=ResolutionY;local aK={}local aL={}local aM={}local aN=0;local aO=false;local aP={}local aQ={}local aR=d(1/apTickRate)*2;local aS={}local aT={}local aU={}local aV={}local aW=false;local aX=0;local aY=nil;local aZ=nil;local a_=nil;local b0=nil;local b1=nil;local b2=nil;local b3=nil;local b4=nil;local b5=nil;local b6=nil;local b7=nil;local b8=nil;local b9=false;local ba=false;local bb=autoRollPreference;local bc=LandingGearGroundHeight;local bd=false;local be=p()local bf=0;local bg=0;local bh=0;local bi=AtmoSpeedLimit;local bj=0;local bk=nil;local bl=0;local bm=0;local bn=false;local bo=false;local bp={VectorToTarget=false}local bq=false;local br=0;local bs=nil;local bt=false;local bu=false;local bv=false;local bw=false;local bx=0;local by=vec3(core.getConstructWorldOrientationUp())local bz=vec3(core.getConstructWorldOrientationForward())local bA=vec3(core.getConstructWorldOrientationRight())local bB=vec3(core.getWorldVelocity())local bC=vec3(bB):len()local bD=vec3(core.getWorldVertical())local bE=-bD:dot(bB)local bF=vec3(core.getConstructWorldPos())local bG=0;local bH=false;local bI=false;local bJ=nil;local bK=true;local bL=0;local bM=0;local bN=false;local bO={}local bP=showHud;local bQ={}local bR=false;local bS=""local bT=""local bU=nil;local bV={}local bW=unit.getClosestPlanetInfluence()>0;local bX=false;local bY=nil;timeCount=0;totalTime=0;local function bZ(b_,c0,type)if type==nil and not voices or type~=nil and not alerts or soundFolder=="archHUD"then return end;if type~=nil then if type==2 then system.logInfo("sound_loop|audiopacks/"..soundFolder.."/"..b_.."|"..c0 .."|"..soundVolume)else system.logInfo("sound_notification|audiopacks/"..soundFolder.."/"..b_.."|"..c0 .."|"..soundVolume)end else system.logInfo("sound_q|audiopacks/"..soundFolder.."/"..b_.."|"..c0 .."|"..soundVolume)end end;local function c1(c2,c3)for i=1,#c3 do c2[#c2+1]=c3[i]end;return c2 end;local function c4(c5)local c6={}local c7={"userControlScheme","soundFolder","freeLookToggle","BrakeToggleDefault","RemoteFreeze","brightHud","RemoteHud","VanillaRockets","InvertMouse","autoRollPreference","turnAssist","ExternalAGG","UseSatNav","ShouldCheckDamage","CalculateBrakeLandingSpeed","AtmoSpeedAssist","ForceAlignment","DisplayDeadZone","showHud","ShowOdometer","hideHudOnToggleWidgets","ShiftShowsRemoteButtons","DisplayOrbit","SetWaypointOnExit","IntruderAlertSystem","AlwaysVSpd","BarFuelDisplay","showHelp","Cockpit","voices","alerts","CollisionSystem"}local c8={"YawStallAngle","PitchStallAngle","brakeLandingRate","MaxPitch","LockPitchTarget","TargetOrbitRadius","LowOrbitHeight","AtmoSpeedLimit","SpaceSpeedLimit","AutoTakeoffAltitude","TargetHoverHeight","LandingGearGroundHeight","ReEntryHeight","MaxGameVelocity","AutopilotInterplanetaryThrottle","warmup","fuelTankHandlingAtmo","fuelTankHandlingSpace","fuelTankHandlingRocket","ContainerOptimization","FuelTankOptimization"}local c9={"ResolutionX","ResolutionY","circleRad","SafeR","SafeG","SafeB","PvPR","PvPG","PvPB","centerX","centerY","throtPosX","throtPosY","vSpdMeterX","vSpdMeterY","altMeterX","altMeterY","fuelX","fuelY","DeadZone","OrbitMapSize","OrbitMapX","OrbitMapY","soundVolume"}local ca={"speedChangeLarge","speedChangeSmall","MouseXSensitivity","MouseYSensitivity","autoRollFactor","rollSpeedFactor","autoRollRollThreshold","minRollVelocity","turnAssistFactor","TrajectoryAlignmentStrength","torqueFactor","pitchSpeedFactor","yawSpeedFactor","brakeSpeedFactor","brakeFlatFactor","DampingMultiplier","apTickRate","hudTickRate","ExtraLongitudeTags","ExtraLateralTags","ExtraVerticalTags"}if not c5 then c1(c6,c7)c1(c6,c8)c1(c6,c9)c1(c6,ca)return c6 elseif c5=="boolean"then return c7 elseif c5=="handling"then return c8 elseif c5=="hud"then return c9 elseif c5=="physics"then return ca end end;local function cb(x,y,cc,cd,ce)if cd==nil then cd=""end;if ce==nil then ce=""end;return e([[<text class="%s" x=%s y=%s style="%s">%s</text>]],cd,x,y,ce,cc)end;local function cf(cg,ch)if r:getAxisCommandType(0)~=axisCommandType.byThrottle and not ch then a.control.cancelCurrentControlMasterMode()end;r:setThrottleCommand(axisCommandId.longitudinal,cg)L=q(B(cg*100,0)/100,-1,1)end;local function ci(cg,ch)if r:getAxisCommandType(0)~=axisCommandType.byTargetSpeed and not ch then a.control.cancelCurrentControlMasterMode()end;r:setTargetSpeedCommand(axisCommandId.longitudinal,cg)bJ=cg end;local function cj(ck,cl)if ck==0 then return c(cl)<1e-09 end;if cl==0 then return c(ck)<1e-09 end;return c(ck-cl)<math.max(c(ck),c(cl))*epsilon end;local function cm(ak,cn)local co=ak>100000;if cn==nil then cn=1 end;if co then return B(ak/1000/200,cn).."SU"elseif ak<1000 then return B(ak,cn).."M"else return B(ak/1000,cn).."KM"end end;local function cp()AltitudeHold=false;if VertTakeOff then StrongBrakes=true;Reentry=false;AutoTakeoff=false;BrakeLanding=true;bb=true;ag=0;if as and aq==-1 then BrakeLanding=false;AltitudeHold=true;ag=0;a:setEngineForceCommand('thrust analog vertical fueled ',vec3(),1)ci(d(bi))end else bt=false;GearExtended=false;a.control.retractLandingGears()r:setTargetGroundAltitude(TargetHoverHeight)BrakeIsOn=true end;VertTakeOff=not VertTakeOff end;local function cq()bt=false;bl=nil;bm=nil;bx=0;if at==0 then if IntoOrbit then bZ("orOff","AP")IntoOrbit=false;bn=false;bs=nil;bb=autoRollPreference;if AltitudeHold then AltitudeHold=false;AutoTakeoff=false end;bp.VectorToTarget=false;bp.AutopilotAlign=false;bq=false elseif bW then bZ("orOn","AP")IntoOrbit=true;bb=true;if bs==nil then bs=planet end;if AltitudeHold then AltitudeHold=false;AutoTakeoff=false end else a3="Unable to engage auto-orbit, not near a planet"end else IntoOrbit=false;bn=false;bs=nil;bb=autoRollPreference;if AltitudeHold then AltitudeHold=false end;bp.VectorToTarget=false;bp.AutopilotAlign=false;bq=false end end;local function cr()if E-bg<1.5 then if planet.hasAtmosphere then if at>0 then HoldAltitude=planet.spaceEngineMinAltitude-50;bZ("11","EP")else if bW then HoldAltitude=planet.noAtmosphericDensityAltitude+LowOrbitHeight;br=HoldAltitude;bq=true;if not IntoOrbit then cq()end;bn=true end end;bg=-1;if AltitudeHold or IntoOrbit or VertTakeOff then return end end else bg=E end;if bW and at==0 then br=au;bq=true;bn=true;cq()if IntoOrbit then bg=E else bg=0 end;return end;AltitudeHold=not AltitudeHold;BrakeLanding=false;Reentry=false;if AltitudeHold then Autopilot=false;ProgradeIsOn=false;RetrogradeIsOn=false;a1=false;bb=true;LockPitch=nil;bt=false;if aq==-1 then bZ("altOn","AH")AutoTakeoff=false;if bg>-1 then if unit.getClosestPlanetInfluence()>0 then HoldAltitude=au end end;if VertTakeOff then cp()end else bZ("lfs","LS")AutoTakeoff=true;if bg>-1 then HoldAltitude=au+AutoTakeoffAltitude end;GearExtended=false;a.control.retractLandingGears()BrakeIsOn=true;r:setTargetGroundAltitude(TargetHoverHeight)if VertTakeOffEngine and bH then cp()end end;if ao then HoldAltitude=100000 end else bZ("altOff","AH")if IntoOrbit then cq()end;if VertTakeOff then cp()end;bb=autoRollPreference;AutoTakeoff=false;VectorToTarget=false;bg=0 end end;local function cs()local function ct(SpaceTarget)bX=false;VectorToTarget=not VectorToTarget;if VectorToTarget then TurnBurn=false;if not AltitudeHold and not SpaceTarget then cr()end end;VectorStatus="Proceeding to Waypoint"end;if E-bh<1.5 and at>0 then if not bw then a3="No space engines detected, Orbital Hop not supported"return end;if planet.hasAtmosphere then if at>0 then HoldAltitude=planet.noAtmosphericDensityAltitude+LowOrbitHeight;bZ("orH","OH")end;bh=-1;if Autopilot or VectorToTarget or IntoOrbit then return end end else bh=E end;TargetSet=false;if AutopilotTargetIndex>0 and not Autopilot and not VectorToTarget and not ao and not IntoOrbit then b7.UpdateAutopilotTarget()b8.showWayPoint(ad,AutopilotTargetCoords)if CustomTarget~=nil then LockPitch=nil;SpaceTarget=CustomTarget.planetname=="Space"if SpaceTarget then bZ("apSpc","AP")if at~=0 then ao=true;cr()else Autopilot=true end elseif planet.name==CustomTarget.planetname then StrongBrakes=true;if at>0 then if not VectorToTarget then bZ("vtt","AP")ct(SpaceTarget)end else bZ("apOn","AP")if not(ad.name==planet.name and bW)then bt=false;Autopilot=true elseif not as then if IntoOrbit then cq()end;br=planet.noAtmosphericDensityAltitude+LowOrbitHeight;bq=true;bp.AutopilotAlign=true;bp.VectorToTarget=true;bn=false;if not IntoOrbit then cq()end end end else bZ("apP","AP")RetrogradeIsOn=false;ProgradeIsOn=false;if at~=0 then ao=true;cr()else Autopilot=true end end elseif at==0 then if CustomTarget==nil and(ad.name==planet.name and bW)and not IntoOrbit then WaypointSet=false;bt=false;bn=false;cq()else bZ("apP","AP")Autopilot=true;RetrogradeIsOn=false;ProgradeIsOn=false;AutopilotRealigned=false;a1=false;AltitudeHold=false;BrakeLanding=false;Reentry=false;AutoTakeoff=false;Q=false;LockPitch=nil;WaypointSet=false end else bZ("apP","AP")ao=true;cr()end else bZ("apOff","AP")ao=false;Autopilot=false;AutopilotRealigned=false;VectorToTarget=false;Q=false;AutoTakeoff=false;AltitudeHold=false;VectorToTarget=false;HoldAltitude=au;TargetSet=false;Reentry=false;if IntoOrbit then cq()end end end;local function cu()local position=bF;local cv=sys:closestBody(position)if(position-cv.center):len()<cv.radius+cv.noAtmosphericDensityAltitude then cv=planet else cv=aY[0][0]end;return cv,position end;local function cw(cx)local cy=-1;local cz;cy=b7.findAtlasIndex(SavedLocations)if cy~=-1 then local cA;if cx~=nil then cz={position=SavedLocations[cy].position,name=cx,atmosphere=SavedLocations[cy].atmosphere,planetname=SavedLocations[cy].planetname,gravity=SavedLocations[cy].gravity}else local cv,cB=cu()cz={position=cB,name=SavedLocations[cy].name,atmosphere=at,planetname=cv.name,gravity=unit.getClosestPlanetInfluence(),safe=true}end;SavedLocations[cy]=cz;cy=-1;cy=b7.findAtlasIndex(aY[0])if cy>-1 then aY[0][cy]=cz end;b7.UpdateAtlasLocationsList()a3=cz.name.." position updated ("..cz.planetname..")"b7.UpdateAutopilotTarget()else a3="Name Not Found"end end;local function cC()BrakeIsOn=not BrakeIsOn;if BrakeLanding then BrakeLanding=false;bb=autoRollPreference end;if BrakeIsOn then bZ("bkOn","B",1)VectorToTarget=false;AutoTakeoff=false;Reentry=false;ProgradeIsOn=false;BrakeLanding=false;AutoLanding=false;bU=nil;if not bI then AltitudeHold=false;LockPitch=nil end;if VertTakeOff then cp()end;if IntoOrbit then cq()end;bb=autoRollPreference;an=false;ap=false;ag=0 else bZ("bkOff","B",1)end end;local function cD(cE,cF,cG)local function cH(cE,cI)cE=vec3(cE)cI=vec3(cI):normalize()local cJ=cE*cI;return cJ.x+cJ.y+cJ.z end;local cK=0.001;local cL=1;if not as or not bd or aq~=-1 or bC<R then if cG==nil then cG=DampingMultiplier end;if cF==nil then cF=cK end;cE=vec3(cE):normalize()local cM=vec3()-cE;local cN=-cH(cM,core.getConstructWorldOrientationRight())*cL;local cO=-cH(cM,core.getConstructWorldOrientationUp())*cL;if aD==0 then aD=cN/2 end;if aE==0 then aE=cO/2 end;if c(cN)<0.1 then W=W-cN*2 else W=W-(cN+(cN-aD)*cG)end;if c(cO)<0.1 then V=V+cO*2 else V=V+cO+(cO-aE)*cG end;aD=cN;aE=cO;if c(cN)<cF and c(cO)<cF then return true end;return false elseif bd and aq==-1 then cE=bB;if cG==nil then cG=DampingMultiplier end;if cF==nil then cF=cK end;cE=vec3(cE):normalize()local cM=bz-cE;local cN=-cH(cM,core.getConstructWorldOrientationRight())*cL;local cO=-cH(cM,core.getConstructWorldOrientationUp())*cL;if aD==0 then aD=cN/2 end;if aE==0 then aE=cO/2 end;if c(cN)<0.1 then W=W-cN*5 else W=W-(cN+(cN-aD)*cG)end;if c(cO)<0.1 then V=V+cO*5 else V=V+cO+(cO-aE)*cG end;aD=cN;aE=cO;if c(cN)<cF and c(cO)<cF then return true end;return false end end;local function cP()if Reentry then a3="Re-Entry cancelled"bZ("reOff","RE")Reentry=false;bb=autoRollPreference;AltitudeHold=false elseif not planet.hasAtmosphere then a3="Re-Entry requirements not met: you must start out of atmosphere\n and within a planets gravity well over a planet with atmosphere"aj=5 elseif not S then Reentry=true;if r:getAxisCommandType(0)~=controlMasterModeId.cruise then a.control.cancelCurrentControlMasterMode()end;bb=true;BrakeIsOn=false;a3="Beginning Parachute Re-Entry - Strap In.  Target speed: "..bi;bZ("par","RE")else Reentry=true;AltitudeHold=true;bb=true;BrakeIsOn=false;HoldAltitude=planet.surfaceMaxAltitude+ReEntryHeight;if HoldAltitude>planet.spaceEngineMinAltitude then HoldAltitude=planet.spaceEngineMinAltitude-planet.spaceEngineMinAltitude/10 end;local cc=cm(HoldAltitude)a3="Beginning Re-entry.  Target speed: "..bi.." Target Altitude: "..cc;bZ("glide","RE")ci(d(bi))end;AutoTakeoff=false end;local function cQ()if antigrav and not ExternalAGG then if bI then bZ("aggOff","AG")antigrav.deactivate()antigrav.hide()else if AntigravTargetAltitude==nil then AntigravTargetAltitude=au end;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;bZ("aggOn","AG")antigrav.activate()antigrav.show()end end end;local function cR(cS)local cT=0;local cU=0;local cV=0;if cS<60 then cS=d(cS)elseif cS<3600 then cT=d(cS/60)cS=d(cS%60)elseif cS<86400 then cU=d(cS/3600)cT=d(cS%3600/60)else cV=d(cS/86400)cU=d(cS%86400/3600)end;if cV>0 then return cV.."d "..cU.."h "elseif cU>0 then return cU.."h "..cT.."m "elseif cT>0 then return cT.."m "..cS.."s"elseif cS>0 then return cS.."s"else return"0s"end end;local function cW(cX)local function cY(cZ)for c_,d0 in pairs(cZ)do dbHud_1.setStringValue(d0,g(_G[d0]))if cX and dbHud_2 then dbHud_2.setStringValue(d0,g(_G[d0]))end end end;if dbHud_1 then cY(b)cY(c4())system.print("Saved Variables to Datacore")if cX and dbHud_2 then a3="Databank copied.  Remove copy when ready."end end end;local function d1()return{[0]={[0]={GM=0,bodyId=0,center={x=0,y=0,z=0},name='Space',planetarySystemId=0,radius=0,hasAtmosphere=false,gravity=0,noAtmosphericDensityAltitude=0,surfaceMaxAltitude=0},[2]={name="Alioth",description="Alioth is the planet selected by the arkship for landfall; it is a typical goldilocks planet where humanity may rebuild in the coming decades. The arkship geological survey reports mountainous regions alongside deep seas and lush forests. This is where it all starts.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9401,atmosphericEngineMaxAltitude=5580,biosphere="Forest",classification="Mesoplanet",bodyId=2,GM=157470826617,gravity=1.0082568597356114,fullAtmosphericDensityMaxAltitude=-10,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=6272,numSatellites=2,positionFromSun=2,center={x=-8,y=-8,z=-126303},radius=126067.8984375,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=3410,surfaceArea=199718780928,surfaceAverageAltitude=200,surfaceMaxAltitude=1100,surfaceMinAltitude=-330,systemZone="High",territories=259472,type="Planet",waterLevel=0,planetarySystemId=0},[21]={name="Alioth Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=21,GM=2118960000,gravity=0.24006116402380084,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=457933,y=-1509011,z=115524},radius=30000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=11309733888,surfaceAverageAltitude=140,surfaceMaxAltitude=200,surfaceMinAltitude=10,systemZone=nil,territories=14522,type="",waterLevel=nil,planetarySystemId=0},[22]={name="Alioth Moon 4",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=22,GM=2165833514,gravity=0.2427018259886451,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-1692694,y=729681,z=-411464},radius=30330,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=0,surfaceArea=11559916544,surfaceAverageAltitude=-15,surfaceMaxAltitude=-5,surfaceMinAltitude=-50,systemZone=nil,territories=14522,type="",waterLevel=nil,planetarySystemId=0},[5]={name="Feli",description="Feli is easily identified by its massive and deep crater. Outside of the crater, the arkship geological survey reports a fairly bland and uniform planet, it also cannot explain the existence of the crater. Feli is particular for having an extremely small atmosphere, allowing life to develop in the deeper areas of its crater but limiting it drastically on the actual surface.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.5488,atmosphericEngineMaxAltitude=66725,biosphere="Barren",classification="Mesoplanet",bodyId=5,GM=16951680000,gravity=0.4801223280476017,fullAtmosphericDensityMaxAltitude=30,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=78500,numSatellites=1,positionFromSun=5,center={x=-43534464,y=22565536,z=-48934464},radius=41800,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=42800,surfaceArea=21956466688,surfaceAverageAltitude=18300,surfaceMaxAltitude=18500,surfaceMinAltitude=46,systemZone="Low",territories=27002,type="Planet",waterLevel=nil,planetarySystemId=0},[50]={name="Feli Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=50,GM=499917600,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-43902841.78,y=22261034.7,z=-48862386},radius=14000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=800,surfaceMaxAltitude=900,surfaceMinAltitude=0,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[120]={name="Ion",description="Ion is nothing more than an oversized ice cube frozen through and through. It is a largely inhospitable planet due to its extremely low temperatures. The arkship geological survey reports extremely rough mountainous terrain with little habitable land.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9522,atmosphericEngineMaxAltitude=10480,biosphere="Ice",classification="Hypopsychroplanet",bodyId=120,GM=7135606629,gravity=0.36009174603570127,fullAtmosphericDensityMaxAltitude=-30,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=17700,numSatellites=2,positionFromSun=12,center={x=2865536.7,y=-99034464,z=-934462.02},radius=44950,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=6410,surfaceArea=25390383104,surfaceAverageAltitude=500,surfaceMaxAltitude=1300,surfaceMinAltitude=250,systemZone="Average",territories=32672,type="Planet",waterLevel=nil,planetarySystemId=0},[121]={name="Ion Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=121,GM=106830900,gravity=0.08802242599860607,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=2472916.8,y=-99133747,z=-1133582.8},radius=11000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=1520530944,surfaceAverageAltitude=100,surfaceMaxAltitude=200,surfaceMinAltitude=3,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[122]={name="Ion Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=122,GM=176580000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=2995424.5,y=-99275010,z=-1378480.7},radius=15000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=-1900,surfaceMaxAltitude=-1400,surfaceMinAltitude=-2100,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[9]={name="Jago",description="Jago is a water planet. The large majority of the planet&apos;s surface is covered by large oceans dotted by small areas of landmass across the planet. The arkship geological survey reports deep seas across the majority of the planet with sub 15 percent coverage of solid ground.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9835,atmosphericEngineMaxAltitude=9695,biosphere="Water",classification="Mesoplanet",bodyId=9,GM=18606274330,gravity=0.5041284298678057,fullAtmosphericDensityMaxAltitude=-90,habitability="Very High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=10900,numSatellites=0,positionFromSun=9,center={x=-94134462,y=12765534,z=-3634464},radius=61590,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=5900,surfaceArea=47668367360,surfaceAverageAltitude=0,surfaceMaxAltitude=1200,surfaceMinAltitude=-500,systemZone="Very High",territories=60752,type="Planet",waterLevel=0,planetarySystemId=0},[100]={name="Lacobus",description="Lacobus is an ice planet that also features large bodies of water. The arkship geological survey reports deep oceans alongside a frozen and rough mountainous environment. Lacobus seems to feature regional geothermal activity allowing for the presence of water on the surface.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.7571,atmosphericEngineMaxAltitude=11120,biosphere="Ice",classification="Psychroplanet",bodyId=100,GM=13975172474,gravity=0.45611622622739767,fullAtmosphericDensityMaxAltitude=-20,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=12510,numSatellites=3,positionFromSun=10,center={x=98865536,y=-13534464,z=-934461.99},radius=55650,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=6790,surfaceArea=38917074944,surfaceAverageAltitude=800,surfaceMaxAltitude=1660,surfaceMinAltitude=250,systemZone="Average",territories=50432,type="Planet",waterLevel=0,planetarySystemId=0},[102]={name="Lacobus Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=102,GM=444981600,gravity=0.14403669598391783,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=99180968,y=-13783862,z=-926156.4},radius=18000,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=0,surfaceArea=4071504128,surfaceAverageAltitude=150,surfaceMaxAltitude=300,surfaceMinAltitude=10,systemZone=nil,territories=5072,type="",waterLevel=nil,planetarySystemId=0},[103]={name="Lacobus Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=103,GM=211503600,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=99250052,y=-13629215,z=-1059341.4},radius=14000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=-1380,surfaceMaxAltitude=-1280,surfaceMinAltitude=-1880,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[101]={name="Lacobus Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=101,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=98905288.17,y=-13950921.1,z=-647589.53},radius=15000,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=500,surfaceMaxAltitude=820,surfaceMinAltitude=3,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[1]={name="Madis",description="Madis is a barren wasteland of a rock; it sits closest to the sun and temperatures reach extreme highs during the day. The arkship geological survey reports long rocky valleys intermittently separated by small ravines.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.8629,atmosphericEngineMaxAltitude=7165,biosphere="Barren",classification="hyperthermoplanet",bodyId=1,GM=6930729684,gravity=0.36009174603570127,fullAtmosphericDensityMaxAltitude=220,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=8050,numSatellites=3,positionFromSun=1,center={x=17465536,y=22665536,z=-34464},radius=44300,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=4480,surfaceArea=24661377024,surfaceAverageAltitude=750,surfaceMaxAltitude=850,surfaceMinAltitude=670,systemZone="Low",territories=30722,type="Planet",waterLevel=nil,planetarySystemId=0},[10]={name="Madis Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=10,GM=78480000,gravity=0.08002039003323584,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17448118.224,y=22966846.286,z=143078.82},radius=10000,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=0,surfaceArea=1256637056,surfaceAverageAltitude=210,surfaceMaxAltitude=420,surfaceMinAltitude=0,systemZone=nil,territories=1472,type="",waterLevel=nil,planetarySystemId=0},[11]={name="Madis Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=11,GM=237402000,gravity=0.09602446196397631,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17194626,y=22243633.88,z=-214962.81},radius=12000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=1809557376,surfaceAverageAltitude=-700,surfaceMaxAltitude=300,surfaceMinAltitude=-2900,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[12]={name="Madis Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=12,GM=265046609,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17520614,y=22184730,z=-309989.99},radius=15000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=700,surfaceMaxAltitude=1100,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[26]={name="Sanctuary",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9666,atmosphericEngineMaxAltitude=6935,biosphere="",classification="",bodyId=26,GM=68234043600,gravity=1.0000000427743831,fullAtmosphericDensityMaxAltitude=-30,habitability="",hasAtmosphere=true,isSanctuary=true,noAtmosphericDensityAltitude=7800,numSatellites=0,positionFromSun=0,center={x=-1404835,y=562655,z=-285074},radius=83400,safeAreaEdgeAltitude=0,size="L",spaceEngineMinAltitude=4230,surfaceArea=87406149632,surfaceAverageAltitude=80,surfaceMaxAltitude=500,surfaceMinAltitude=-60,systemZone=nil,territories=111632,type="",waterLevel=0,planetarySystemId=0},[6]={name="Sicari",description="Sicari is a typical desert planet; it has survived for millenniums and will continue to endure. While not the most habitable of environments it remains a relatively untouched and livable planet of the Alioth sector. The arkship geological survey reports large flatlands alongside steep plateaus.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.897,atmosphericEngineMaxAltitude=7725,biosphere="Desert",classification="Mesoplanet",bodyId=6,GM=10502547741,gravity=0.4081039739797361,fullAtmosphericDensityMaxAltitude=-625,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=8770,numSatellites=0,positionFromSun=6,center={x=52765536,y=27165538,z=52065535},radius=51100,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=4480,surfaceArea=32813432832,surfaceAverageAltitude=130,surfaceMaxAltitude=220,surfaceMinAltitude=50,systemZone="Average",territories=41072,type="Planet",waterLevel=nil,planetarySystemId=0},[7]={name="Sinnen",description="Sinnen is a an empty and rocky hell. With no atmosphere to speak of it is one of the least hospitable planets in the sector. The arkship geological survey reports mostly flatlands alongside deep ravines which look to have once been riverbeds. This planet simply looks to have dried up and died, likely from solar winds.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9226,atmosphericEngineMaxAltitude=10335,biosphere="Desert",classification="Mesoplanet",bodyId=7,GM=13033380591,gravity=0.4401121421448438,fullAtmosphericDensityMaxAltitude=-120,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=11620,numSatellites=1,positionFromSun=7,center={x=58665538,y=29665535,z=58165535},radius=54950,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=6270,surfaceArea=37944188928,surfaceAverageAltitude=317,surfaceMaxAltitude=360,surfaceMinAltitude=23,systemZone="Average",territories=48002,type="Planet",waterLevel=nil,planetarySystemId=0},[70]={name="Sinnen Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=70,GM=396912600,gravity=0.1360346539426409,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=58969616,y=29797945,z=57969449},radius=17000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=3631681280,surfaceAverageAltitude=-2050,surfaceMaxAltitude=-1950,surfaceMinAltitude=-2150,systemZone=nil,territories=4322,type="",waterLevel=nil,planetarySystemId=0},[110]={name="Symeon",description="Symeon is an ice planet mysteriously split at the equator by a band of solid desert. Exactly how this phenomenon is possible is unclear but some sort of weather anomaly may be responsible. The arkship geological survey reports a fairly diverse mix of flat-lands alongside mountainous formations.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9559,atmosphericEngineMaxAltitude=6920,biosphere="Ice, Desert",classification="Hybrid",bodyId=110,GM=9204742375,gravity=0.3920998898971822,fullAtmosphericDensityMaxAltitude=-30,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=7800,numSatellites=0,positionFromSun=11,center={x=14165536,y=-85634465,z=-934464.3},radius=49050,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=4230,surfaceArea=30233462784,surfaceAverageAltitude=39,surfaceMaxAltitude=450,surfaceMinAltitude=126,systemZone="High",territories=38882,type="Planet",waterLevel=nil,planetarySystemId=0},[4]={name="Talemai",description="Talemai is a planet in the final stages of an Ice Age. It seems likely that the planet was thrown into tumult by a cataclysmic volcanic event which resulted in its current state. The arkship geological survey reports large mountainous regions across the entire planet.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.8776,atmosphericEngineMaxAltitude=9685,biosphere="Barren",classification="Psychroplanet",bodyId=4,GM=14893847582,gravity=0.4641182439650478,fullAtmosphericDensityMaxAltitude=-78,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=10890,numSatellites=3,positionFromSun=4,center={x=-13234464,y=55765536,z=465536},radius=57500,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=5890,surfaceArea=41547563008,surfaceAverageAltitude=580,surfaceMaxAltitude=610,surfaceMinAltitude=520,systemZone="Average",territories=52922,type="Planet",waterLevel=nil,planetarySystemId=0},[42]={name="Talemai Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=42,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-13058408,y=55781856,z=740177.76},radius=15000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=720,surfaceMaxAltitude=850,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[40]={name="Talemai Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=40,GM=141264000,gravity=0.09602446196397631,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-13503090,y=55594325,z=769838.64},radius=12000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=1809557376,surfaceAverageAltitude=250,surfaceMaxAltitude=450,surfaceMinAltitude=0,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[41]={name="Talemai Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=41,GM=106830900,gravity=0.08802242599860607,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-12800515,y=55700259,z=325207.84},radius=11000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=1520530944,surfaceAverageAltitude=190,surfaceMaxAltitude=400,surfaceMinAltitude=0,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[8]={name="Teoma",description="[REDACTED] The arkship geological survey [REDACTED]. This planet should not be here.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.7834,atmosphericEngineMaxAltitude=5580,biosphere="Forest",classification="Mesoplanet",bodyId=8,GM=18477723600,gravity=0.48812434578525177,fullAtmosphericDensityMaxAltitude=15,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=6280,numSatellites=0,positionFromSun=8,center={x=80865538,y=54665536,z=-934463.94},radius=62000,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=3420,surfaceArea=48305131520,surfaceAverageAltitude=700,surfaceMaxAltitude=1100,surfaceMinAltitude=-200,systemZone="High",territories=60752,type="Planet",waterLevel=0,planetarySystemId=0},[3]={name="Thades",description="Thades is a scorched desert planet. Perhaps it was once teaming with life but now all that remains is ash and dust. The arkship geological survey reports a rocky mountainous planet bisected by a massive unnatural ravine; something happened to this planet.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.03552,atmosphericEngineMaxAltitude=32180,biosphere="Desert",classification="Thermoplanet",bodyId=3,GM=11776905000,gravity=0.49612641213015557,fullAtmosphericDensityMaxAltitude=150,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=32800,numSatellites=2,positionFromSun=3,center={x=29165536,y=10865536,z=65536},radius=49000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=21400,surfaceArea=30171856896,surfaceAverageAltitude=13640,surfaceMaxAltitude=13690,surfaceMinAltitude=370,systemZone="Low",territories=38882,type="Planet",waterLevel=nil,planetarySystemId=0},[30]={name="Thades Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=30,GM=211564034,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=29214402,y=10907080.695,z=433858.2},radius=14000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=60,surfaceMaxAltitude=300,surfaceMinAltitude=0,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[31]={name="Thades Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=31,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=29404193,y=10432768,z=19554.131},radius=15000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=70,surfaceMaxAltitude=350,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0}}}end;local function d2()local function d3(d4)return type(d4)=='number'end;local function d5(d4)return type(A(d4))=='number'end;local function d6(d7)return type(d7)=='table'end;local function d8(d9)return type(d9)=='string'end;local function da(d0)return d6(d0)and d3(d0.x and d0.y and d0.z)end;local function db(dc)return d6(dc)and d3(dc.latitude and dc.longitude and dc.altitude and dc.bodyId and dc.systemId)end;local dd=math.pi/180;local de=180/math.pi;local epsilon=1e-10;local C=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local df='::pos{'..C..','..C..','..C..','..C..','..C..'}'local utils=require('cpml.utils')local vec3=require('cpml.vec3')local function dg(d4)local cJ=string.gsub(string.reverse(e('%.4f',d4)),'^0*%.?','')return cJ==''and'0'or string.reverse(cJ)end;local function dh(di)if da(di)then return e('{x=%.3f,y=%.3f,z=%.3f}',di.x,di.y,di.z)end;if d6(di)and not getmetatable(di)then local dj={}local dk=next(di)if type(dk)=='nil'or dk==1 then dj=di else for c_,d0 in pairs(di)do local cg=dh(d0)if type(c_)=='number'then table.insert(dj,e('[%s]=%s',c_,cg))else table.insert(dj,e('%s=%s',c_,cg))end end end;return e('{%s}',table.concat(dj,','))end;if d8(di)then return e("'%s'",di:gsub("'",[[\']]))end;return tostring(di)end;local dl={}dl.__index=dl;dl.__tostring=function(di,dm)local dn={}for c_ in pairs(di)do table.insert(dn,c_)end;table.sort(dn)local dj={}for _,c_ in ipairs(dn)do local cg=dh(di[c_])if type(c_)=='number'then table.insert(dj,e('[%s]=%s',c_,cg))else table.insert(dj,e('%s=%s',c_,cg))end end;if dm then return e('%s%s',dm,table.concat(dj,',\n'..dm))end;return e('{%s}',table.concat(dj,','))end;dl.__eq=function(dp,dq)return dp.planetarySystemId==dq.planetarySystemId and dp.bodyId==dq.bodyId and cj(dp.radius,dq.radius)and cj(dp.center.x,dq.center.x)and cj(dp.center.y,dq.center.y)and cj(dp.center.z,dq.center.z)and cj(dp.GM,dq.GM)end;local function dr(ds,dt,du,dv,dw)assert(d5(ds),'Argument 1 (planetarySystemId) must be a number:'..type(ds))assert(d5(dt),'Argument 2 (bodyId) must be a number:'..type(dt))assert(d5(du),'Argument 3 (radius) must be a number:'..type(du))assert(d6(dv),'Argument 4 (worldCoordinates) must be a array or vec3.'..type(dv))assert(d5(dw),'Argument 5 (GM) must be a number:'..type(dw))return setmetatable({planetarySystemId=A(ds),bodyId=A(dt),radius=A(du),center=vec3(dv),GM=A(dw)},dl)end;local MapPosition={}MapPosition.__index=MapPosition;MapPosition.__tostring=function(cv)return e('::pos{%d,%d,%s,%s,%s}',cv.systemId,cv.bodyId,dg(cv.latitude*de),dg(cv.longitude*de),dg(cv.altitude))end;MapPosition.__eq=function(dp,dq)return dp.bodyId==dq.bodyId and dp.systemId==dq.systemId and cj(dp.latitude,dq.latitude)and cj(dp.altitude,dq.altitude)and(cj(dp.longitude,dq.longitude)or cj(dp.latitude,math.pi/2)or cj(dp.latitude,-math.pi/2))end;local function dx(dy,dt,dz,dA,dB)local ds=dy;if d8(dy)and not dA and not dB and not dt and not dz then ds,dt,dz,dA,dB=n(dy,df)assert(ds,'Argument 1 (position string) is malformed.')else assert(d5(ds),'Argument 1 (systemId) must be a number:'..type(ds))assert(d5(dt),'Argument 2 (bodyId) must be a number:'..type(dt))assert(d5(dz),'Argument 3 (latitude) must be in degrees:'..type(dz))assert(d5(dA),'Argument 4 (longitude) must be in degrees:'..type(dA))assert(d5(dB),'Argument 5 (altitude) must be in meters:'..type(dB))end;ds=A(ds)dt=A(dt)dz=A(dz)dA=A(dA)dB=A(dB)if dt==0 then return setmetatable({latitude=dz,longitude=dA,altitude=dB,bodyId=dt,systemId=ds},MapPosition)end;return setmetatable({latitude=dd*q(dz,-90,90),longitude=dd*(dA%360),altitude=dB,bodyId=dt,systemId=ds},MapPosition)end;local dC={}dC.__index=dC;dC.__tostring=function(di,dm)local dD=dm and dm..'  'local dE={}local dn={}for c_ in pairs(di)do table.insert(dn,c_)end;table.sort(dn)for _,dF in ipairs(dn)do bdy=di[dF]local dG=dl.__tostring(bdy,dD)if dm then table.insert(dE,e('[%s]={\n%s\n%s}',dF,dG,dm))else table.insert(dE,e('  [%s]=%s',dF,dG))end end;if dm then return e('\n%s%s%s',dm,table.concat(dE,',\n'..dm),dm)end;return e('{\n%s\n}',table.concat(dE,',\n'))end;local function dH(dI)local aY={}local pid;for _,d0 in pairs(dI)do local dJ=d0.planetarySystemId;if type(dJ)~='number'then error('Invalid planetary system ID: '..tostring(dJ))elseif pid and dJ~=pid then error('Mistringmatch planetary system IDs: '..dJ..' and '..pid)end;local dK=d0.bodyId;if type(dK)~='number'then error('Invalid body ID: '..tostring(dK))elseif aY[dK]then error('Duplicate body ID: '..tostring(dK))end;setmetatable(d0.center,getmetatable(vec3.unit_x))aY[dK]=setmetatable(d0,dl)pid=dJ end;return setmetatable(aY,dC)end;b1={}local function dL(dI)return setmetatable({galaxyAtlas=dI or{}},b1)end;b1.__index=function(d7,i)if type(i)=='number'then local system=d7.galaxyAtlas[i]return dH(system)end;return rawget(b1,i)end;b1.__pairs=function(di)return function(d7,c_)local dM,nv=next(d7,c_)return dM,nv and dH(nv)end,di.galaxyAtlas,nil end;b1.__tostring=function(di)local dN={}for _,dO in pairs(di or{})do local dP=dO:getPlanetarySystemId()local dQ=dC.__tostring(dO,'    ')table.insert(dN,e('  [%s]={%s\n  }',dP,dQ))end;return e('{\n%s\n}\n',table.concat(dN,',\n'))end;b1.BodyParameters=dr;b1.MapPosition=dx;b1.PlanetarySystem=dH;function b1.createBodyParameters(dR,dt,dS,dT,dU,dV,dW)assert(d5(dR),'Argument 1 (planetarySystemId) must be a number:'..type(dR))assert(d5(dt),'Argument 2 (bodyId) must be a number:'..type(dt))assert(d5(dS),'Argument 3 (surfaceArea) must be a number:'..type(dS))assert(d6(dT),'Argument 4 (aPosition) must be an array or vec3:'..type(dT))assert(d6(dU),'Argument 5 (verticalAtPosition) must be an array or vec3:'..type(dU))assert(d5(dV),'Argument 6 (altitude) must be in meters:'..type(dV))assert(d5(dW),'Argument 7 (gravityAtPosition) must be number:'..type(dW))local du=z(dS/4/math.pi)local ak=du+dV;local dX=vec3(dT)+ak*vec3(dU)local dw=dW*ak*ak;return dr(dR,dt,du,dX,dw)end;b1.isMapPosition=db;function b1:getPlanetarySystem(dy)if i==nil then i=0 end;if nv==nil then nv=0 end;local dR=dy;if db(dy)then dR=dy.systemId end;if type(dR)=='number'then local system=self.galaxyAtlas[i]if system then if getmetatable(nv)~=dC then system=dH(system)end;return system end end end;function dC:sizeCalculator(dY)return 1.05*dY.radius end;function dC:castIntersections(dZ,cI,d_,e0,e1,e2)local e3={}local e4=e1 or self;for _,dY in pairs(e4)do table.insert(e3,dY)end;if not e2 then table.sort(e3,function(e5,e6)return(e5.center-dZ):len()<(e6.center-dZ):len()end)end;local e7=cI:normalize()for _,dY in ipairs(e3)do local e8=dY.center-dZ;local du=self:sizeCalculator(dY)local e9=e8:dot(e7)local ea=e9^2-(e8:len2()-du^2)if ea>=0 then local eb=z(ea)local ec=e9+eb;local ed=e9-eb;if ed>0 then return dY,ec,ed elseif ec>0 then return dY,ec,nil end end end;return nil,nil,nil end;function dC:closestBody(ee)assert(type(ee)=='table','Invalid coordinates.')local ef,dY;local eg=vec3(ee)for _,eh in pairs(self)do local ei=(eh.center-eg):len2()if(not dY or ei<ef)and eh.name~="Space"then dY=eh;ef=ei end end;return dY end;function dC:convertToBodyIdAndWorldCoordinates(dy)local ej=dy;if d8(dy)then ej=dx(dy)end;if ej.bodyId==0 then return 0,vec3(ej.latitude,ej.longitude,ej.altitude)end;local eh=self:getBodyParameters(ej)if eh then return ej.bodyId,eh:convertToWorldCoordinates(ej)end end;function dC:getBodyParameters(dy)local dt=dy;if db(dy)then dt=dy.bodyId end;assert(d5(dt),'Argument 1 (bodyId) must be a number:'..type(dt))return self[dt]end;function dC:getPlanetarySystemId()local _,d0=next(self)return d0 and d0.planetarySystemId end;function dl:convertToMapPosition(dv)assert(d6(dv),'Argument 1 (worldCoordinates) must be an array or vec3:'..type(dv))local ek=vec3(dv)if self.bodyId==0 then return setmetatable({latitude=ek.x,longitude=ek.y,altitude=ek.z,bodyId=0,systemId=self.planetarySystemId},MapPosition)end;local el=ek-self.center;local ak=el:len()local dB=ak-self.radius;local dz=0;local dA=0;if not cj(ak,0)then local em=m(el.y,el.x)dA=em>=0 and em or 2*math.pi+em;dz=math.pi/2-math.acos(el.z/ak)end;return setmetatable({latitude=dz,longitude=dA,altitude=dB,bodyId=self.bodyId,systemId=self.planetarySystemId},MapPosition)end;function dl:convertToWorldCoordinates(dy)local ej=d8(dy)and dx(dy)or dy;if ej.bodyId==0 then return vec3(ej.latitude,ej.longitude,ej.altitude)end;assert(db(ej),'Argument 1 (mapPosition) is not an instance of "MapPosition".')assert(ej.systemId==self.planetarySystemId,'Argument 1 (mapPosition) has a different planetary system ID.')assert(ej.bodyId==self.bodyId,'Argument 1 (mapPosition) has a different planetary body ID.')local en=math.cos(ej.latitude)return self.center+(self.radius+ej.altitude)*vec3(en*math.cos(ej.longitude),en*math.sin(ej.longitude),math.sin(ej.latitude))end;function dl:getAltitude(dv)return(vec3(dv)-self.center):len()-self.radius end;function dl:getDistance(dv)return(vec3(dv)-self.center):len()end;function dl:getGravity(dv)local eo=self.center-vec3(dv)local ep=eo:len2()return self.GM/ep*eo/z(ep)end;return setmetatable(b1,{__call=function(_,...)return dL(...)end})end;local function eq()local b3={}local er=30000000/3600;local es=er*er;local et=100;local function eu(d0)return 1/z(1-d0*d0/es)end;function b3.computeAccelerationTime(ev,ew,ex)local ey=er*math.asin(ev/er)return(er*math.asin(ex/er)-ey)/ew end;function b3.computeDistanceAndTime(ev,ex,ez,eA,eB,eC)eB=eB or 0;eC=eC or 0;local eD=ev<=ex;local eE=eA*(eD and 1 or-1)/ez;local eF=-eC/ez;local eG=eE+eF;if eD and eG<=0 or not eD and eG>=0 then return-1,-1 end;local eH,eI=0,0;if eE~=0 and eB>0 then local ey=math.asin(ev/er)local eJ=math.pi*(eE/2+eF)local eK=eE*eB;local eL=er*math.pi;local d0=function(d7)local eM=(eJ*d7-eK*math.sin(math.pi*d7/2/eB)+eL*ey)/eL;local eN=math.tan(eM)return er*eN/z(eN*eN+1)end;local eO=eD and function(d9)return d9>=ex end or function(d9)return d9<=ex end;eI=2*eB;if eO(d0(eI))then local eP=0;while c(eI-eP)>0.5 do local d7=(eI+eP)/2;if eO(d0(d7))then eI=d7 else eP=d7 end end end;local eQ=ev;local eR=eI/et;for eS=1,et do local eT=d0(eS*eR)eH=eH+(eT+eQ)*eR/2;eQ=eT end;if eI<2*eB then return eH,eI end;ev=eQ end;local ey=er*math.asin(ev/er)local E=(er*math.asin(ex/er)-ey)/eG;local eU=es*math.cos(ey/er)/eG;local ak=eU-es*math.cos((eG*E+ey)/er)/eG;return ak+eH,E+eI end;function b3.computeTravelTime(ev,ew,ak)if ak==0 then return 0 end;if ew>0 then local ey=er*math.asin(ev/er)local eU=es*math.cos(ey/er)/ew;return(er*math.acos(ew*(eU-ak)/es)-ey)/ew end;if ev==0 then return-1 end;assert(ev>0,'Acceleration and initial speed are both zero.')return ak/ev end;function b3.lorentz(d0)return eu(d0)end;return b3 end;local function eV()local vec3=require('cpml.vec3')local d2=d2()local function d8(d9)return type(d9)=='string'end;local function d6(d7)return type(d7)=='table'end;Kepler={}Kepler.__index=Kepler;function Kepler:escapeAndOrbitalSpeed(dB)assert(self.body)local ak=dB+self.body.radius;if not cj(ak,0)then local orbit=z(self.body.GM/ak)return z(2)*orbit,orbit end;return nil,nil end;function Kepler:orbitalParameters(dy,eW)assert(self.body)assert(d6(dy)or d8(dy))assert(d6(eW))local cB=(d8(dy)or d2.isMapPosition(dy))and self.body:convertToWorldCoordinates(dy)or vec3(dy)local d0=vec3(eW)local eX=cB-self.body.center;local eY=d0:len2()local eZ=eX:len()local e_=self.body.GM;local f0=((eY-e_/eZ)*eX-eX:dot(d0)*d0)/e_;local ck=e_/(2*e_/eZ-eY)local f1=f0:len()local e7=f0:normalize()local f2=ck*(1-f1)local f3=ck*(1+f1)local f4=f2*e7+self.body.center;local f5=f1<=1 and-f3*e7+self.body.center or nil;local f6=z(ck*e_*(1-f1*f1))local f7=f5 and 2*math.pi*z(ck^3/e_)local f8=math.acos(f0:dot(eX)/(f1*eZ))if eX:dot(d0)<0 then f8=-(f8-2*math.pi)end;local f9=math.acos((math.cos(f8)+f1)/(1+f1*math.cos(f8)))local fa=f9;if fa<0 then fa=fa+2*math.pi end;local fb=fa-f1*math.sin(fa)local fc=0;local fd=0;local fe=0;if f7~=nil then fc=fb/(2*math.pi/f7)fd=f7-fc;fe=fd+f7/2;if f8-math.pi>0 then fd=fc;fe=fd+f7/2 end;if fe>f7 then fe=fe-f7 end end;return{periapsis={position=f4,speed=f6/f2,circularOrbitSpeed=z(e_/f2),altitude=f2-self.body.radius},apoapsis=f5 and{position=f5,speed=f6/f3,circularOrbitSpeed=z(e_/f3),altitude=f3-self.body.radius},currentVelocity=d0,currentPosition=cB,eccentricity=f1,period=f7,eccentricAnomaly=f9,meanAnomaly=fb,timeToPeriapsis=fd,timeToApoapsis=fe}end;local function ff(fg)local eh=d2.BodyParameters(fg.planetarySystemId,fg.bodyId,fg.radius,fg.center,fg.GM)return setmetatable({body=eh},Kepler)end;return setmetatable(Kepler,{__call=function(_,...)return ff(...)end})end;local function fh()local fi=0;local function fj(fk)local du=500000;local fl,fm,fn=math.huge;local fo=false;local fp=vec3({13771471,7435803,-128971})local fq=18000000;fl=vec3(fk):dist(fp)if fl<fq then return true,c(fl-fq),"Safe Zone",0 end;fm=vec3(fk):dist(vec3(planet.center))if fm<du then fo=true end;if c(fm-du)<c(fl-fq)then return fo,c(fm-du),planet.name,planet.bodyId else return fo,c(fl-fq),"Safe Zone",0 end end;local function fr(d0)if aI==1920 then return d0 else return B(aI*d0/1920,0)end end;local function fs(d0)if aJ==1080 then return d0 else return B(aJ*d0/1080,0)end end;local function ft()return w()==0 and userControlScheme~="keyboard"and l()==0 end;local function fu()local fv="TRAVEL"if not bK then fv="CRUISE"end;if Autopilot then fv="AUTOPILOT"end;return fv end;local function fw(fx,aW,x,fy,fz,fA,fB,fC)local fD=1;local fE=2;local fF=3;local fG=4;local fH=5;local fI=6;local fJ=""local fK=0;local fL=fuelY;local fM=fuelY+5;if not BarFuelDisplay then fM=fM+5 end;if l()==1 and not RemoteHud then fL=fL-50;fM=fM-50 end;if fz=="ATMO"then fJ="atmofueltank"elseif fz=="SPACE"then fJ="spacefueltank"else fJ="rocketfueltank"end;fK=_G[fJ.."_size"]if#fA>0 then for i=1,#fA do local fN=string.sub(fA[i][fE],1,12)local fO=0;for fP=1,fK do if fA[i][fE]==f(unit[fJ.."_"..fP].getData()).name then fO=fP;break end end;if aW or fB[i]==nil or fC[i]==nil then local fQ=0;local fR=0;local fS=0;local fT=0;local fU=p()if fO~=0 then fC[i]=f(unit[fJ.."_"..fO].getData()).percentage;fB[i]=f(unit[fJ.."_"..fO].getData()).timeLeft;if fB[i]=="n/a"then fB[i]=0 end else fS=k(fA[i][fD])-fA[i][fG]fQ=fA[i][fF]fC[i]=d(0.5+fS*100/fQ)fR=fA[i][fH]fT=fA[i][fI]if fR<=fS then fB[i]=0 else fB[i]=d(0.5+fS/((fR-fS)/(fU-fT)))end;fA[i][fH]=fS;fA[i][fI]=fU end end;if fN==fy then fN=e("%s %d",fz,i)end;if fO==0 then fN=fN.." *"end;local fV;if fB[i]==0 then fV=""else fV=cR(fB[i])end;if fC[i]~=nil then local fW=d(fC[i]*2.55)local fX=e("rgb(%d,%d,%d)",255-fW,fW,0)local cd=""if fV~=""and fB[i]<120 or fC[i]<5 then if aW then cd=[[class="red"]]end end;if BarFuelDisplay then table.insert(fx,e([[
                                            <g class="pdim">                        
                                            <rect fill=grey class="bar" x="%d" y="%d" width="100" height="13"></rect></g>
                                            <g class="bar txtstart">
                                            <rect fill=%s width="%d" height="13" x="%d" y="%d"></rect>
                                            <text fill=black x="%d" y="%d">%s%% %s</text>
                                            </g>]],x,fM,fX,fC[i],x,fM,x+2,fM+10,fC[i],fV))fx[#fx+1]=cb(x,fL,fN,cd.."txtstart pdim txtfuel")fL=fL-30;fM=fM-30 else fx[#fx+1]=cb(x,fL,fN,cd.." pdim txtfuel")fx[#fx+1]=cb(x,fM,e("%d%% %s",fC[i],fV),"pdim txtfuel","fill:"..fX)fL=fL+30;fM=fM+30 end end end end end;local function fY(fx,dB)if dB<200000 and not as or dB and as then local fZ=0;if c(bE)>1 then fZ=45*math.log(c(bE),10)if bE<0 then fZ=-fZ end end;fx[#fx+1]=e([[
                                <g class="pbright txt txtvspd" transform="translate(%d %d) scale(0.6)">
                                        <text x="55" y="-41">1000</text>
                                        <text x="10" y="-65">100</text>
                                        <text x="-45" y="-45">10</text>
                                        <text x="-73" y="3">O</text>
                                        <text x="-45" y="52">-10</text>
                                        <text x="10" y="72">-100</text>
                                        <text x="55" y="50">-1000</text>
                                        <text x="85" y="0" class="txtvspdval txtend">%d m/s</text>
                                    <g class="linethick">
                                        <path d="m-41 75 2.5-4.4m17 12 1.2-4.9m20 7.5v-10m-75-34 4.4-2.5m-12-17 4.9-1.2m17 40 7-7m-32-53h10m34-75 2.5 4.4m17-12 1.2 4.9m20-7.5v10m-75 34 4.4 2.5m-12 17 4.9 1.2m17-40 7 7m-32 53h10m116 75-2.5-4.4m-17 12-1.2-4.9m40-17-7-7m-12-128-2.5 4.4m-17-12-1.2 4.9m40 17-7 7"/>
                                        <circle r="90" />
                                    </g>
                                    <path transform="rotate(%d)" d="m-0.094-7c-22 2.2-45 4.8-67 7 23 1.7 45 5.6 67 7 4.4-0.068 7.8-4.9 6.3-9.1-0.86-2.9-3.7-5-6.8-4.9z" />
                                </g>
                            ]],vSpdMeterX,vSpdMeterY,d(bE),d(fZ))end;return fx end;local function f_(g0)local g1=-bD;g0=g0-g0:project_on(g1)local g2=vec3(0,0,1)g2=g2-g2:project_on(g1)local g3=g2:cross(g1)local fZ=g2:angle_between(g0)*constants.rad2deg;if g0:dot(g3)<0 then fZ=360-fZ end;return fZ end;local function g4(fx,centerX,centerY,g5,g6,bW)local g7=circleRad;local g8=20;local g9=d(g5)if bW then for i=-45,45,5 do local ga=i;fx[#fx+1]=e([[<g transform="rotate(%f,%d,%d)">]],ga,centerX,centerY)len=5;if i%15==0 then len=15 elseif i%10==0 then len=10 end;fx[#fx+1]=e([[<line x1=%d y1=%d x2=%d y2="%d"/></g>]],centerX,centerY+g7+g8-len,centerX,centerY+g7+g8)end;fx[#fx+1]=cb(centerX,centerY+g7+g8-35,g6,"pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY+g7+g8-25,g9 .." deg","pdim txt txtmid")fx[#fx+1]=e([[<g transform="rotate(%f,%d,%d)">]],-g5,centerX,centerY)fx[#fx+1]=e([[<<polygon points="%d,%d %d,%d %d,%d"/>]],centerX-5,centerY+g7+g8-20,centerX+5,centerY+g7+g8-20,centerX,centerY+g7+g8-15)fx[#fx+1]="</g>"end;local gb=g9;if bW then gb=f_(bz)end;local gc=20;local gd=d(gb)local ge=0;local gf=centerY+g7+g8+20;local gg=centerX;if g6~="YAW"then gf=fs(130)gg=fr(960)end;local gh=[[<path class="txttick line" d="]]local gi=d(gd-(gc+10)-gd%5+0.5)for i=gi+60,gi,-5 do local x=gg-(-i*5+gb*5)if i%10==0 then ge=10;local C=i;if C==360 then C=0 elseif C>360 then C=C-360 elseif C<0 then C=C+360 end;fx[#fx+1]=cb(x+5,gf-12,C)elseif i%5==0 then ge=5 end;if ge==10 then gh=e([[%s M %f %f v %d]],gh,x,gf-5,ge)else gh=e([[%s M %f %f v %d]],gh,x,gf-2.5,ge)end end;fx[#fx+1]=gh..[["/>]]fx[#fx+1]=e([[<<polygon points="%d,%d %d,%d %d,%d"/>]],gg-5,gf+10,gg+5,gf+10,gg,gf+5)if bW then g6="HDG"end;fx[#fx+1]=cb(gg,gf+25,gd.."deg","pdim txt txtmid","")fx[#fx+1]=cb(gg,gf+35,g6,"pdim txt txtmid","")end;local function gj(fx,gk,g5,centerX,centerY,bW,gl,eT)local g7=circleRad;local gm=d(g7*3/5)if g7>0 then local gn=d(gk)local len=0;local gh=e([[<path transform="rotate(%f,%d,%d)" class="dim line" d="]],-1*g5,centerX,centerY)if not as then gh=e([[<path transform="rotate(0,%d,%d)" class="dim line" d="]],centerX,centerY)end;fx[#fx+1]=e([[<clipPath id="cut"><circle r="%f" cx="%d" cy="%d"/></clipPath>]],g7-1,centerX,centerY)fx[#fx+1]=[[<g class="dim txttick" clip-path="url(#cut)">]]for i=d(gn-30-gn%5+0.5),d(gn+30+gn%5+0.5),5 do if i%10==0 then len=30 elseif i%5==0 then len=20 end;local y=centerY+-i*5+gk*5;if len==30 then gh=e([[%s M %d %f h %d]],gh,centerX-gm-len,y,len)if as then fx[#fx+1]=e([[<g path transform="rotate(%f,%d,%d)" class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],-1*g5,centerX,centerY,centerX-gm+10,y,i)fx[#fx+1]=e([[<g path transform="rotate(%f,%d,%d)" class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],-1*g5,centerX,centerY,centerX+gm-10,y,i)if i==0 or i==180 or i==-180 then fx[#fx+1]=e([[<path transform="rotate(%f,%d,%d)" d="m %d,%f %d,0" stroke-width="1" style="fill:none;stroke:#F5B800;" />]],-1*g5,centerX,centerY,centerX-gm+20,y,gm*2-40)end else fx[#fx+1]=cb(centerX-gm+10,y,i,"pdim txt txtmid")fx[#fx+1]=cb(centerX+gm-10,y,i,"pdim txt txtmid")end;gh=e([[%s M %d %f h %d]],gh,centerX+gm,y,len)else gh=e([[%s M %d %f h %d]],gh,centerX-gm-len,y,len)gh=e([[%s M %d %f h %d]],gh,centerX+gm,y,len)end end;fx[#fx+1]=gh..[["/>]]local go="PITCH"if not bW then go="REL PITCH"end;if gk>90 and not as then gk=90-(gk-90)elseif gk<-90 and not as then gk=-90-(gk+90)end;if g7>200 then if as then if eT>R then fx[#fx+1]=cb(centerX,centerY-15,"Yaw","pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY+20,gl,"pdim txt txtmid")end;fx[#fx+1]=e([[<g transform="rotate(%f,%d,%d)">]],-g5,centerX,centerY)else fx[#fx+1]=e([[<g transform="rotate(0,%d,%d)">]],centerX,centerY)end;fx[#fx+1]=e([[<<polygon points="%d,%d %d,%d %d,%d"/> class="pdim txtend"><text x="%d" y="%f">%d</text>]],centerX-gm+25,centerY-5,centerX-gm+20,centerY,centerX-gm+25,centerY+5,centerX-gm+50,centerY+4,gn)fx[#fx+1]=e([[<<polygon points="%d,%d %d,%d %d,%d"/> class="pdim txtend"><text x="%d" y="%f">%d</text>]],centerX+gm-25,centerY-5,centerX+gm-20,centerY,centerX+gm-25,centerY+5,centerX+gm-30,centerY+4,gn)fx[#fx+1]="</g>"end;local gp=d(g7/3)fx[#fx+1]=e([[<path d="m %d,%d %d,0" stroke-width="2" style="fill:none;stroke:#F5B800;" />]],centerX-gp,centerY,g7-gp)if not as and bW then fx[#fx+1]=e([[<path transform="rotate(%f,%d,%d)" d="m %d,%f %d,0" stroke-width="1" style="fill:none;stroke:#F5B800;" />]],-1*g5,centerX,centerY,centerX-gm+10,centerY,gm*2-20)end;fx[#fx+1]="</g>"if g7<200 then if as and eT>R then fx[#fx+1]=cb(centerX,centerY-g7,go,"pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY-g7+10,gn,"pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY-15,"Yaw","pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY+20,gl,"pdim txt txtmid")else fx[#fx+1]=cb(centerX,centerY-g7,go,"pdim txt txtmid")fx[#fx+1]=cb(centerX,centerY-g7+15,gn,"pdim txt txtmid")end end end end;local function gq(fx,dB,bW)local gr=altMeterX;local gs=altMeterY;local gt=78;local gu=19;local gv=aq;if aq~=-1 then fx[#fx+1]=cb(gr+gt,gs+gu+20,e("AGL: %.1fm",aq),"pdim altsm txtend")end;if bW and(dB<200000 and not as or dB and as)then table.insert(fx,e([[
                                <g class="pdim">                        
                                    <rect class="line" x="%d" y="%d" width="%d" height="%d"/> 
                                    <clipPath id="alt"><rect class="line" x="%d" y="%d" width="%d" height="%d"/></clipPath>
                                    <g clip-path="url(#alt)">]],gr-1,gs-4,gt+2,gu+6,gr+1,gs-1,gt-4,gu))local cy=0;local gw=1;local gx=0;local gy=dB<0;local gz=dB<planet.surfaceMaxAltitude;local gA=9;if gy then gA=0 end;local dB=c(dB)while cy<6 do local gB=11;local gC=16;local gD=9;local gE=14;local cd="altsm"if cy>2 then gC=gC+3;gB=gB+2;gE=gE+2;gD=gD-6;cd="altbig"end;if gy then cd=cd.." red"elseif gz then cd=cd.." orange"end;local gF=dB/gw%10;local gG=d(gF)local gH=d((gG+1)%10)local gI=gx;if cy==0 then gI=gF-gG;if gy then gI=1-gI end end;if gy and(cy==0 or gx~=0)then local gJ=gH;gH=gG;gG=gJ end;local gK=gC*(gI-1)local gL=gK+gC;local x=gr+gD+(6-cy)*gB;local y=gs+gE;fx[#fx+1]=cb(x,y+gK,gH,cd)fx[#fx+1]=cb(x,y+gL,gG,cd)cy=cy+1;gw=gw*10;if gG==gA then gx=gI else gx=0 end end;table.insert(fx,[[</g></g>]])end end;local function gM(eW)eW=vec3(eW)local gN=-math.deg(m(eW.y,eW.z))+180;gN=gN-90;if gN<0 then gN=360+gN end;if gN>180 then gN=-180+gN-180 end;return-gN end;local function gO(eW)eW=vec3(eW)local gb=math.deg(m(eW.y,eW.x))-90;if gb<-180 then gb=360+gb end;return gb end;local function gP(fx,eW,eT,centerX,centerY)if eT>5 and not as or eT>R then local g7=circleRad;local gQ=20;local gR=20;local gS=vec3(eW)local gT=gM(gS)local gU=gO(gS)local gV=14;local gW=gV/2;local gX=-gU/gR*g7;local gY=gT/gQ*g7;local x=centerX+gX;local y=centerY+gY;local ak=z(gX^2+gY^2)local gZ=[[<circle
                            cx="]]..x..[["
                            cy="]]..y..[["
                            r="]]..gW/gV..[["
                            style="fill:#d7fe00;stroke:none;fill-opacity:1"/>
                        <circle
                            cx="]]..x..[["
                            cy="]]..y..[["
                            r="]]..gW..[["
                            style="stroke:#d7fe00;stroke-opacity:1;fill:none" />
                        <path
                            d="M ]]..x-gV..[[,]]..y..[[ h ]]..gW..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />
                        <path
                            d="M ]]..x+gW..[[,]]..y..[[ h ]]..gW..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />
                        <path
                            d="M ]]..x..[[,]]..y-gV..[[ v ]]..gW..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />]]if ak<g7 then fx[#fx+1]=gZ else local fZ=m(gY,gX)local g_=4;local h0=centerX+g7*math.cos(fZ)local h1=centerY+g7*math.sin(fZ)fx[#fx+1]=e('<g transform="rotate(%f %f %f)"><rect x="%f" y="%f" width="%f" height="%f" stroke="#d7fe00" fill="#d7fe00" /><path d="M %f %f l %f %f l %f %f z" fill="#d7fe00" stroke="#d7fe00"></g>',fZ*180/math.pi,h0,h1,h0-g_,h1-g_/2,g_*2,g_,h0+g_,h1-g_,g_,g_,-g_,g_)end;if not as then gT=gM(-gS)gU=gO(-gS)gX=-gU/gR*g7;gY=gT/gQ*g7;x=centerX+gX;y=centerY+gY;ak=z(gX^2+gY^2)if ak<g7 then local h2=[[<circle
                                    cx="]]..x..[["
                                    cy="]]..y..[["
                                    r="]]..gW..[["
                                    style="stroke:#d7fe00;stroke-opacity:1;fill:none" />
                                <path
                                    d="M ]]..x..[[,]]..y-gV..[[ v ]]..gW..[["
                                    style="stroke:#d7fe00;stroke-opacity:1" id="l"/>
                                <use
                                    xlink:href="#l"
                                    transform="rotate(120,]]..x..[[,]]..y..[[)" />
                                <use
                                    xlink:href="#l"
                                    transform="rotate(-120,]]..x..[[,]]..y..[[)" />
                                <path
                                    d="M ]]..x-gW..[[,]]..y..[[ h ]]..gV..[["
                                    style="stroke-width:0.5;stroke:#d7fe00;stroke-opacity:1"
                                    transform="rotate(-45,]]..x..[[,]]..y..[[)" id="c"/>
                                <use
                                    xlink:href="#c"
                                    transform="rotate(-90,]]..x..[[,]]..y..[[)"/>]]fx[#fx+1]=h2 end end end end;local function h3(fx,fv,h4,h5)h4=d(h4+0.5)local fL=throtPosY+10;local fM=throtPosY+20;if l()==1 and not RemoteHud then fL=55;fM=65 end;local h6="CRUISE"local unit="km/h"local cg=h5;if fv=="TRAVEL"or fv=="AUTOPILOT"then h6="THROT"unit="%"cg=h4;local h7="dim"if h4<0 then h7="red"end;fx[#fx+1]=e([[<g class="%s">
                                <path class="linethick" d="M %d %d L %d %d L %d %d L %d %d"/>
                                <g transform="translate(0 %.0f)">
                                    <polygon points="%d,%d %d,%d %d,%d"/>
                                </g>]],h7,throtPosX-7,throtPosY-50,throtPosX,throtPosY-50,throtPosX,throtPosY+50,throtPosX-7,throtPosY+50,1-c(h4),throtPosX-10,throtPosY+50,throtPosX-15,throtPosY+53,throtPosX-15,throtPosY+47)end;fx[#fx+1]=cb(throtPosX+10,fL,h6,"pbright txtstart")fx[#fx+1]=cb(throtPosX+10,fM,e("%.0f %s",cg,unit),"pbright txtstart")if as and AtmoSpeedAssist and bK and N then h4=d(O*100+0.5)local h7="red"if h4<0 then h7="red"end;fx[#fx+1]=e([[<g class="%s">
                                <g transform="translate(0 %d)">
                                    <polygon points="%d,%d %d,%d %d,%d"/>
                                </g></g>]],h7,1-c(h4),throtPosX-10,throtPosY+50,throtPosX-15,throtPosY+53,throtPosX-15,throtPosY+47)fx[#fx+1]=cb(throtPosX+10,fL+40,"LIMIT","pbright txtstart")fx[#fx+1]=cb(throtPosX+10,fM+40,h4 .."%","pbright txtstart")end;if as and AtmoSpeedAssist or Reentry then fx[#fx+1]=cb(throtPosX+10,fL-40,"LIMIT: "..bi.." km/h","dim txtstart")elseif not as and Autopilot then fx[#fx+1]=cb(throtPosX+10,fL-40,"LIMIT: "..d(MaxGameVelocity*3.6+0.5).." km/h","dim txtstart")end end;local function h8(fx,h9)local ha=throtPosY-10;local hb=throtPosX+10;fx[#fx+1]=cb(0,0,"","pdim txt txtend")if l()==1 and not RemoteHud then ha=75 end;fx[#fx+1]=cb(hb,ha,d(h9).." km/h","pbright txtbig txtstart")end;local function hc(fx)fx[#fx+1]=cb(fr(1900),fs(1070),e("ARCH Hud Version: %.3f",VERSION_NUMBER),"hudver")fx[#fx+1]=[[<g class="warnings">]]if unit.isMouseControlActivated()==1 then fx[#fx+1]=cb(fr(960),fs(550),"Warning: Invalid Control Scheme Detected","warnings")fx[#fx+1]=cb(fr(960),fs(600),"Keyboard Scheme must be selected","warnings")fx[#fx+1]=cb(fr(960),fs(650),"Set your preferred scheme in Lua Parameters instead","warnings")end;local hd=fr(960)local he=fs(860)local hf=fs(880)local hg=fs(900)local hh=fs(960)local hi=fs(200)local hj=fs(250)local hk=fs(960)if l()==1 and not RemoteHud then he=fs(135)hf=fs(155)hg=fs(175)hi=fs(115)hj=fs(95)end;if BrakeIsOn then fx[#fx+1]=cb(hd,he,"Brake Engaged","warnings")elseif M>0 then fx[#fx+1]=cb(hd,he,"Auto-Brake Engaged","warnings","opacity:"..M)end;if as and bd and aq==-1 then if not Autopilot and not VectorToTarget and not BrakeLanding and not bI and not VertTakeOff and not AutoTakeoff then fx[#fx+1]=cb(hd,hi+50,"** STALL WARNING **","warnings")bZ("stall","SW",2)end end;if bU then fx[#fx+1]=cb(hd,hi+90,"Flight Assist in Progress","warnings")end;if az then fx[#fx+1]=cb(hd,hk,"Gyro Enabled","warnings")end;if GearExtended then if T then fx[#fx+1]=cb(hd,hf,"Gear Extended","warn")else fx[#fx+1]=cb(hd,hf,"Landed (G: Takeoff)","warnings")end;local hl=cm(a:getTargetGroundAltitude())fx[#fx+1]=cb(hd,hg,"Hover Height: "..hl,"warn")end;if a8 then fx[#fx+1]=cb(hd,hh+20,"ROCKET BOOST ENABLED","warn")end;if antigrav and not ExternalAGG and bI and AntigravTargetAltitude~=nil then if c(au-antigrav.getBaseAltitude())<501 then fx[#fx+1]=cb(hd,hi+15,e("AGG On - Target Altitude: %d Singularity Altitude: %d",d(AntigravTargetAltitude),d(antigrav.getBaseAltitude())),"warn")else fx[#fx+1]=cb(hd,hi+15,e("AGG On - Target Altitude: %d Singluarity Altitude: %d",d(AntigravTargetAltitude),d(antigrav.getBaseAltitude())),"warnings")end elseif Autopilot and AutopilotTargetName~="None"then fx[#fx+1]=cb(hd,hi+20,"Autopilot "..AutopilotStatus,"warn")elseif LockPitch~=nil then fx[#fx+1]=cb(hd,hi+20,e("LockedPitch: %d",d(LockPitch)),"warn")elseif a1 then fx[#fx+1]=cb(hd,hi+20,"Follow Mode Engaged","warn")elseif Reentry then fx[#fx+1]=cb(hd,hi+20,"Re-entry in Progress","warn")end;if AltitudeHold or VertTakeOff then local hl=cm(HoldAltitude,2)if VertTakeOff then if bI then hl=cm(antigrav.getBaseAltitude(),2).." AGG singularity height"end;fx[#fx+1]=cb(hd,hi,"VTO to "..hl,"warn")elseif AutoTakeoff and not IntoOrbit then if ao then fx[#fx+1]=cb(hd,hi,"Takeoff to "..AutopilotTargetName,"warn")else fx[#fx+1]=cb(hd,hi,"Takeoff to "..hl,"warn")end;if BrakeIsOn and not VertTakeOff then fx[#fx+1]=cb(hd,hi+50,"Throttle Up and Disengage Brake For Takeoff","crit")end else fx[#fx+1]=cb(hd,hi,"Altitude Hold: "..hl,"warn")end end;if VertTakeOff and(antigrav~=nil and antigrav)then if at>0.1 then fx[#fx+1]=cb(hd,hi+20,"Beginning ascent","warn")elseif at<0.09 and at>0.05 then fx[#fx+1]=cb(hd,hi+20,"Aligning trajectory","warn")elseif at<0.05 then fx[#fx+1]=cb(hd,hi+20,"Leaving atmosphere","warn")end end;if IntoOrbit then if bk~=nil then fx[#fx+1]=cb(hd,hi,bk,"warn")end end;if IntruderAlertSystem and safeMass==-1 then fx[#fx+1]=cb(hd,hi+70,"POSSIBLE INTRUDER ALERT - MASS GAIN OF "..bG.."kg DETECTED","warnings")bZ("alarm","AL",2)end;if BrakeLanding then if StrongBrakes then fx[#fx+1]=cb(hd,hi,"Brake-Landing","warnings")else fx[#fx+1]=cb(hd,hi,"Coast-Landing","warnings")end end;if ProgradeIsOn then fx[#fx+1]=cb(hd,hi,"Prograde Alignment","crit")end;if RetrogradeIsOn then fx[#fx+1]=cb(hd,hi,"Retrograde Alignment","crit")end;if bX then local type;if string.find(bX,"COLLISION")then type="warnings"else type="crit"end;fx[#fx+1]=cb(hd,hj+20,bX,type)elseif at==0 then local hm,ec,ed=b2:getPlanetarySystem(0):castIntersections(bF,bB:normalize(),function(dY)if dY.noAtmosphericDensityAltitude>0 then return dY.radius+dY.noAtmosphericDensityAltitude else return dY.radius+dY.surfaceMaxAltitude*1.5 end end)local hn=ec;if ed~=nil and ec~=nil then hn=math.min(ed,ec)end;if hn~=nil then local hl=cm(hn)local travelTime=b3.computeTravelTime(bC,0,hn)local ho="Collision"if hm.noAtmosphericDensityAltitude>0 then ho="Atmosphere"end;fx[#fx+1]=cb(hd,hj+20,hm.name.." "..ho.." "..cR(travelTime).." In "..hl,"crit")end end;if VectorToTarget and not IntoOrbit then fx[#fx+1]=cb(hd,hi+35,VectorStatus,"warn")end;fx[#fx+1]="</g>"return fx end;local function hp(eT)return d(B(eT*3.6,0)+0.5).." km/h"end;local function hq(fx)local hr=OrbitMapX;local hs=OrbitMapY;local ht=OrbitMapSize;local hu=4;local hv=15;local x=0;local y=0;local hw,hx,hy,hz;local function hA(type)local hB,E,eT,hC;if type=="Periapsis"then hB=orbit.periapsis.altitude;E=orbit.timeToPeriapsis;eT=orbit.periapsis.speed;hC=35 else hB=orbit.apoapsis.altitude;E=orbit.timeToApoapsis;eT=orbit.apoapsis.speed;hC=-35 end;fx[#fx+1]=e([[<line class="pdim op30 linethick" x1="%f" y1="%f" x2="%f" y2="%f"/>]],x+hC,y-5,hr+ht/2-hw+hz,y-5)fx[#fx+1]=cb(x,y,type)y=y+hv;local hl=cm(hB)fx[#fx+1]=cb(x,y,hl)y=y+hv;fx[#fx+1]=cb(x,y,cR(E))y=y+hv;fx[#fx+1]=cb(x,y,hp(eT))end;if orbit~=nil and at<0.2 and planet~=nil and orbit.apoapsis~=nil and orbit.periapsis~=nil and orbit.period~=nil and orbit.apoapsis.speed>5 and DisplayOrbit then hs=hs+hu;x=hr+ht+hr/2+hu;y=hs+ht/2+5+hu;hw=ht/4;hz=0;fx[#fx+1]=[[<g class="pbright txtorb txtmid">]]fx[#fx+1]=e('<rect width="%f" height="%d" rx="10" ry="10" x="%d" y="%d" style="fill:rgb(0,0,100);stroke-width:4;stroke:white;fill-opacity:0.3;" />',ht+hr*2,ht+hs,hu,hu)if orbit.periapsis~=nil and orbit.apoapsis~=nil then hy=(orbit.apoapsis.altitude+orbit.periapsis.altitude+planet.radius*2)/(hw*2)hx=(planet.radius+orbit.periapsis.altitude+(orbit.apoapsis.altitude-orbit.periapsis.altitude)/2)/hy*(1-orbit.eccentricity)hz=hw-orbit.periapsis.altitude/hy-planet.radius/hy;local hD=""if orbit.periapsis.altitude<=0 then hD='redout'end;fx[#fx+1]=e([[<ellipse class="%s line" cx="%f" cy="%f" rx="%f" ry="%f"/>]],hD,hr+ht/2+hz+hu,hs+ht/2+hu,hw,hx)fx[#fx+1]=e('<circle cx="%f" cy="%f" r="%f" stroke="white" stroke-width="3" fill="blue" />',hr+ht/2+hu,hs+ht/2+hu,planet.radius/hy)end;if orbit.apoapsis~=nil and orbit.apoapsis.speed<MaxGameVelocity and orbit.apoapsis.speed>1 then hA("Apoapsis")end;y=hs+ht/2+5+hu;x=hr-hr/2+10+hu;if orbit.periapsis~=nil and orbit.periapsis.speed<MaxGameVelocity and orbit.periapsis.speed>1 then hA("Periapsis")end;fx[#fx+1]=cb(hr+ht/2+hu,planet.name,20+hu,"txtorbbig")if orbit.period~=nil and orbit.periapsis~=nil and orbit.apoapsis~=nil and orbit.apoapsis.speed>1 then local hE=orbit.timeToApoapsis/orbit.period*2*math.pi;local hF=hw*math.cos(hE)local hG=hx*math.sin(hE)fx[#fx+1]=e('<circle cx="%f" cy="%f" r="5" stroke="white" stroke-width="3" fill="white" />',hr+ht/2+hF+hz+hu,hs+ht/2+hG+hu)end;fx[#fx+1]=[[</g>]]return fx else return fx end end;local hH;local function hI()if radarPanelID~=nil and am==0 then s(radarPanelID)radarPanelID=nil;if hH~=nil then s(hH)hH=nil end else if am==1 then s(radarPanelID)radarPanelID=nil;_autoconf.displayCategoryPanel(radar,radar_size,L_TEXT("ui_lua_widget_periscope", "Periscope"),"periscope")hH=_autoconf.panels[_autoconf.panels_size]end;placeRadar=true;if radarPanelID==nil and placeRadar then _autoconf.displayCategoryPanel(radar,radar_size,L_TEXT("ui_lua_widget_radar", "Radar"),"radar")radarPanelID=_autoconf.panels[_autoconf.panels_size]placeRadar=false end;am=0 end end;local function hJ(fx)local x=30;local y=275;local hK={"Alt-1: Increment Interplanetary Helper","Alt-2: Decrement Interplanetary Helper","Alt-3: Toggle Vanilla Widget view"}local hL={"","------------------IN ATMO-----------------","Alt-4: Autopilot in atmo to target","Alt-4-4: Autopilot to LowOrbitHeight over atmosphere and orbit to target","Alt-6: Altitude hold at current altitude","Alt-6-6: Altitude Hold at 11% atmosphere","Alt-Q/E: Hard Bankroll left/right till released","Alt-S: 180 deg bank turn"}local hM={"","------------------NO ATMO-----------------","Alt-4 (Alt < 100k): Autopilot to Orbit and land","Alt-4 (Alt > 100k): Autopilot to target","Alt-6: Orbit at current altitude","Alt-6-6: Orbit at LowOrbitHeight over atmosphere"}local hN={"","------------------ALWAYS--------------------","Alt-5: Lock Pitch at current pitch","Alt-7: Toggle Collision System on and offset","Alt-8: Toggle ground stabilization (underwater flight)","Alt-9: Activate Gyroscope","","CTRL: Toggle Brakes on and off, cancels active AP","LeftAlt: Tap to shift freelook on and off","Shift: Hold while not in freelook to see Buttons","Type /commands or /help in lua chat to see text commands"}if as then c1(hK,hL)table.insert(hK,"--------------CONDITIONAL-----------------")if VertTakeOff then table.insert(hK,"Hit Alt-6 before exiting Atmosphere during VTO to hold in level flight")end;if aq~=-1 then if antigrav then if bI then table.insert(hK,"Alt-6: AGG is on, will takeoff to AGG Height")else table.insert(hK,"Turn on AGG to takeoff to AGG Height")end end;if VertTakeOffEngine then table.insert(hK,"Alt-6: Begins Vertical Takeoff.")else table.insert(hK,"Alt-4/Alt-6: Autotakeoff if below hoverheight")end else table.insert(hK,"G: Begin BrakeLanding or Land")end else c1(hK,hM)end;if AltitudeHold then table.insert(hK,"Alt-Spacebar/Alt-C will raise/lower target height")end;c1(hK,hN)for i=1,#hK do y=y+12;fx[#fx+1]=cb(x,y,hK[i],"pdim txttick txtstart")end end;local function hO(hP,hQ)local hR;local hS=(hQ-hP):normalize()local eX=(bF-hP):dot(hS)/hS:dot(hS)if eX<=0.then return(bF-hP):len()elseif eX>=(hQ-hP):len()then return(bF-hQ):len()end;local hT=hP+eX*hS;hR=(hT-bF):len()return hR end;local function hU()local hR;local hV=nil;local hW=nil;local hX=nil;for c_,hY in pairs(aY[0])do if hY.hasAtmosphere then local ak=hO(planet.center,hY.center)if hV==nil or ak<hV then hW=hY;hV=ak;hX=planet end;if ad and ad.hasAtmosphere and ad.name~=planet.name then local ei=hO(ad.center,hY.center)if ei<hV then hW=hY;hV=ei;hX=ad end end end end;local hZ=fr(1770)local h_=fs(330)if hV then local i0="txttick "local i1=500000;if hV<hW.radius+i1 or hV<hX.radius+i1 then if bR then i0="txttick red "else i0="txttick orange "end end;hR=cm(hV,2)bT=cb(hZ,h_,"Pipe ("..hX.name.."--"..hW.name.."): "..hR,i0 .."pbright txtmid")end end;local i2=fr(1770)local i3=fs(350)local i4=fs(15)local i5=fr(1370)local i6,i7;local i8={}local i9={XS=13,S=27,M=55,L=110,XL=221}local ia={}local ib={}function ib.HUDPrologue(fx)bR,fi,_,_=fj(bF)if not bR then I=PvPR;K=PvPG;J=PvPB else I=SafeR;K=SafeG;J=SafeB end;aA=[[rgb(]]..d(I+0.5)..","..d(K+0.5)..","..d(J+0.5)..[[)]]aB=[[rgb(]]..d(I*0.9+0.5)..","..d(K*0.9+0.5)..","..d(J*0.9+0.5)..[[)]]local ic=aA;local id=aB;local ie=aA;local ig=aB;if ft()and not brightHud then ic=[[rgb(]]..d(I*0.4+0.5)..","..d(K*0.4+0.5)..","..d(J*0.3+0.5)..[[)]]id=[[rgb(]]..d(I*0.3+0.5)..","..d(K*0.3+0.5)..","..d(J*0.2+0.5)..[[)]]end;fx[#fx+1]=e([[
                        <head>
                            <style>
                                body {margin: 0}
                                svg {position:absolute;top:0;left:0;font-family:Montserrat;} 
                                .txt {font-size:10px;font-weight:bold;}
                                .txttick {font-size:12px;font-weight:bold;}
                                .txtbig {font-size:14px;font-weight:bold;}
                                .altsm {font-size:16px;font-weight:normal;}
                                .altbig {font-size:21px;font-weight:normal;}
                                .line {stroke-width:2px;fill:none}
                                .linethick {stroke-width:3px;fill:none}
                                .warnings {font-size:26px;fill:red;text-anchor:middle;font-family:Bank}
                                .warn {fill:orange;font-size:24px}
                                .crit {fill:darkred;font-size:28px}
                                .bright {fill:%s;stroke:%s}
                                .pbright {fill:%s;stroke:%s}
                                .dim {fill:%s;stroke:%s}
                                .pdim {fill:%s;stroke:%s}
                                .red {fill:red;stroke:red}
                                .orange {fill:orange;stroke:orange}
                                .redout {fill:none;stroke:red}
                                .op30 {opacity:0.3}
                                .op10 {opacity:0.1}
                                .txtstart {text-anchor:start}
                                .txtend {text-anchor:end}
                                .txtmid {text-anchor:middle}
                                .txtvspd {font-family:sans-serif;font-weight:normal}
                                .txtvspdval {font-size:20px}
                                .txtfuel {font-size:11px;font-weight:bold}
                                .txtorb {font-size:12px}
                                .txtorbbig {font-size:18px}
                                .hudver {font-size:10px;font-weight:bold;fill:red;text-anchor:end;font-family:Bank}
                                .msg {font-size:40px;fill:red;text-anchor:middle;font-weight:normal}
                                .cursor {stroke:white}
                            </style>
                        </head>
                        <body>
                            <svg height="100%%" width="100%%" viewBox="0 0 %d %d">
                            ]],ic,ic,ie,ie,id,id,ig,ig,aI,aJ)return fx end;function ib.DrawVerticalSpeed(fx,dB)fY(fx,dB)end;function ib.UpdateHud(fx)local dB=au;local eW=core.getVelocity()local eT=vec3(eW):len()local gN=bL;local ih=bM;local g5=ih;local gk=bL;local h4=d(unit.getThrottle())local h9=eT*3.6;local h5=unit.getAxisCommandValue(0)local ii=fr(1770)local ij=fs(310)if AtmoSpeedAssist and bK then h5=L;h4=L*100 end;local fv=fu()local g6="ROLL"if h4==nil then h4=0 end;if not bW then if eT>5 then gN=gM(eW)ih=gO(eW)else gN=0;ih=0 end;g6="YAW"end;if fi>50000 and not as then local ik;if fi>200000 then ik=B(fi/200000,2).." su"else ik=B(fi/1000,1).." km"end;fx[#fx+1]=cb(ii,ij,"PvP Boundary: "..ik,"pbright txtbig txtmid")end;fx[#fx+1]=al;fx[#fx+1]=aF;fx[#fx+1]=bS;if bT~=""then fx[#fx+1]=bT end;if aX%aR==0 then aW=true end;if fuelX~=0 and fuelY~=0 then fw(fx,aW,fuelX,"Atmospheric ","ATMO",aK,aU,aV)fw(fx,aW,fuelX+120,"Space fuel t","SPACE",aL,aS,aT)fw(fx,aW,fuelX+240,"Rocket fuel ","ROCKET",aM,aP,aQ)end;if aW then aW=false;aX=0 end;aX=aX+1;fY(fx,dB)if l()==0 or RemoteHud then if not ft()or brightHud then if bW then g4(fx,centerX,centerY,g5,g6,bW)gj(fx,gk,g5,centerX,centerY,bW,d(gO(eW)),eT)else g4(fx,centerX,centerY,ih,g6,bW)gj(fx,gN,ih,centerX,centerY,bW,d(ih),eT)end;gq(fx,dB,bW)gP(fx,eW,eT,centerX,centerY)end end;h3(fx,fv,h4,h5)h8(fx,h9)hc(fx)hq(fx)if showHelp then hJ(fx)end;return fx end;function ib.HUDEpilogue(fx)fx[#fx+1]="</svg>"return fx end;function ib.ExtraData(fx)local il=fr(1240)local im=fs(55)local io=im+10;local ip;local iq=0;local fv=fu()if VertTakeOffEngine then fv=fv.."-VERTICAL"end;if CollisionSystem and not AutoTakeoff and not BrakeLanding and bC>20 then fv=fv.."-COLLISION ON"end;if TurnBurn then fv="TB-"..fv end;if not stablized then fv=fv.."-DeCoupled"end;local ir=vec3(core.getWorldAcceleration()):len()/9.80665;ip=core.g()fx[#fx+1]=[[<g class="pdim txt txtend">]]if l()==1 and not RemoteHud then il=fr(1120)im=fs(55)io=im+10 elseif as then local is=fr(770)fx[#fx+1]=cb(is,im,"ATMOSPHERE","pdim txt txtend")fx[#fx+1]=cb(is,io,e("%.2f",at),"pdim txt txtend","")end;fx[#fx+1]=cb(il,im,"GRAVITY","pdim txt txtend")fx[#fx+1]=cb(il,io,e("%.2f",ip/9.80665),"pdim txt txtend")fx[#fx+1]=cb(il,im+20,"ACCEL","pdim txt txtend")fx[#fx+1]=cb(il,io+20,e("%.2f",ir),"pdim txt txtend")fx[#fx+1]=cb(fr(960),fs(180),fv,"txtbig txtmid")end;function ib.DrawOdometer(fx,ae,TotalDistanceTravelled,af)local ip;local it=0;local iu=0;local iq=0;if as then iq=LastMaxBrakeInAtmo else iq=LastMaxBrake end;maxThrust=a:maxForceForward()ip=core.g()if ip>0.1 then iu=ax*ip;it=maxThrust/ip end;fx[#fx+1]=e([[
                        <g class="pbright txt">
                        <path class="linethick" d="M %d 0 L %d %d Q %d %d %d %d L %d 0"/>]],fr(660),fr(700),fs(35),fr(960),fs(55),fr(1240),fs(35),fr(1280))if l()==0 or RemoteHud then fx[#fx+1]=cb(fr(700),fs(20),e("Trip: %.2f km",ae),"txtstart")fx[#fx+1]=cb(fr(700),fs(30),e("Lifetime: %.2f kSU",TotalDistanceTravelled/200000),"txtstart")fx[#fx+1]=cb(fr(830),fs(20),"Trip Time: "..cR(af),"txtstart")fx[#fx+1]=cb(fr(830),fs(30),"Total Time: "..cR(TotalFlightTime),"txtstart")fx[#fx+1]=cb(fr(970),fs(20),e("Mass: %.2f Tons",ax/1000),"txtstart")fx[#fx+1]=cb(fr(1240),fs(10),e("Max Brake: %.2f kN",iq/1000),"txtend")fx[#fx+1]=cb(fr(1240),fs(30),e("Max Thrust: %.2f kN",maxThrust/1000),"txtend")if ip>0.1 then fx[#fx+1]=cb(fr(970),fs(30),e("Max Mass: %.2f Tons",it/1000),"txtstart")fx[#fx+1]=cb(fr(1240),fs(20),e("Req Thrust: %.2f kN",iu/1000),"txtend")else fx[#fx+1]=cb(fr(970),fs(30),"Max Mass: n/a","txtstart")fx[#fx+1]=cb(fr(1240),fs(20),"Req Thrust: n/a","txtend")end end;fx[#fx+1]="</g>"return fx end;function ib.DrawWarnings(fx)return hc(fx)end;function ib.DisplayOrbitScreen(fx)return hq(fx)end;function ib.DisplayMessage(fx,hl)if hl~="empty"then local y=310;for iv in string.gmatch(hl,"([^\n]+)")do y=y+35;fx[#fx+1]=cb("50%",y,iv,"msg")end end;if aj~=0 then unit.setTimer("msgTick",aj)aj=0 end end;function ib.DrawDeadZone(fx)fx[#fx+1]=e([[<circle class="dim line" style="fill:none" cx="50%%" cy="50%%" r="%d"/>]],DeadZone)end;function ib.UpdatePipe()if as then bT=""return end;hU()end;function ib.UpdateRadarRoutine()local function iw(ix,iy,iz,iA,iB,iC,iD,iE)iy,iA,iC,iE=vec3(iy),vec3(iA),vec3(iC),vec3(iE)local iF,iG,iH=ix*ix,iz*iz,iB*iB;local eY=iA-iy;local iI=eY:normalize()local iJ=eY:len()local iK=iC-iy;local iL=(iK-iK:project_on(iI)):normalize()local iM,iN=iK:dot(iI),iK:dot(iL)local iO=iM*iM+iN*iN;local iP=iI:cross(iL)local x=(iF-iG+iJ*iJ)/(2*iJ)local y=(iF-iH+iO-2*iM*x)/(2*iN)local dc=iF-x^2-y^2;local iQ=z(dc)local iR=iy+iI*x+iL*y+iP*iQ;local iS=iy+iI*x+iL*y-iP*iQ;if c((iE-iR):len()-iD)<c((iE-iS):len()-iD)then return iR else return iS end end;local function iT()local function iU()local iV=core.getConstructWorldOrientationRight()local eY=core.getConstructWorldOrientationForward()local iK=core.getConstructWorldOrientationUp()local iW=library.systemResolution3(iV,eY,iK,{1,0,0})local iX=library.systemResolution3(iV,eY,iK,{0,1,0})local iY=library.systemResolution3(iV,eY,iK,{0,0,1})return function(iZ)return library.systemResolution3(iW,iX,iY,iZ)end end;local i_=iU()local j0=core.getConstructWorldPos()local cB=core.getElementPositionById(1)local j1={cB[1]-G,cB[2]-G,cB[3]-G}local j2=i_(j1)local j3={j0[1]-j2[1],j0[2]-j2[2],j0[3]-j2[3]}return j3 end;local function j4(j5,eZ,j6)local j7=j5.pts;local cy=#j7;local j8=j5.ref;if cy>3 then local j9,ja,jb,jc=j7[cy],j7[cy-1],j7[cy-2],j7[cy-3]j5.ref=j6;local cB=iw(j9[1],j9[2],ja[1],ja[2],jb[1],jb[2],jc[1],jc[2])local x,y,iQ=cB.x,cB.y,cB.z;if x==x and y==y and iQ==iQ then x=x+j8[1]y=y+j8[2]iQ=iQ+j8[3]local jd=vec3(x,y,iQ)if not j5.lastPos then j5.center=jd elseif(j5.lastPos-jd):len()<2 then j5.center=jd;j5.skipCalc=true end;j5.lastPos=jd end;j5.pts={}else local je={j6[1]-j8[1],j6[2]-j8[2],j6[3]-j8[3]}j7[cy+1]={eZ,je}end end;if radar_1 then local jf=#radar_1.getEntries()local jg=radar_1.getData()local jh=jg:gmatch('{"constructId[^}]*}[^}]*}')if jf>0 then local j6=iT()local ji,jj,jk=0,0,0;for d0 in jh do local dJ,ak,jl=d0:match([[{"constructId":"([%d%.]*)","distance":([%d%.]*).-"size":"(%a+)"]])local jm=i9[jl]ak=A(ak)if radar_1.hasMatchingTransponder(dJ)==1 then table.insert(i8,dJ)end;local jn=radar_1.getConstructType(dJ)if CollisionSystem then if jm>27 or jn=="static"or jn=="space"then jk=jk+1;local fN=radar_1.getConstructName(dJ)local j5=bV[dJ]if j5==nil then jm=jm+H;bV[dJ]={pts={},ref=j6,name=fN,i=0,radius=jm,skipCalc=false}j5=bV[dJ]end;if not j5.skipCalc then j4(j5,ak,j6)jj=jj+1 end;if j5.center then table.insert(ia,j5)end end;ji=ji+1;if bW and ji>700 or jj>70 or(not bW and ji>300 or jj>30)then coroutine.yield()ji,jj=0,0 end end end;local jo=#ia;if jo>0 and bC>20 then local dY,jp,jq,jr;local js=0;local jt=b2:getPlanetarySystem(0)jr=bB:normalize()while js<jo do coroutine.yield()local ju={table.unpack(ia,js,math.min(js+75,jo))}dY,jp,jq=jt:castIntersections(bF,jr,nil,nil,ju,true)if dY and jq then bY={dY,jp,jq}break end;js=js+75 end;if not dY then bY=nil end else bY=nil end;ia={}local jv=jg:find('identifiedConstructs":%[%]')if jv==nil and hH==nil then am=1;hI()end;if jv~=nil and hH~=nil then hI()end;if radarPanelID==nil then hI()end;if CollisionSystem then i6=jo.."/"..jk.." Plotted : "..jf-jk.." Ignored"else i6="Radar Contacts: "..jf end;bS=cb(i2,i3,i6,"pbright txtbig txtmid")if#i8>0 then bS=bS..cb(x,y,"Friendlies In Range","pbright txtbig txtmid")for c_,d0 in pairs(i8)do i4=i4+20;bS=bS..cb(i5,i4,radar_1.getConstructName(d0),"pdim txtmid")end;i8={}end else local jw;jw=jg:find('worksInEnvironment":false')if jw then bS=cb(i2,i3,"Radar: Jammed","pbright txtbig txtmid")else bS=cb(i2,i3,"Radar: No Contacts","pbright txtbig txtmid")end;if radarPanelID~=nil then am=0;hI()end end end end;function ib.UpdateRadar()local jx=coroutine.status(UpdateRadarCoroutine)if jx=="suspended"then local cg,jy=coroutine.resume(UpdateRadarCoroutine)if jy then system.print("ERROR UPDATE RADAR: "..jy)end elseif jx=="dead"then UpdateRadarCoroutine=coroutine.create(ib.UpdateRadarRoutine)local cg,jy=coroutine.resume(UpdateRadarCoroutine)end end;function ib.DrawSettings(fx)if#bO>0 then local x=fr(640)local y=fs(200)fx[#fx+1]=[[<g class="pbright txtvspd txtstart">]]for c_,d0 in pairs(bO)do fx[#fx+1]=cb(x,y,d0 ..": ".._G[d0])y=y+20;if c_%12==0 then x=x+fr(350)y=fs(200)end end;fx[#fx+1]=cb(fr(640),fs(200)+260,"To Change: In Lua Chat, enter /G VariableName Value")fx[#fx+1]="</g>"end;return fx end;UpdateRadarCoroutine=coroutine.create(ib.UpdateRadarRoutine)return ib end;local function jz()local function jA()local function jB(jC,jD)return jC.name<jD.name end;bQ={}for c_,d0 in pairs(aY[0])do bQ[#bQ+1]={name=d0.name,index=c_}end;table.sort(bQ,jB)end;local d1={}function d1.UpdateAtlasLocationsList()jA()end;function d1.UpdateAutopilotTarget()if AutopilotTargetIndex==0 then AutopilotTargetName="None"ad=nil;CustomTarget=nil;return true end;local jE=bQ[AutopilotTargetIndex].index;local jF=aY[0][jE]if jF.center then AutopilotTargetName=jF.name;ad=b2[0][jE]if CustomTarget~=nil then if at==0 then if t(widgetMaxBrakeTimeText,widgetMaxBrakeTime)~=1 then u(widgetMaxBrakeTimeText,widgetMaxBrakeTime)end;if t(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)~=1 then u(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)end;if t(widgetCurBrakeTimeText,widgetCurBrakeTime)~=1 then u(widgetCurBrakeTimeText,widgetCurBrakeTime)end;if t(widgetCurBrakeDistanceText,widgetCurBrakeDistance)~=1 then u(widgetCurBrakeDistanceText,widgetCurBrakeDistance)end;if t(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)~=1 then u(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end end;if t(widgetMaxMassText,widgetMaxMass)~=1 then u(widgetMaxMassText,widgetMaxMass)end;if t(widgetTravelTimeText,widgetTravelTime)~=1 then u(widgetTravelTimeText,widgetTravelTime)end;if t(widgetTargetOrbitText,widgetTargetOrbit)~=1 then u(widgetTargetOrbitText,widgetTargetOrbit)end end;CustomTarget=nil else CustomTarget=jF;for _,d0 in pairs(b2[0])do if d0.name==CustomTarget.planetname then ad=d0;AutopilotTargetName=CustomTarget.name;break end end;if t(widgetMaxMassText,widgetMaxMass)~=1 then u(widgetMaxMassText,widgetMaxMass)end;if t(widgetTravelTimeText,widgetTravelTime)~=1 then u(widgetTravelTimeText,widgetTravelTime)end end;if CustomTarget==nil then AutopilotTargetCoords=vec3(ad.center)else AutopilotTargetCoords=CustomTarget.position end;if ad.planetname~="Space"then if ad.hasAtmosphere then AutopilotTargetOrbit=d(ad.radius*(TargetOrbitRadius-1)+ad.noAtmosphericDensityAltitude)else AutopilotTargetOrbit=d(ad.radius*(TargetOrbitRadius-1)+ad.surfaceMaxAltitude)end else AutopilotTargetOrbit=1000 end;if CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotEndSpeed=0 else _,AutopilotEndSpeed=b5(ad):escapeAndOrbitalSpeed(AutopilotTargetOrbit)end;AutopilotPlanetGravity=0;AutopilotAccelerating=false;AutopilotBraking=false;AutopilotCruising=false;Autopilot=false;AutopilotRealigned=false;AutopilotStatus="Aligning"return true end;function d1.adjustAutopilotTargetIndex(g1)if not Autopilot and not VectorToTarget and not ao and not IntoOrbit then if g1==nil then AutopilotTargetIndex=AutopilotTargetIndex+1;if AutopilotTargetIndex>#bQ then AutopilotTargetIndex=0 end else AutopilotTargetIndex=AutopilotTargetIndex-1;if AutopilotTargetIndex<0 then AutopilotTargetIndex=#bQ end end;if AutopilotTargetIndex==0 then b7.UpdateAutopilotTarget()else local jE=bQ[AutopilotTargetIndex].index;local jF=aY[0][jE]if jF.name=="Space"or iphCondition=="Custom Only"and jF.center or iphCondition=="No Moons"and string.find(jF.name,"Moon")~=nil then if g1==nil then b7.adjustAutopilotTargetIndex()else b7.adjustAutopilotTargetIndex(1)end else b7.UpdateAutopilotTarget()end end else a3="Disengage autopilot before changing Interplanetary Helper"bZ("iph","AP")end end;function d1.findAtlasIndex(jG)for c_,d0 in pairs(jG)do if d0.name and d0.name==CustomTarget.name then return c_ end end;return-1 end;for c_,d0 in pairs(SavedLocations)do table.insert(aY[0],d0)end;jA()d1.UpdateAutopilotTarget()return d1 end;local function jH()local jI={}local function jJ(eT)local jK=AutopilotEndSpeed;if not Autopilot then jK=0 end;if not as then return b3.computeDistanceAndTime(eT,jK,ax,0,0,LastMaxBrake-AutopilotPlanetGravity*ax)else if LastMaxBrakeInAtmo and LastMaxBrakeInAtmo>0 then return b3.computeDistanceAndTime(eT,jK,ax,0,0,LastMaxBrakeInAtmo-AutopilotPlanetGravity*ax)else return 0,0 end end end;local function jL(eT)local jK=AutopilotEndSpeed;if not Autopilot then jK=0 end;return b3.computeDistanceAndTime(eT,jK,ax,a:maxForceForward(),warmup,LastMaxBrake-AutopilotPlanetGravity*ax)end;local jM=false;function jI.GetAutopilotBrakeDistanceAndTime(eT)return jJ(eT)end;function jI.GetAutopilotTBBrakeDistanceAndTime(eT)return jL(eT)end;local function jN(jO,jP,jQ)jP=jP:project_on_plane(jO)jQ=jQ:project_on_plane(jO)return m(jP:cross(jQ):dot(jO),jP:dot(jQ))end;local function jR()local function jS()local jT=-1;local jU=-1;if vBooster then jT=vBooster.distance()end;if hover then jU=hover.distance()end;if jT~=-1 and jU~=-1 then if jT<jU then return jT else return jU end elseif jT~=-1 then return jT elseif jU~=-1 then return jU else return-1 end end;local jV=jS()local jW=-1;if telemeter_1 then jW=telemeter_1.getDistance()end;if jV~=-1 and jW~=-1 then if jV<jW then return jV else return jW end elseif jV~=-1 then return jV else return jW end end;local function jX(planet,ee,jY)local function jZ(j_,dv)local ek=vec3(dv)if j_.bodyId==0 then return setmetatable({latitude=ek.x,longitude=ek.y,altitude=ek.z,bodyId=0,systemId=j_.planetarySystemId},MapPosition)end;local el=ek-j_.center;local ak=el:len()local dB=ak-j_.radius;local dz=0;local dA=0;if not cj(ak,0)then local em=m(el.y,el.x)dA=em>=0 and em or 2*math.pi+em;dz=math.pi/2-math.acos(el.z/ak)end;return setmetatable({latitude=math.deg(dz),longitude=math.deg(dA),altitude=dB,bodyId=j_.bodyId,systemId=j_.planetarySystemId},MapPosition)end;local k0=jZ(planet,ee)k0="::pos{"..k0.systemId..","..k0.bodyId..","..k0.latitude..","..k0.longitude..","..k0.altitude.."}"if jY then return k0 else system.setWaypoint(k0)return true end end;function jI.showWayPoint(planet,ee,jY)return jX(planet,ee,jY)end;function jI.APTick()local function k1()if bY and not BrakeLanding then local dY=bY[1]local jp,jq=bY[2],bY[3]local k2=math.min(jp,jq or jp)local k3=k2/bC;if(AltitudeHold or VectorToTarget or LockPitch or Autopilot)and not AutoTakeoff and(a9*1.5>k2 or k3<1)then BrakeIsOn=true;cf(0)if AltitudeHold then cr()end;if LockPitch then ToggleLockPitch()end;a3="Autopilot Cancelled due to possible collision"if VectorToTarget or Autopilot then cs()end;StrongBrakes=true;BrakeLanding=true;bb=true end;if k3<11 then bX=dY.name.." COLLISION "..cR(k3).." / "..cm(k2,2)else bX=dY.name.." collision "..cR(k3)end;if k3<6 then bZ("alarm","AL",2)end else bX=false end end;as=j()>0;at=j()au=core.getAltitude()aq=jR()E=p()be=E;bW=unit.getClosestPlanetInfluence()>0;if CollisionSystem then k1()end;if antigrav then bI=antigrav.getState()==1 end;local k4=1;local k5=1;local k6=E-be;local k7=-math.deg(jN(by,bB,bz))local k8=math.deg(jN(bA,bB,bz))local g1=bD*-1;bd=as and k7<-YawStallAngle or k7>YawStallAngle or k8<-PitchStallAngle or k8>PitchStallAngle;local k9=system.getMouseDeltaX()local ka=system.getMouseDeltaY()if InvertMouse and not a2 then ka=-ka end;W=0;a0=0;V=0;sys=b2[0]planet=sys:closestBody(core.getConstructWorldPos())kepPlanet=b5(planet)orbit=kepPlanet:orbitalParameters(core.getConstructWorldPos(),bB)if au==0 then au=(bF-planet.center):len()-planet.radius end;local ip=planet:getGravity(core.getConstructWorldPos()):len()*ax;bf=0;b4=core.getMaxKinematicsParametersAlongAxis("ground",core.getConstructOrientationUp())[1]if w()==0 then if l()==1 and a2 then if not b9 then ah=ah+k9;ai=ai+ka end else ah=0;ai=0 end else ah=ah+k9;ai=ai+ka;ak=z(ah*ah+ai*ai)if not a2 and l()==0 then if userControlScheme=="virtual joystick"then if ah>0 and ah>DeadZone then W=W-(ah-DeadZone)*MouseXSensitivity elseif ah<0 and ah<DeadZone*-1 then W=W-(ah+DeadZone)*MouseXSensitivity else W=0 end;if ai>0 and ai>DeadZone then V=V-(ai-DeadZone)*MouseYSensitivity elseif ai<0 and ai<DeadZone*-1 then V=V-(ai+DeadZone)*MouseYSensitivity else V=0 end else ah=0;ai=0;if userControlScheme=="mouse"then V=(-utils.smoothstep(ka,-100,100)+0.5)*2*k4;W=(-utils.smoothstep(k9,-100,100)+0.5)*2*k5 end end end end;local kb=bC>8334;if bC>SpaceSpeedLimit/3.6 and not as and not Autopilot and not kb then a3="Space Speed Engine Shutoff reached"cf(0)end;if not kb and LastIsWarping then if not BrakeIsOn then cC()end;if Autopilot then cs()end end;LastIsWarping=kb;if as and at>0.09 then if bC>bi/3.6 and not AtmoSpeedAssist and not jM then BrakeIsOn=true;jM=true elseif not AtmoSpeedAssist and jM then if bC<bi/3.6 then BrakeIsOn=false;jM=false end end end;if BrakeIsOn then Z=1 else Z=0 end;if ProgradeIsOn then if an then BrakeIsOn=false;local kc=false;if CustomTarget~=nil then kc=cD(CustomTarget.position-bF,0.1)else kc=cD(vec3(bB),0.01)end;bb=true;if kc then ci(d(bi))if(c(bM)<2 or c(bL)>85)and bC>=bi/3.6-1 then BrakeIsOn=false;ProgradeIsOn=false;S=true;an=false;ap=true;Autopilot=false;cP()end elseif as and AtmoSpeedAssist then cf(1)end elseif bC>R then cD(vec3(bB),0.01)end end;if RetrogradeIsOn then if as then RetrogradeIsOn=false elseif bC>R then cD(-vec3(bB))end end;if not ProgradeIsOn and an and not IntoOrbit then if at==0 then S=true;cP()an=false;ap=true else an=false;cs()end end;if ap and CustomTarget~=nil and(au<HoldAltitude+250 and au>HoldAltitude-250)and bC*3.6>bi-250 and c(bE)<25 and at>=0.1 and(CustomTarget.position-bF):len()>2000+au then cs()ap=false end;if VertTakeOff then bb=true;local kd=HoldAltitude;if bE<-30 then a3="Unable to achieve lift. Safety Landing."ag=0;bb=autoRollPreference;VertTakeOff=false;BrakeLanding=true elseif not ExternalAGG and bI or HoldAltitude<planet.spaceEngineMinAltitude then if bI then kd=antigrav.getBaseAltitude()end;if au<kd-100 then bj=0;ag=15;BrakeIsOn=false elseif bE>0 then BrakeIsOn=true;ag=0 elseif bE<-30 then BrakeIsOn=true;ag=15 elseif au>=kd then if bI then if Autopilot or VectorToTarget then cp()else BrakeIsOn=true;VertTakeOff=false end;a3="Takeoff complete. Singularity engaged"bZ("aggLk","AG")else BrakeIsOn=false;a3="VTO complete. Engaging Horizontal Flight"bZ("vtoc","VT")cp()end;ag=0 end else if at>0.08 then bj=0;BrakeIsOn=false;ag=20 elseif at<0.08 and at>0 then BrakeIsOn=false;if bv then bj=0;ag=20 else ag=0;bj=36;ci(3500)end else bb=autoRollPreference;IntoOrbit=true;bt=false;CancelIntoOrbit=false;bn=false;bl=nil;bm=nil;if bs==nil then bs=planet end;br=kd;bq=true;VertTakeOff=false end end;if bj~=nil then if vTpitchPID==nil then vTpitchPID=pid.new(2*0.01,0,2*0.1)end;local ke=q(bj-bL,-PitchStallAngle*0.80,PitchStallAngle*0.80)vTpitchPID:inject(ke)local kf=q(vTpitchPID:get(),-1,1)V=kf end end;if IntoOrbit then local cM;local kg=false;local kh=cm(br)if bs==nil then bs=planet;if VectorToTarget then bs=ad end end;if not bq then br=d(bs.radius+bs.surfaceMaxAltitude+LowOrbitHeight)if bs.hasAtmosphere then br=d(bs.radius+bs.noAtmosphericDensityAltitude+LowOrbitHeight)end;bq=true end;if bp.VectorToTarget then cM=CustomTarget.position-bF end;local ki,kj=b5(bs):escapeAndOrbitalSpeed((bF-bs.center):len()-bs.radius)local kk=bM;if not bn then local kl=false;local km=false;cf(0)bm=0;bk="Aligning to orbital path - OrbitHeight: "..kh;if bp.VectorToTarget then cD(cM:normalize():project_on_plane(bD))kg=bz:dot(cM:project_on_plane(by):normalize())>0.95 else cD(bB)kg=k7<0.5;if bC<150 then kg=true end end;V=0;bl=0;if bL<=bl+1 and bL>=bl-1 then kl=true else kl=false end;if kk<=bm+1 and kk>=bm-1 then km=true else km=false end;if kl and km and kg then bl=nil;bm=nil;bn=true end else if bp.VectorToTarget then cD(cM:normalize():project_on_plane(bD))elseif bC>150 then cD(bB)end;V=0;if bp.VectorToTarget then local a9,_=b3.computeDistanceAndTime(bC,bi/3.6,ax,0,0,LastMaxBrake)if bt and cM:len()>15000+a9+au then bk="Orbiting to Target"if au-100<=bs.noAtmosphericDensityAltitude or travelTime>orbit.timeToPeriapsis and orbit.periapsis.altitude<bs.noAtmosphericDensityAltitude then bt=false end elseif bt or cM:len()<15000+a9+au then a3="Orbit complete, proceeding with reentry"bZ("orCom","OB")AutopilotTargetCoords=CustomTarget.position;S=true;ap=true;bp.VectorToTarget,bp.AutopilotAlign=false,false;cq()cP()end end;if orbit.periapsis~=nil and orbit.apoapsis~=nil and orbit.eccentricity<1 and au>br*0.9 and au<br*1.4 then if orbit.apoapsis~=nil then if orbit.periapsis.altitude>=br*0.99 and orbit.apoapsis.altitude>=br*0.99 and orbit.periapsis.altitude<orbit.apoapsis.altitude and orbit.periapsis.altitude*1.05>=orbit.apoapsis.altitude or bt then if bt then BrakeIsOn=false;cf(0)bl=0;if not bp.VectorToTarget then a3="Orbit complete"bZ("orCom","OB")cq()end else bx=bx+1;if bx>=2 then bt=true end end else bk="Adjusting Orbit - OrbitHeight: "..kh;bo=true;ci(kj*3.6+1)if VSpdPID==nil then VSpdPID=pid.new(0.5,0,10*0.1)end;local kn=bE;local ko=au-br;local kp=c(ko)if bE<10 and c(bL)<10 and kp<100 then kn=bE*2 end;if kn<10 and c(bL)<10 and kp<100 then kn=kn*2 end;if kn<5 and c(bL)<5 and kp<100 then kn=kn*4 end;VSpdPID:inject(kn)bl=q(-VSpdPID:get(),-90,90)if OrbitAltPID==nil then OrbitAltPID=pid.new(0.15,0,5*0.1)end;OrbitAltPID:inject(ko)bl=q(bl-q(OrbitAltPID:get(),-15,15),-90,90)end end else local kq=2.75;local kr=c(o(ki*kq))local ks=kr%50;if ks>0 then kr=kr-ks+50 end;BrakeIsOn=false;if au<br*0.8 then bk="Escaping planet gravity - OrbitHeight: "..kh;bl=utils.map(bE,200,0,-15,80)elseif au>=br*0.8 and au<br*1.15 then bk="Approaching orbital corridor - OrbitHeight: "..kh;kr=kr*0.75;bl=utils.map(bE,100,-100,-15,65)elseif au>=br*1.15 and au<br*1.5 then bk="Approaching orbital corridor - OrbitHeight: "..kh;kr=kr*0.75;if bE<0 or bo then bl=utils.map(au,br*1.5,br*1.01,-30,0)else bl=utils.map(au,br*0.99,br*1.5,0,30)end elseif au>br*1.5 then bk="Reentering orbital corridor - OrbitHeight: "..kh;bl=-65;local kt=utils.map(bE,-150,-400,1,0.55)kr=kr*kt end;ci(d(kr))end end;if bl~=nil then if OrbitPitchPID==nil then OrbitPitchPID=pid.new(1*0.01,0,5*0.1)end;local ku=bl-bL;OrbitPitchPID:inject(ku)local kv=q(OrbitPitchPID:get(),-0.5,0.5)V=kv end end;if Autopilot and at==0 and not an then local function kw(i6,orbit)system.print(i6)BrakeIsOn=false;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"cf(0)Q=false;a3=i6;bZ("apCom","AP")if orbit or an then if orbit and AutopilotTargetOrbit~=nil and not an then if not au or au==0 then return end;br=au;bq=true end;cq()end end;local kx,ky=AutopilotTargetCoords,false;if CustomTarget~=nil and CustomTarget.planetname~="Space"then AutopilotRealigned=true;if not TargetSet then local kz=(CustomTarget.position-ad.center):normalize()local kA=kz:project_on_plane((ad.center-bF):normalize()):normalize()local kB=ad.center+kA*(ad.radius+AutopilotTargetOrbit)local kC=CustomTarget.position+(CustomTarget.position-ad.center):normalize()*(AutopilotTargetOrbit-ad:getAltitude(CustomTarget.position))if(bF-kB):len()<(bF-kC):len()then kx=kB else kx=kC;AutopilotEndSpeed=0 end;AutopilotTargetCoords=kx;b8.showWayPoint(ad,AutopilotTargetCoords)ky=true;TargetSet=true end;AutopilotPlanetGravity=0 elseif CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotPlanetGravity=0;ky=true;TargetSet=true;AutopilotRealigned=true;kx=CustomTarget.position+(bF-CustomTarget.position)*AutopilotTargetOrbit elseif CustomTarget==nil then AutopilotPlanetGravity=0;if not TargetSet then local kz=(bF+bB*100000-ad.center):normalize()local kA=kz:project_on_plane((ad.center-bF):normalize()):normalize()if kA:len()<1 then kz=(bF+bz*100000-ad.center):normalize()kA=kz:project_on_plane((ad.center-bF):normalize()):normalize()end;kx=ad.center+kA*(ad.radius+AutopilotTargetOrbit)AutopilotTargetCoords=kx;TargetSet=true;ky=true;AutopilotRealigned=true;b8.showWayPoint(ad,AutopilotTargetCoords)end end;AutopilotDistance=(vec3(kx)-bF):len()local hm,ec,ed=b2:getPlanetarySystem(0):castIntersections(bF,bB:normalize(),function(dY)if dY.noAtmosphericDensityAltitude>0 then return dY.radius+dY.noAtmosphericDensityAltitude else return dY.radius+dY.surfaceMaxAltitude*1.5 end end)local hn=ec;if ed~=nil and ec~=nil then hn=math.min(ed,ec)end;if hn~=nil and hn<AutopilotDistance and hm.name==ad.name then AutopilotDistance=hn end;local kc=true;local kD=(ad.center-(bF+vec3(bB):normalize()*AutopilotDistance)):len()-ad.radius;local hl=cm(kD)t(widgetTrajectoryAltitudeText,'{"label": "Projected Altitude", "value": "'..hl..'"}')local a9,aa;if not TurnBurn then a9,aa=jJ(bC)else a9,aa=jL(bC)end;if bC>300 and AutopilotAccelerating then local cM=vec3(kx)-bF;local kE=q(math.deg(jN(by,bB:normalize(),cM:normalize()))*bC/500,-90,90)local kF=q(math.deg(jN(bA,bB:normalize(),cM:normalize()))*bC/500,-90,90)if c(kE)<20 and c(kF)<20 then kE=kE*2;kF=kF*2 end;if c(kE)<2 and c(kF)<2 then kE=kE*2;kF=kF*2 end;local k7=-math.deg(jN(by,bz,bB:normalize()))local k8=-math.deg(jN(bA,bz,bB:normalize()))if apPitchPID==nil then apPitchPID=pid.new(2*0.01,0,2*0.1)end;apPitchPID:inject(kF-k8)local kG=q(apPitchPID:get(),-1,1)V=V+kG;if apYawPID==nil then apYawPID=pid.new(2*0.01,0,2*0.1)end;apYawPID:inject(kE-k7)local kH=q(apYawPID:get(),-1,1)W=W+kH;ky=true;if c(kE)>2 or c(kF)>2 then if AutopilotStatus~="Adjusting Trajectory"then AutopilotStatus="Adjusting Trajectory"bZ("apAdj","AP")end else if AutopilotStatus~="Accelerating"then AutopilotStatus="Accelerating"bZ("apAcc","AP")end end end;if kD<AutopilotTargetOrbit*1.5 then if CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotEndSpeed=0 elseif CustomTarget==nil then _,AutopilotEndSpeed=b5(ad):escapeAndOrbitalSpeed(kD)end end;if not AutopilotCruising and not AutopilotBraking and not ky then kc=cD((kx-bF):normalize())elseif TurnBurn and(AutopilotBraking or AutopilotCruising)then kc=cD(-vec3(bB):normalize())end;if AutopilotAccelerating then if not Q then BrakeIsOn=false;cf(AutopilotInterplanetaryThrottle)L=B(AutopilotInterplanetaryThrottle,2)Q=true end;local kI=unit.getThrottle()if AtmoSpeedAssist then kI=L end;if vec3(core.getVelocity()):len()>=MaxGameVelocity or kI==0 and Q then AutopilotAccelerating=false;if AutopilotStatus~="Cruising"then bZ("apCru","AP")AutopilotStatus="Cruising"end;AutopilotCruising=true;cf(0)end;if AutopilotDistance<=a9 then AutopilotAccelerating=false;if AutopilotStatus~="Braking"then bZ("apBrk","AP")AutopilotStatus="Braking"end;AutopilotBraking=true;cf(0)Q=false end elseif AutopilotBraking then if AutopilotStatus~="Orbiting to Target"then BrakeIsOn=true;Z=1 end;if TurnBurn then cf(1,true)end;local _,kj=b5(ad):escapeAndOrbitalSpeed((bF-planet.center):len()-planet.radius)local cM;if CustomTarget~=nil then cM=CustomTarget.position-bF end;if CustomTarget~=nil and CustomTarget.planetname=="Space"and bC<50 then kw("Autopilot complete, arrived at space location")BrakeIsOn=true;Z=1 elseif CustomTarget~=nil and CustomTarget.planetname~="Space"and bC<=kj and(orbit.apoapsis==nil or orbit.periapsis==nil or orbit.apoapsis.altitude<=0 or orbit.periapsis.altitude<=0)then kw("Autopilot complete, commencing reentry")AutopilotTargetCoords=CustomTarget.position;an=true;b8.showWayPoint(ad,AutopilotTargetCoords)elseif orbit.periapsis~=nil and orbit.periapsis.altitude>0 and orbit.eccentricity<1 or AutopilotStatus=="Circularizing"then if AutopilotStatus~="Circularizing"then bZ("apCir","AP")AutopilotStatus="Circularizing"end;if bC<=kj then if CustomTarget~=nil then if bB:normalize():dot(cM:normalize())>0.4 then if AutopilotStatus~="Orbiting to Target"then bZ("apOrb","OB")AutopilotStatus="Orbiting to Target"end;if not WaypointSet then BrakeIsOn=false;b8.showWayPoint(ad,CustomTarget.position)WaypointSet=true end else kw("Autopilot complete, proceeding with reentry")AutopilotTargetCoords=CustomTarget.position;an=true;b8.showWayPoint(ad,CustomTarget.position)WaypointSet=false end else kw("Autopilot completed, setting orbit",true)Z=0 end end elseif AutopilotStatus=="Circularizing"then kw("Autopilot complete, fixing Orbit",true)end elseif AutopilotCruising then if AutopilotDistance<=a9 then AutopilotAccelerating=false;if AutopilotStatus~="Braking"then bZ("apBrk","AP")AutopilotStatus="Braking"end;AutopilotBraking=true end;local kI=unit.getThrottle()if AtmoSpeedAssist then kI=L end;if kI>0 then AutopilotAccelerating=true;if AutopilotStatus~="Accelerating"then AutopilotStatus="Accelerating"bZ("apAcc","AP")end;AutopilotCruising=false end else if kc then if not AutopilotRealigned and CustomTarget==nil or not AutopilotRealigned and CustomTarget~=nil and CustomTarget.planetname~="Space"then if not an then AutopilotTargetCoords=vec3(ad.center)+(AutopilotTargetOrbit+ad.radius)*bA;AutopilotShipUp=by;AutopilotShipRight=bA end;AutopilotRealigned=true elseif kc then AutopilotAccelerating=true;if AutopilotStatus~="Accelerating"then AutopilotStatus="Accelerating"bZ("apAcc","AP")end;if not Q then cf(AutopilotInterplanetaryThrottle,true)L=B(AutopilotInterplanetaryThrottle,2)Q=true;BrakeIsOn=false end end end end elseif Autopilot and(CustomTarget~=nil and CustomTarget.planetname~="Space"and at>0)then a3="Autopilot complete, proceeding with reentry"bZ("apCom","AP")AutopilotTargetCoords=CustomTarget.position;BrakeIsOn=false;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"Z=0;cf(0)Q=false;ProgradeIsOn=true;an=true;b8.showWayPoint(ad,CustomTarget.position)end;if a1 then bb=true;local kF=0;local cB=bF+vec3(unit.getMasterPlayerRelativePosition())local kJ=cB-bF;local kK=vec3(kJ):project_on(bz):len()local kL=vec3(kJ):project_on(bA):len()local ak=z(kK*kK+kL*kL)cD(kJ:normalize())local kM=40;local kN=ak<kM;local kO=100;local kP=q((ak-kM)/2,10,kO)V=0;local kc=c(W)<0.1;if kc and bC<kP and not kN then BrakeIsOn=false;kF=-20 else BrakeIsOn=true;kF=0 end;local kQ=0;if c(kF-bL)>kQ then if pitchPID==nil then pitchPID=pid.new(2*0.01,0,2*0.1)end;pitchPID:inject(kF-bL)local kG=pitchPID:get()V=kG end end;if AltitudeHold or BrakeLanding or Reentry or VectorToTarget or LockPitch~=nil then local kR=LastMaxBrakeInAtmo;if kR then kR=kR*q(bC/100,0.1,1)*at else kR=LastMaxBrake end;if at<0.01 then kR=LastMaxBrake end;local kS=vec3(core.getWorldAirFrictionAcceleration())local kT=z(kS:len()-kS:project_on(g1):len())*ax;if bC>100 then a9,aa=b3.computeDistanceAndTime(bC,100,ax,0,0,kR+kT)local kU,kV=b3.computeDistanceAndTime(100,0,ax,0,0,kR/2)a9=a9+kU else a9,aa=b3.computeDistanceAndTime(bC,0,ax,0,0,kR/2)end;local kW=HoldAltitude-au;local kX=500+bC;local kY=1;if AutoTakeoff then kY=q(bC/100,0.1,1)end;local kF=(utils.smoothstep(kW,-kX,kX)-0.5)*2*MaxPitch*kY;if not Reentry and not an and not VectorToTarget and bz:dot(bB:normalize())<0.99 then kF=(utils.smoothstep(kW,-kX*q(20-19*at*10,1,20),kX*q(20-19*at*10,1,20))-0.5)*2*MaxPitch*q(2-at*10,1,2)*kY end;if not AltitudeHold then kF=0 end;if LockPitch~=nil then if bW and not IntoOrbit then kF=LockPitch else LockPitch=nil end end;bb=true;local kZ=V;if Reentry then local k_=d(bi)local l0,l1=b3.computeDistanceAndTime(bC,k_/3.6,ax,0,0,LastMaxBrake-planet.gravity*9.8*ax)local l2=au-(planet.noAtmosphericDensityAltitude+5000)if not bK and au>planet.noAtmosphericDensityAltitude+5000 and bC<=k_/3.6 and bC>k_/3.6-10 and c(bB:normalize():dot(bz))>0.9 then cf(0)elseif bK and bC>k_/3.6 and(l0>-1 and l2<=l0 or au<=planet.noAtmosphericDensityAltitude+5000)then BrakeIsOn=true else BrakeIsOn=false end;ci(k_,true)if not S then kF=-80;if at>0.02 then a3="PARACHUTE DEPLOYED"Reentry=false;BrakeLanding=true;kF=0;bb=autoRollPreference end elseif planet.noAtmosphericDensityAltitude>0 and au>planet.noAtmosphericDensityAltitude+5000 then bb=true elseif au<=planet.noAtmosphericDensityAltitude+5000 then ci(k_)if not bK and r:getTargetSpeed(axisCommandId.longitudinal)==bi then S=false;Reentry=false;bb=true end end end;if bC>R and not ao and not VectorToTarget and not BrakeLanding and ForceAlignment then cD(vec3(bB))end;if bU or(VectorToTarget or ao)and AutopilotTargetIndex>0 and at>0.01 then local cM;if bU then if type(bU)=="table"then cM=bU elseif bU<3 and bU>0 then cM=-bD:cross(bB)*5000 elseif bU>=3 then cM=bD:cross(bB)*5000 elseif bU<0 then cM=bB*25000 end elseif CustomTarget~=nil then cM=CustomTarget.position-bF else cM=ad.center-bF end;local kE=math.deg(jN(bD:normalize(),bB,cM))*2;local l3=math.rad(c(bM))if bC>minRollVelocity and at>0.01 then local l4=q(90-kF*2,-90,90)bf=q(kE*2,-l4,l4)local l5=kE;kE=q(q(kE,-YawStallAngle*0.80,YawStallAngle*0.80)*math.cos(l3)+4*(bL-kF)*math.sin(math.rad(bM)),-YawStallAngle*0.80,YawStallAngle*0.80)kF=q(q(kF*math.cos(l3),-PitchStallAngle*0.80,PitchStallAngle*0.80)+c(q(c(l5)*math.sin(l3),-PitchStallAngle*0.80,PitchStallAngle*0.80)),-PitchStallAngle*0.80,PitchStallAngle*0.80)else bf=0;kE=q(kE,-YawStallAngle*0.80,YawStallAngle*0.80)end;local l6=k7-kE;if bU and c(l6)<=0.0001 and(type(bU)=="table"or type(bU)~="table"and bU<0 and c(bM)<1)then if bU==-2 then cr()end;bU=nil;bZ("180Off","BR")return end;if not bd and bC>minRollVelocity and at>0.01 then if yawPID==nil then yawPID=pid.new(2*0.01,0,2*0.1)end;yawPID:inject(l6)local kH=q(yawPID:get(),-1,1)W=W+kH elseif as and aq>-1 or bC<minRollVelocity then cD(cM)elseif bd and at>0.01 then if(k7<-YawStallAngle or k7>YawStallAngle)and at>0.01 then cD(bB)end;if(k8<-PitchStallAngle or k8>PitchStallAngle)and at>0.01 then kF=q(bL-k8,bL-PitchStallAngle*0.80,bL+PitchStallAngle*0.80)end end;if CustomTarget~=nil and not ao then local kd=planet:getAltitude(CustomTarget.position)local l2=z(cM:len()^2-(au-kd)^2)local l7=bB:len()-c(bE)StrongBrakes=true;if not ao and not Reentry and l2<=a9+bC*k6/2 and(bB:project_on_plane(bD):normalize():dot(cM:project_on_plane(bD):normalize())>0.99 or VectorStatus=="Finalizing Approach")then VectorStatus="Finalizing Approach"cf(0)if AltitudeHold then cr()VectorToTarget=true end;BrakeIsOn=true elseif not AutoTakeoff then BrakeIsOn=false end;if VectorStatus=="Finalizing Approach"and(l7<0.1 or l2<0.1 or LastDistanceToTarget~=nil and LastDistanceToTarget<l2)then if not bI then bZ("bklOn","BL")BrakeLanding=true end;VectorToTarget=false;VectorStatus="Proceeding to Waypoint"bX=false end;LastDistanceToTarget=l2 end elseif VectorToTarget and at==0 and HoldAltitude>planet.noAtmosphericDensityAltitude and not(ao or Reentry)then if CustomTarget~=nil and ad.name==planet.name then local cM=CustomTarget.position-bF;local kd=planet:getAltitude(CustomTarget.position)local l2=z(cM:len()^2-(au-kd)^2)local kR=LastMaxBrakeInAtmo;if kR then a9,aa=b3.computeDistanceAndTime(bC,0,ax,0,0,kR/2)StrongBrakes=true;if l2<=a9+bC*k6/2 and bB:project_on_plane(bD):normalize():dot(cM:project_on_plane(bD):normalize())>0.99 then if planet.hasAtmosphere then BrakeIsOn=false;ProgradeIsOn=false;S=true;an=false;ap=true;Autopilot=false;cP()end end;LastDistanceToTarget=l2 end end end;if at==0 and(AltitudeHold and HoldAltitude>planet.noAtmosphericDensityAltitude)and not(ao or IntoOrbit or Reentry)then if not bt and not IntoOrbit then br=HoldAltitude;bq=true;if VectorToTarget then bp.VectorToTarget=true end;cq()VectorToTarget=false;bn=true end end;if bd and at>0.01 and aq==-1 and bC>minRollVelocity and VectorStatus~="Finalizing Approach"then cD(bB)kF=q(bL-k8,bL-PitchStallAngle*0.80,bL+PitchStallAngle*0.80)end;V=kZ;local jW=-1;if BrakeLanding then kF=0;local l8=false;local l9=30;if b4~=nil and b4>0 then local la=q(at,0.4,2)local kR=LastMaxBrakeInAtmo*q(bC/100,0.1,1)*la;local lb=b4*la+kR-ip;local lc=kR/2-ip;local ld=bC-z(c(lc/2)*20/(0.5*ax))*utils.sign(lc)if ld<0 then ld=0 end;local le;if bC>100 then local lf,_=b3.computeDistanceAndTime(bC,100,ax,0,0,kR)local lg,_=b3.computeDistanceAndTime(100,0,ax,0,0,z(kR))le=lf+lg else le=b3.computeDistanceAndTime(bC,0,ax,0,0,z(kR))end;if le<20 then BrakeIsOn=false else local lh=0;if ld>100 then local li,_=b3.computeDistanceAndTime(ld,100,ax,0,0,lb)local lj,_=b3.computeDistanceAndTime(100,0,ax,0,0,b4*la+z(kR)-ip)lh=li+lj else lh,_=b3.computeDistanceAndTime(ld,0,ax,0,0,b4*la+z(kR)-ip)end;lh=(lh+15+bC*k6)*1.1;local lk=CustomTarget~=nil and planet:getAltitude(CustomTarget.position)>0 and CustomTarget.safe;if lk then local kd=planet:getAltitude(CustomTarget.position)local ll=au-kd-100;local cM=CustomTarget.position-bF;local lm=z(cM:len()^2-(au-kd)^2)if lm>100 then lk=false elseif ll<=lh or lh==-1 then BrakeIsOn=true;l8=true else BrakeIsOn=false;l8=true end end;if not lk and CalculateBrakeLandingSpeed then if lh>=l9 then BrakeIsOn=true else BrakeIsOn=false end;l8=true end end end;if not bK then cf(0)end;r:setTargetGroundAltitude(500)r:activateGroundEngineAltitudeStabilization(500)stablized=true;jW=aq;if jW>-1 then bb=autoRollPreference;if bC<1 or bB:normalize():dot(bD)<0 then BrakeLanding=false;AltitudeHold=false;GearExtended=true;if T then a.control.extendLandingGears()bZ("grOut","LG",1)end;r:setTargetGroundAltitude(LandingGearGroundHeight)ag=0;BrakeIsOn=true else BrakeIsOn=true end elseif StrongBrakes and bB:normalize():dot(-g1)<0.999 then BrakeIsOn=true elseif bE<-brakeLandingRate and not l8 then BrakeIsOn=true elseif not l8 then BrakeIsOn=false end end;if AutoTakeoff or ao then local hm,ed,ec;if AutopilotTargetCoords~=nil then hm,ed,ec=b2:getPlanetarySystem(0):castIntersections(bF,(AutopilotTargetCoords-bF):normalize(),function(dY)return dY.radius+dY.noAtmosphericDensityAltitude end)end;if bI then if au>=HoldAltitude-50 then AutoTakeoff=false;if not Autopilot and not VectorToTarget then BrakeIsOn=true;cf(0)end else HoldAltitude=antigrav.getBaseAltitude()end elseif c(kF)<15 and au/HoldAltitude>0.75 then AutoTakeoff=false;if not ao then if bK and not AtmoSpeedAssist then a.control.cancelCurrentControlMasterMode()end elseif ao and bC<R then Autopilot=true;ao=false;AltitudeHold=false;AutoTakeoff=false;cf(0)elseif ao then cf(0)BrakeIsOn=true end elseif ao and at==0 and ad~=nil and(hm==nil or hm.name==ad.name)then Autopilot=true;ao=false;AltitudeHold=false;AutoTakeoff=false;if not bK then cf(0)end;AutopilotAccelerating=true end end;local ln=aq>-1;local lo=bL;if(VectorToTarget or ao or bU)and not ln and bC>minRollVelocity and at>0.01 then local l3=math.rad(c(bM))lo=bL*c(math.cos(l3))+k8*math.sin(l3)end;local lp=q(kF-lo,-PitchStallAngle*0.80,PitchStallAngle*0.80)if at<0.01 and VectorToTarget then lp=q(kF-lo,-85,MaxPitch)elseif at<0.01 then lp=q(kF-lo,-MaxPitch,MaxPitch)end;if c(bM)<5 or VectorToTarget or bU or BrakeLanding or ln or AltitudeHold then if pitchPID==nil then pitchPID=pid.new(5*0.01,0,5*0.1)end;pitchPID:inject(lp)local kG=pitchPID:get()V=V+kG end end;if antigrav~=nil and(antigrav and not ExternalAGG and au<200000)then if AntigravTargetAltitude==nil or AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if desiredBaseAltitude~=AntigravTargetAltitude then desiredBaseAltitude=AntigravTargetAltitude;antigrav.setBaseAltitude(desiredBaseAltitude)end end end;aq=jR()return jI end;function script.onStart()local lq={}local lr={}local ls=false;local function lt()local function lu(lv)local lw=dbHud_1.hasKey;for c_,d0 in pairs(lv)do if lw(d0)then local cJ=f(dbHud_1.getStringValue(d0))if cJ~=nil then _G[d0]=cJ;ls=true end end end end;if dbHud_1 then if not useTheseSettings then lu(c4())coroutine.yield()lu(b)else lu(b)a3="Updated user preferences used.  Will be saved when you exit seat.\nToggle off useTheseSettings to use saved values"aj=5;ls=false end;coroutine.yield()if ls then a3="Loaded Saved Variables"aI=ResolutionX;aJ=ResolutionY;BrakeToggleStatus=BrakeToggleDefault;userControlScheme=string.lower(userControlScheme)bb=autoRollPreference;bi=AtmoSpeedLimit;aA=[[rgb(]]..d(I+0.5)..","..d(K+0.5)..","..d(J+0.5)..[[)]]aB=[[rgb(]]..d(I*0.9+0.5)..","..d(K*0.9+0.5)..","..d(J*0.9+0.5)..[[)]]elseif not useTheseSettings then a3="No Saved Variables Found - Exit HUD to save settings"end else a3="No databank found. Attach one to control unit and rerun \nthe autoconfigure to save preferences and locations"end;if LastStartTime+180<E then LastMaxBrakeInAtmo=0 end;LastStartTime=E;userControlScheme=string.lower(userControlScheme)if string.find("keyboard virtual joystick mouse",userControlScheme)==nil then a3="Invalid User Control Scheme selected.\nChange userControlScheme in Lua Parameters to keyboard, mouse, or virtual joystick\nOr use shift and button in screen"aj=7 end;if antigrav and not ExternalAGG then if AntigravTargetAltitude==nil then AntigravTargetAltitude=au end;antigrav.setBaseAltitude(AntigravTargetAltitude)end;if safeMass==0 then safeMass=ax end;VectorStatus="Proceeding to Waypoint"end;local function lx()local function ly(lz,lA)if lz>lA then lA=lz end;local lB,lC=0,0;if ContainerOptimization>0 then lB=ContainerOptimization*0.05 end;if FuelTankOptimization>0 then lC=FuelTankOptimization*0.05 end;lA=lA*(1-(lB+lC))return lA end;local lD=core.getElementNameById;local lE=fuelX~=0 and fuelY~=0;for c_ in pairs(av)do local type=core.getElementTypeById(av[c_])if n(type,'^.*Atmospheric Engine$')then if n(tostring(core.getElementTagsById(av[c_])),'^.*vertical.*$')then bH=true end end;if n(type,'^.*Space Engine$')then bw=true;if n(tostring(core.getElementTagsById(av[c_])),'^.*vertical.*$')then local lF=core.getElementRotationById(av[c_])if lF[4]<0 then if o(-lF[4],0.1)==0.5 then bu=true end else if o(lF[4],0.1)==0.5 then bv=true end end end end;if type=="Landing Gear"then T=true end;if type=="Dynamic Core Unit"then local lG=h(av[c_])if lG>10000 then G=128;H=110 elseif lG>1000 then G=64;H=55 elseif lG>150 then G=32;H=27 end end;aN=aN+h(av[c_])if lE and(type=="Atmospheric Fuel Tank"or type=="Space Fuel Tank"or type=="Rocket Fuel Tank")then local lG=h(av[c_])local lH=k(av[c_])local lz=0;local fU=p()if type=="Atmospheric Fuel Tank"then local lA=400;local lI=35.03;if lG>10000 then lA=51200;lI=5480 elseif lG>1300 then lA=6400;lI=988.67 elseif lG>150 then lA=1600;lI=182.67 end;lz=lH-lI;if fuelTankHandlingAtmo>0 then lA=lA+lA*fuelTankHandlingAtmo*0.2 end;lA=ly(lz,lA)aK[#aK+1]={av[c_],lD(av[c_]),lA,lI,lz,fU}end;if type=="Rocket Fuel Tank"then local lA=320;local lI=173.42;if lG>65000 then lA=40000;lI=25740 elseif lG>6000 then lA=5120;lI=4720 elseif lG>700 then lA=640;lI=886.72 end;lz=lH-lI;if fuelTankHandlingRocket>0 then lA=lA+lA*fuelTankHandlingRocket*0.1 end;lA=ly(lz,lA)aM[#aM+1]={av[c_],lD(av[c_]),lA,lI,lz,fU}end;if type=="Space Fuel Tank"then local lA=2400;local lI=182.67;if lG>10000 then lA=76800;lI=5480 elseif lG>1300 then lA=9600;lI=988.67 end;lz=lH-lI;if fuelTankHandlingSpace>0 then lA=lA+lA*fuelTankHandlingSpace*0.2 end;lA=ly(lz,lA)aL[#aL+1]={av[c_],lD(av[c_]),lA,lI,lz,fU}end end end;if not bH then VertTakeOff,VertTakeOffEngine=false,false end end;local function lJ()if gyro~=nil then az=gyro.getState()==1 end;if not stablized then r:deactivateGroundEngineAltitudeStabilization()end;if userControlScheme~="keyboard"then v(1)else v(0)end;if door and(as or not as and au<10000)then for _,d0 in pairs(door)do d0.toggle()end end;if switch then for _,d0 in pairs(switch)do d0.toggle()end end;if forcefield and(as or not as==0 and au<10000)then for _,d0 in pairs(forcefield)do d0.toggle()end end;if antigrav then bI=antigrav.getState()==1;if bI and not ExternalAGG then antigrav.show()end end;if l()==1 and RemoteFreeze then system.freeze(1)else system.freeze(0)end;if T then GearExtended=a.control.isAnyLandingGearExtended()==1;if GearExtended then a.control.extendLandingGears()else a.control.retractLandingGears()end end;if aq~=-1 or not as and vec3(core.getVelocity()):len()<50 then BrakeIsOn=true;GearExtended=true;if T then a.control.extendLandingGears()end else BrakeIsOn=false end;r:setTargetGroundAltitude(bc)if as and aq~=-1 then b4=core.getMaxKinematicsParametersAlongAxis("ground",core.getConstructOrientationUp())[1]end;WasInAtmo=as end;local function lK(lL,lM,lN,lO,x,y,lP,lQ,lR,lS)local lT={enableName=lL,disableName=lM,width=lN,height=lO,x=x,y=y,toggleVar=lP,toggleFunction=lQ,drawCondition=lR,hovered=false}if lS then table.insert(lr,lT)else table.insert(lq,lT)end;return lT end;local function lU(lV)if not bN then showHandlingVariables=false;showHudVariables=false;showPhysicsVariables=false;showHud=true;return elseif lV=="handling"then showHandlingVariables=not showHandlingVariables;showHudVariables=false;showPhysicsVariables=false elseif lV=="hud"then showHudVariables=not showHudVariables;showHandlingVariables=false;showPhysicsVariables=false elseif lV=="physics"then showPhysicsVariables=not showPhysicsVariables;showHandlingVariables=false;showHudVariables=false end;if showPhysicsVariables or showHudVariables or showHandlingVariables then bO=c4(lV)showHud=false else bO={}showHud=true end end;local function lW()bN=not bN;if bN then aH=lr;a3="Hold SHIFT to see Settings"bP=showHud else aH=lq;a3="Hold SHIFT to see Control Buttons"lU()showHud=bP end end;local function lX(d0)_G[d0]=not _G[d0]if _G[d0]then a3=d0 .." set to true"else a3=d0 .." set to false"end;if d0=="showHud"then bP=_G[d0]elseif d0=="BrakeToggleDefault"then BrakeToggleStatus=BrakeToggleDefault elseif d0=="Cockpit"then system.showScreen(0)dbHud_1.setStringValue("content","")end end;local function lY()local lZ=50;local l_=340;local x=500;local y=aJ/2-400;local m0=0;for c_,d0 in pairs(c4("boolean"))do if type(_G[d0])=="boolean"then lK(d0,d0,l_,lZ,x,y,function()return _G[d0]end,function()lX(d0)end,function()return true end,true)y=y+lZ+20;if m0==9 then x=x+l_+20;y=aJ/2-400;m0=0 else m0=m0+1 end end end;lK("Control View","Control View",l_,lZ,10,aJ/2-500,function()return true end,lW,function()return true end,true)lK("View Handling Settings",'Hide Handling Settings',l_,lZ,10,aJ/2-(500-lZ),function()return showHandlingVariables end,function()lU("handling")end,function()return true end,true)lK("View Hud Settings",'Hide Hud Settings',l_,lZ,10,aJ/2-(500-lZ*2),function()return showHudVariables end,function()lU("hud")end,function()return true end,true)lK("View Physics Settings",'Hide Physics Settings',l_,lZ,10,aJ/2-(500-lZ*3),function()return showPhysicsVariables end,function()lU("physics")end,function()return true end,true)end;local function m1()local function m2()if dbHud_1 then local cv,position=cu()local fN=cv.name..". "..#SavedLocations;if radar_1 then local dJ,_=radar_1.getData():match('"constructId":"([0-9]*)","distance":([%d%.]*)')if dJ~=nil and dJ~=""then fN=fN.." "..radar_1.getConstructName(dJ)end end;local cz={}cz={position=position,name=fN,atmosphere=cv.atmosphericDensityAboveSurface,planetname=cv.name,gravity=cv.gravity,safe=true}SavedLocations[#SavedLocations+1]=cz;table.insert(aY[0],cz)b7.UpdateAtlasLocationsList()a3="Location saved as "..fN.."("..cv.name..")"else a3="Databank must be installed to save locations"end end;local function m3()TurnBurn=not TurnBurn end;local function m4(m5)if m5==1 then ProgradeIsOn=not ProgradeIsOn;RetrogradeIsOn=false else RetrogradeIsOn=not RetrogradeIsOn;ProgradeIsOn=false end;Autopilot=false;AltitudeHold=false;a1=false;BrakeLanding=false;LockPitch=nil;Reentry=false;AutoTakeoff=false end;local function m6()m4(1)end;local function m7()local cy=-1;cy=b7.findAtlasIndex(aY[0])if cy>-1 then table.remove(aY[0],cy)end;cy=-1;cy=b7.findAtlasIndex(SavedLocations)if cy~=-1 then a3=CustomTarget.name.." saved location cleared"table.remove(SavedLocations,cy)end;b7.adjustAutopilotTargetIndex()b7.UpdateAtlasLocationsList()end;local function m8()local fN=AutopilotTargetName;if fN==nil then local hl=cm((bF-CustomTarget.position):len())fN=CustomTarget.name.." "..hl end;if fN==nil then fN="None"end;return"Engage Autopilot: "..fN end;local function m9()local fN=AutopilotTargetName;if fN==nil then fN=CustomTarget.name end;if fN==nil then fN="None"end;return"Disable Autopilot: "..fN end;local function ma()if safeMass>0 then a3="Safe Mass set to "..B(ax,2).." kg"else a3="Intruder Detection reset\nSafe Mass set to "..B(ax,2).." kg"aj=5;bG=0 end;safeMass=ax end;local function mb()if l()==1 then a1=not a1;if a1 then Autopilot=false;RetrogradeIsOn=false;ProgradeIsOn=false;AltitudeHold=false;Reentry=false;BrakeLanding=false;AutoTakeoff=false;OldGearExtended=GearExtended;GearExtended=false;a.control.retractLandingGears()r:setTargetGroundAltitude(TargetHoverHeight)bZ("folOn","F")else bZ("folOff","F")BrakeIsOn=true;bb=autoRollPreference;GearExtended=OldGearExtended;if GearExtended then a.control.extendLandingGears()r:setTargetGroundAltitude(LandingGearGroundHeight)end end else a3="Follow Mode only works with Remote controller"a1=false end end;local lZ=50;local l_=260;local mc=lK("Enable Brake Toggle","Disable Brake Toggle",l_,lZ,aI/2-l_/2,aJ/2+350,function()return BrakeToggleStatus end,function()BrakeToggleStatus=not BrakeToggleStatus;if BrakeToggleStatus then a3="Brakes in Toggle Mode"else a3="Brakes in Default Mode"end end)lK("Align Prograde","Disable Prograde",l_,lZ,aI/2-l_/2-50-mc.width,aJ/2-lZ+380,function()return ProgradeIsOn end,m6)lK("Align Retrograde","Disable Retrograde",l_,lZ,aI/2-l_/2+mc.width+50,aJ/2-lZ+380,function()return RetrogradeIsOn end,m4,function()return at==0 end)local md=lK(m8,m9,600,60,aI/2-600/2,aJ/2-60/2-400,function()return Autopilot end,cs)lK("Save Position","Save Position",200,md.height,md.x+md.width+30,md.y,function()return false end,m2,function()return AutopilotTargetIndex==0 or CustomTarget==nil end)lK("Update Position","Update Position",200,md.height,md.x+md.width+30,md.y,function()return false end,cw,function()return AutopilotTargetIndex>0 and CustomTarget~=nil end)lK("Clear Position","Clear Position",200,md.height,md.x-200-30,md.y,function()return true end,m7,function()return AutopilotTargetIndex>0 and CustomTarget~=nil end)lZ=60;l_=300;local x=10;local y=aJ/2-500;lK("Show Help","Hide Help",l_,lZ,x,y,function()return showHelp end,function()showHelp=not showHelp end)y=y+lZ+20;lK("View Settings","View Settings",l_,lZ,x,y,function()return true end,lW)local y=aJ/2-300;lK("Enable Turn and Burn","Disable Turn and Burn",l_,lZ,x,y,function()return TurnBurn end,m3)lK("Horizontal Takeoff Mode","Vertical Takeoff Mode",l_,lZ,x+l_+20,y,function()return VertTakeOffEngine end,function()VertTakeOffEngine=not VertTakeOffEngine;if VertTakeOffEngine then a3="Vertical Takeoff Mode"else a3="Horizontal Takeoff Mode"end end,function()return bH end)y=y+lZ+20;lK("Show Orbit Display","Hide Orbit Display",l_,lZ,x,y,function()return DisplayOrbit end,function()DisplayOrbit=not DisplayOrbit;if DisplayOrbit then a3="Orbit Display Enabled"else a3="Orbit Display Disabled"end end)lK("Engage Orbiting","Cancel Orbiting",l_,lZ,x+l_+20,y,function()return IntoOrbit end,cq,function()return at==0 and bW end)y=y+lZ+20;lK("Glide Re-Entry","Cancel Glide Re-Entry",l_,lZ,x,y,function()return Reentry end,function()an=true;m6()end,function()return planet.hasAtmosphere and not as end)lK("Parachute Re-Entry","Cancel Parachute Re-Entry",l_,lZ,x+l_+20,y,function()return Reentry end,cP,function()return planet.hasAtmosphere and not as end)y=y+lZ+20;lK("Engage Follow Mode","Disable Follow Mode",l_,lZ,x,y,function()return a1 end,mb,function()return l()==1 end)lK("Enable Repair Arrows","Disable Repair Arrows",l_,lZ,x+l_+20,y,function()return aO end,function()aO=not aO;if aO then a3="Repair Arrows Enabled"else a3="Repair Arrows Diabled"end end,function()return l()==1 end)y=y+lZ+20;if not ExternalAGG then lK("Enable AGG","Disable AGG",l_,lZ,x,y,function()return bI end,cQ,function()return antigrav~=nil end)end;lK("Reset Intruder Alert","Set Safe Mass",l_,lZ,x+l_+20,y,function()return safeMass>0 end,ma,function()return IntruderAlertSystem end)y=y+lZ+20;lK(function()return e("Switch IPH Mode - Current: %s",iphCondition)end,function()return e("IPH Mode: %s",iphCondition)end,l_*2,lZ,x,y,function()return false end,function()if iphCondition=="All"then iphCondition="Custom Only"elseif iphCondition=="Custom Only"then iphCondition="No Moons"else iphCondition="All"end;a3="IPH Mode: "..iphCondition end)y=y+lZ+20;lK(function()return e("Toggle Control Scheme - Current: %s",userControlScheme)end,function()return e("Control Scheme: %s",userControlScheme)end,l_*2,lZ,x,y,function()return false end,function()if userControlScheme=="keyboard"then userControlScheme="mouse"elseif userControlScheme=="mouse"then userControlScheme="virtual joystick"else userControlScheme="keyboard"end;a3="New Control Scheme: "..userControlScheme end)end;SetupComplete=false;beginSetup=coroutine.create(function()r:setupCustomTargetSpeedRanges(axisCommandId.longitudinal,{1000,5000,10000,20000,30000})lt()coroutine.yield()lx()coroutine.yield()b8=jH()lJ()lY()m1()aH=lq;coroutine.yield()aY=d1()b1=d2()b2=b1(d1())b3=eq()b5=eV()b6=fh()b7=jz()b8=jH()coroutine.yield()unit.hide()system.showScreen(1)collectgarbage("collect")coroutine.yield()unit.setTimer("apTick",apTickRate)unit.setTimer("hudTick",hudTickRate)unit.setTimer("oneSecond",1)unit.setTimer("tenthSecond",1/10)unit.setTimer("fiveSecond",5)bZ("start","SU")end)coroutine.resume(beginSetup)end;function script.onStop()_autoconf.hideCategoryPanels()if antigrav~=nil and not ExternalAGG then antigrav.hide()end;if warpdrive~=nil then warpdrive.hide()end;core.hide()a.control.switchOffHeadlights()if door and(at>0 or at==0 and au<10000)then for _,d0 in pairs(door)do d0.toggle()end end;if switch then for _,d0 in pairs(switch)do d0.toggle()end end;if forcefield and(at>0 or at==0 and au<10000)then for _,d0 in pairs(forcefield)do d0.toggle()end end;safeMass=ax;cW()if button then button.activate()end;if SetWaypointOnExit then b8.showWayPoint(planet,bF)end;bZ("stop","SU")end;function script.onTick(me)local mf=nil;if me=="contact"then if not contactTimer then contactTimer=0 end;if E>contactTimer+10 then a3="Radar Contact"bZ("rdrCon","RC")contactTimer=E end;unit.stopTimer("contact")elseif me=="tenthSecond"then local function mg()local mh=system.createData;local mi=system.createWidget;panelInterplanetary=system.createWidgetPanel("Interplanetary Helper")interplanetaryHeader=mi(panelInterplanetary,"value")interplanetaryHeaderText=mh('{"label": "Target Planet", "value": "N/A", "unit":""}')u(interplanetaryHeaderText,interplanetaryHeader)widgetDistance=mi(panelInterplanetary,"value")widgetDistanceText=mh('{"label": "distance", "value": "N/A", "unit":""}')u(widgetDistanceText,widgetDistance)widgetTravelTime=mi(panelInterplanetary,"value")widgetTravelTimeText=mh('{"label": "Travel Time", "value": "N/A", "unit":""}')u(widgetTravelTimeText,widgetTravelTime)widgetMaxMass=mi(panelInterplanetary,"value")widgetMaxMassText=mh('{"label": "Maximum Mass", "value": "N/A", "unit":""}')u(widgetMaxMassText,widgetMaxMass)widgetTargetOrbit=mi(panelInterplanetary,"value")widgetTargetOrbitText=mh('{"label": "Target Altitude", "value": "N/A", "unit":""}')u(widgetTargetOrbitText,widgetTargetOrbit)widgetCurBrakeDistance=mi(panelInterplanetary,"value")widgetCurBrakeDistanceText=mh('{"label": "Cur Brake distance", "value": "N/A", "unit":""}')widgetCurBrakeTime=mi(panelInterplanetary,"value")widgetCurBrakeTimeText=mh('{"label": "Cur Brake Time", "value": "N/A", "unit":""}')widgetMaxBrakeDistance=mi(panelInterplanetary,"value")widgetMaxBrakeDistanceText=mh('{"label": "Max Brake distance", "value": "N/A", "unit":""}')widgetMaxBrakeTime=mi(panelInterplanetary,"value")widgetMaxBrakeTimeText=mh('{"label": "Max Brake Time", "value": "N/A", "unit":""}')widgetTrajectoryAltitude=mi(panelInterplanetary,"value")widgetTrajectoryAltitudeText=mh('{"label": "Projected Altitude", "value": "N/A", "unit":""}')if not as then u(widgetCurBrakeDistanceText,widgetCurBrakeDistance)u(widgetCurBrakeTimeText,widgetCurBrakeTime)u(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)u(widgetMaxBrakeTimeText,widgetMaxBrakeTime)u(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end end;local function mj()s(panelInterplanetary)panelInterplanetary=nil end;local function mk()if not Autopilot then if CustomTarget==nil or CustomTarget.planetname~=planet.name then AutopilotDistance=(ad.center-bF):len()else AutopilotDistance=(CustomTarget.position-bF):len()end end;local eT=bC;local kI=unit.getThrottle()/100;if AtmoSpeedAssist then kI=L end;local ml,mm=b3.computeDistanceAndTime(bC,MaxGameVelocity,ax,a:maxForceForward()*kI,warmup,0)local a9,aa;if not TurnBurn then a9,aa=b8.GetAutopilotBrakeDistanceAndTime(MaxGameVelocity)else a9,aa=b8.GetAutopilotTBBrakeDistanceAndTime(MaxGameVelocity)end;local _,mn;if not TurnBurn and eT>0 then _,mn=b8.GetAutopilotBrakeDistanceAndTime(eT)else _,mn=b8.GetAutopilotTBBrakeDistanceAndTime(eT)end;local mo=0;local mp=0;if AutopilotCruising or not Autopilot and eT>5 then mp=b3.computeTravelTime(eT,0,AutopilotDistance)elseif a9+ml<AutopilotDistance then mo=AutopilotDistance-(a9+ml)mp=b3.computeTravelTime(8333.0556,0,mo)else local mq=(AutopilotDistance-a9)/ml;ml=AutopilotDistance-a9;mm=mm*mq end;if CustomTarget~=nil and CustomTarget.planetname==planet.name and not Autopilot then return mp elseif AutopilotBraking then return mn elseif AutopilotCruising then return mp+mn else return mm+aa+mp end end;local function mr(ip,ms)if ip==nil then ip=core.g()end;ip=B(ip,5)if ms~=nil and ms or(mf==nil or mf~=ip)then local eW=core.getVelocity()local eT=vec3(eW):len()local mt=f(unit.getData()).maxBrake;if mt~=nil and mt>0 and as then mt=mt/q(eT/100,0.1,1)mt=mt/at;if at>0.10 then if LastMaxBrakeInAtmo then LastMaxBrakeInAtmo=(LastMaxBrakeInAtmo+mt)/2 else LastMaxBrakeInAtmo=mt end end end;if mt~=nil and mt>0 then LastMaxBrake=mt end;mf=ip end end;mr(nil,true)if at>0 and not WasInAtmo then if not bK and AtmoSpeedAssist and(AltitudeHold or Reentry)then cf(1)P=false end end;if bJ~=nil then if r:getTargetSpeed(axisCommandId.longitudinal)~=bJ then ci(bJ,TRUE)else bJ=nil end end;if AutopilotTargetName~="None"then if panelInterplanetary==nil then mg()end;if AutopilotTargetName~=nil then local mu=CustomTarget~=nil;local mv=LastMaxBrakeInAtmo/ad:getGravity(ad.center+vec3(0,0,1)*ad.radius):len()t(interplanetaryHeaderText,'{"label": "Target", "value": "'..AutopilotTargetName..'", "unit":""}')travelTime=mk()if mu and not Autopilot then ak=(bF-CustomTarget.position):len()else ak=(AutopilotTargetCoords-bF):len()end;if not TurnBurn then a9,aa=b8.GetAutopilotBrakeDistanceAndTime(bC)ab,ac=b8.GetAutopilotBrakeDistanceAndTime(MaxGameVelocity)else a9,aa=b8.GetAutopilotTBBrakeDistanceAndTime(bC)ab,ac=b8.GetAutopilotTBBrakeDistanceAndTime(MaxGameVelocity)end;local hl=cm(ak)t(widgetDistanceText,'{"label": "distance", "value": "'..hl..'"}')t(widgetTravelTimeText,'{"label": "Travel Time", "value": "'..cR(travelTime)..'", "unit":""}')hl=cm(a9)t(widgetCurBrakeDistanceText,'{"label": "Cur Brake distance", "value": "'..hl..'"}')t(widgetCurBrakeTimeText,'{"label": "Cur Brake Time", "value": "'..cR(aa)..'", "unit":""}')hl=cm(ab)t(widgetMaxBrakeDistanceText,'{"label": "Max Brake distance", "value": "'..hl..'"}')t(widgetMaxBrakeTimeText,'{"label": "Max Brake Time", "value": "'..cR(ac)..'", "unit":""}')t(widgetMaxMassText,'{"label": "Maximum Mass", "value": "'..e("%.2f",mv/1000)..'", "unit":" Tons"}')hl=cm(AutopilotTargetOrbit)t(widgetTargetOrbitText,'{"label": "Target Orbit", "value": "'..hl..'"}')if at>0 and not WasInAtmo then system.removeDataFromWidget(widgetMaxBrakeTimeText,widgetMaxBrakeTime)system.removeDataFromWidget(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)system.removeDataFromWidget(widgetCurBrakeTimeText,widgetCurBrakeTime)system.removeDataFromWidget(widgetCurBrakeDistanceText,widgetCurBrakeDistance)system.removeDataFromWidget(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)WasInAtmo=true end;if at==0 and WasInAtmo then if t(widgetMaxBrakeTimeText,widgetMaxBrakeTime)==1 then u(widgetMaxBrakeTimeText,widgetMaxBrakeTime)end;if t(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)==1 then u(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)end;if t(widgetCurBrakeTimeText,widgetCurBrakeTime)==1 then u(widgetCurBrakeTimeText,widgetCurBrakeTime)end;if t(widgetCurBrakeDistanceText,widgetCurBrakeDistance)==1 then u(widgetCurBrakeDistanceText,widgetCurBrakeDistance)end;if t(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)==1 then u(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end;WasInAtmo=false end end else mj()end;if warpdrive~=nil then if f(warpdrive.getData()).destination~="Unknown"and f(warpdrive.getData()).distance>400000 then warpdrive.show()showWarpWidget=true else warpdrive.hide()showWarpWidget=false end end elseif me=="oneSecond"then local function mw(fx)local mx=0;aF=""local my=aN;local mz=0;local mA=0;local mB=0;local fW=0;local fX=""local mC=core.getElementHitPointsById;for c_ in pairs(av)do local lG=0;local mD=0;mD=h(av[c_])lG=mC(av[c_])mz=mz+lG;if lG<mD then if lG==0 then mB=mB+1 else mA=mA+1 end;if aO and#aC==0 then position=vec3(core.getElementPositionById(av[c_]))local x=position.x-G;local y=position.y-G;local iQ=position.z-G;table.insert(aC,core.spawnArrowSticker(x,y,iQ+1,"down"))table.insert(aC,core.spawnArrowSticker(x,y,iQ+1,"down"))core.rotateSticker(aC[2],0,0,90)table.insert(aC,core.spawnArrowSticker(x+1,y,iQ,"north"))table.insert(aC,core.spawnArrowSticker(x+1,y,iQ,"north"))core.rotateSticker(aC[4],90,90,0)table.insert(aC,core.spawnArrowSticker(x-1,y,iQ,"south"))table.insert(aC,core.spawnArrowSticker(x-1,y,iQ,"south"))core.rotateSticker(aC[6],90,-90,0)table.insert(aC,core.spawnArrowSticker(x,y-1,iQ,"east"))table.insert(aC,core.spawnArrowSticker(x,y-1,iQ,"east"))core.rotateSticker(aC[8],90,0,90)table.insert(aC,core.spawnArrowSticker(x,y+1,iQ,"west"))table.insert(aC,core.spawnArrowSticker(x,y+1,iQ,"west"))core.rotateSticker(aC[10],-90,0,90)table.insert(aC,av[c_])end elseif aO and#aC>0 and aC[11]==av[c_]then for fP in pairs(aC)do core.deleteSticker(aC[fP])end;aC={}end end;mx=d(mz/my*100)if mx<100 then fx[#fx+1]=cb(0,0,"","pbright txt")fW=d(mx*2.55)fX=e("rgb(%d,%d,%d)",255-fW,fW,0)if mx<100 then fx[#fx+1]=cb("50%",1035,"Elemental Integrity: "..mx.."%","txtbig txtmid","fill:"..fX)if mB>0 then fx[#fx+1]=cb("50%",1055,"Disabled Modules: "..mB.." Damaged Modules: "..mA,"txtbig txtmid","fill:"..fX)elseif mA>0 then fx[#fx+1]=cb("50%",1055,"Damaged Modules: "..mA,"txtbig txtmid","fill:"..fX)end end end end;local function mE()if weapon then if WeaponPanelID==nil and(radarPanelID~=nil or GearExtended)then _autoconf.displayCategoryPanel(weapon,weapon_size,L_TEXT("ui_lua_widget_weapon", "Weapons"),"weapon",true)WeaponPanelID=_autoconf.panels[_autoconf.panels_size]elseif WeaponPanelID~=nil and radarPanelID==nil and not GearExtended then s(WeaponPanelID)WeaponPanelID=nil end end end;local function mF()local fU=p()local h9=bC;local mG=fU-aw;if h9>1.38889 then h9=h9/1000;local mH=h9*(fU-aw)TotalDistanceTravelled=TotalDistanceTravelled+mH;ae=ae+mH end;af=af+mG;TotalFlightTime=TotalFlightTime+mG;aw=fU end;local function mI()if safeMass>0 then if ax>safeMass+50 then bG=d(ax-safeMass)safeMass=-1 elseif ax<safeMass then safeMass=ax end elseif safeMass==-1 then safeMass=-2 else safeMass=-1 end end;if IntruderAlertSystem then mI()end;mF()b6.UpdatePipe()mE()local fx={}b6.ExtraData(fx)if ShowOdometer then fx=b6.DrawOdometer(fx,ae,TotalDistanceTravelled,af)end;if ShouldCheckDamage then mw(fx)end;al=table.concat(fx,"")collectgarbage("collect")elseif me=="fiveSecond"then if not UseSatNav then return end;ar=dbHud_1.getStringValue("SPBAutopilotTargetName")if ar~=nil and ar~=""and ar~="SatNavNotChanged"then local cJ=f(dbHud_1.getStringValue("SavedLocations"))if cJ~=nil then _G["SavedLocations"]=cJ;local cy=-1;local cz;for c_,d0 in pairs(SavedLocations)do if d0.name and d0.name=="SatNav Location"then cy=c_;break end end;if cy~=-1 then cz=SavedLocations[cy]cy=-1;for c_,d0 in pairs(aY[0])do if d0.name and d0.name=="SatNav Location"then cy=c_;break end end;if cy>-1 then aY[0][cy]=cz end;b7.UpdateAtlasLocationsList()a3=cz.name.." position updated"end end;for i=1,#bQ do if bQ[i].name==ar then AutopilotTargetIndex=i;system.print("Index = "..AutopilotTargetIndex.." "..bQ[i].name)b7.UpdateAutopilotTarget()dbHud_1.setStringValue("SPBAutopilotTargetName","SatNavNotChanged")break end end end elseif me=="msgTick"then local fx={}b6.DisplayMessage(fx,"empty")a3="empty"unit.stopTimer("msgTick")aj=3 elseif me=="animateTick"then ba=true;b9=false;ah=0;ai=0;unit.stopTimer("animateTick")elseif me=="hudTick"then local function mJ(fx)local mK=d(q(ak/(aI/4)*255,0,255))fx[#fx+1]=e("<line x1='0' y1='0' x2='%fpx' y2='%fpx' style='stroke:rgb(%d,%d,%d);stroke-width:2;transform:translate(50%%, 50%%)' />",ah,ai,d(I+0.5)+mK,d(K+0.5)-mK,d(J+0.5)-mK)end;local function mL()for _,d0 in pairs(aH)do if d0.hovered then if not d0.drawCondition or d0.drawCondition()then d0.toggleFunction()end;d0.hovered=false end end end;local function mM()local function mN(mO,mP,x,y,lN,lO)if mO>x and mO<x+lN and mP>y and mP<y+lO then return true else return false end end;local x=ah+aI/2;local y=ai+aJ/2;for _,d0 in pairs(aH)do d0.hovered=mN(x,y,d0.x,d0.y,d0.width,d0.height)end end;local function mQ(fx)local function mR(fx,mS,hover,x,y,eM,mT,mU,mV,mW,mX)if type(mW)=="function"then mW=mW()end;if type(mX)=="function"then mX=mX()end;fx[#fx+1]=e("<rect x='%f' y='%f' width='%f' height='%f' fill='",x,y,eM,mT)if mS then fx[#fx+1]=e("%s'",mU)else fx[#fx+1]=mV end;if hover then fx[#fx+1]=" style='stroke:white; stroke-width:2'"else fx[#fx+1]=" style='stroke:black; stroke-width:1'"end;fx[#fx+1]="></rect>"fx[#fx+1]=e("<text x='%f' y='%f' font-size='24' fill='",x+eM/2,y+mT/2+5)if mS then fx[#fx+1]="black"else fx[#fx+1]="white"end;fx[#fx+1]="' text-anchor='middle' font-family='Montserrat'>"if mS then fx[#fx+1]=e("%s</text>",mW)else fx[#fx+1]=e("%s</text>",mX)end end;local mY="rgb(50,50,50)'"local mZ="rgb(210,200,200)"local m_=mR;for _,d0 in pairs(aH)do local lM=d0.disableName;local lL=d0.enableName;if type(lM)=="function"then lM=lM()end;if type(lL)=="function"then lL=lL()end;if not d0.drawCondition or d0.drawCondition()then m_(fx,d0.toggleVar(),d0.hovered,d0.x,d0.y,d0.width,d0.height,mZ,mY,lM,lL)end end end;local n0=B(ResolutionX/2,0)local n1=B(ResolutionY/2,0)local fx={}b6.HUDPrologue(fx)if showHud then b6.UpdateHud(fx)else if AlwaysVSpd then b6.DrawVerticalSpeed(fx,au)end;b6.DisplayOrbitScreen(fx)b6.DrawWarnings(fx)end;if bN and bO~={}then b6.DrawSettings(fx)end;b6.HUDEpilogue(fx)fx[#fx+1]=e([[<svg width="100%%" height="100%%" style="position:absolute;top:0;left:0"  viewBox="0 0 %d %d">]],aI,aJ)if a3~="empty"then b6.DisplayMessage(fx,a3)end;if l()==0 and userControlScheme=="virtual joystick"then if DisplayDeadZone then b6.DrawDeadZone(fx)end end;if w()==0 then if l()==1 and a2 then if not AltIsOn then mM()mQ(fx)end;if not b9 and not ba then local n2=table.concat(fx,"")fx={}fx[#fx+1]=e("<style>@keyframes test { from { opacity: 0; } to { opacity: 1; } }  body { animation-name: test; animation-duration: 0.5s; }</style><body><svg width='100%%' height='100%%' position='absolute' top='0' left='0'><rect width='100%%' height='100%%' x='0' y='0' position='absolute' style='fill:rgb(6,5,26);'/></svg><svg width='50%%' height='50%%' style='position:absolute;top:30%%;left:25%%' viewbox='0 0 %d %d'>",aI,aJ)fx[#fx+1]=n2;fx[#fx+1]="</body>"b9=true;fx[#fx+1]=[[</svg></body>]]unit.setTimer("animateTick",0.5)local content=table.concat(fx,"")system.setScreen(content)elseif ba then local n2=table.concat(fx,"")fx={}fx[#fx+1]=e("<body style='background-color:rgb(6,5,26)'><svg width='50%%' height='50%%' style='position:absolute;top:30%%;left:25%%' viewbox='0 0 %d %d'>",aI,aJ)fx[#fx+1]=n2;fx[#fx+1]="</body>"end;if not b9 then fx[#fx+1]=e([[<g transform="translate(%d %d)"><circle class="cursor" cx="%fpx" cy="%fpx" r="5"/></g>]],n0,n1,ah,ai)end else mL()end else if not a2 and l()==0 then mL()if ak>DeadZone then if DisplayDeadZone then mJ(fx)end end elseif not AltIsOn or AltIsOn and a2 then mM()mQ(fx)end;fx[#fx+1]=e([[<g transform="translate(%d %d)"><circle class="cursor" cx="%fpx" cy="%fpx" r="5"/></g>]],n0,n1,ah,ai)end;fx[#fx+1]=[[</svg></body>]]content=table.concat(fx,"")if not DidLogOutput then system.logInfo(LastContent)DidLogOutput=true end elseif me=="apTick"then b8.APTick()b6.UpdateRadar()end end;function script.onFlush()local function n3(n4,kP)local n5=vec3()local n6=vec3()if n4==axisCommandId.longitudinal then n5=vec3(core.getConstructOrientationForward())n6=bz elseif n4==axisCommandId.vertical then n5=vec3(core.getConstructOrientationUp())n6=by elseif n4==axisCommandId.lateral then n5=vec3(core.getConstructOrientationRight())n6=bA else return vec3()end;local n7=vec3(core.getWorldGravity())local n8=n7:dot(n6)local n9=vec3(core.getWorldAirFrictionAcceleration())local na=n9:dot(n6)local nb=vec3(core.getVelocity())local nc=nb:dot(n5)local nd=kP*constants.kph2m;if targetSpeedPID2==nil then targetSpeedPID2=pid.new(10,0,10.0)end;targetSpeedPID2:inject(nd-nc)local ne=targetSpeedPID2:get()local nf=(ne-na-n8)*n6;return nf end;local function ng(n4,kP)local n5=vec3()local n6=vec3()if n4==axisCommandId.longitudinal then n5=vec3(core.getConstructOrientationForward())n6=bz elseif n4==axisCommandId.vertical then n5=vec3(core.getConstructOrientationUp())n6=by elseif n4==axisCommandId.lateral then n5=vec3(core.getConstructOrientationRight())n6=bA else return vec3()end;local n7=vec3(core.getWorldGravity())local n8=n7:dot(n6)local n9=vec3(core.getWorldAirFrictionAcceleration())local na=n9:dot(n6)local nb=vec3(core.getVelocity())local nc=nb:dot(n5)local nd=kP*constants.kph2m;if targetSpeedPID==nil then targetSpeedPID=pid.new(10,0,10.0)end;targetSpeedPID:inject(nd-nc)local ne=targetSpeedPID:get()local nf=(ne-na-n8)*n6;return nf end;local function nh(ni,g0,jD)local nj=ni:cross(jD):normalize_inplace()local gN=math.acos(q(nj:dot(-g0),-1,1))*constants.rad2deg;if nj:cross(-g0):dot(jD)<0 then gN=-gN end;return gN end;if antigrav and not ExternalAGG then if not bI and antigrav.getBaseAltitude()~=AntigravTargetAltitude then antigrav.setBaseAltitude(AntigravTargetAltitude)end end;bK=r:getAxisCommandType(0)==axisCommandType.byThrottle;if bK and P then cf(0)P=false elseif not bK and not P then L=0;P=true end;pitchSpeedFactor=math.max(pitchSpeedFactor,0.01)yawSpeedFactor=math.max(yawSpeedFactor,0.01)rollSpeedFactor=math.max(rollSpeedFactor,0.01)torqueFactor=math.max(torqueFactor,0.01)brakeSpeedFactor=math.max(brakeSpeedFactor,0.01)brakeFlatFactor=math.max(brakeFlatFactor,0.01)autoRollFactor=math.max(autoRollFactor,0.01)turnAssistFactor=math.max(turnAssistFactor,0.01)local nk=q(U+V+system.getControlDeviceForwardInput(),-1,1)local nl=q(X+a0+system.getControlDeviceYawInput(),-1,1)local nm=q(Y+W-system.getControlDeviceLeftRightInput(),-1,1)local nn=Z;bD=vec3(core.getWorldVertical())if bD==nil or bD:len()==0 then bD=(planet.center-bF):normalize()end;by=vec3(core.getConstructWorldOrientationUp())bz=vec3(core.getConstructWorldOrientationForward())bA=vec3(core.getConstructWorldOrientationRight())bB=vec3(core.getWorldVelocity())bF=vec3(core.getConstructWorldPos())ax=core.getConstructMass()bC=vec3(bB):len()bE=-bD:dot(bB)bM=getRoll(bD,bz,bA)local no=bM/180*math.pi;local np=math.cos(no)local nq=math.sin(no)bL=nh(bD,bz,bA*np+by*nq)local nr=bB:normalize()local ns=c(bM)local nt=utils.sign(bM)local nu=vec3(core.getWorldAngularVelocity())local nw=nk*pitchSpeedFactor*bA+nl*rollSpeedFactor*bz+nm*yawSpeedFactor*by;if bb==true and bD:len()>0.01 then local nx=c(bf-bM)if((ProgradeIsOn or Reentry or BrakeLanding or an or AltitudeHold or IntoOrbit)and nx>0 or at>0.0 and nx<autoRollRollThreshold and autoRollPreference)and nl==0 and c(bL)<85 then local ny=bf;local nz=autoRollFactor;if at==0 then nz=nz/4;bf=0;ny=0 end;if rollPID==nil then rollPID=pid.new(nz*0.01,0,nz*0.1)end;rollPID:inject(ny-bM)local nA=rollPID:get()nw=nw+nA*bz end end;if bD:len()>0.01 and at>0.0 then local nB=20.0;if turnAssist==true and ns>nB and nk==0 and nm==0 then local nC=turnAssistFactor*0.1;local nD=turnAssistFactor*0.025;local nE=(ns-nB)/(180-nB)*180;local nF=0;if nE<90 then nF=nE/90 elseif nE<180 then nF=(180-nE)/90 end;nF=nF*nF;local nG=-nt*nD*(1.0-nF)local nH=nC*nF;nw=nw+nH*bA+nG*by end end;local nI=1;local nJ=0;local nK=1;if system.getMouseWheel()>0 then if AltIsOn then if at>0 or Reentry then bi=q(bi+speedChangeLarge,0,AtmoSpeedLimit)elseif Autopilot then MaxGameVelocity=q(MaxGameVelocity+speedChangeLarge/3.6*100,0,8333.00)end elseif ay then local nL=L;L=B(q(L+speedChangeLarge/100,-1,1),2)if L>=0 and nL<0 then L=0;ay=false end end elseif system.getMouseWheel()<0 then if AltIsOn then if at>0 or Reentry then bi=q(bi-speedChangeLarge,0,AtmoSpeedLimit)elseif Autopilot then MaxGameVelocity=q(MaxGameVelocity-speedChangeLarge/3.6*100,0,8333.00)end elseif ay then local nL=L;L=B(q(L-speedChangeLarge/100,-1,1),2)if L<=0 and nL>0 then L=0;ay=false end end else ay=true end;M=0;if as and AtmoSpeedAssist and bK then if throttlePID==nil then throttlePID=pid.new(0.5,0,1)end;throttlePID:inject(bi/3.6-bB:dot(bz))local nM=throttlePID:get()O=q(nM,-1,1)if O<L and at>0.005 then N=true;r:setThrottleCommand(axisCommandId.longitudinal,q(O,0.01,1))else N=false;r:setThrottleCommand(axisCommandId.longitudinal,L)end;if brakePID==nil then brakePID=pid.new(1*0.01,0,1*0.1)end;brakePID:inject(bB:len()-bi/3.6)local nN=q(brakePID:get(),0,1)if at>0 and bE<-80 or at>0.005 then M=nN end;if M>0 then if N and O==0.01 then r:setThrottleCommand(axisCommandId.longitudinal,0)end else O=q(O,0.01,1)end;local nO=''local nP=vec3()local nQ=n3(axisCommandId.vertical,ag*1000)a:setEngineForceCommand("vertical airfoil , vertical ground ",nQ,nJ)local nR='thrust analog longitudinal 'if ExtraLongitudeTags~="none"then nR=nR..ExtraLongitudeTags end;local nS=r:getAxisCommandType(axisCommandId.longitudinal)local nT=r:composeAxisAccelerationFromThrottle(nR,axisCommandId.longitudinal)local nU=ng(axisCommandId.lateral,LeftAmount*1000)nO=nO..' , '.."lateral airfoil , lateral ground "nP=nP+nU;if nP:len()>constants.epsilon then a:setEngineForceCommand(nO,nP,nJ,'','','',nK)end;a:setEngineForceCommand(nR,nT,nI)local nV='thrust analog vertical fueled 'local nW='thrust analog lateral fueled 'if ExtraLateralTags~="none"then nW=nW..ExtraLateralTags end;if ExtraVerticalTags~="none"then nV=nV..ExtraVerticalTags end;if ag~=0 or BrakeLanding and BrakeIsOn or not GearExtended and not stablized then a:setEngineForceCommand(nV,nQ,nI)else a:setEngineForceCommand(nV,vec3(),nI)end;if LeftAmount~=0 then a:setEngineForceCommand(nW,nU,nI)else a:setEngineForceCommand(nW,vec3(),nI)end;if nn==0 then nn=M end;local nX=-nn*(brakeSpeedFactor*bB+brakeFlatFactor*nr)a:setEngineForceCommand('brake',nX)else if AtmoSpeedAssist then r:setThrottleCommand(axisCommandId.longitudinal,L)end;local kP=unit.getAxisCommandValue(0)if not bK then if brakePID==nil then brakePID=pid.new(1*0.01,0,1*0.1)end;brakePID:inject(bB:len()-kP/3.6)local nN=q(brakePID:get(),0,1)nn=q(nn+nN,0,1)end;local nX=-nn*(brakeSpeedFactor*bB+brakeFlatFactor*nr)a:setEngineForceCommand('brake',nX)local nO=''local nP=vec3()local nY=false;local nR='thrust analog longitudinal 'if ExtraLongitudeTags~="none"then nR=nR..ExtraLongitudeTags end;local nS=r:getAxisCommandType(axisCommandId.longitudinal)if nS==axisCommandType.byThrottle then local nT=r:composeAxisAccelerationFromThrottle(nR,axisCommandId.longitudinal)a:setEngineForceCommand(nR,nT,nI)elseif nS==axisCommandType.byTargetSpeed then local nT=r:composeAxisAccelerationFromTargetSpeed(axisCommandId.longitudinal)nO=nO..' , '..nR;nP=nP+nT;if r:getTargetSpeed(axisCommandId.longitudinal)==0 or r:getCurrentToTargetDeltaSpeed(axisCommandId.longitudinal)<-r:getTargetSpeedCurrentStep(axisCommandId.longitudinal)*0.5 then nY=true end end;local nW='thrust analog lateral 'if ExtraLateralTags~="none"then nW=nW..ExtraLateralTags end;local nZ=r:getAxisCommandType(axisCommandId.lateral)if nZ==axisCommandType.byThrottle then local n_=r:composeAxisAccelerationFromThrottle(nW,axisCommandId.lateral)a:setEngineForceCommand(nW,n_,nI)elseif nZ==axisCommandType.byTargetSpeed then local nU=r:composeAxisAccelerationFromTargetSpeed(axisCommandId.lateral)nO=nO..' , '..nW;nP=nP+nU end;local nV='thrust analog vertical 'if ExtraVerticalTags~="none"then nV=nV..ExtraVerticalTags end;local o0=r:getAxisCommandType(axisCommandId.vertical)if o0==axisCommandType.byThrottle then local nQ=r:composeAxisAccelerationFromThrottle(nV,axisCommandId.vertical)if ag~=0 or BrakeLanding and BrakeIsOn then a:setEngineForceCommand(nV,nQ,nI,'airfoil','ground','',nK)else a:setEngineForceCommand(nV,vec3(),nI)a:setEngineForceCommand('airfoil vertical',nQ,nI,'airfoil','','',nK)a:setEngineForceCommand('ground vertical',nQ,nI,'ground','','',nK)end elseif o0==axisCommandType.byTargetSpeed then if ag<0 then a:setEngineForceCommand('hover',vec3(),nI)end;local o1=r:composeAxisAccelerationFromTargetSpeed(axisCommandId.vertical)nO=nO..' , '..nV;nP=nP+o1 end;if nP:len()>constants.epsilon then if Z~=0 or nY or c(nr:dot(bz))<0.8 then nO=nO..', brake'end;a:setEngineForceCommand(nO,nP,nJ,'','','',nK)end end;local o2=torqueFactor*(nw-nu)local o3=vec3(core.getWorldAirFrictionAngularAcceleration())o2=o2-o3;a:setEngineTorqueCommand('torque',o2,nI,'airfoil','','',nK)a:setBoosterCommand('rocket_engine')if a8 and not VanillaRockets then local eT=vec3(core.getVelocity()):len()local o4=0.15;if not bK then local o5=r:getTargetSpeed(axisCommandId.longitudinal)if eT*3.6>o5*(1-o4)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif eT*3.6<o5*(1-o4)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end else local kI=unit.getThrottle()if AtmoSpeedAssist then kI=L*100 end;local kP=kI/100;if j==0 then kP=kP*MaxGameVelocity;if eT>=kP*(1-o4)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif eT<kP*(1-o4)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end else local k_=d(bi)kP=kP*k_/3.6;if eT>=kP*(1-o4)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif eT<kP*(1-o4)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end end end end end;function script.onUpdate()if not SetupComplete then local jx=coroutine.status(beginSetup)if jx=="suspended"then local cg,jy=coroutine.resume(beginSetup)if jy then system.print("ERROR STARTUP: "..jy)end elseif jx=="dead"then SetupComplete=true end end;if SetupComplete then a:update()if not b9 and content~=LastContent then if not Cockpit then system.setScreen(content)else dbHud_1.setStringValue("content",content)end end;LastContent=content end end;function script.onActionStart(o6)local mult=1;local function o7(o8)local function o9(oa,o8)local ob={planet.surfaceMaxAltitude+100,planet.spaceEngineMinAltitude-50,planet.noAtmosphericDensityAltitude+LowOrbitHeight,planet.radius*(TargetOrbitRadius-1)+planet.noAtmosphericDensityAltitude}local oc=oa;for _,d0 in ipairs(ob)do if o8 and oc>d0 then oa=d0 elseif oa<d0 and not o8 then oa=d0;break end end;return oa end;if o8 then mult=-1 end;if not ExternalAGG and bI then if a2 and o8 then AntigravTargetAltitude=1000 elseif AntigravTargetAltitude~=nil then AntigravTargetAltitude=AntigravTargetAltitude+mult*a5;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if AltitudeHold and AntigravTargetAltitude<HoldAltitude+10 and AntigravTargetAltitude>HoldAltitude-10 then HoldAltitude=AntigravTargetAltitude end else AntigravTargetAltitude=desiredBaseAltitude+mult*100 end elseif AltitudeHold or VertTakeOff or IntoOrbit then if IntoOrbit then if a2 then br=o9(br,o8)else br=br+mult*a4 end;if br<planet.noAtmosphericDensityAltitude then br=planet.noAtmosphericDensityAltitude end else if a2 and as then HoldAltitude=o9(HoldAltitude,o8)else HoldAltitude=HoldAltitude+mult*a4 end end else r:updateTargetGroundAltitudeFromActionStart(mult*1.0)end end;local function od(o8)if o8 then mult=-1 end;if not a2 then if AtmoSpeedAssist and not AltIsOn then L=q(L+mult*speedChangeLarge/100,-1,1)else r:updateCommandFromActionStart(axisCommandId.longitudinal,mult*speedChangeLarge)end else if o8 then mult=1 else mult=nil end;b7.adjustAutopilotTargetIndex(mult)end end;local function oe(of)if not as then a3="Flight Assist in Atmo only"return end;local d7=type(of)if bU==nil then if d7=="table"then if Autopilot or VectorToTarget then cs()end;bZ("180On","BR")elseif of==1 then bZ("bnkLft","BR")else bZ("bnkRht","BR")end;if not AltitudeHold and not Autopilot and not VectorToTarget then cr()if d7~="table"then of=of+1 end end;bU=of else bZ("180Off","BR")bU=nil end end;if o6=="gear"then GearExtended=not GearExtended;if GearExtended then VectorToTarget=false;LockPitch=nil;cf(0)if vBooster or hover then if as and aq==-1 then bZ("bklOn","BL")StrongBrakes=true;Reentry=false;AutoTakeoff=false;VertTakeOff=false;AltitudeHold=false;BrakeLanding=true;bb=true;GearExtended=false else if T then bZ("grOut","LG",1)a.control.extendLandingGears()end;r:setTargetGroundAltitude(LandingGearGroundHeight)if as then BrakeIsOn=true end end end;if T and not BrakeLanding and not(vBooster or hover)then bZ("grOut","LG",1)a.control.extendLandingGears()end else if T then bZ("grIn","LG",1)a.control.retractLandingGears()end;r:setTargetGroundAltitude(TargetHoverHeight)end elseif o6=="light"then if a.control.isAnyHeadlightSwitchedOn()==1 then a.control.switchOffHeadlights()else a.control.switchOnHeadlights()end elseif o6=="forward"then U=U-1 elseif o6=="backward"then if AltIsOn then oe(-bB*5000)else U=U+1 end elseif o6=="left"then if AltIsOn then oe(1)else X=X-1 end elseif o6=="right"then if AltIsOn then oe(3)else X=X+1 end elseif o6=="yawright"then Y=Y-1 elseif o6=="yawleft"then Y=Y+1 elseif o6=="straferight"then r:updateCommandFromActionStart(axisCommandId.lateral,1.0)LeftAmount=1 elseif o6=="strafeleft"then r:updateCommandFromActionStart(axisCommandId.lateral,-1.0)LeftAmount=-1 elseif o6=="up"then ag=ag+1;r:deactivateGroundEngineAltitudeStabilization()r:updateCommandFromActionStart(axisCommandId.vertical,1.0)elseif o6=="down"then ag=ag-1;r:deactivateGroundEngineAltitudeStabilization()r:updateCommandFromActionStart(axisCommandId.vertical,-1.0)elseif o6=="groundaltitudeup"then o7()elseif o6=="groundaltitudedown"then o7(true)elseif o6=="option1"then b7.adjustAutopilotTargetIndex()toggleView=false elseif o6=="option2"then b7.adjustAutopilotTargetIndex(1)toggleView=false elseif o6=="option3"then local function og()aG=not aG;if not aG then bZ("wid","DH")unit.show()core.show()if atmofueltank_size>0 then _autoconf.displayCategoryPanel(atmofueltank,atmofueltank_size,L_TEXT("ui_lua_widget_atmofuel", "Atmo Fuel"),"fuel_container")fuelPanelID=_autoconf.panels[_autoconf.panels_size]end;if spacefueltank_size>0 then _autoconf.displayCategoryPanel(spacefueltank,spacefueltank_size,L_TEXT("ui_lua_widget_spacefuel", "Space Fuel"),"fuel_container")spacefuelPanelID=_autoconf.panels[_autoconf.panels_size]end;if rocketfueltank_size>0 then _autoconf.displayCategoryPanel(rocketfueltank,rocketfueltank_size,L_TEXT("ui_lua_widget_rocketfuel", "Rocket Fuel"),"fuel_container")rocketfuelPanelID=_autoconf.panels[_autoconf.panels_size]end else bZ("hud","DH")unit.hide()core.hide()if fuelPanelID~=nil then s(fuelPanelID)fuelPanelID=nil end;if spacefuelPanelID~=nil then s(spacefuelPanelID)spacefuelPanelID=nil end;if rocketfuelPanelID~=nil then s(rocketfuelPanelID)rocketfuelPanelID=nil end end end;if hideHudOnToggleWidgets then if showHud then showHud=false else showHud=true end end;og()toggleView=false elseif o6=="option4"then bU=nil;cs()toggleView=false elseif o6=="option5"then function ToggleLockPitch()if LockPitch==nil then bZ("lkPOn","LP")if not a2 then LockPitch=bL else LockPitch=LockPitchTarget end;AutoTakeoff=false;AltitudeHold=false;BrakeLanding=false else bZ("lkPOff","LP")LockPitch=nil end end;ToggleLockPitch()toggleView=false elseif o6=="option6"then cr()toggleView=false elseif o6=="option7"then CollisionSystem=not CollisionSystem;if CollisionSystem then a3="Collision System Enabled"else a3="Collision System Secured"end;toggleView=false elseif o6=="option8"then stablized=not stablized;if not stablized then a3="DeCoupled Mode - Ground Stabilization off"r:deactivateGroundEngineAltitudeStabilization()bZ("gsOff","GS")else a3="Coupled Mode - Ground Stabilization on"r:activateGroundEngineAltitudeStabilization(currentGroundAltitudeStabilization)a:setEngineForceCommand('hover',vec3(),1)bZ("gsOn","GS")end;toggleView=false elseif o6=="option9"then if gyro~=nil then gyro.toggle()az=gyro.getState()==1;if az then bZ("gyOn","GA")else bZ("gyOff","GA")end end;toggleView=false elseif o6=="lshift"then if AltIsOn then a2=true end;if w()==1 then a2=true;PrevViewLock=w()v(1)elseif l()==1 and ShiftShowsRemoteButtons then a2=true;ba=false;b9=false end elseif o6=="brake"then if BrakeToggleStatus then cC()elseif not BrakeIsOn then cC()else BrakeIsOn=true end elseif o6=="lalt"then toggleView=true;AltIsOn=true;if l()==0 and not freeLookToggle and userControlScheme=="keyboard"then v(1)end elseif o6=="booster"then if VanillaRockets then a:toggleBoosters()elseif not a8 then if not IsRocketOn then a:toggleBoosters()IsRocketOn=true end;a8=true else if IsRocketOn then a:toggleBoosters()IsRocketOn=false end;a8=false end elseif o6=="stopengines"then local function oh()if E-F<1.5 then bZ("clear","CA")AutopilotAccelerating=false;AutopilotBraking=false;AutopilotCruising=false;Autopilot=false;AutopilotRealigned=false;AutopilotStatus="Aligning"RetrogradeIsOn=false;ProgradeIsOn=false;bU=nil;AltitudeHold=false;Reentry=false;BrakeLanding=false;BrakeIsOn=false;AutoTakeoff=false;VertTakeOff=false;a1=false;Q=false;an=false;ao=false;S=false;bb=autoRollPreference;VectorToTarget=false;TurnBurn=false;az=false;LockPitch=nil;IntoOrbit=false end end;oh()F=E;if r:getAxisCommandType(0)~=axisCommandType.byTargetSpeed then if L~=0 then r:resetCommand(axisCommandId.longitudinal)cf(0)else cf(100)end else if r:getTargetSpeed(axisCommandId.longitudinal)~=0 then r:resetCommand(axisCommandId.longitudinal)else if as then ci(AtmoSpeedLimit)else ci(MaxGameVelocity*3.6)end end end elseif o6=="speedup"then od()elseif o6=="speeddown"then od(true)elseif o6=="antigravity"and not ExternalAGG then if antigrav~=nil then cQ()end end end;function script.onActionStop(o6)local function oi()if not ExternalAGG and bI then a7=a5 end;if AltitudeHold or VertTakeOff or IntoOrbit then a6=a4 end end;if o6=="forward"then U=0 elseif o6=="backward"then U=0 elseif o6=="left"then if bU then if bU==2 then bU=-2 else bU=-1 end end;X=0 elseif o6=="right"then if bU then if bU==4 then bU=-2 else bU=-1 end end;X=0 elseif o6=="yawright"then Y=0 elseif o6=="yawleft"then Y=0 elseif o6=="straferight"then r:updateCommandFromActionStop(axisCommandId.lateral,-1.0)LeftAmount=0 elseif o6=="strafeleft"then r:updateCommandFromActionStop(axisCommandId.lateral,1.0)LeftAmount=0 elseif o6=="up"then ag=0;r:updateCommandFromActionStop(axisCommandId.vertical,-1.0)if stablized then r:activateGroundEngineAltitudeStabilization(currentGroundAltitudeStabilization)a:setEngineForceCommand('hover',vec3(),1)end elseif o6=="down"then ag=0;r:updateCommandFromActionStop(axisCommandId.vertical,1.0)if stablized then r:activateGroundEngineAltitudeStabilization(currentGroundAltitudeStabilization)a:setEngineForceCommand('hover',vec3(),1)end elseif o6=="groundaltitudeup"then oi()toggleView=false elseif o6=="groundaltitudedown"then oi()toggleView=false elseif o6=="lshift"then if w()==1 then ah=0;ai=0;v(PrevViewLock)elseif l()==1 and ShiftShowsRemoteButtons then ba=false;b9=false end;a2=false elseif o6=="brake"then if not BrakeToggleStatus then if BrakeIsOn then cC()else BrakeIsOn=false end end elseif o6=="lalt"then if l()==0 and freeLookToggle then if toggleView then if w()==1 then v(0)else v(1)end else toggleView=true end elseif l()==0 and not freeLookToggle and userControlScheme=="keyboard"then v(0)end;AltIsOn=false end end;function script.onActionLoop(o6)local function oj(o8)local mult=1;if o8 then mult=-1 end;if not ExternalAGG and bI then if AntigravTargetAltitude~=nil then AntigravTargetAltitude=AntigravTargetAltitude+mult*a7;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if AltitudeHold and AntigravTargetAltitude<HoldAltitude+10 and AntigravTargetAltitude>HoldAltitude-10 then HoldAltitude=AntigravTargetAltitude end;a7=q(a7*1.05,a5,500)BrakeIsOn=false else AntigravTargetAltitude=desiredBaseAltitude+mult*100;BrakeIsOn=false end elseif AltitudeHold or VertTakeOff or IntoOrbit then if IntoOrbit then br=br+mult*a6;if br<planet.noAtmosphericDensityAltitude then br=planet.noAtmosphericDensityAltitude end else HoldAltitude=HoldAltitude+mult*a6 end;a6=q(a6*1.05,a4,500)else r:updateTargetGroundAltitudeFromActionLoop(mult*1.0)end end;local function ok(o8)if o8 then mult=-1 end;if not a2 then if AtmoSpeedAssist and not AltIsOn then L=q(L+mult*speedChangeSmall/100,-1,1)else r:updateCommandFromActionLoop(axisCommandId.longitudinal,mult*speedChangeSmall)end end end;if o6=="groundaltitudeup"then if not a2 then oj()end elseif o6=="groundaltitudedown"then if not a2 then oj(true)end elseif o6=="speedup"then ok()elseif o6=="speeddown"then ok(true)end end;function script.onInputText(cc)local function ol()for c_,d0 in pairs(c4())do dbHud_1.setStringValue(d0,g(nil))end;for c_,d0 in pairs(b)do if d0~="SavedLocations"then dbHud_1.setStringValue(d0,g(nil))end end;a3="Databank wiped except Save Locations. New variables will save after re-enter seat and exit"aj=5 end;local function om(on,planet,cB,gJ)local function oo(cB)local C=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local df='::pos{'..C..','..C..','..C..','..C..','..C..'}'local ds,dt,dz,dA,dB=n(cB,df)if ds=="0"and dt=="0"then return vec3(A(dz),A(dA),A(dB))end;dA=math.rad(dA)dz=math.rad(dz)local planet=aY[A(ds)][A(dt)]local en=math.cos(dz)local op=vec3(en*math.cos(dA),en*math.sin(dA),math.sin(dz))return planet.center+(planet.radius+dB)*op end;if dbHud_1 or gJ then local cz={}local position=oo(cB)if planet.name=="Space"then cz={position=position,name=on,atmosphere=0,planetname=planet.name,gravity=planet.gravity}else cz={position=position,name=on,atmosphere=planet.atmosphericDensityAboveSurface,planetname=planet.name,gravity=planet.gravity}end;if not gJ then SavedLocations[#SavedLocations+1]=cz else for c_,d0 in pairs(aY[0])do if d0.name and on==d0.name then table.remove(aY[0],c_)end end end;table.insert(aY[0],cz)b7.UpdateAtlasLocationsList()else a3="Databank must be installed to save permanent locations"end end;local i;local oq,os=nil,nil;local ot="Command List:\n/commands \n/setname <newname> - Updates current selected saved position name\n/G VariableName newValue - Updates global variable to new value\n".."/G dump - shows all variables updatable by /G\n/agg <targetheight> - Manually set agg target height\n".."/addlocation SafeZoneCenter ::pos{0,0,13771471,7435803,-128971} - adds a saved location by waypoint, not as accurate as making one at location\n".."/::pos{0,0,13771471,7435803,-128971} - adds a temporary waypoint that is not saved to databank with name 0Temp\n".."/copydatabank - copies dbHud databank to a blank databank\n".."/iphWP - displays current IPH target's ::pos waypoint in lua chat"i=string.find(cc," ")oq=cc;if i~=nil then oq=string.sub(cc,0,i-1)os=string.sub(cc,i+1)end;if oq=="/help"or oq=="/commands"then for iv in string.gmatch(ot,"([^\n]+)")do system.print(iv)end;return elseif oq=="/setname"then if os==nil or os==""then a3="Usage: ah-setname Newname"return end;if AutopilotTargetIndex>0 and CustomTarget~=nil then cw(os)else a3="Select a saved target to rename first"end elseif oq=="/addlocation"or string.find(cc,"::pos")~=nil then local gJ=false;local on="0-Temp"if os==nil or os==""then os=oq;gJ=true end;i=string.find(os,"::")if not gJ then on=string.sub(os,1,i-2)end;local cB=string.sub(os,i)local C=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local df='::pos{'..C..','..C..','..C..','..C..','..C..'}'local ds,dt,dz,dA,dB=n(cB,df)local planet=aY[A(ds)][A(dt)]if planet.name=="Space"then local jd=vec3(A(dz),A(dA),A(dB))local cv=sys:closestBody(jd)if(jd-cv.center):len()<cv.radius+cv.noAtmosphericDensityAltitude then system.print(cB.." recognized as: "..cv.name)planet=cv end end;om(on,planet,cB,gJ)a3="Added "..on.." to saved locations,\nplanet "..planet.name.." at "..cB;aj=5 elseif oq=="/agg"then if os==nil or os==""then a3="Usage: /agg targetheight"return end;os=A(os)if os<1000 then os=1000 end;AntigravTargetAltitude=os;a3="AGG Target Height set to "..os elseif oq=="/G"then if os==nil or os==""then a3="Usage: /G VariableName variablevalue\n/G dump - shows all variables"return end;if os=="dump"then for c_,d0 in pairs(c4())do if type(_G[d0])=="boolean"then if _G[d0]==true then system.print(d0 .." true")else system.print(d0 .." false")end elseif _G[d0]==nil then system.print(d0 .." nil")else system.print(d0 .." ".._G[d0])end end;return end;i=string.find(os," ")local ou=string.sub(os,0,i-1)local ov=string.sub(os,i+1)for c_,d0 in pairs(c4())do if d0==ou then a3="Variable "..ou.." changed to "..ov;local ow=type(_G[d0])if ow=="number"then ov=A(ov)elseif ow=="boolean"then if string.lower(ov)=="true"then ov=true else ov=false end end;_G[d0]=ov;return end end;a3="No such global variable: "..ou elseif oq=="/copydatabank"then if dbHud_2 then cW(true)else a3="Spare Databank required to copy databank"end elseif oq=="/iphWP"then if AutopilotTargetIndex>0 then system.print(b8.showWayPoint(ad,AutopilotTargetCoords,true))a3="::pos waypoint shown in lua chat"else a3="No target selected in IPH"end end end;function script.onEnter(dJ)if radar_1 and not as and not bR then unit.setTimer("contact",0.1)end end;function script.onLeave(dJ)if radar_1 and CollisionSystem then if#bV>650 then dJ=tostring(dJ)bV[dJ]=nil end end end;script.onStart()
        
        
        -- error handling code added by wrap.lua
        end, __wrap_lua__traceback)
        if not ok then
          __wrap_lua__error(message)
          if not script then script = {} end
        end
    stop:
      lua: |
        if not __wrap_lua__stopped and script.onStop then
          local ok, message = xpcall(script.onStop,__wrap_lua__traceback,unit)
          if not ok then __wrap_lua__error(message) end
        end
    tick(timerId):
      lua: |
        if not __wrap_lua__stopped and script.onTick then
          local ok, message = xpcall(script.onTick,__wrap_lua__traceback,timerId,unit)
          if not ok then __wrap_lua__error(message) end
        end
  system:
    actionStart(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionStart then
          local ok, message = xpcall(script.onActionStart,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    actionStop(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionStop then
          local ok, message = xpcall(script.onActionStop,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    actionLoop(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionLoop then
          local ok, message = xpcall(script.onActionLoop,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    update:
      lua: |
        if not __wrap_lua__stopped and script.onUpdate then
          local ok, message = xpcall(script.onUpdate,__wrap_lua__traceback,system)
          if not ok then __wrap_lua__error(message) end
        end
    flush:
      lua: |
        if not __wrap_lua__stopped and script.onFlush then
          local ok, message = xpcall(script.onFlush,__wrap_lua__traceback,system)
          if not ok then __wrap_lua__error(message) end
        end
    inputText(text):
      lua: |
        if not __wrap_lua__stopped and script.onInputText then
          local ok, message = xpcall(script.onInputText,__wrap_lua__traceback,text,system)
          if not ok then __wrap_lua__error(message) end
        end
  radar_1:
    enter(id):
      lua: |
        local radar = radar_1
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_1
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_2:
    enter(id):
      lua: |
        local radar = radar_2
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_2
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_3:
    enter(id):
      lua: |
        local radar = radar_3
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_3
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_4:
    enter(id):
      lua: |
        local radar = radar_4
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_4
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_5:
    enter(id):
      lua: |
        local radar = radar_5
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_5
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_6:
    enter(id):
      lua: |
        local radar = radar_6
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_6
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_7:
    enter(id):
      lua: |
        local radar = radar_7
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_7
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_8:
    enter(id):
      lua: |
        local radar = radar_8
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_8
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_9:
    enter(id):
      lua: |
        local radar = radar_9
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_9
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
  radar_10:
    enter(id):
      lua: |
        local radar = radar_10
        if not __wrap_lua__stopped and script.onEnter then
          local ok, message = xpcall(script.onEnter,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
    leave(id):
      lua: |
        local radar = radar_10
        if not __wrap_lua__stopped and script.onLeave then
          local ok, message = xpcall(script.onLeave,__wrap_lua__traceback,id,radar)
          if not ok then __wrap_lua__error(message) end
        end
