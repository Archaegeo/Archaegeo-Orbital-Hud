name: ArchHud - Archaegeo v1.141 (Minified)
slots:
  core:
    class: CoreUnit
  radar:
    class: RadarPVPUnit
    select: manual
  antigrav:
    class: AntiGravityGeneratorUnit
  warpdrive:
    class: WarpDriveUnit
  gyro:
    class: GyroUnit
  weapon:
    class: WeaponUnit
    select: manual
  dbHud:
    class: databank
    select: manual
  telemeter:
    class: TelemeterUnit
    select: manual
  vBooster:
    class: VerticalBooster
  hover:
    class: Hovercraft
  door:
    class: DoorUnit
    select: manual
  switch:
    class: ManualSwitchUnit
    select: manual
  forcefield:
    class: ForceFieldUnit
    select: manual
  atmofueltank:
    class: AtmoFuelContainer
    select: manual
  spacefueltank:
    class: SpaceFuelContainer
    select: manual
  rocketfueltank:
    class: RocketFuelContainer
    select: manual
handlers:
  unit:
    start:
      lua: |
        -- error handling code added by wrap.lua
        __wrap_lua__stopped = false
        __wrap_lua__stopOnError = false
        __wrap_lua__rethrowErrorAlways = false
        __wrap_lua__rethrowErrorIfStopped = true
        __wrap_lua__printError = true
        __wrap_lua__showErrorOnScreens = true
        
        function __wrap_lua__error (message)
          if __wrap_lua__stopped then return end
        
          -- make the traceback more readable and escape HTML syntax characters
          message = tostring(message):gsub('"%-%- |STDERROR%-EVENTHANDLER[^"]*"', 'chunk'):gsub("&", "&amp;"):gsub("<", "&lt;"):gsub(">", "&gt;")
        
          local unit = unit or self or {}
        
          if __wrap_lua__showErrorOnScreens then
            for _, value in pairs(unit) do
              if type(value) == "table" and value.setCenteredText and value.setHTML then -- value is a screen
                if message:match("\n") then
                  value.setHTML([[
        <pre style="color: white; background-color: black; font-family: Consolas,monospace; font-size: 4vh; white-space: pre-wrap; margin: 1em">
        Error: ]] .. message .. [[
        </pre>]])
                else
                  value.setCenteredText(message)
                end
              end
            end
          end
        
          if __wrap_lua__printError and system and system.print then
            system.print("Error: " .. message:gsub("\n", "<br>"))
          end
        
          if __wrap_lua__stopOnError then
            __wrap_lua__stopped = true
          end
        
          if __wrap_lua__stopped and unit and unit.exit then
            unit.exit()
          end
        
          if __wrap_lua__rethrowErrorAlways or (__wrap_lua__stopped and __wrap_lua__rethrowErrorIfStopped) then
            error(message)
          end
        end
        
        -- in case traceback is removed or renamed
        __wrap_lua__traceback = traceback or (debug and debug.traceback) or function (arg1, arg2) return arg2 or arg1 end
        
        local ok, message = xpcall(function ()
        
        -- script code
        
        useTheseSettings = false --export: (Default: false)
        userControlScheme = "virtual joystick" --export: (Default: "virtual joystick") Set to "virtual joystick", "mouse", or "keyboard"
        freeLookToggle = true --export: (Default: true)
        BrakeToggleDefault = true --export: (Default: true)
        RemoteFreeze = false --export: (Default: false)
        RemoteHud = false --export: (Default: false)
        brightHud = false --export: (Default: false)
        VanillaRockets = false --export: (Default: false)
        InvertMouse = false --export: (Default: false)
        autoRollPreference = false --export: (Default: false)
        turnAssist = true --export: (Default: true)
        ExternalAGG = false --export: (Default: false)
        UseSatNav = false --export: (Default: false)
        ShouldCheckDamage = true --export: (Default: true)
        CalculateBrakeLandingSpeed = false --export: (Default: false)
        AtmoSpeedAssist = true --export: (Default: true)
        ForceAlignment = false --export: (Default: false)
        DisplayDeadZone = true --export: (Default: true)
        showHud = true --export: (Default: true) 
        ShowOdometer = true --export: (Default: true)
        hideHudOnToggleWidgets = true --export: (Default: true)
        ShiftShowsRemoteButtons = true --export: (Default: true)
        DisplayOrbit = true --export: (Default: true) 
        YawStallAngle = 35 --export: (Default: 35)
        PitchStallAngle = 35 --export: (Default: 35)
        brakeLandingRate = 30 --export: (Default: 30)
        MaxPitch = 30 --export: (Default: 30)
        TargetOrbitRadius = 1.4 --export: (Default: 1.4)
        AtmoSpeedLimit = 1050 --export: (Default: 1050)
        SpaceSpeedLimit = 30000 --export: (Default: 30000).
        AutoTakeoffAltitude = 1000 --export: (Default: 1000)
        TargetHoverHeight = 50 --export: (Default: 50)
        LandingGearGroundHeight = 0 --export: (Default: 0)
        MaxGameVelocity = 8333.00 --export: (Default: 8333.00)
        AutopilotInterplanetaryThrottle = 1.0 --export: (Default: 1.0)
        warmup = 32 --export: (Default: 32)
        fuelTankHandlingAtmo = 0 --export: (Default: 0)
        fuelTankHandlingSpace = 0 --export: (Default: 0)
        fuelTankHandlingRocket = 0 --export: (Default: 0)
        ContainerOptimization = 0 --export: (Default: 0)
        FuelTankOptimization = 0 --export: (Default: 0)
        ResolutionX = 1920 --export: (Default: 1920)
        ResolutionY = 1080 --export: (Default: 1080) 
        circleRad = 400 --export: (Default: 400)
        SafeR = 130 --export: (Default: 130)
        SafeG = 224 --export: (Default: 224)
        SafeB = 255 --export: (Default: 255)
        PvPR = 255 --export: (Default: 255)
        PvPG = 0 --export: (Default: 0)
        PvPB = 0 --export: (Default: 0)
        centerX = 960 --export: (Default: 960)
        centerY = 540 --export: (Default: 540)
        throtPosX = 1300 --export: (Default: 1300)
        throtPosY = 540 --export: (Default: 540)
        vSpdMeterX = 1525  --export: (Default: 1525)
        vSpdMeterY = 325 --export: (Default: 325)
        altMeterX = 550  --export: (Default: 550)
        altMeterY = 540 --export: (Default: 540) 
        fuelX = 100 --export: (Default: 100)
        fuelY = 300 --export: (Default: 300)
        DeadZone = 50 --export: (Default: 50)
        OrbitMapSize = 250 --export: (Default: 250)
        OrbitMapX = 75 --export: (Default: 75)
        OrbitMapY = 0 --export: (Default: 0)
        speedChangeLarge = 5 --export: (Default: 5)
        speedChangeSmall = 1 --export: (Default: 1)
        MouseYSensitivity = 0.003 --export: (Default: 0.003)
        MouseXSensitivity = 0.003 --export: (Default: 0.003)
        autoRollFactor = 2 --export: (Default: 2)
        rollSpeedFactor = 1.5 --export: (Default: 1.5)
        autoRollRollThreshold = 0 --export: (Default: 0)
        turnAssistFactor = 2 --export: (Default: 2)
        TrajectoryAlignmentStrength = 0.002 --export: (Default: 0.002)
        torqueFactor = 2 --export: (Default: 2)
        pitchSpeedFactor = 0.8 --export: (Default: 0.8)
        yawSpeedFactor = 1 --export: (Default: 1)
        brakeSpeedFactor = 3 --export: (Default: 3)
        brakeFlatFactor = 1 --export: (Default: 1)
        DampingMultiplier = 40 --export: (Default: 40) 
        minRollVelocity = 150 --export: (Default: 150)
        apTickRate = 0.0166667 --export: (Default: 0.0166667)  
        hudTickRate = 0.0666667 --export: (Default: 0.0666667)
        ExtraLongitudeTags = "none" --export: (Default: "none")
        ExtraLateralTags = "none" --export: (Default: "none")
        ExtraVerticalTags = "none" --export: (Default: "none")
        local a=Navigator.new(system,core,unit)script={}VERSION_NUMBER=1.141;SetWaypointOnExit=true;local b={"userControlScheme","TargetOrbitRadius","apTickRate","freeLookToggle","turnAssist","SafeR","SafeG","SafeB","warmup","DeadZone","circleRad","MouseXSensitivity","MouseYSensitivity","MaxGameVelocity","showHud","autoRollPreference","InvertMouse","pitchSpeedFactor","yawSpeedFactor","rollSpeedFactor","brakeSpeedFactor","brakeFlatFactor","autoRollFactor","turnAssistFactor","torqueFactor","AutoTakeoffAltitude","TargetHoverHeight","AutopilotInterplanetaryThrottle","hideHudOnToggleWidgets","DampingMultiplier","fuelTankHandlingAtmo","ExternalAGG","ShouldCheckDamage","fuelTankHandlingSpace","fuelTankHandlingRocket","RemoteFreeze","hudTickRate","speedChangeLarge","speedChangeSmall","brightHud","brakeLandingRate","MaxPitch","AtmoSpeedLimit","centerX","centerY","SpaceSpeedLimit","AtmoSpeedAssist","SetWaypointOnExit","vSpdMeterX","vSpdMeterY","altMeterX","altMeterY","fuelX","fuelY","LandingGearGroundHeight","TrajectoryAlignmentStrength","RemoteHud","YawStallAngle","PitchStallAngle","ResolutionX","ResolutionY","UseSatNav","FuelTankOptimization","ContainerOptimization","ExtraLongitudeTags","ExtraLateralTags","ExtraVerticalTags","OrbitMapSize","OrbitMapX","OrbitMapY","DisplayOrbit","CalculateBrakeLandingSpeed","ForceAlignment","autoRollRollThreshold","minRollVelocity","PvPR","PvPG","PvPB","DisplayDeadZone"}BrakeToggleStatus=BrakeToggleDefault;VertTakeOffEngine=false;BrakeIsOn=false;RetrogradeIsOn=false;ProgradeIsOn=false;Autopilot=false;TurnBurn=false;AltitudeHold=false;BrakeLanding=false;AutoTakeoff=false;Reentry=false;VertTakeOff=false;HoldAltitude=1000;AutopilotAccelerating=false;AutopilotRealigned=false;AutopilotBraking=false;AutopilotCruising=false;AutopilotEndSpeed=0;AutopilotStatus="Aligning"AutopilotPlanetGravity=0;PrevViewLock=1;AutopilotTargetName="None"AutopilotTargetCoords=nil;AutopilotTargetIndex=0;GearExtended=nil;TotalDistanceTravelled=0.0;TotalFlightTime=0;SavedLocations={}VectorToTarget=false;LocationIndex=0;LastMaxBrake=0;LockPitch=nil;LastMaxBrakeInAtmo=0;AntigravTargetAltitude=1000;LastStartTime=0;SpaceTarget=false;LeftAmount=0;IntoOrbit=false;showHelp=true;local c={"showHelp","VertTakeOff","VertTakeOffEngine","SpaceTarget","BrakeToggleStatus","BrakeIsOn","RetrogradeIsOn","ProgradeIsOn","Autopilot","TurnBurn","AltitudeHold","BrakeLanding","Reentry","AutoTakeoff","HoldAltitude","AutopilotAccelerating","AutopilotBraking","AutopilotCruising","AutopilotRealigned","AutopilotEndSpeed","AutopilotStatus","AutopilotPlanetGravity","PrevViewLock","AutopilotTargetName","AutopilotTargetCoords","AutopilotTargetIndex","TotalDistanceTravelled","TotalFlightTime","SavedLocations","VectorToTarget","LocationIndex","LastMaxBrake","LockPitch","LastMaxBrakeInAtmo","AntigravTargetAltitude","LastStartTime"}local d=math.abs;local e=math.floor;local f=string.format;local g=json.decode;local h=json.encode;local j=core.getElementMaxHitPointsById;local k=unit.getAtmosphereDensity;local l=core.getElementMassById;local m=core.getConstructMass;local n=a.control.isRemoteControlled;local o=math.atan;local p=string.match;local tostring=tostring;local q=utils.round;local r=system.getTime;local vec3=vec3;local s=utils.clamp;local t=a.axisCommandManager;local u=system.destroyWidgetPanel;local v=system.updateData;local w=system.addDataToWidget;local x=system.lockView;local y=system.isViewLocked;local function z(A,B)local C=10^(B or 0)return e(A*C+0.5)/C end;local D=SafeR;local E=SafeB;local F=SafeG;local G=false;local H=0;local I=0;local J=0;local K=false;local L=0;local M=false;local N=z(ResolutionX/2,0)local O=z(ResolutionY/2,0)local P=false;local Q=55;local R=false;local S=false;local T=0;local U=0;local V=0;local W=0;local X=0;local Y=0;local Z=0;local a0=false;local a1=false;local a2="empty"local a3=5;local a4=5;local a5=a3;local a6=a4;local a7=false;local a8,a9=0;local aa,ab=0;local ac=nil;local ad=0;local ae=0;local af=false;local ag=0;local ah=0;local ai=0;local aj=3;local ak=0;local al=""local am=""local an=0;local ao=false;local ap=false;local aq=false;local ar=-1;local as=false;local at=""local au=k()>0;local av=k()local aw=core.getAltitude()local ax=core.getElementIdList()local ay=r()local az=nil;local aA=false;local aB=[[rgb(]]..e(D+0.5)..","..e(F+0.5)..","..e(E+0.5)..[[)]]local aC=[[rgb(]]..e(D*0.9+0.5)..","..e(F*0.9+0.5)..","..e(E*0.9+0.5)..[[)]]local aD={}local aE=0;local aF=0;local aG=""local aH=true;local aI={}local aJ=ResolutionX;local aK=ResolutionY;local aL=false;local aM=false;local aN=0;local aO=nil;local aP={}local aQ={}local aR={}local aS=0;local aT=false;local aU={}local aV={}local aW=e(1/apTickRate)*2;local aX={}local aY={}local aZ={}local a_={}local b0=false;local b1=16;local b2=0;local b3=nil;local b4=""local b5=nil;local b6=nil;local b7=nil;local b8=nil;local b9=nil;local ba=nil;local bb=nil;local bc=nil;local bd=nil;local be=false;local bf=false;local bg=autoRollPreference;local bh=LandingGearGroundHeight;local bi=system.getMouseDeltaX()local bj=system.getMouseDeltaY()local bk=false;local bl=r()local bm=0;local bn=0;local bo=0;local bp=AtmoSpeedLimit;local bq=0;local br=nil;local bs=0;local bt=0;local bu=false;local bv=false;local bw={VectorToTarget=false}local bx=false;local by=0;local bz=nil;local bA=false;local bB=false;local bC=false;local bD=false;local bE=0;local bF=r()local bG=vec3(core.getConstructWorldOrientationUp())local bH=vec3(core.getConstructWorldOrientationForward())local bI=vec3(core.getConstructWorldOrientationRight())local bJ=vec3(core.getWorldVelocity())local bK=vec3(bJ):len()local bL=vec3(core.getWorldVertical())local bM=-bL:dot(bJ)local bN=vec3(core.getConstructWorldPos())local bO=false;local bP=false;local bQ=nil;local bR=true;local bS=0;local bT=0;local function bU(bV,bW)if t:getAxisCommandType(0)~=axisCommandType.byThrottle and not bW then a.control.cancelCurrentControlMasterMode()end;t:setThrottleCommand(axisCommandId.longitudinal,bV)I=s(z(bV*100,0)/100,-1,1)end;local function bX(bV,bW)if t:getAxisCommandType(0)~=axisCommandType.byTargetSpeed and not bW then a.control.cancelCurrentControlMasterMode()end;t:setTargetSpeedCommand(axisCommandId.longitudinal,bV)bQ=bV end;local function bY()AtlasOrdered={}for bZ,b_ in pairs(b3[0])do table.insert(AtlasOrdered,{name=b_.name,index=bZ})end;local function c0(c1,c2)return c1.name<c2.name end;table.sort(AtlasOrdered,c0)end;local function c3(c4,c5)if c4==0 then return d(c5)<1e-09 end;if c5==0 then return d(c4)<1e-09 end;return d(c4-c5)<math.max(d(c4),d(c5))*epsilon end;local function c6(ak,c7)local c8=ak>100000;local c9,ca=""if c7==nil then c7=1 end;if c8 then c9,ca=z(ak/1000/200,c7),"SU"elseif ak<1000 then c9,ca=z(ak,c7),"M"else c9,ca=z(ak/1000,c7),"KM"end;return c9,ca end;local function cb(cc)for bZ,b_ in pairs(cc)do if b_.name and b_.name==CustomTarget.name then return bZ end end;return-1 end;local function cd()if VertTakeOff then AltitudeHold=false;StrongBrakes=true;Reentry=false;AutoTakeoff=false;AltitudeHold=false;BrakeLanding=true;VertTakeOff=false;bg=true;ag=0;if au and ar==-1 then BrakeLanding=false;AltitudeHold=true;ag=0;a:setEngineForceCommand('thrust analog vertical fueled ',vec3(),1)bX(e(bp))end else VertTakeOff=true;AltitudeHold=false;bA=false;GearExtended=false;a.control.retractLandingGears()t:setTargetGroundAltitude(TargetHoverHeight)BrakeIsOn=true end end;local function ce()bA=false;bs=nil;bt=nil;bE=0;if av==0 then if IntoOrbit then IntoOrbit=false;bu=false;bz=nil;bg=autoRollPreference;if AltitudeHold then AltitudeHold=false;AutoTakeoff=false end;bw.VectorToTarget=false;bw.AutopilotAlign=false;bx=false elseif unit.getClosestPlanetInfluence()>0 then IntoOrbit=true;bg=true;if bz==nil then bz=planet end;if AltitudeHold then AltitudeHold=false;AutoTakeoff=false end else a2="Unable to engage orbiting, not near planet"end else IntoOrbit=false;bu=false;bz=nil;bg=autoRollPreference;if AltitudeHold then AltitudeHold=false end;bw.VectorToTarget=false;bw.AutopilotAlign=false;bx=false end end;local function cf()if bF-bn<1.5 then if planet.hasAtmosphere then if av>0 then HoldAltitude=planet.spaceEngineMinAltitude-50 else if unit.getClosestPlanetInfluence()>0 then HoldAltitude=planet.noAtmosphericDensityAltitude+1000;by=HoldAltitude;bx=true;if not IntoOrbit then ce()end;bu=true end end;bn=-1;if AltitudeHold or IntoOrbit or VertTakeOff then return end end else bn=bF end;if unit.getClosestPlanetInfluence()>0 and av==0 then by=aw;bx=true;bu=true;ce()if IntoOrbit then bn=bF else bn=0 end;return end;AltitudeHold=not AltitudeHold;BrakeLanding=false;Reentry=false;if AltitudeHold then Autopilot=false;ProgradeIsOn=false;RetrogradeIsOn=false;a0=false;bg=true;LockPitch=nil;bA=false;if ar==-1 then AutoTakeoff=false;if bn>-1 then if unit.getClosestPlanetInfluence()>0 then HoldAltitude=aw end end;if VertTakeOff then cd()end else AutoTakeoff=true;if bn>-1 then HoldAltitude=aw+AutoTakeoffAltitude end;GearExtended=false;a.control.retractLandingGears()BrakeIsOn=true;t:setTargetGroundAltitude(TargetHoverHeight)if VertTakeOffEngine and bO then cd()end end;if ap then HoldAltitude=100000 end else if IntoOrbit then ce()end;if VertTakeOff then cd()end;bg=autoRollPreference;AutoTakeoff=false;VectorToTarget=false;bn=0 end end;local function cg()if n()==1 then a0=not a0;if a0 then Autopilot=false;RetrogradeIsOn=false;ProgradeIsOn=false;AltitudeHold=false;Reentry=false;BrakeLanding=false;AutoTakeoff=false;OldGearExtended=GearExtended;GearExtended=false;a.control.retractLandingGears()t:setTargetGroundAltitude(TargetHoverHeight)else BrakeIsOn=true;bg=autoRollPreference;GearExtended=OldGearExtended;if GearExtended then a.control.extendLandingGears()t:setTargetGroundAltitude(LandingGearGroundHeight)end end else a2="Follow Mode only works with Remote controller"a0=false end end;local function ch()if AutopilotTargetIndex==0 then AutopilotTargetName="None"ac=nil;CustomTarget=nil;return true end;local ci=AtlasOrdered[AutopilotTargetIndex].index;local cj=b3[0][ci]if cj.center then AutopilotTargetName=cj.name;ac=b9[0][ci]if CustomTarget~=nil then if av==0 then if v(widgetMaxBrakeTimeText,widgetMaxBrakeTime)~=1 then w(widgetMaxBrakeTimeText,widgetMaxBrakeTime)end;if v(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)~=1 then w(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)end;if v(widgetCurBrakeTimeText,widgetCurBrakeTime)~=1 then w(widgetCurBrakeTimeText,widgetCurBrakeTime)end;if v(widgetCurBrakeDistanceText,widgetCurBrakeDistance)~=1 then w(widgetCurBrakeDistanceText,widgetCurBrakeDistance)end;if v(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)~=1 then w(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end end;if v(widgetMaxMassText,widgetMaxMass)~=1 then w(widgetMaxMassText,widgetMaxMass)end;if v(widgetTravelTimeText,widgetTravelTime)~=1 then w(widgetTravelTimeText,widgetTravelTime)end;if v(widgetTargetOrbitText,widgetTargetOrbit)~=1 then w(widgetTargetOrbitText,widgetTargetOrbit)end end;CustomTarget=nil else CustomTarget=cj;for _,b_ in pairs(b9[0])do if b_.name==CustomTarget.planetname then ac=b_;AutopilotTargetName=CustomTarget.name;break end end;if v(widgetMaxMassText,widgetMaxMass)~=1 then w(widgetMaxMassText,widgetMaxMass)end;if v(widgetTravelTimeText,widgetTravelTime)~=1 then w(widgetTravelTimeText,widgetTravelTime)end end;if CustomTarget==nil then AutopilotTargetCoords=vec3(ac.center)else AutopilotTargetCoords=CustomTarget.position end;if ac.planetname~="Space"then if ac.hasAtmosphere then AutopilotTargetOrbit=e(ac.radius*(TargetOrbitRadius-1)+ac.noAtmosphericDensityAltitude)else AutopilotTargetOrbit=e(ac.radius*(TargetOrbitRadius-1)+ac.surfaceMaxAltitude)end else AutopilotTargetOrbit=1000 end;if CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotEndSpeed=0 else _,AutopilotEndSpeed=bc(ac):escapeAndOrbitalSpeed(AutopilotTargetOrbit)end;AutopilotPlanetGravity=0;AutopilotAccelerating=false;AutopilotBraking=false;AutopilotCruising=false;Autopilot=false;AutopilotRealigned=false;AutopilotStatus="Aligning"return true end;local function ck(cl)if not Autopilot and not VectorToTarget and not ap and not IntoOrbit then if cl==nil then AutopilotTargetIndex=AutopilotTargetIndex+1;if AutopilotTargetIndex>#AtlasOrdered then AutopilotTargetIndex=0 end else AutopilotTargetIndex=AutopilotTargetIndex-1;if AutopilotTargetIndex<0 then AutopilotTargetIndex=#AtlasOrdered end end;if AutopilotTargetIndex==0 then ch()else local ci=AtlasOrdered[AutopilotTargetIndex].index;local cj=b3[0][ci]if cj.name=="Space"then if cl==nil then ck()else ck(1)end else ch()end end else a2="Disengage autopilot before changing Interplanetary Helper"end end;local function cm(planet,cn)local function co(cp,cq)local cr=vec3(cq)if cp.bodyId==0 then return setmetatable({latitude=cr.x,longitude=cr.y,altitude=cr.z,bodyId=0,systemId=cp.planetarySystemId},MapPosition)end;local cs=cr-cp.center;local ak=cs:len()local ct=ak-cp.radius;local cu=0;local cv=0;if not c3(ak,0)then local cw=o(cs.y,cs.x)cv=cw>=0 and cw or 2*math.pi+cw;cu=math.pi/2-math.acos(cs.z/ak)end;return setmetatable({latitude=math.deg(cu),longitude=math.deg(cv),altitude=ct,bodyId=cp.bodyId,systemId=cp.planetarySystemId},MapPosition)end;local cx=co(planet,cn)cx="::pos{"..cx.systemId..","..cx.bodyId..","..cx.latitude..","..cx.longitude..","..cx.altitude.."}"system.setWaypoint(cx)end;local function cy()local function cz(SpaceTarget)VectorToTarget=not VectorToTarget;if VectorToTarget then TurnBurn=false;if not AltitudeHold and not SpaceTarget then cf()end end;VectorStatus="Proceeding to Waypoint"end;if bF-bo<1.5 and av>0 then if not bD then a2="No space engines detected, Orbital Hop not supported"return end;if planet.hasAtmosphere then if av>0 then HoldAltitude=planet.noAtmosphericDensityAltitude+1000 end;bo=-1;if Autopilot or VectorToTarget then return end end else bo=bF end;TargetSet=false;if AutopilotTargetIndex>0 and not Autopilot and not VectorToTarget and not ap then ch()cm(ac,AutopilotTargetCoords)if CustomTarget~=nil then LockPitch=nil;SpaceTarget=CustomTarget.planetname=="Space"if SpaceTarget then if av~=0 then ap=true;cf()else Autopilot=true end elseif planet.name==CustomTarget.planetname then StrongBrakes=true;if av>0 then if not VectorToTarget then cz(SpaceTarget)end else if aw>AutopilotTargetOrbit*1.5 or aw==0 then bA=false;Autopilot=true elseif not au then if IntoOrbit then ce()end;by=planet.noAtmosphericDensityAltitude+1000;bx=true;bw.AutopilotAlign=true;bw.VectorToTarget=true;bu=false;if not IntoOrbit then ce()end end end else RetrogradeIsOn=false;ProgradeIsOn=false;if av~=0 then ap=true;cf()else Autopilot=true end end elseif av==0 then local cA=unit.getClosestPlanetInfluence()>0;if CustomTarget==nil and(ac.name==planet.name and cA)and not IntoOrbit then WaypointSet=false;bA=false;bu=false;ce()else Autopilot=true;RetrogradeIsOn=false;ProgradeIsOn=false;AutopilotRealigned=false;a0=false;AltitudeHold=false;BrakeLanding=false;Reentry=false;AutoTakeoff=false;P=false;LockPitch=nil;WaypointSet=false end else ap=true;cf()end else ap=false;Autopilot=false;AutopilotRealigned=false;VectorToTarget=false;P=false;AutoTakeoff=false;AltitudeHold=false;VectorToTarget=false;HoldAltitude=aw;TargetSet=false;Reentry=false;if IntoOrbit then ce()end end end;local function cB(cC)local cD=-1;local cE;cD=cb(SavedLocations)if cD~=-1 then local cF;if cC~=nil then cE={position=SavedLocations[cD].position,name=cC,atmosphere=SavedLocations[cD].atmosphere,planetname=SavedLocations[cD].planetname,gravity=SavedLocations[cD].gravity}else cE={position=bN,name=SavedLocations[cD].name,atmosphere=av,planetname=planet.name,gravity=unit.getClosestPlanetInfluence(),safe=true}end;SavedLocations[cD]=cE;cD=-1;cD=cb(b3[0])if cD>-1 then b3[0][cD]=cE end;bY()a2=CustomTarget.name.." position updated"AutopilotTargetIndex=0;ch()else a2="Name Not Found"end end;local function cG()BrakeIsOn=not BrakeIsOn;if BrakeLanding then BrakeLanding=false;bg=autoRollPreference end;if BrakeIsOn then AltitudeHold=false;VectorToTarget=false;AutoTakeoff=false;VertTakeOff=false;Reentry=false;ProgradeIsOn=false;BrakeLanding=false;AutoLanding=false;AltitudeHold=false;if VertTakeOff then cd()end;if IntoOrbit then ce()end;LockPitch=nil;bg=autoRollPreference;ao=false;aq=false;ag=0 end end;local function cH(cI,cJ,cK)local function cL(cI,cM)cI=vec3(cI)cM=vec3(cM):normalize()local c9=cI*cM;return c9.x+c9.y+c9.z end;local cN=0.001;local cO=1;if not au or not bk or ar~=-1 or bK<Q then local cP=cK;if cP==nil then cP=DampingMultiplier end;if cJ==nil then cJ=cN end;cI=vec3(cI):normalize()local cQ=vec3()-cI;local cR=-cL(cQ,core.getConstructWorldOrientationRight())*cO;local cS=-cL(cQ,core.getConstructWorldOrientationUp())*cO;if aE==0 then aE=cR/2 end;if aF==0 then aF=cS/2 end;if d(cR)<0.1 then V=V-cR*2 else V=V-(cR+(cR-aE)*cP)end;if d(cS)<0.1 then U=U+cS*2 else U=U+cS+(cS-aF)*cP end;aE=cR;aF=cS;if d(cR)<cJ and d(cS)<cJ then return true end;return false elseif bk and ar==-1 then cI=bJ;local cP=cK;if cP==nil then cP=DampingMultiplier end;if cJ==nil then cJ=cN end;cI=vec3(cI):normalize()local cQ=bH-cI;local cR=-cL(cQ,core.getConstructWorldOrientationRight())*cO;local cS=-cL(cQ,core.getConstructWorldOrientationUp())*cO;if aE==0 then aE=cR/2 end;if aF==0 then aF=cS/2 end;if d(cR)<0.1 then V=V-cR*5 else V=V-(cR+(cR-aE)*cP)end;if d(cS)<0.1 then U=U+cS*5 else U=U+cS+(cS-aF)*cP end;aE=cR;aF=cS;if d(cR)<cJ and d(cS)<cJ then return true end;return false end end;local function cT()if Reentry then a2="Re-Entry cancelled"Reentry=false;bg=autoRollPreference;AltitudeHold=false elseif not planet.hasAtmosphere then a2="Re-Entry requirements not met: you must start out of atmosphere\n and within a planets gravity well over a planet with atmosphere"aj=5 elseif not R then StrongBrakes=planet.gravity*9.80665*m()<LastMaxBrakeInAtmo;if not StrongBrakes then a2="WARNING: Insufficient Brakes for Parachute Re-Entry"else Reentry=true;if t:getAxisCommandType(0)~=controlMasterModeId.cruise then a.control.cancelCurrentControlMasterMode()end;bg=true;BrakeIsOn=false;a2="Beginning Parachute Re-Entry - Strap In.  Target speed: "..bp end else Reentry=true;AltitudeHold=true;bg=true;BrakeIsOn=false;HoldAltitude=planet.spaceEngineMinAltitude-50;local cU,cV=c6(HoldAltitude)a2="Beginning Re-entry.  Target speed: "..bp.." Target Altitude: "..cU..cV;bX(e(bp))end;AutoTakeoff=false end;local function cW()if antigrav and not ExternalAGG then if bP then antigrav.deactivate()antigrav.hide()else if AntigravTargetAltitude==nil then AntigravTargetAltitude=aw end;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;antigrav.activate()antigrav.show()end end end;local function cX(cY)local cZ=0;local c_=0;local d0=0;if cY<60 then cY=e(cY)elseif cY<3600 then cZ=e(cY/60)cY=e(cY%60)elseif cY<86400 then c_=e(cY/3600)cZ=e(cY%3600/60)else d0=e(cY/86400)c_=e(cY%86400/3600)end;if d0>0 then return d0 .."d "..c_.."h "elseif c_>0 then return c_.."h "..cZ.."m "elseif cZ>0 then return cZ.."m "..cY.."s"elseif cY>0 then return cY.."s"else return"0s"end end;local function d1()local d2=-1;if telemeter_1 then d2=telemeter_1.getDistance()end;if ar~=-1 and d2~=-1 then if ar<d2 then return ar else return d2 end elseif ar~=-1 then return ar else return d2 end end;local function d3(d4)local function d5(d6)for bZ,b_ in pairs(d6)do dbHud_1.setStringValue(b_,h(_G[b_]))if d4 and dbHud_2 then dbHud_2.setStringValue(b_,h(_G[b_]))end end end;if dbHud_1 then if not af then d5(c)d5(b)system.print("Saved Variables to Datacore")if d4 and dbHud_2 then a2="Databank copied.  Remove copy when ready."end end end end;local function d7()local function d8(b_)if aJ==1920 then return b_ else return z(aJ*b_/1920,0)end end;local function d9(b_)if aK==1080 then return b_ else return z(aK*b_/1080,0)end end;local function da()return y()==0 and userControlScheme~="keyboard"and n()==0 end;local function db()local dc="TRAVEL"if not bR then dc="CRUISE"end;if Autopilot then dc="AUTOPILOT"end;return dc end;local function dd(de,b0,df,dg,dh,di,dj,dk)local dl=1;local dm=2;local dn=3;local dp=4;local dq=5;local dr=6;local ds=""local dt=0;local du=fuelY;local dv=fuelY+10;if n()==1 and not RemoteHud then du=du-50;dv=dv-50 end;de[#de+1]=[[<g class="pdim txtfuel">]]if dh=="ATMO"then ds="atmofueltank"elseif dh=="SPACE"then ds="spacefueltank"else ds="rocketfueltank"end;dt=_G[ds.."_size"]if#di>0 then for i=1,#di do local dw=string.sub(di[i][dm],1,12)local dx=0;for dy=1,dt do if di[i][dm]==g(unit[ds.."_"..dy].getData()).name then dx=dy;break end end;if b0 or dj[i]==nil or dk[i]==nil then local dz=0;local dA=0;local dB=0;local dC=0;local dD=r()if dx~=0 then dk[i]=g(unit[ds.."_"..dx].getData()).percentage;dj[i]=g(unit[ds.."_"..dx].getData()).timeLeft;if dj[i]=="n/a"then dj[i]=0 end else dB=l(di[i][dl])-di[i][dp]dz=di[i][dn]dk[i]=e(0.5+dB*100/dz)dA=di[i][dq]dC=di[i][dr]if dA<=dB then dj[i]=0 else dj[i]=e(0.5+dB/((dA-dB)/(dD-dC)))end;di[i][dq]=dB;di[i][dr]=dD end end;if dw==dg then dw=f("%s %d",dh,i)end;if dx==0 then dw=dw.." *"end;local dE;if dj[i]==0 then dE="n/a"else dE=cX(dj[i])end;if dk[i]~=nil then local dF=e(dk[i]*2.55)local dG=f("rgb(%d,%d,%d)",255-dF,dF,0)local dH=""if dE~="n/a"and dj[i]<120 or dk[i]<5 then if b0 then dH=[[class="red"]]end end;de[#de+1]=f([[
                                        <text x=%d y="%d" %s>%s</text>
                                        <text x=%d y="%d" style="fill:%s">%d%% %s</text>
                                    ]],df,du,dH,dw,df,dv,dG,dk[i],dE)du=du+30;dv=dv+30 end end end;de[#de+1]="</g>"end;local function dI(de,ct)if ct<200000 and not au or ct and au then local dJ=0;if d(bM)>1 then dJ=45*math.log(d(bM),10)if bM<0 then dJ=-dJ end end;de[#de+1]=f([[
                                <g class="pbright txt txtvspd" transform="translate(%d %d) scale(0.6)">
                                        <text x="31" y="-41">1000</text>
                                        <text x="-10" y="-65">100</text>
                                        <text x="-54" y="-45">10</text>
                                        <text x="-73" y="3">O</text>
                                        <text x="-56" y="52">-10</text>
                                        <text x="-14" y="72">-100</text>
                                        <text x="29" y="50">-1000</text>
                                        <text x="85" y="0" class="txtvspdval txtend">%d m/s</text>
                                    <g class="linethick">
                                        <path d="m-41 75 2.5-4.4m17 12 1.2-4.9m20 7.5v-10m-75-34 4.4-2.5m-12-17 4.9-1.2m17 40 7-7m-32-53h10m34-75 2.5 4.4m17-12 1.2 4.9m20-7.5v10m-75 34 4.4 2.5m-12 17 4.9 1.2m17-40 7 7m-32 53h10m116 75-2.5-4.4m-17 12-1.2-4.9m40-17-7-7m-12-128-2.5 4.4m-17-12-1.2 4.9m40 17-7 7"/>
                                        <circle r="90" />
                                    </g>
                                    <path transform="rotate(%d)" d="m-0.094-7c-22 2.2-45 4.8-67 7 23 1.7 45 5.6 67 7 4.4-0.068 7.8-4.9 6.3-9.1-0.86-2.9-3.7-5-6.8-4.9z" />
                                </g>
                            ]],vSpdMeterX,vSpdMeterY,e(bM),e(dJ))end;return de end;local function dK(dL)local cl=-bL;dL=dL-dL:project_on(cl)local dM=vec3(0,0,1)dM=dM-dM:project_on(cl)local dN=dM:cross(cl)local dJ=dM:angle_between(dL)*constants.rad2deg;if dL:dot(dN)<0 then dJ=360-dJ end;return dJ end;local function dO(de,centerX,centerY,dP,dQ,cA)local dR=circleRad;local dS=20;local dT=e(dP)if cA then for i=-45,45,5 do local dU=i;de[#de+1]=f([[<g transform="rotate(%f,%d,%d)">]],dU,centerX,centerY)len=5;if i%15==0 then len=15 elseif i%10==0 then len=10 end;de[#de+1]=f([[<line x1=%d y1=%d x2=%d y2="%d"/></g>]],centerX,centerY+dR+dS-len,centerX,centerY+dR+dS)end;de[#de+1]=f([["
                                <g class="pdim txt txtmid">
                                    <text x="%d" y="%d">%s</text>
                                    <text x="%d" y="%d">%d deg</text>
                                </g>
                                ]],centerX,centerY+dR+dS-35,dQ,centerX,centerY+dR+dS-25,dT)de[#de+1]=f([[<g transform="rotate(%f,%d,%d)">]],-dP,centerX,centerY)de[#de+1]=f([[<<polygon points="%d,%d %d,%d %d,%d"/>]],centerX-5,centerY+dR+dS-20,centerX+5,centerY+dR+dS-20,centerX,centerY+dR+dS-15)de[#de+1]="</g>"end;local dV=dT;if cA then dV=dK(bH)end;local dW=20;local dX=e(dV)local dY=0;local dZ=centerY+dR+dS+20;local d_=centerX;if dQ~="YAW"then dZ=d9(130)d_=d8(960)end;local e0=[[<path class="txttick line" d="]]for i=e(dX-(dW+10)-dX%5+0.5),e(dX+dW+10+dX%5+0.5),5 do local df=d_+-i*5+dV*5;if i%10==0 then dY=10;local A=i;if A==360 then A=0 elseif A>360 then A=A-360 elseif A<0 then A=A+360 end;de[#de+1]=f([[
                                        <text x="%f" y="%f">%d</text>]],df+5,dZ-12,A)elseif i%5==0 then dY=5 end;if dY==10 then e0=f([[%s M %f %f v %d]],e0,df,dZ-5,dY)else e0=f([[%s M %f %f v %d]],e0,df,dZ-2.5,dY)end end;de[#de+1]=e0 ..[["/>]]de[#de+1]=f([[<<polygon points="%d,%d %d,%d %d,%d"/>]],d_-5,dZ+10,d_+5,dZ+10,d_,dZ+5)if cA then dQ="HDG"end;de[#de+1]=f([["
                            <g class="pdim txt txtmid">
                            <text x="%d" y="%d">%d deg</text>
                            <text x="%d" y="%d">%s</text>
                            </g>
                            ]],d_,dZ+25,dX,d_,dZ+35,dQ)end;local function e1(de,e2,dP,centerX,centerY,cA,e3,e4)local dR=circleRad;local e5=e(dR*3/5)if dR>0 then local e6=e(e2)local len=0;local e0=f([[<path transform="rotate(%f,%d,%d)" class="dim line" d="]],-1*dP,centerX,centerY)if not au then e0=f([[<path transform="rotate(0,%d,%d)" class="dim line" d="]],centerX,centerY)end;de[#de+1]=f([[<clipPath id="cut"><circle r="%f" cx="%d" cy="%d"/></clipPath>]],dR-1,centerX,centerY)de[#de+1]=[[<g class="dim txttick" clip-path="url(#cut)">]]for i=e(e6-30-e6%5+0.5),e(e6+30+e6%5+0.5),5 do if i%10==0 then len=30 elseif i%5==0 then len=20 end;local e7=centerY+-i*5+e2*5;if len==30 then e0=f([[%s M %d %f h %d]],e0,centerX-e5-len,e7,len)if au then de[#de+1]=f([[<g path transform="rotate(%f,%d,%d)" class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],-1*dP,centerX,centerY,centerX-e5+10,e7,i)de[#de+1]=f([[<g path transform="rotate(%f,%d,%d)" class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],-1*dP,centerX,centerY,centerX+e5-10,e7,i)if i==0 or i==180 or i==-180 then de[#de+1]=f([[<path transform="rotate(%f,%d,%d)" d="m %d,%f %d,0" stroke-width="1" style="fill:none;stroke:#F5B800;" />]],-1*dP,centerX,centerY,centerX-e5+20,e7,e5*2-40)end else de[#de+1]=f([[<g class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],centerX-e5+10,e7,i)de[#de+1]=f([[<g class="pdim txt txtmid"><text x="%d" y="%f">%d</text></g>]],centerX+e5-10,e7,i)end;e0=f([[%s M %d %f h %d]],e0,centerX+e5,e7,len)else e0=f([[%s M %d %f h %d]],e0,centerX-e5-len,e7,len)e0=f([[%s M %d %f h %d]],e0,centerX+e5,e7,len)end end;de[#de+1]=e0 ..[["/>]]local e8="PITCH"if not cA then e8="REL PITCH"end;if e2>90 and not au then e2=90-(e2-90)elseif e2<-90 and not au then e2=-90-(e2+90)end;if dR>200 then if au then if e4>Q then de[#de+1]=f([["
                                        <g class="pdim txt txtmid">
                                        <text x="%d" y="%d">%s</text>
                                        <text x="%d" y="%d">%d deg</text>
                                        </g>
                                        ]],centerX,centerY-15,"Yaw",centerX,centerY+20,e3)end;de[#de+1]=f([[<g transform="rotate(%f,%d,%d)">]],-dP,centerX,centerY)else de[#de+1]=f([[<g transform="rotate(0,%d,%d)">]],centerX,centerY)end;de[#de+1]=f([[<<polygon points="%d,%d %d,%d %d,%d"/> class="pdim txtend"><text x="%d" y="%f">%d</text>]],centerX-e5+25,centerY-5,centerX-e5+20,centerY,centerX-e5+25,centerY+5,centerX-e5+50,centerY+4,e6)de[#de+1]=f([[<<polygon points="%d,%d %d,%d %d,%d"/> class="pdim txtend"><text x="%d" y="%f">%d</text>]],centerX+e5-25,centerY-5,centerX+e5-20,centerY,centerX+e5-25,centerY+5,centerX+e5-30,centerY+4,e6)de[#de+1]="</g>"end;local e9=e(dR/3)de[#de+1]=f([[<path d="m %d,%d %d,0" stroke-width="2" style="fill:none;stroke:#F5B800;" />]],centerX-e9,centerY,dR-e9)if not au and cA then de[#de+1]=f([[<path transform="rotate(%f,%d,%d)" d="m %d,%f %d,0" stroke-width="1" style="fill:none;stroke:#F5B800;" />]],-1*dP,centerX,centerY,centerX-e5+10,centerY,e5*2-20)end;de[#de+1]="</g>"if dR<200 then if au and e4>Q then de[#de+1]=f([["
                                    <g class="pdim txt txtmid">
                                    <text x="%d" y="%d">%s</text>
                                    <text x="%d" y="%d">%d deg</text>
                                    <text x="%d" y="%d">%s</text>
                                    <text x="%d" y="%d">%d deg</text>
                                    </g>
                                    ]],centerX,centerY-dR,e8,centerX,centerY-dR+10,e6,centerX,centerY-15,"Yaw",centerX,centerY+20,e3)else de[#de+1]=f([["
                                    <g class="pdim txt txtmid">
                                    <text x="%d" y="%d">%s</text>
                                    <text x="%d" y="%d">%d deg</text>
                                    </g>
                                    ]],centerX,centerY-dR,e8,centerX,centerY-dR+15,e6)end end end end;local function ea(de,ct,cA)local eb=altMeterX;local ec=altMeterY;local ed=78;local ee=19;local ef=d1()if ef~=-1 then table.insert(de,f([[
                            <g class="pdim altsm txtend">
                            <text x="%d" y="%d">AGL: %.1fm</text>
                            </g>
                            ]],eb+ed,ec+ee+20,ef))end;if cA and(ct<200000 and not au or ct and au)then table.insert(de,f([[
                                <g class="pdim">                        
                                    <rect class="line" x="%d" y="%d" width="%d" height="%d"/> 
                                    <clipPath id="alt"><rect class="line" x="%d" y="%d" width="%d" height="%d"/></clipPath>
                                    <g clip-path="url(#alt)">]],eb-1,ec-4,ed+2,ee+6,eb+1,ec-1,ed-4,ee))local cD=0;local eg=1;local eh=0;local ei=ct<0;local ej=9;if ei then ej=0 end;local ct=d(ct)while cD<6 do local ek=11;local el=16;local em=9;local en=14;local dH="altsm"if cD>2 then el=el+3;ek=ek+2;en=en+2;em=em-6;dH="altbig"end;if ei then dH=dH.." red"end;local eo=ct/eg%10;local ep=e(eo)local eq=e((ep+1)%10)local er=eh;if cD==0 then er=eo-ep;if ei then er=1-er end end;if ei and(cD==0 or eh~=0)then local es=eq;eq=ep;ep=es end;local et=el*(er-1)local eu=et+el;local df=eb+em+(6-cD)*ek;local e7=ec+en;table.insert(de,f([[
                                    <g class="%s">
                                    <text x="%d" y="%f">%d</text>
                                    <text x="%d" y="%f">%d</text>
                                    </g>
                                ]],dH,df,e7+et,eq,df,e7+eu,ep))cD=cD+1;eg=eg*10;if ep==ej then eh=er else eh=0 end end;table.insert(de,[[</g></g>]])end end;local function ev(ew)ew=vec3(ew)local ex=-math.deg(o(ew.y,ew.z))+180;ex=ex-90;if ex<0 then ex=360+ex end;if ex>180 then ex=-180+ex-180 end;return-ex end;local function ey(ew)ew=vec3(ew)local dV=math.deg(o(ew.y,ew.x))-90;if dV<-180 then dV=360+dV end;return dV end;local function ez(de,ew,e4,centerX,centerY)if e4>5 and not au or e4>Q then local dR=circleRad;local eA=20;local eB=20;local eC=vec3(ew)local eD=ev(eC)local eE=ey(eC)local eF=14;local eG=eF/2;local eH=-eE/eB*dR;local eI=eD/eA*dR;local df=centerX+eH;local e7=centerY+eI;local ak=math.sqrt(eH^2+eI^2)local eJ=[[<circle
                            cx="]]..df..[["
                            cy="]]..e7 ..[["
                            r="]]..eG/eF..[["
                            style="fill:#d7fe00;stroke:none;fill-opacity:1"/>
                        <circle
                            cx="]]..df..[["
                            cy="]]..e7 ..[["
                            r="]]..eG..[["
                            style="stroke:#d7fe00;stroke-opacity:1;fill:none" />
                        <path
                            d="M ]]..df-eF..[[,]]..e7 ..[[ h ]]..eG..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />
                        <path
                            d="M ]]..df+eG..[[,]]..e7 ..[[ h ]]..eG..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />
                        <path
                            d="M ]]..df..[[,]]..e7-eF..[[ v ]]..eG..[["
                            style="stroke:#d7fe00;stroke-opacity:1" />]]if ak<dR then de[#de+1]=eJ else local dJ=o(eI,eH)local eK=4;local eL=centerX+dR*math.cos(dJ)local eM=centerY+dR*math.sin(dJ)de[#de+1]=f('<g transform="rotate(%f %f %f)"><rect x="%f" y="%f" width="%f" height="%f" stroke="#d7fe00" fill="#d7fe00" /><path d="M %f %f l %f %f l %f %f z" fill="#d7fe00" stroke="#d7fe00"></g>',dJ*180/math.pi,eL,eM,eL-eK,eM-eK/2,eK*2,eK,eL+eK,eM-eK,eK,eK,-eK,eK)end;if not au then eD=ev(-eC)eE=ey(-eC)eH=-eE/eB*dR;eI=eD/eA*dR;df=centerX+eH;e7=centerY+eI;ak=math.sqrt(eH^2+eI^2)if ak<dR then local eN=[[<circle
                                    cx="]]..df..[["
                                    cy="]]..e7 ..[["
                                    r="]]..eG..[["
                                    style="stroke:#d7fe00;stroke-opacity:1;fill:none" />
                                <path
                                    d="M ]]..df..[[,]]..e7-eF..[[ v ]]..eG..[["
                                    style="stroke:#d7fe00;stroke-opacity:1" id="l"/>
                                <use
                                    xlink:href="#l"
                                    transform="rotate(120,]]..df..[[,]]..e7 ..[[)" />
                                <use
                                    xlink:href="#l"
                                    transform="rotate(-120,]]..df..[[,]]..e7 ..[[)" />
                                <path
                                    d="M ]]..df-eG..[[,]]..e7 ..[[ h ]]..eF..[["
                                    style="stroke-width:0.5;stroke:#d7fe00;stroke-opacity:1"
                                    transform="rotate(-45,]]..df..[[,]]..e7 ..[[)" id="c"/>
                                <use
                                    xlink:href="#c"
                                    transform="rotate(-90,]]..df..[[,]]..e7 ..[[)"/>]]de[#de+1]=eN end end end end;local function eO(de,dc,eP,eQ)eP=e(eP+0.5)local du=throtPosY+10;local dv=throtPosY+20;if n()==1 and not RemoteHud then du=55;dv=65 end;local eR="CRUISE"local unit="km/h"local bV=eQ;if dc=="TRAVEL"or dc=="AUTOPILOT"then eR="THROT"unit="%"bV=eP;local eS="dim"if eP<0 then eS="red"end;de[#de+1]=f([[<g class="%s">
                                <path class="linethick" d="M %d %d L %d %d L %d %d L %d %d"/>
                                <g transform="translate(0 %.0f)">
                                    <polygon points="%d,%d %d,%d %d,%d"/>
                                </g>]],eS,throtPosX-7,throtPosY-50,throtPosX,throtPosY-50,throtPosX,throtPosY+50,throtPosX-7,throtPosY+50,1-d(eP),throtPosX-10,throtPosY+50,throtPosX-15,throtPosY+53,throtPosX-15,throtPosY+47)end;de[#de+1]=f([[
                            <g class="pbright txtstart">
                                    <text x="%s" y="%s">%s</text>
                                    <text x="%s" y="%s">%.0f %s</text>
                            </g>
                        </g>]],throtPosX+10,du,eR,throtPosX+10,dv,bV,unit)if au and AtmoSpeedAssist and bR and K then eP=e(L*100+0.5)local eS="red"if eP<0 then eS="red"end;de[#de+1]=f([[<g class="%s">
                                <g transform="translate(0 %d)">
                                    <polygon points="%d,%d %d,%d %d,%d"/>
                                </g></g>]],eS,1-d(eP),throtPosX-10,throtPosY+50,throtPosX-15,throtPosY+53,throtPosX-15,throtPosY+47)de[#de+1]=f([[
                                    <g class="pbright txtstart">
                                            <text x="%s" y="%s">%s</text>
                                            <text x="%s" y="%s">%d %s</text>
                                    </g>]],throtPosX+10,du+40,"LIMIT",throtPosX+10,dv+40,eP,"%")end;if au and AtmoSpeedAssist or Reentry then de[#de+1]=f([[
                                <g class="dim txtstart">
                                    <text x="%s" y="%s">%s %s</text>
                                </g>
                            ]],throtPosX+10,du-40,"LIMIT: ",bp.." km/h")elseif not au and Autopilot then de[#de+1]=f([[
                                <g class="dim txtstart">
                                    <text x="%s" y="%s">%s %s</text>
                                </g>
                            ]],throtPosX+10,du-40,"LIMIT: ",e(MaxGameVelocity*3.6+0.5).." km/h")end end;local function eT(de,eU)local eV=throtPosY-10;local eW=throtPosX+10;de[#de+1]=[[<g class="pdim txt txtend">]]if n()==1 and not RemoteHud then eV=75 end;de[#de+1]=f([[
                            <g class="pbright txtstart">
                                <text class="txtbig" x="%d" y="%d">%d km/h</text>
                            </g>
                        </g>]],eW,eV,e(eU))end;local function eX(de)de[#de+1]=f([[<text class="hudver" x="%d" y="%d">ARCH Hud Version: %.3f</text>]],d8(1900),d9(1070),VERSION_NUMBER)de[#de+1]=[[<g class="warnings">]]if unit.isMouseControlActivated()==1 then de[#de+1]=f([[
                                <text x="%d" y="%d">Warning: Invalid Control Scheme Detected</text>]],d8(960),d9(550))de[#de+1]=f([[
                                <text x="%d" y="%d">Keyboard Scheme must be selected</text>]],d8(960),d9(600))de[#de+1]=f([[
                                <text x="%d" y="%d">Set your preferred scheme in Lua Parameters instead</text>]],d8(960),d9(650))end;local eY=d8(960)local eZ=d9(860)local e_=d9(880)local f0=d9(900)local f1=d9(960)local f2=d9(200)local f3=d9(150)local f4=d9(960)if n()==1 and not RemoteHud then eZ=d9(135)e_=d9(155)f0=d9(175)f2=d9(115)f3=d9(95)end;if BrakeIsOn then de[#de+1]=f([[<text x="%d" y="%d">Brake Engaged</text>]],eY,eZ)elseif J>0 then de[#de+1]=f([[<text x="%d" y="%d" style="opacity:%s">Auto-Brake Engaged</text>]],eY,eZ,J)end;if au and bk and ar==-1 then de[#de+1]=f([[<text x="%d" y="%d">** STALL WARNING **</text>]],eY,f2+50)end;if az then de[#de+1]=f([[<text x="%d" y="%d">Gyro Enabled</text>]],eY,f4)end;if GearExtended then if S then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Gear Extended</text>]],eY,e_)else de[#de+1]=f([[<text x="%d" y="%d">Landed (G: Takeoff)</text>]],eY,e_)end;local f5,ca=c6(a:getTargetGroundAltitude())de[#de+1]=f([[<text class="warn" x="%d" y="%d">Hover Height: %s</text>]],eY,f0,f5 ..ca)end;if a7 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">ROCKET BOOST ENABLED</text>]],eY,f1+20)end;if antigrav and not ExternalAGG and bP and AntigravTargetAltitude~=nil then if d(aw-antigrav.getBaseAltitude())<501 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">AGG On - Target Altitude: %d Singularity Altitude: %d</text>]],eY,f2+15,e(AntigravTargetAltitude),e(antigrav.getBaseAltitude()))else de[#de+1]=f([[<text x="%d" y="%d">AGG On - Target Altitude: %d Singluarity Altitude: %d</text>]],eY,f2+15,e(AntigravTargetAltitude),e(antigrav.getBaseAltitude()))end elseif Autopilot and AutopilotTargetName~="None"then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Autopilot %s</text>]],eY,f2+20,AutopilotStatus)elseif LockPitch~=nil then de[#de+1]=f([[<text class="warn" x="%d" y="%d">LockedPitch: %d</text>]],eY,f2+20,e(LockPitch))elseif a0 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Follow Mode Engaged</text>]],eY,f2+20)elseif Reentry then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Re-entry in Progress</text>]],eY,f2+20)end;local f6,f7,f8=b9:getPlanetarySystem(0):castIntersections(bN,bJ:normalize(),function(f9)if f9.noAtmosphericDensityAltitude>0 then return f9.radius+f9.noAtmosphericDensityAltitude else return f9.radius+f9.surfaceMaxAltitude*1.5 end end)local fa=f7;if f8~=nil and f7~=nil then fa=math.min(f8,f7)end;if AltitudeHold or VertTakeOff then local f5,ca=c6(HoldAltitude,2)if VertTakeOff then if bP then f5,ca=c6(antigrav.getBaseAltitude(),2)end;de[#de+1]=f([[<text class="warn" x="%d" y="%d">VTO to %s</text>]],eY,f2,f5 ..ca)elseif AutoTakeoff and not IntoOrbit then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Takeoff to %s</text>]],eY,f2,f5 ..ca)if BrakeIsOn and not VertTakeOff then de[#de+1]=f([[<text class="crit" x="%d" y="%d">Throttle Up and Disengage Brake For Takeoff</text>]],eY,f2+50)end else de[#de+1]=f([[<text class="warn" x="%d" y="%d">Altitude Hold: %s</text>]],eY,f2,f5 ..ca)end end;if VertTakeOff and(antigrav~=nil and antigrav)then if av>0.1 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Beginning ascent</text>]],eY,f2)elseif av<0.09 and av>0.05 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Aligning trajectory</text>]],eY,f2)elseif av<0.05 then de[#de+1]=f([[<text class="warn" x="%d" y="%d">Leaving atmosphere</text>]],eY,f2)end end;if IntoOrbit then if br~=nil then de[#de+1]=f([[<text class="warn" x="%d" y="%d">%s</text>]],eY,f2,br)end end;if BrakeLanding then if StrongBrakes then de[#de+1]=f([[<text x="%d" y="%d">Brake-Landing</text>]],eY,f2)else de[#de+1]=f([[<text x="%d" y="%d">Coast-Landing</text>]],eY,f2)end end;if ProgradeIsOn then de[#de+1]=f([[<text class="crit" x="%d" y="%d">Prograde Alignment</text>]],eY,f2)end;if RetrogradeIsOn then de[#de+1]=f([[<text class="crit" x="%d" y="%d">Retrograde Alignment</text>]],eY,f2)end;if fa~=nil and av==0 then local f5,ca=c6(fa)local travelTime=ba.computeTravelTime(bK,0,fa)local fb="Collision"if f6.noAtmosphericDensityAltitude>0 then fb="Atmosphere"end;de[#de+1]=f([[<text class="crit" x="%d" y="%d">%s %s In %s (%s)</text>]],eY,f3,f6.name,fb,cX(travelTime),f5 ..ca)end;if VectorToTarget and not IntoOrbit then de[#de+1]=f([[<text class="warn" x="%d" y="%d">%s</text>]],eY,f2+35,VectorStatus)end;de[#de+1]="</g>"return de end;local function fc(e4)return e(z(e4*3.6,0)+0.5).." km/h"end;local function fd(de)local fe=OrbitMapX;local ff=OrbitMapY;local fg=OrbitMapSize;local fh=4;local fi=15;local df=0;local e7=0;local fj,fk,fl,fm;local function fn(type)local fo,bF,e4,fp;if type=="Periapsis"then fo=orbit.periapsis.altitude;bF=orbit.timeToPeriapsis;e4=orbit.periapsis.speed;fp=35 else fo=orbit.apoapsis.altitude;bF=orbit.timeToApoapsis;e4=orbit.apoapsis.speed;fp=-35 end;de[#de+1]=f([[<line class="pdim op30 linethick" x1="%f" y1="%f" x2="%f" y2="%f"/>]],df+fp,e7-5,fe+fg/2-fj+fm,e7-5)de[#de+1]=f([[<text x="%f" y="%f">%s</text>]],df,e7,type)e7=e7+fi;local f5,ca=c6(fo)de[#de+1]=f([[<text x="%f" y="%f">%s</text>]],df,e7,f5 ..ca)e7=e7+fi;de[#de+1]=f([[<text x="%f" y="%f">%s</text>]],df,e7,cX(bF))e7=e7+fi;de[#de+1]=f([[<text x="%f" y="%f">%s</text>]],df,e7,fc(e4))end;if orbit~=nil and av<0.2 and planet~=nil and orbit.apoapsis~=nil and orbit.periapsis~=nil and orbit.period~=nil and orbit.apoapsis.speed>5 and DisplayOrbit then ff=ff+fh;df=fe+fg+fe/2+fh;e7=ff+fg/2+5+fh;fj=fg/4;fm=0;de[#de+1]=[[<g class="pbright txtorb txtmid">]]de[#de+1]=f('<rect width="%f" height="%d" rx="10" ry="10" x="%d" y="%d" style="fill:rgb(0,0,100);stroke-width:4;stroke:white;fill-opacity:0.3;" />',fg+fe*2,fg+ff,fh,fh)if orbit.periapsis~=nil and orbit.apoapsis~=nil then fl=(orbit.apoapsis.altitude+orbit.periapsis.altitude+planet.radius*2)/(fj*2)fk=(planet.radius+orbit.periapsis.altitude+(orbit.apoapsis.altitude-orbit.periapsis.altitude)/2)/fl*(1-orbit.eccentricity)fm=fj-orbit.periapsis.altitude/fl-planet.radius/fl;local fq=""if orbit.periapsis.altitude<=0 then fq='redout'end;de[#de+1]=f([[<ellipse class="%s line" cx="%f" cy="%f" rx="%f" ry="%f"/>]],fq,fe+fg/2+fm+fh,ff+fg/2+fh,fj,fk)de[#de+1]=f('<circle cx="%f" cy="%f" r="%f" stroke="white" stroke-width="3" fill="blue" />',fe+fg/2+fh,ff+fg/2+fh,planet.radius/fl)end;if orbit.apoapsis~=nil and orbit.apoapsis.speed<MaxGameVelocity and orbit.apoapsis.speed>1 then fn("Apoapsis")end;e7=ff+fg/2+5+fh;df=fe-fe/2+10+fh;if orbit.periapsis~=nil and orbit.periapsis.speed<MaxGameVelocity and orbit.periapsis.speed>1 then fn("Periapsis")end;de[#de+1]=f([[<text class="txtorbbig" x="%f" y="%d">%s</text>]],fe+fg/2+fh,20+fh,planet.name)if orbit.period~=nil and orbit.periapsis~=nil and orbit.apoapsis~=nil and orbit.apoapsis.speed>1 then local fr=orbit.timeToApoapsis/orbit.period*2*math.pi;local fs=fj*math.cos(fr)local ft=fk*math.sin(fr)de[#de+1]=f('<circle cx="%f" cy="%f" r="5" stroke="white" stroke-width="3" fill="white" />',fe+fg/2+fs+fm+fh,ff+fg/2+ft+fh)end;de[#de+1]=[[</g>]]return de else return de end end;local function fu()if radarPanelID~=nil and an==0 then u(radarPanelID)radarPanelID=nil;if perisPanelID~=nil then u(perisPanelID)perisPanelID=nil end else if an==1 then u(radarPanelID)radarPanelID=nil;_autoconf.displayCategoryPanel(radar,radar_size,L_TEXT("ui_lua_widget_periscope", "Periscope"),"periscope")perisPanelID=_autoconf.panels[_autoconf.panels_size]end;placeRadar=true;if radarPanelID==nil and placeRadar then _autoconf.displayCategoryPanel(radar,radar_size,L_TEXT("ui_lua_widget_radar", "Radar"),"radar")radarPanelID=_autoconf.panels[_autoconf.panels_size]placeRadar=false end;an=0 end end;local function fv(de)local function fw(fx,fy)for i=1,#fy do table.insert(fx,fy[i])end;return fx end;local df=50;local e7=525;local fz={"Alt-1: Increment Interplanetary Helper","Alt-2: Decrement Interplanetary Helper","Alt-3: Toggle Vanilla Widget view"}local fA={"Alt-4: Autopilot in atmo to target","Alt-4-4: Autopilot to +1k over atmosphere and orbit to target","Alt-5: Lock Pitch at current pitch","Alt-6: Altitude hold at current altitude","Alt-6-6: Altitude Hold at 11% atmosphere","Alt-9: Activate Gyroscope"}local fB={"Alt-4 (Alt < 100k): Autopilot to Orbit and land","Alt-4 (Alt > 100k): Autopilot to target","Alt-6: Orbit at current altitude","Alt-6-6: Orbit at 1k over atmosphere","Alt-9: Activate Gyroscope"}local fC={"CTRL: Toggle Brakes on and off, cancels active AP","LeftAlt: Tap to shift freelook on and off","Shift: Hold while not in freelook to see Buttons","Type /commands or /help in lua chat to see text commands"}if au then fw(fz,fA)table.insert(fz,"---------------------------------------")if VertTakeOff then table.insert(fz,"Hit Alt-6 before exiting Atmosphere during VTO to hold in level flight")end;if ar~=-1 then if antigrav then if bP then table.insert(fz,"Alt-6: AGG is on, will takeoff to AGG Height")else table.insert(fz,"Turn on AGG to takeoff to AGG Height")end end;if VertTakeOffEngine then table.insert(fz,"Alt-6: Begins Vertical Takeoff.")else table.insert(fz,"Alt-4/Alt-6: Autotakeoff if below hoverheight")end else table.insert(fz,"G: Begin BrakeLanding or Land")end else fw(fz,fB)end;if AltitudeHold then table.insert(fz,"Alt-Spacebar/Alt-C will raise/lower target height")end;table.insert(fz,"---------------------------------------")fw(fz,fC)de[#de+1]=[[<g class="pdim txttick txtstart">]]for i=1,#fz do e7=e7+12;de[#de+1]=f([[<text x=%d y="%d">%s</text>]],df,e7,fz[i])end;de[#de+1]="</g>"end;local fD={}function fD.HUDPrologue(de)if not G then D=PvPR;F=PvPG;E=PvPB else D=SafeR;F=SafeG;E=SafeB end;aB=[[rgb(]]..e(D+0.5)..","..e(F+0.5)..","..e(E+0.5)..[[)]]aC=[[rgb(]]..e(D*0.9+0.5)..","..e(F*0.9+0.5)..","..e(E*0.9+0.5)..[[)]]local fE=aB;local fF=aC;local fG=aB;local fH=aC;if da()and not brightHud then fE=[[rgb(]]..e(D*0.4+0.5)..","..e(F*0.4+0.5)..","..e(E*0.3+0.5)..[[)]]fF=[[rgb(]]..e(D*0.3+0.5)..","..e(F*0.3+0.5)..","..e(E*0.2+0.5)..[[)]]end;de[#de+1]=f([[
                        <head>
                            <style>
                                body {margin: 0}
                                svg {position:absolute;top:0;left:0;font-family:Montserrat;} 
                                .txt {font-size:10px;font-weight:bold;}
                                .txttick {font-size:12px;font-weight:bold;}
                                .txtbig {font-size:14px;font-weight:bold;}
                                .altsm {font-size:16px;font-weight:normal;}
                                .altbig {font-size:21px;font-weight:normal;}
                                .line {stroke-width:2px;fill:none}
                                .linethick {stroke-width:3px;fill:none}
                                .warnings {font-size:26px;fill:red;text-anchor:middle;font-family:Bank}
                                .warn {fill:orange;font-size:24px}
                                .crit {fill:darkred;font-size:28px}
                                .bright {fill:%s;stroke:%s}
                                .pbright {fill:%s;stroke:%s}
                                .dim {fill:%s;stroke:%s}
                                .pdim {fill:%s;stroke:%s}
                                .red {fill:red;stroke:red}
                                .redout {fill:none;stroke:red}
                                .op30 {opacity:0.3}
                                .op10 {opacity:0.1}
                                .txtstart {text-anchor:start}
                                .txtend {text-anchor:end}
                                .txtmid {text-anchor:middle}
                                .txtvspd {font-family:sans-serif;font-weight:normal}
                                .txtvspdval {font-size:20px}
                                .txtfuel {font-size:11px;font-weight:bold}
                                .txtorb {font-size:12px}
                                .txtorbbig {font-size:18px}
                                .hudver {font-size:10px;font-weight:bold;fill:red;text-anchor:end;font-family:Bank}
                                .msg {font-size:40px;fill:red;text-anchor:middle;font-weight:normal}
                                .cursor {stroke:white}
                            </style>
                        </head>
                        <body>
                            <svg height="100%%" width="100%%" viewBox="0 0 %d %d">
                            ]],fE,fE,fG,fG,fF,fF,fH,fH,aJ,aK)return de end;function fD.UpdateHud(de)local ct=aw;local ew=core.getVelocity()local e4=vec3(ew):len()local ex=bS;local fI=bT;local dP=fI;local e2=bS;local eP=e(unit.getThrottle())local eU=e4*3.6;local eQ=unit.getAxisCommandValue(0)local fJ=d8(1770)local fK=d9(310)if AtmoSpeedAssist and bR then eQ=I;eP=I*100 end;local dc=db()local dQ="ROLL"local cA=unit.getClosestPlanetInfluence()>0;if eP==nil then eP=0 end;if not cA then if e4>5 then ex=ev(ew)fI=ey(ew)else ex=0;fI=0 end;dQ="YAW"end;if H>50000 and not au then local fL;if H>200000 then fL=z(H/200000,2).." su"else fL=z(H/1000,1).." km"end;de[#de+1]=f([[<text class="pbright txtbig txtmid" x="%d" y="%d">PvP Boundary: %s</text>]],fJ,fK,fL)end;de[#de+1]=am;de[#de+1]=aG;de[#de+1]=al;if b2%aW==0 then b0=true end;if fuelX~=0 and fuelY~=0 then dd(de,b0,fuelX,"Atmospheric ","ATMO",aP,aZ,a_)dd(de,b0,fuelX+100,"Space fuel t","SPACE",aQ,aX,aY)dd(de,b0,fuelX+200,"Rocket fuel ","ROCKET",aR,aU,aV)end;if b0 then b0=false;b2=0 end;b2=b2+1;dI(de,ct)if n()==0 or RemoteHud then if not da()or brightHud then if cA then dO(de,centerX,centerY,dP,dQ,cA)e1(de,e2,dP,centerX,centerY,cA,e(ey(ew)),e4)else dO(de,centerX,centerY,fI,dQ,cA)e1(de,ex,fI,centerX,centerY,cA,e(fI),e4)end;ea(de,ct,cA)ez(de,ew,e4,centerX,centerY)end end;eO(de,dc,eP,eQ)eT(de,eU)eX(de)fd(de)if showHelp then fv(de)end;if screen_2 then local fM=bN;local df=960+fM.x/b5;local e7=450+fM.y/b6;screen_2.moveContent(b7,(df-80)/19.2,(e7-80)/10.8)end;return de end;function fD.HUDEpilogue(de)de[#de+1]="</svg>"return de end;function fD.DrawOdometer(de,ad,TotalDistanceTravelled,ae,fN)local fO=d8(1240)local fP=d9(55)local fQ=fP+10;local fR=core.g()local fS=0;local fT=0;local fU=0;local dc=db()if VertTakeOffEngine then dc=dc.."-VERTICAL"end;if TurnBurn then dc="TB-"..dc end;if au then fU=LastMaxBrakeInAtmo else fU=LastMaxBrake end;maxThrust=a:maxForceForward()aN=m()if not ShowOdometer then return end;local fV=vec3(core.getWorldAcceleration()):len()/9.80665;fR=planet:getGravity(planet.center+vec3(0,0,1)*planet.radius):len()if fR>0.1 then fT=aN*fR;fS=maxThrust/fR end;de[#de+1]=[[<g class="pdim txt txtend">]]if n()==1 and not RemoteHud then fO=d8(1120)fP=d9(55)fQ=fP+10 elseif au then local fW=d8(770)de[#de+1]=f([[
                            <text x="%d" y="%d">ATMOSPHERE</text>
                            <text x="%d" y="%d">%.2f</text>
                        ]],fW,fP,fW,fQ,av)end;de[#de+1]=f([[
                        <g class="pbright txtend">
                        </g>
                        <text x="%d" y="%d">GRAVITY</text>
                        <text x="%d" y="%d">%.2f g</text>
                        <text x="%d" y="%d">ACCEL</text>
                        <text x="%d" y="%d">%.2f g</text>
                        ]],fO,fP,fO,fQ,fR/9.80665,fO,fP+20,fO,fQ+20,fV)de[#de+1]=f([[
                        <g class="pbright txt">
                        <path class="linethick" d="M %d 0 L %d %d Q %d %d %d %d L %d 0"/>]],d8(660),d8(700),d9(35),d8(960),d9(55),d8(1240),d9(35),d8(1280))if n()==0 or RemoteHud then de[#de+1]=f([[
                            <text class="txtstart" x="%d" y="%d" >Trip: %.2f km</text>
                            <text class="txtstart" x="%d" y="%d">Lifetime: %.2f Mm</text>
                            <text class="txtstart" x="%d" y="%d">Trip Time: %s</text>
                            <text class="txtstart" x="%d" y="%d">Total Time: %s</text>
                            <text class="txtstart" x="%d" y="%d">Mass: %.2f Tons</text>
                            <text class="txtend" x="%d" y="%d">Max Brake: %.2f kN</text>
                            <text class="txtend" x="%d" y="%d">Max Thrust: %.2f kN</text>
                            <text class="txtbig txtmid" x="%d" y="%d">%s</text>]],d8(700),d9(20),ad,d8(700),d9(30),TotalDistanceTravelled/1000,d8(830),d9(20),cX(ae),d8(830),d9(30),cX(TotalFlightTime),d8(970),d9(20),aN/1000,d8(1240),d9(10),fU/1000,d8(1240),d9(30),maxThrust/1000,d8(960),d9(180),dc)if fR>0.1 then de[#de+1]=f([[
                                    <text class="txtstart" x="%d" y="%d">Max Mass: %.2f Tons</text>
                                    <text class="txtend" x="%d" y="%d">Req Thrust: %.2f kN</text>
                            ]],d8(970),d9(30),fS/1000,d8(1240),d9(20),fT/1000)else de[#de+1]=f([[
                                <text class="txtstart" x="%d" y="%d" text-anchor="start">Max Mass: n/a</text>
                                <text class="txtend" x="%d" y="%d" text-anchor="end">Req Thrust: n/a</text>
                            ]],d8(970),d9(30),d8(1240),d9(20))end else de[#de+1]=f([[<text class="txtbig txtmid" x="960" y="33">%s</text>]],d8(960),d9(33),dc)end;de[#de+1]="</g>"return de end;function fD.DrawWarnings(de)return eX(de)end;function fD.DisplayOrbitScreen(de)return fd(de)end;function fD.DisplayMessage(de,f5)if f5~="empty"then de[#de+1]=[[<text class="msg" x="50%%" y="310" >]]for fX in string.gmatch(f5,"([^\n]+)")do de[#de+1]=f([[<tspan x="50%%" dy="35">%s</tspan>]],fX)end;de[#de+1]=[[</text>]]end;if aj~=0 then unit.setTimer("msgTick",aj)aj=0 end end;function fD.DrawDeadZone(de)de[#de+1]=f([[<circle class="dim line" style="fill:none" cx="50%%" cy="50%%" r="%d"/>]],DeadZone)end;function fD.UpdateRadar()if radar_1 then local fY=radar_1.getEntries()local fZ=radar_1.getData()local f_=d8(1770)local g0=d9(330)if#fY>0 then local g1=fZ:find('identifiedConstructs":%[%]')if g1==nil and perisPanelID==nil then an=1;fu()end;if g1~=nil and perisPanelID~=nil then fu()end;if radarPanelID==nil then fu()end;al=f([[<text class="pbright txtbig txtmid" x="%d" y="%d">Radar: %i contacts</text>]],f_,g0,#fY)local g2={}for bZ,b_ in pairs(fY)do if radar_1.hasMatchingTransponder(b_)==1 then table.insert(g2,b_)end end;if#g2>0 then local e7=d9(15)local df=d8(1370)al=f([[%s<text class="pbright txtbig txtmid" x="%d" y="%d">Friendlies In Range</text>]],al,df,e7)for bZ,b_ in pairs(g2)do e7=e7+20;al=f([[%s<text class="pdim txtmid" x="%d" y="%d">%s</text>]],al,df,e7,radar_1.getConstructName(b_))end end else local g3;g3=fZ:find('worksInEnvironment":false')if g3 then al=f([[
                                    <text class="pbright txtbig txtmid" x="%d" y="%d">Radar: Jammed</text>]],f_,g0)else al=f([[
                                    <text class="pbright txtbig txtmid" x="%d" y="%d">Radar: No Contacts</text>]],f_,g0)end;if radarPanelID~=nil then an=0;fu()end end end end;return fD end;local function g4()return{[0]={[0]={GM=0,bodyId=0,center={x=0,y=0,z=0},name='Space',planetarySystemId=0,radius=0,hasAtmosphere=false,gravity=0,noAtmosphericDensityAltitude=0,surfaceMaxAltitude=0},[2]={name="Alioth",description="Alioth is the planet selected by the arkship for landfall; it is a typical goldilocks planet where humanity may rebuild in the coming decades. The arkship geological survey reports mountainous regions alongside deep seas and lush forests. This is where it all starts.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9401,atmosphericEngineMaxAltitude=5580,biosphere="Forest",classification="Mesoplanet",bodyId=2,GM=157470826617,gravity=1.0082568597356114,fullAtmosphericDensityMaxAltitude=-10,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=6272,numSatellites=2,positionFromSun=2,center={x=-8,y=-8,z=-126303},radius=126067.8984375,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=3410,surfaceArea=199718780928,surfaceAverageAltitude=200,surfaceMaxAltitude=1100,surfaceMinAltitude=-330,systemZone="High",territories=259472,type="Planet",waterLevel=0,planetarySystemId=0},[21]={name="Alioth Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=21,GM=2118960000,gravity=0.24006116402380084,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=457933,y=-1509011,z=115524},radius=30000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=11309733888,surfaceAverageAltitude=140,surfaceMaxAltitude=200,surfaceMinAltitude=10,systemZone=nil,territories=14522,type="",waterLevel=nil,planetarySystemId=0},[22]={name="Alioth Moon 4",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=22,GM=2165833514,gravity=0.2427018259886451,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-1692694,y=729681,z=-411464},radius=30330,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=0,surfaceArea=11559916544,surfaceAverageAltitude=-15,surfaceMaxAltitude=-5,surfaceMinAltitude=-50,systemZone=nil,territories=14522,type="",waterLevel=nil,planetarySystemId=0},[5]={name="Feli",description="Feli is easily identified by its massive and deep crater. Outside of the crater, the arkship geological survey reports a fairly bland and uniform planet, it also cannot explain the existence of the crater. Feli is particular for having an extremely small atmosphere, allowing life to develop in the deeper areas of its crater but limiting it drastically on the actual surface.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.5488,atmosphericEngineMaxAltitude=66725,biosphere="Barren",classification="Mesoplanet",bodyId=5,GM=16951680000,gravity=0.4801223280476017,fullAtmosphericDensityMaxAltitude=30,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=78500,numSatellites=1,positionFromSun=5,center={x=-43534464,y=22565536,z=-48934464},radius=41800,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=42800,surfaceArea=21956466688,surfaceAverageAltitude=18300,surfaceMaxAltitude=18500,surfaceMinAltitude=46,systemZone="Low",territories=27002,type="Planet",waterLevel=nil,planetarySystemId=0},[50]={name="Feli Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=50,GM=499917600,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-43902841.78,y=22261034.7,z=-48862386},radius=14000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=800,surfaceMaxAltitude=900,surfaceMinAltitude=0,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[120]={name="Ion",description="Ion is nothing more than an oversized ice cube frozen through and through. It is a largely inhospitable planet due to its extremely low temperatures. The arkship geological survey reports extremely rough mountainous terrain with little habitable land.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9522,atmosphericEngineMaxAltitude=10480,biosphere="Ice",classification="Hypopsychroplanet",bodyId=120,GM=7135606629,gravity=0.36009174603570127,fullAtmosphericDensityMaxAltitude=-30,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=17700,numSatellites=2,positionFromSun=12,center={x=2865536.7,y=-99034464,z=-934462.02},radius=44950,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=6410,surfaceArea=25390383104,surfaceAverageAltitude=500,surfaceMaxAltitude=1300,surfaceMinAltitude=250,systemZone="Average",territories=32672,type="Planet",waterLevel=nil,planetarySystemId=0},[121]={name="Ion Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=121,GM=106830900,gravity=0.08802242599860607,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=2472916.8,y=-99133747,z=-1133582.8},radius=11000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=1520530944,surfaceAverageAltitude=100,surfaceMaxAltitude=200,surfaceMinAltitude=3,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[122]={name="Ion Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=122,GM=176580000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=2995424.5,y=-99275010,z=-1378480.7},radius=15000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=-1900,surfaceMaxAltitude=-1400,surfaceMinAltitude=-2100,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[9]={name="Jago",description="Jago is a water planet. The large majority of the planet&apos;s surface is covered by large oceans dotted by small areas of landmass across the planet. The arkship geological survey reports deep seas across the majority of the planet with sub 15 percent coverage of solid ground.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9835,atmosphericEngineMaxAltitude=9695,biosphere="Water",classification="Mesoplanet",bodyId=9,GM=18606274330,gravity=0.5041284298678057,fullAtmosphericDensityMaxAltitude=-90,habitability="Very High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=10900,numSatellites=0,positionFromSun=9,center={x=-94134462,y=12765534,z=-3634464},radius=61590,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=5900,surfaceArea=47668367360,surfaceAverageAltitude=0,surfaceMaxAltitude=1200,surfaceMinAltitude=-500,systemZone="Very High",territories=60752,type="Planet",waterLevel=0,planetarySystemId=0},[100]={name="Lacobus",description="Lacobus is an ice planet that also features large bodies of water. The arkship geological survey reports deep oceans alongside a frozen and rough mountainous environment. Lacobus seems to feature regional geothermal activity allowing for the presence of water on the surface.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.7571,atmosphericEngineMaxAltitude=11120,biosphere="Ice",classification="Psychroplanet",bodyId=100,GM=13975172474,gravity=0.45611622622739767,fullAtmosphericDensityMaxAltitude=-20,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=12510,numSatellites=3,positionFromSun=10,center={x=98865536,y=-13534464,z=-934461.99},radius=55650,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=6790,surfaceArea=38917074944,surfaceAverageAltitude=800,surfaceMaxAltitude=1660,surfaceMinAltitude=250,systemZone="Average",territories=50432,type="Planet",waterLevel=0,planetarySystemId=0},[102]={name="Lacobus Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=102,GM=444981600,gravity=0.14403669598391783,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=99180968,y=-13783862,z=-926156.4},radius=18000,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=0,surfaceArea=4071504128,surfaceAverageAltitude=150,surfaceMaxAltitude=300,surfaceMinAltitude=10,systemZone=nil,territories=5072,type="",waterLevel=nil,planetarySystemId=0},[103]={name="Lacobus Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=103,GM=211503600,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=99250052,y=-13629215,z=-1059341.4},radius=14000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=-1380,surfaceMaxAltitude=-1280,surfaceMinAltitude=-1880,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[101]={name="Lacobus Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=101,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=98905288.17,y=-13950921.1,z=-647589.53},radius=15000,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=500,surfaceMaxAltitude=820,surfaceMinAltitude=3,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[1]={name="Madis",description="Madis is a barren wasteland of a rock; it sits closest to the sun and temperatures reach extreme highs during the day. The arkship geological survey reports long rocky valleys intermittently separated by small ravines.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.8629,atmosphericEngineMaxAltitude=7165,biosphere="Barren",classification="hyperthermoplanet",bodyId=1,GM=6930729684,gravity=0.36009174603570127,fullAtmosphericDensityMaxAltitude=220,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=8050,numSatellites=3,positionFromSun=1,center={x=17465536,y=22665536,z=-34464},radius=44300,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=4480,surfaceArea=24661377024,surfaceAverageAltitude=750,surfaceMaxAltitude=850,surfaceMinAltitude=670,systemZone="Low",territories=30722,type="Planet",waterLevel=nil,planetarySystemId=0},[10]={name="Madis Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=10,GM=78480000,gravity=0.08002039003323584,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17448118.224,y=22966846.286,z=143078.82},radius=10000,safeAreaEdgeAltitude=500000,size="XL",spaceEngineMinAltitude=0,surfaceArea=1256637056,surfaceAverageAltitude=210,surfaceMaxAltitude=420,surfaceMinAltitude=0,systemZone=nil,territories=1472,type="",waterLevel=nil,planetarySystemId=0},[11]={name="Madis Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=11,GM=237402000,gravity=0.09602446196397631,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17194626,y=22243633.88,z=-214962.81},radius=12000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=1809557376,surfaceAverageAltitude=-700,surfaceMaxAltitude=300,surfaceMinAltitude=-2900,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[12]={name="Madis Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=12,GM=265046609,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=17520614,y=22184730,z=-309989.99},radius=15000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=700,surfaceMaxAltitude=1100,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[26]={name="Sanctuary",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9666,atmosphericEngineMaxAltitude=6935,biosphere="",classification="",bodyId=26,GM=68234043600,gravity=1.0000000427743831,fullAtmosphericDensityMaxAltitude=-30,habitability="",hasAtmosphere=true,isSanctuary=true,noAtmosphericDensityAltitude=7800,numSatellites=0,positionFromSun=0,center={x=-1404835,y=562655,z=-285074},radius=83400,safeAreaEdgeAltitude=0,size="L",spaceEngineMinAltitude=4230,surfaceArea=87406149632,surfaceAverageAltitude=80,surfaceMaxAltitude=500,surfaceMinAltitude=-60,systemZone=nil,territories=111632,type="",waterLevel=0,planetarySystemId=0},[6]={name="Sicari",description="Sicari is a typical desert planet; it has survived for millenniums and will continue to endure. While not the most habitable of environments it remains a relatively untouched and livable planet of the Alioth sector. The arkship geological survey reports large flatlands alongside steep plateaus.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.897,atmosphericEngineMaxAltitude=7725,biosphere="Desert",classification="Mesoplanet",bodyId=6,GM=10502547741,gravity=0.4081039739797361,fullAtmosphericDensityMaxAltitude=-625,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=8770,numSatellites=0,positionFromSun=6,center={x=52765536,y=27165538,z=52065535},radius=51100,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=4480,surfaceArea=32813432832,surfaceAverageAltitude=130,surfaceMaxAltitude=220,surfaceMinAltitude=50,systemZone="Average",territories=41072,type="Planet",waterLevel=nil,planetarySystemId=0},[7]={name="Sinnen",description="Sinnen is a an empty and rocky hell. With no atmosphere to speak of it is one of the least hospitable planets in the sector. The arkship geological survey reports mostly flatlands alongside deep ravines which look to have once been riverbeds. This planet simply looks to have dried up and died, likely from solar winds.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9226,atmosphericEngineMaxAltitude=10335,biosphere="Desert",classification="Mesoplanet",bodyId=7,GM=13033380591,gravity=0.4401121421448438,fullAtmosphericDensityMaxAltitude=-120,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=11620,numSatellites=1,positionFromSun=7,center={x=58665538,y=29665535,z=58165535},radius=54950,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=6270,surfaceArea=37944188928,surfaceAverageAltitude=317,surfaceMaxAltitude=360,surfaceMinAltitude=23,systemZone="Average",territories=48002,type="Planet",waterLevel=nil,planetarySystemId=0},[70]={name="Sinnen Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=70,GM=396912600,gravity=0.1360346539426409,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=58969616,y=29797945,z=57969449},radius=17000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=3631681280,surfaceAverageAltitude=-2050,surfaceMaxAltitude=-1950,surfaceMinAltitude=-2150,systemZone=nil,territories=4322,type="",waterLevel=nil,planetarySystemId=0},[110]={name="Symeon",description="Symeon is an ice planet mysteriously split at the equator by a band of solid desert. Exactly how this phenomenon is possible is unclear but some sort of weather anomaly may be responsible. The arkship geological survey reports a fairly diverse mix of flat-lands alongside mountainous formations.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.9559,atmosphericEngineMaxAltitude=6920,biosphere="Ice, Desert",classification="Hybrid",bodyId=110,GM=9204742375,gravity=0.3920998898971822,fullAtmosphericDensityMaxAltitude=-30,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=7800,numSatellites=0,positionFromSun=11,center={x=14165536,y=-85634465,z=-934464.3},radius=49050,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=4230,surfaceArea=30233462784,surfaceAverageAltitude=39,surfaceMaxAltitude=450,surfaceMinAltitude=126,systemZone="High",territories=38882,type="Planet",waterLevel=nil,planetarySystemId=0},[4]={name="Talemai",description="Talemai is a planet in the final stages of an Ice Age. It seems likely that the planet was thrown into tumult by a cataclysmic volcanic event which resulted in its current state. The arkship geological survey reports large mountainous regions across the entire planet.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.8776,atmosphericEngineMaxAltitude=9685,biosphere="Barren",classification="Psychroplanet",bodyId=4,GM=14893847582,gravity=0.4641182439650478,fullAtmosphericDensityMaxAltitude=-78,habitability="Average",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=10890,numSatellites=3,positionFromSun=4,center={x=-13234464,y=55765536,z=465536},radius=57500,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=5890,surfaceArea=41547563008,surfaceAverageAltitude=580,surfaceMaxAltitude=610,surfaceMinAltitude=520,systemZone="Average",territories=52922,type="Planet",waterLevel=nil,planetarySystemId=0},[42]={name="Talemai Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=42,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-13058408,y=55781856,z=740177.76},radius=15000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=720,surfaceMaxAltitude=850,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0},[40]={name="Talemai Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=40,GM=141264000,gravity=0.09602446196397631,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-13503090,y=55594325,z=769838.64},radius=12000,safeAreaEdgeAltitude=500000,size="S",spaceEngineMinAltitude=0,surfaceArea=1809557376,surfaceAverageAltitude=250,surfaceMaxAltitude=450,surfaceMinAltitude=0,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[41]={name="Talemai Moon 3",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=41,GM=106830900,gravity=0.08802242599860607,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=-12800515,y=55700259,z=325207.84},radius=11000,safeAreaEdgeAltitude=500000,size="XS",spaceEngineMinAltitude=0,surfaceArea=1520530944,surfaceAverageAltitude=190,surfaceMaxAltitude=400,surfaceMinAltitude=0,systemZone=nil,territories=1922,type="",waterLevel=nil,planetarySystemId=0},[8]={name="Teoma",description="[REDACTED] The arkship geological survey [REDACTED]. This planet should not be here.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.7834,atmosphericEngineMaxAltitude=5580,biosphere="Forest",classification="Mesoplanet",bodyId=8,GM=18477723600,gravity=0.48812434578525177,fullAtmosphericDensityMaxAltitude=15,habitability="High",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=6280,numSatellites=0,positionFromSun=8,center={x=80865538,y=54665536,z=-934463.94},radius=62000,safeAreaEdgeAltitude=500000,size="L",spaceEngineMinAltitude=3420,surfaceArea=48305131520,surfaceAverageAltitude=700,surfaceMaxAltitude=1100,surfaceMinAltitude=-200,systemZone="High",territories=60752,type="Planet",waterLevel=0,planetarySystemId=0},[3]={name="Thades",description="Thades is a scorched desert planet. Perhaps it was once teaming with life but now all that remains is ash and dust. The arkship geological survey reports a rocky mountainous planet bisected by a massive unnatural ravine; something happened to this planet.",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0.03552,atmosphericEngineMaxAltitude=32180,biosphere="Desert",classification="Thermoplanet",bodyId=3,GM=11776905000,gravity=0.49612641213015557,fullAtmosphericDensityMaxAltitude=150,habitability="Low",hasAtmosphere=true,isSanctuary=false,noAtmosphericDensityAltitude=32800,numSatellites=2,positionFromSun=3,center={x=29165536,y=10865536,z=65536},radius=49000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=21400,surfaceArea=30171856896,surfaceAverageAltitude=13640,surfaceMaxAltitude=13690,surfaceMinAltitude=370,systemZone="Low",territories=38882,type="Planet",waterLevel=nil,planetarySystemId=0},[30]={name="Thades Moon 1",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=30,GM=211564034,gravity=0.11202853997062348,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=29214402,y=10907080.695,z=433858.2},radius=14000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2463008768,surfaceAverageAltitude=60,surfaceMaxAltitude=300,surfaceMinAltitude=0,systemZone=nil,territories=3002,type="",waterLevel=nil,planetarySystemId=0},[31]={name="Thades Moon 2",description="",antiGravMinAltitude=1000,atmosphericDensityAboveSurface=0,atmosphericEngineMaxAltitude=0,biosphere="",classification="",bodyId=31,GM=264870000,gravity=0.12003058201190042,fullAtmosphericDensityMaxAltitude=0,habitability="",hasAtmosphere=false,isSanctuary=false,noAtmosphericDensityAltitude=0,numSatellites=0,positionFromSun=0,center={x=29404193,y=10432768,z=19554.131},radius=15000,safeAreaEdgeAltitude=500000,size="M",spaceEngineMinAltitude=0,surfaceArea=2827433472,surfaceAverageAltitude=70,surfaceMaxAltitude=350,surfaceMinAltitude=0,systemZone=nil,territories=3632,type="",waterLevel=nil,planetarySystemId=0}}}end;local function g5()local function g6(g7)return type(g7)=='number'end;local function g8(g7)return type(tonumber(g7))=='number'end;local function g9(ga)return type(ga)=='table'end;local function gb(gc)return type(gc)=='string'end;local function gd(b_)return g9(b_)and g6(b_.x and b_.y and b_.z)end;local function ge(gf)return g9(gf)and g6(gf.latitude and gf.longitude and gf.altitude and gf.bodyId and gf.systemId)end;local gg=math.pi/180;local gh=180/math.pi;local epsilon=1e-10;local A=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local gi='::pos{'..A..','..A..','..A..','..A..','..A..'}'local utils=require('cpml.utils')local vec3=require('cpml.vec3')local gj=s;local function c3(c4,c5)if c4==0 then return d(c5)<1e-09 end;if c5==0 then return d(c4)<1e-09 end;return d(c4-c5)<math.max(d(c4),d(c5))*epsilon end;local function gk(g7)local c9=string.gsub(string.reverse(f('%.4f',g7)),'^0*%.?','')return c9==''and'0'or string.reverse(c9)end;local function gl(gm)if gd(gm)then return f('{x=%.3f,y=%.3f,z=%.3f}',gm.x,gm.y,gm.z)end;if g9(gm)and not getmetatable(gm)then local gn={}local go=next(gm)if type(go)=='nil'or go==1 then gn=gm else for bZ,b_ in pairs(gm)do local bV=gl(b_)if type(bZ)=='number'then table.insert(gn,f('[%s]=%s',bZ,bV))else table.insert(gn,f('%s=%s',bZ,bV))end end end;return f('{%s}',table.concat(gn,','))end;if gb(gm)then return f("'%s'",gm:gsub("'",[[\']]))end;return tostring(gm)end;local gp={}gp.__index=gp;gp.__tostring=function(gm,gq)local gr={}for bZ in pairs(gm)do table.insert(gr,bZ)end;table.sort(gr)local gn={}for _,bZ in ipairs(gr)do local bV=gl(gm[bZ])if type(bZ)=='number'then table.insert(gn,f('[%s]=%s',bZ,bV))else table.insert(gn,f('%s=%s',bZ,bV))end end;if gq then return f('%s%s',gq,table.concat(gn,',\n'..gq))end;return f('{%s}',table.concat(gn,','))end;gp.__eq=function(gs,gt)return gs.planetarySystemId==gt.planetarySystemId and gs.bodyId==gt.bodyId and c3(gs.radius,gt.radius)and c3(gs.center.x,gt.center.x)and c3(gs.center.y,gt.center.y)and c3(gs.center.z,gt.center.z)and c3(gs.GM,gt.GM)end;local function gu(gv,gw,gx,cq,gy)assert(g8(gv),'Argument 1 (planetarySystemId) must be a number:'..type(gv))assert(g8(gw),'Argument 2 (bodyId) must be a number:'..type(gw))assert(g8(gx),'Argument 3 (radius) must be a number:'..type(gx))assert(g9(cq),'Argument 4 (worldCoordinates) must be a array or vec3.'..type(cq))assert(g8(gy),'Argument 5 (GM) must be a number:'..type(gy))return setmetatable({planetarySystemId=tonumber(gv),bodyId=tonumber(gw),radius=tonumber(gx),center=vec3(cq),GM=tonumber(gy)},gp)end;local MapPosition={}MapPosition.__index=MapPosition;MapPosition.__tostring=function(gz)return f('::pos{%d,%d,%s,%s,%s}',gz.systemId,gz.bodyId,gk(gz.latitude*gh),gk(gz.longitude*gh),gk(gz.altitude))end;MapPosition.__eq=function(gs,gt)return gs.bodyId==gt.bodyId and gs.systemId==gt.systemId and c3(gs.latitude,gt.latitude)and c3(gs.altitude,gt.altitude)and(c3(gs.longitude,gt.longitude)or c3(gs.latitude,math.pi/2)or c3(gs.latitude,-math.pi/2))end;local function gA(gB,gw,cu,cv,ct)local gv=gB;if gb(gB)and not cv and not ct and not gw and not cu then gv,gw,cu,cv,ct=p(gB,gi)assert(gv,'Argument 1 (position string) is malformed.')else assert(g8(gv),'Argument 1 (systemId) must be a number:'..type(gv))assert(g8(gw),'Argument 2 (bodyId) must be a number:'..type(gw))assert(g8(cu),'Argument 3 (latitude) must be in degrees:'..type(cu))assert(g8(cv),'Argument 4 (longitude) must be in degrees:'..type(cv))assert(g8(ct),'Argument 5 (altitude) must be in meters:'..type(ct))end;gv=tonumber(gv)gw=tonumber(gw)cu=tonumber(cu)cv=tonumber(cv)ct=tonumber(ct)if gw==0 then return setmetatable({latitude=cu,longitude=cv,altitude=ct,bodyId=gw,systemId=gv},MapPosition)end;return setmetatable({latitude=gg*gj(cu,-90,90),longitude=gg*(cv%360),altitude=ct,bodyId=gw,systemId=gv},MapPosition)end;local gC={}gC.__index=gC;gC.__tostring=function(gm,gq)local gD=gq and gq..'  'local gE={}local gr={}for bZ in pairs(gm)do table.insert(gr,bZ)end;table.sort(gr)for _,gF in ipairs(gr)do bdy=gm[gF]local gG=gp.__tostring(bdy,gD)if gq then table.insert(gE,f('[%s]={\n%s\n%s}',gF,gG,gq))else table.insert(gE,f('  [%s]=%s',gF,gG))end end;if gq then return f('\n%s%s%s',gq,table.concat(gE,',\n'..gq),gq)end;return f('{\n%s\n}',table.concat(gE,',\n'))end;local function gH(gI)local b3={}local pid;for _,b_ in pairs(gI)do local gJ=b_.planetarySystemId;if type(gJ)~='number'then error('Invalid planetary system ID: '..tostring(gJ))elseif pid and gJ~=pid then error('Mistringmatch planetary system IDs: '..gJ..' and '..pid)end;local gK=b_.bodyId;if type(gK)~='number'then error('Invalid body ID: '..tostring(gK))elseif b3[gK]then error('Duplicate body ID: '..tostring(gK))end;setmetatable(b_.center,getmetatable(vec3.unit_x))b3[gK]=setmetatable(b_,gp)pid=gJ end;return setmetatable(b3,gC)end;b8={}local function gL(gI)return setmetatable({galaxyAtlas=gI or{}},b8)end;b8.__index=function(ga,i)if type(i)=='number'then local system=ga.galaxyAtlas[i]return gH(system)end;return rawget(b8,i)end;b8.__pairs=function(gm)return function(ga,bZ)local gM,nv=next(ga,bZ)return gM,nv and gH(nv)end,gm.galaxyAtlas,nil end;b8.__tostring=function(gm)local gN={}for _,gO in pairs(gm or{})do local gP=gO:getPlanetarySystemId()local gQ=gC.__tostring(gO,'    ')table.insert(gN,f('  [%s]={%s\n  }',gP,gQ))end;return f('{\n%s\n}\n',table.concat(gN,',\n'))end;b8.BodyParameters=gu;b8.MapPosition=gA;b8.PlanetarySystem=gH;function b8.createBodyParameters(gR,gw,gS,gT,gU,gV,gW)assert(g8(gR),'Argument 1 (planetarySystemId) must be a number:'..type(gR))assert(g8(gw),'Argument 2 (bodyId) must be a number:'..type(gw))assert(g8(gS),'Argument 3 (surfaceArea) must be a number:'..type(gS))assert(g9(gT),'Argument 4 (aPosition) must be an array or vec3:'..type(gT))assert(g9(gU),'Argument 5 (verticalAtPosition) must be an array or vec3:'..type(gU))assert(g8(gV),'Argument 6 (altitude) must be in meters:'..type(gV))assert(g8(gW),'Argument 7 (gravityAtPosition) must be number:'..type(gW))local gx=math.sqrt(gS/4/math.pi)local ak=gx+gV;local gX=vec3(gT)+ak*vec3(gU)local gy=gW*ak*ak;return gu(gR,gw,gx,gX,gy)end;b8.isMapPosition=ge;function b8:getPlanetarySystem(gB)if i==nil then i=0 end;if nv==nil then nv=0 end;local gR=gB;if ge(gB)then gR=gB.systemId end;if type(gR)=='number'then local system=self.galaxyAtlas[i]if system then if getmetatable(nv)~=gC then system=gH(system)end;return system end end end;function gC:castIntersections(gY,cM,gZ,g_)local gZ=gZ or function(f9)return 1.05*f9.radius end;local h0={}if g_ then for _,i in ipairs(g_)do h0[i]=self[i]end else g_={}for bZ,f9 in pairs(self)do table.insert(g_,bZ)h0[bZ]=f9 end end;local function h1(h2,h3)local h4=h0[h2].center-gY;local h5=h0[h3].center-gY;return h4:len()<h5:len()end;table.sort(g_,h1)local h6=cM:normalize()for i,gJ in ipairs(g_)do local f9=h0[gJ]local h7=f9.center-gY;local gx=gZ(f9)local h8=h7:dot(h6)local h9=h8^2-(h7:len2()-gx^2)if h9>=0 then local ha=math.sqrt(h9)local f7=h8+ha;local f8=h8-ha;if f8>0 then return f9,f7,f8 elseif f7>0 then return f9,f7,nil end end end;return nil,nil,nil end;function gC:closestBody(cn)assert(type(cn)=='table','Invalid coordinates.')local hb,f9;local hc=vec3(cn)for _,hd in pairs(self)do local he=(hd.center-hc):len2()if(not f9 or he<hb)and hd.name~="Space"then f9=hd;hb=he end end;return f9 end;function gC:convertToBodyIdAndWorldCoordinates(gB)local hf=gB;if gb(gB)then hf=gA(gB)end;if hf.bodyId==0 then return 0,vec3(hf.latitude,hf.longitude,hf.altitude)end;local hd=self:getBodyParameters(hf)if hd then return hf.bodyId,hd:convertToWorldCoordinates(hf)end end;function gC:getBodyParameters(gB)local gw=gB;if ge(gB)then gw=gB.bodyId end;assert(g8(gw),'Argument 1 (bodyId) must be a number:'..type(gw))return self[gw]end;function gC:getPlanetarySystemId()local _,b_=next(self)return b_ and b_.planetarySystemId end;function gp:convertToMapPosition(cq)assert(g9(cq),'Argument 1 (worldCoordinates) must be an array or vec3:'..type(cq))local cr=vec3(cq)if self.bodyId==0 then return setmetatable({latitude=cr.x,longitude=cr.y,altitude=cr.z,bodyId=0,systemId=self.planetarySystemId},MapPosition)end;local cs=cr-self.center;local ak=cs:len()local ct=ak-self.radius;local cu=0;local cv=0;if not c3(ak,0)then local cw=o(cs.y,cs.x)cv=cw>=0 and cw or 2*math.pi+cw;cu=math.pi/2-math.acos(cs.z/ak)end;return setmetatable({latitude=cu,longitude=cv,altitude=ct,bodyId=self.bodyId,systemId=self.planetarySystemId},MapPosition)end;function gp:convertToWorldCoordinates(gB)local hf=gb(gB)and gA(gB)or gB;if hf.bodyId==0 then return vec3(hf.latitude,hf.longitude,hf.altitude)end;assert(ge(hf),'Argument 1 (mapPosition) is not an instance of "MapPosition".')assert(hf.systemId==self.planetarySystemId,'Argument 1 (mapPosition) has a different planetary system ID.')assert(hf.bodyId==self.bodyId,'Argument 1 (mapPosition) has a different planetary body ID.')local hg=math.cos(hf.latitude)return self.center+(self.radius+hf.altitude)*vec3(hg*math.cos(hf.longitude),hg*math.sin(hf.longitude),math.sin(hf.latitude))end;function gp:getAltitude(cq)return(vec3(cq)-self.center):len()-self.radius end;function gp:getDistance(cq)return(vec3(cq)-self.center):len()end;function gp:getGravity(cq)local hh=self.center-vec3(cq)local hi=hh:len2()return self.GM/hi*hh/math.sqrt(hi)end;return setmetatable(b8,{__call=function(_,...)return gL(...)end})end;function script.onStart()local function hj()local function hk(hl)local hm=dbHud_1.hasKey;for bZ,b_ in pairs(hl)do if hm(b_)then local c9=g(dbHud_1.getStringValue(b_))if c9~=nil then _G[b_]=c9;aL=true end end end end;if dbHud_1 then local hm=dbHud_1.hasKey;if not useTheseSettings then hk(b)else a2="Updated user preferences used.  Will be saved when you exit seat.\nToggle off useTheseSettings to use saved values"aj=5 end;coroutine.yield()hk(c)if aL then a2="Loaded Saved Variables (see Lua Chat Tab for list)"N=z(ResolutionX/2,0)O=z(ResolutionY/2,0)aJ=ResolutionX;aK=ResolutionY;BrakeToggleStatus=BrakeToggleDefault;userControlScheme=string.lower(userControlScheme)bg=autoRollPreference;bp=AtmoSpeedLimit;aB=[[rgb(]]..e(D+0.5)..","..e(F+0.5)..","..e(E+0.5)..[[)]]aC=[[rgb(]]..e(D*0.9+0.5)..","..e(F*0.9+0.5)..","..e(E*0.9+0.5)..[[)]]else a2="No Saved Variables Found - Stand up / leave remote to save settings"end else a2="No databank found, install one anywhere and rerun the autoconfigure to save variables"end;if LastStartTime+180<bF then LastMaxBrakeInAtmo=0 end;LastStartTime=bF;userControlScheme=string.lower(userControlScheme)if string.find("keyboard virtual joystick mouse",userControlScheme)==nil then a2="Invalid User Control Scheme selected.  Change userControlScheme in Lua Parameters to keyboard, mouse, or virtual joystick\nOr use shift and button in screen"aj=5 end;if antigrav and not ExternalAGG then if AntigravTargetAltitude==nil then AntigravTargetAltitude=aw end;antigrav.setBaseAltitude(AntigravTargetAltitude)end end;local function hn()local function ho(hp,hq)if hp>hq then hq=hp end;if ContainerOptimization>0 then hq=hq-hq*ContainerOptimization*0.05 end;if FuelTankOptimization>0 then hq=hq-hq*FuelTankOptimization*0.05 end;return hq end;local hr=core.getElementNameById;local hs=fuelX~=0 and fuelY~=0;for bZ in pairs(ax)do local type=core.getElementTypeById(ax[bZ])if p(type,'^.*Atmospheric Engine$')then if p(tostring(core.getElementTagsById(ax[bZ])),'^.*vertical.*$')then bO=true end end;if p(type,'^.*Space Engine$')then bD=true;if p(tostring(core.getElementTagsById(ax[bZ])),'^.*vertical.*$')then local ht=core.getElementRotationById(ax[bZ])if ht[4]<0 then if q(-ht[4],0.1)==0.5 then bB=true end else if q(ht[4],0.1)==0.5 then bC=true end end end end;if type=="Landing Gear"then S=true end;if type=="Dynamic Core Unit"then local hu=j(ax[bZ])if hu>10000 then b1=128 elseif hu>1000 then b1=64 elseif hu>150 then b1=32 end end;aS=aS+j(ax[bZ])if hs and(type=="Atmospheric Fuel Tank"or type=="Space Fuel Tank"or type=="Rocket Fuel Tank")then local hu=j(ax[bZ])local hv=l(ax[bZ])local hp=0;local dD=r()if type=="Atmospheric Fuel Tank"then local hq=400;local hw=35.03;if hu>10000 then hq=51200;hw=5480 elseif hu>1300 then hq=6400;hw=988.67 elseif hu>150 then hq=1600;hw=182.67 end;hp=hv-hw;if fuelTankHandlingAtmo>0 then hq=hq+hq*fuelTankHandlingAtmo*0.2 end;hq=ho(hp,hq)aP[#aP+1]={ax[bZ],hr(ax[bZ]),hq,hw,hp,dD}end;if type=="Rocket Fuel Tank"then local hq=320;local hw=173.42;if hu>65000 then hq=40000;hw=25740 elseif hu>6000 then hq=5120;hw=4720 elseif hu>700 then hq=640;hw=886.72 end;hp=hv-hw;if fuelTankHandlingRocket>0 then hq=hq+hq*fuelTankHandlingRocket*0.1 end;hq=ho(hp,hq)aR[#aR+1]={ax[bZ],hr(ax[bZ]),hq,hw,hp,dD}end;if type=="Space Fuel Tank"then local hq=2400;local hw=182.67;if hu>10000 then hq=76800;hw=5480 elseif hu>1300 then hq=9600;hw=988.67 end;hp=hv-hw;if fuelTankHandlingSpace>0 then hq=hq+hq*fuelTankHandlingSpace*0.2 end;hq=ho(hp,hq)aQ[#aQ+1]={ax[bZ],hr(ax[bZ]),hq,hw,hp,dD}end end end;if not bO then VertTakeOff,VertTakeOffEngine=false,false end end;local function hx()if gyro~=nil then az=gyro.getState()==1 end;if userControlScheme~="keyboard"then x(1)else x(0)end;if door and(au or not au and aw<10000)then for _,b_ in pairs(door)do b_.toggle()end end;if switch then for _,b_ in pairs(switch)do b_.toggle()end end;if forcefield and(au or not au==0 and aw<10000)then for _,b_ in pairs(forcefield)do b_.toggle()end end;if antigrav then bP=antigrav.getState()==1;if bP and not ExternalAGG then antigrav.show()end end;if n()==1 and RemoteFreeze then system.freeze(1)else system.freeze(0)end;if S then GearExtended=a.control.isAnyLandingGearExtended()==1;if GearExtended then a.control.extendLandingGears()else a.control.retractLandingGears()end end;local hy=d1()if hy~=-1 or not au and vec3(core.getVelocity()):len()<50 then BrakeIsOn=true;if not S then GearExtended=true end else BrakeIsOn=false end;if bh~=nil then t:setTargetGroundAltitude(bh)if bh==0 and not S then GearExtended=true;BrakeIsOn=true end else bh=a:getTargetGroundAltitude()if GearExtended then t:setTargetGroundAltitude(LandingGearGroundHeight)else t:setTargetGroundAltitude(TargetHoverHeight)end end;if au and hy~=-1 then bb=core.getMaxKinematicsParametersAlongAxis("ground",core.getConstructOrientationUp())[1]end;WasInAtmo=au end;local function hz(hA,hB,hC,hD,df,e7,hE,hF,hG)local hH={enableName=hA,disableName=hB,width=hC,height=hD,x=df,y=e7,toggleVar=hE,toggleFunction=hF,drawCondition=hG,hovered=false}table.insert(aI,hH)return hH end;local function hI()local function hJ()if dbHud_1 then local position=bN;local dw=planet.name..". "..#SavedLocations;if radar_1 then local gJ,_=radar_1.getData():match('"constructId":"([0-9]*)","distance":([%d%.]*)')if gJ~=nil and gJ~=""then dw=dw.." "..radar_1.getConstructName(gJ)end end;local cE={}cE={position=position,name=dw,atmosphere=planet.atmosphericDensityAboveSurface,planetname=planet.name,gravity=planet.gravity,safe=true}SavedLocations[#SavedLocations+1]=cE;table.insert(b3[0],cE)bY()a2="Location saved as "..dw else a2="Databank must be installed to save locations"end end;local function hK()TurnBurn=not TurnBurn end;local function hL(hM)if hM==1 then ProgradeIsOn=not ProgradeIsOn;RetrogradeIsOn=false else RetrogradeIsOn=not RetrogradeIsOn;ProgradeIsOn=false end;Autopilot=false;AltitudeHold=false;a0=false;BrakeLanding=false;LockPitch=nil;Reentry=false;AutoTakeoff=false end;local function hN()hL(1)end;local function hO()local cD=-1;cD=cb(b3[0])if cD>-1 then table.remove(b3[0],cD)end;cD=-1;cD=cb(SavedLocations)if cD~=-1 then a2=CustomTarget.name.." saved location cleared"table.remove(SavedLocations,cD)end;ck()bY()end;local function hP()local dw=AutopilotTargetName;if dw==nil then local f5,ca=c6((bN-CustomTarget.position):len())dw=CustomTarget.name.." "..f5 ..ca end;if dw==nil then dw="None"end;return"Engage Autopilot: "..dw end;local function hQ()local dw=AutopilotTargetName;if dw==nil then dw=CustomTarget.name end;if dw==nil then dw="None"end;return"Disable Autopilot: "..dw end;local hR=50;local hS=260;local hT=hz("Enable Brake Toggle","Disable Brake Toggle",hS,hR,aJ/2-hS/2,aK/2+350,function()return BrakeToggleStatus end,function()BrakeToggleStatus=not BrakeToggleStatus;if BrakeToggleStatus then a2="Brakes in Toggle Mode"else a2="Brakes in Default Mode"end end)hz("Align Prograde","Disable Prograde",hS,hR,aJ/2-hS/2-50-hT.width,aK/2-hR+380,function()return ProgradeIsOn end,hN)hz("Align Retrograde","Disable Retrograde",hS,hR,aJ/2-hS/2+hT.width+50,aK/2-hR+380,function()return RetrogradeIsOn end,hL,function()return av==0 end)local hU=hz(hP,hQ,600,60,aJ/2-600/2,aK/2-60/2-400,function()return Autopilot end,cy)hz("Save Position","Save Position",200,hU.height,hU.x+hU.width+30,hU.y,function()return false end,hJ,function()return AutopilotTargetIndex==0 or CustomTarget==nil end)hz("Update Position","Update Position",200,hU.height,hU.x+hU.width+30,hU.y,function()return false end,cB,function()return AutopilotTargetIndex>0 and CustomTarget~=nil end)hz("Clear Position","Clear Position",200,hU.height,hU.x-200-30,hU.y,function()return true end,hO,function()return AutopilotTargetIndex>0 and CustomTarget~=nil end)hR=60;hS=300;local df=10;local e7=aK/2-500;hz("Show Help","Hide Help",hS,hR,df,e7,function()return showHelp end,function()showHelp=not showHelp end)local e7=aK/2-300;hz("Enable Turn and Burn","Disable Turn and Burn",hS,hR,df,e7,function()return TurnBurn end,hK)hz("Horizontal Takeoff Mode","Vertical Takeoff Mode",hS,hR,df+hS+20,e7,function()return VertTakeOffEngine end,function()VertTakeOffEngine=not VertTakeOffEngine;if VertTakeOffEngine then a2="Vertical Takeoff Mode"else a2="Horizontal Takeoff Mode"end end,function()return bO end)e7=e7+hR+20;hz("Show Orbit Display","Hide Orbit Display",hS,hR,df,e7,function()return DisplayOrbit end,function()DisplayOrbit=not DisplayOrbit;if DisplayOrbit then a2="Orbit Display Enabled"else a2="Orbit Display Disabled"end end)hz("Engage Orbiting","Cancel Orbiting",hS,hR,df+hS+20,e7,function()return IntoOrbit end,ce,function()return av==0 and unit.getClosestPlanetInfluence()>0 end)e7=e7+hR+20;hz("Glide Re-Entry","Cancel Glide Re-Entry",hS,hR,df,e7,function()return Reentry end,function()ao=true;hN()end,function()return planet.hasAtmosphere and not au end)hz("Parachute Re-Entry","Cancel Parachute Re-Entry",hS,hR,df+hS+20,e7,function()return Reentry end,cT,function()return planet.hasAtmosphere and not au end)e7=e7+hR+20;hz("Engage Follow Mode","Disable Follow Mode",hS,hR,df,e7,function()return a0 end,cg,function()return n()==1 end)hz("Enable Repair Arrows","Disable Repair Arrows",hS,hR,df+hS+20,e7,function()return aT end,function()aT=not aT;if aT then a2="Repair Arrows Enabled"else a2="Repair Arrows Diabled"end end,function()return n()==1 end)e7=e7+hR+20;if not ExternalAGG then hz("Enable AGG","Disable AGG",hS,hR,df,e7,function()return bP end,cW,function()return antigrav~=nil end)end;e7=e7+hR+20;hz(function()return f("Toggle Control Scheme - Current: %s",userControlScheme)end,function()return f("Control Scheme: %s",userControlScheme)end,hS*2,hR,df,e7,function()return false end,function()if userControlScheme=="keyboard"then userControlScheme="mouse"elseif userControlScheme=="mouse"then userControlScheme="virtual joystick"else userControlScheme="keyboard"end end)end;local function hV()local hW=nil;local hX=nil;local hY=nil;local hZ=nil;b3=g4()for bZ,b_ in pairs(b3[0])do if hW==nil or b_.center.x<hW then hW=b_.center.x end;if hX==nil or b_.center.x>hX then hX=b_.center.x end;if hY==nil or b_.center.y<hY then hY=b_.center.y end;if hZ==nil or b_.center.y>hZ then hZ=b_.center.y end end;b4=""local h_=1.1*(hX-hW)/1920;local i0=1.4*(hZ-hY)/1080;for bZ,b_ in pairs(b3[0])do local df=960+b_.center.x/h_;local e7=540+b_.center.y/i0;b4=b4 ..'<circle cx="'..df..'" cy="'..e7 ..'" r="'..b_.radius/h_*30 ..'" stroke="white" stroke-width="3" fill="blue" />'if not p(b_.name,"Moon")and not p(b_.name,"Sanctuary")and not p(b_.name,"Space")then b4=b4 .."<text x='"..df.."' y='"..e7+b_.radius/h_*30+20 .."' font-size='28' fill="..aB.." text-anchor='middle' font-family='Montserrat'>"..b_.name.."</text>"end end;local fM=bN;local df=960+fM.x/h_;local e7=540+fM.y/i0;b4=b4 ..'<circle cx="'..df..'" cy="'..e7 ..'" r="5" stroke="white" stroke-width="3" fill="red"/>'b4=b4 .."<text x='"..df.."' y='"..e7-50 .."' font-size='36' fill='darkred' text-anchor='middle' font-family='Bank' font-weight='bold'>You Are Here</text>"b4=b4 ..[[</svg>]]b5=h_;b6=i0;if screen_2 then screen_2.setHTML('<svg width="100%" height="100%" viewBox="0 0 1920 1080">'..b4)local fM=bN;local df=960+fM.x/h_;local e7=540+fM.y/i0;b4='<svg><circle cx="80" cy="80" r="5" stroke="white" stroke-width="3" fill="red"/>'b4=b4 .."<text x='80' y='105' font-size='18' fill="..aB.." text-anchor='middle' font-family='Montserrat''>You Are Here</text></svg>"b7=screen_2.addContent((df-80)/19.20,(e7-80)/10.80,b4)end end;local function i1()for bZ,b_ in pairs(SavedLocations)do table.insert(b3[0],b_)end;bY()end;local function i2()local ba={}local i3=30000000/3600;local i4=i3*i3;local i5=100;local function i6(b_)return 1/math.sqrt(1-b_*b_/i4)end;function ba.computeAccelerationTime(i7,i8,i9)local ia=i3*math.asin(i7/i3)return(i3*math.asin(i9/i3)-ia)/i8 end;function ba.computeDistanceAndTime(i7,i9,ib,ic,id,ie)id=id or 0;ie=ie or 0;local ig=i7<=i9;local ih=ic*(ig and 1 or-1)/ib;local ii=-ie/ib;local ij=ih+ii;if ig and ij<=0 or not ig and ij>=0 then return-1,-1 end;local ik,il=0,0;if ih~=0 and id>0 then local ia=math.asin(i7/i3)local im=math.pi*(ih/2+ii)local io=ih*id;local ip=i3*math.pi;local b_=function(ga)local iq=(im*ga-io*math.sin(math.pi*ga/2/id)+ip*ia)/ip;local ir=math.tan(iq)return i3*ir/math.sqrt(ir*ir+1)end;local is=ig and function(gc)return gc>=i9 end or function(gc)return gc<=i9 end;il=2*id;if is(b_(il))then local it=0;while d(il-it)>0.5 do local ga=(il+it)/2;if is(b_(ga))then il=ga else it=ga end end end;local iu=i7;local iv=il/i5;for iw=1,i5 do local e4=b_(iw*iv)ik=ik+(e4+iu)*iv/2;iu=e4 end;if il<2*id then return ik,il end;i7=iu end;local ia=i3*math.asin(i7/i3)local bF=(i3*math.asin(i9/i3)-ia)/ij;local ix=i4*math.cos(ia/i3)/ij;local ak=ix-i4*math.cos((ij*bF+ia)/i3)/ij;return ak+ik,bF+il end;function ba.computeTravelTime(i7,i8,ak)if ak==0 then return 0 end;if i8>0 then local ia=i3*math.asin(i7/i3)local ix=i4*math.cos(ia/i3)/i8;return(i3*math.acos(i8*(ix-ak)/i4)-ia)/i8 end;if i7==0 then return-1 end;assert(i7>0,'Acceleration and initial speed are both zero.')return ak/i7 end;function ba.lorentz(b_)return i6(b_)end;return ba end;local function iy()local vec3=require('cpml.vec3')local g5=g5()local function gb(gc)return type(gc)=='string'end;local function g9(ga)return type(ga)=='table'end;local function c3(c4,c5)if c4==0 then return d(c5)<1e-09 end;if c5==0 then return d(c4)<1e-09 end;return d(c4-c5)<math.max(d(c4),d(c5))*constants.epsilon end;Kepler={}Kepler.__index=Kepler;function Kepler:escapeAndOrbitalSpeed(ct)assert(self.body)local ak=ct+self.body.radius;if not c3(ak,0)then local orbit=math.sqrt(self.body.GM/ak)return math.sqrt(2)*orbit,orbit end;return nil,nil end;function Kepler:orbitalParameters(gB,ew)assert(self.body)assert(g9(gB)or gb(gB))assert(g9(ew))local fM=(gb(gB)or g5.isMapPosition(gB))and self.body:convertToWorldCoordinates(gB)or vec3(gB)local b_=vec3(ew)local iz=fM-self.body.center;local h5=b_:len2()local iA=iz:len()local iB=self.body.GM;local iC=((h5-iB/iA)*iz-iz:dot(b_)*b_)/iB;local c4=iB/(2*iB/iA-h5)local iD=iC:len()local h6=iC:normalize()local iE=c4*(1-iD)local iF=c4*(1+iD)local iG=iE*h6+self.body.center;local iH=iD<=1 and-iF*h6+self.body.center or nil;local iI=math.sqrt(c4*iB*(1-iD*iD))local iJ=iH and 2*math.pi*math.sqrt(c4^3/iB)local iK=math.acos(iC:dot(iz)/(iD*iA))if iz:dot(b_)<0 then iK=-(iK-2*math.pi)end;local iL=math.acos((math.cos(iK)+iD)/(1+iD*math.cos(iK)))local iM=iL;if iM<0 then iM=iM+2*math.pi end;local iN=iM-iD*math.sin(iM)local iO=0;local iP=0;local iQ=0;if iJ~=nil then iO=iN/(2*math.pi/iJ)iP=iJ-iO;iQ=iP+iJ/2;if iK-math.pi>0 then iP=iO;iQ=iP+iJ/2 end;if iQ>iJ then iQ=iQ-iJ end end;return{periapsis={position=iG,speed=iI/iE,circularOrbitSpeed=math.sqrt(iB/iE),altitude=iE-self.body.radius},apoapsis=iH and{position=iH,speed=iI/iF,circularOrbitSpeed=math.sqrt(iB/iF),altitude=iF-self.body.radius},currentVelocity=b_,currentPosition=fM,eccentricity=iD,period=iJ,eccentricAnomaly=iL,meanAnomaly=iN,timeToPeriapsis=iP,timeToApoapsis=iQ}end;local function iR(iS)local hd=g5.BodyParameters(iS.planetarySystemId,iS.bodyId,iS.radius,iS.center,iS.GM)return setmetatable({body=hd},Kepler)end;return setmetatable(Kepler,{__call=function(_,...)return iR(...)end})end;SetupComplete=false;beginSetup=coroutine.create(function()t:setupCustomTargetSpeedRanges(axisCommandId.longitudinal,{1000,5000,10000,20000,30000})hj()coroutine.yield()hn()coroutine.yield()hx()hI()coroutine.yield()hV()b8=g5()b9=b8(g4())ba=i2()bc=iy()bd=d7()i1()bY()ch()coroutine.yield()unit.hide()system.showScreen(1)collectgarbage("collect")coroutine.yield()unit.setTimer("apTick",apTickRate)unit.setTimer("hudTick",hudTickRate)unit.setTimer("oneSecond",1)unit.setTimer("tenthSecond",1/10)if UseSatNav then unit.setTimer("fiveSecond",5)end end)end;function script.onStop()_autoconf.hideCategoryPanels()if antigrav~=nil and not ExternalAGG then antigrav.hide()end;if warpdrive~=nil then warpdrive.hide()end;core.hide()a.control.switchOffHeadlights()if door and(av>0 or av==0 and aw<10000)then for _,b_ in pairs(door)do b_.toggle()end end;if switch then for _,b_ in pairs(switch)do b_.toggle()end end;if forcefield and(av>0 or av==0 and aw<10000)then for _,b_ in pairs(forcefield)do b_.toggle()end end;d3()if button then button.activate()end;if SetWaypointOnExit then cm(planet,bN)end end;function script.onTick(iT)local function iU(e4)if not au then return ba.computeDistanceAndTime(e4,AutopilotEndSpeed,m(),0,0,LastMaxBrake-AutopilotPlanetGravity*m())else if LastMaxBrakeInAtmo and LastMaxBrakeInAtmo>0 then return ba.computeDistanceAndTime(e4,AutopilotEndSpeed,m(),0,0,LastMaxBrakeInAtmo-AutopilotPlanetGravity*m())else return 0,0 end end end;local function iV(e4)return ba.computeDistanceAndTime(e4,AutopilotEndSpeed,m(),a:maxForceForward(),warmup,LastMaxBrake-AutopilotPlanetGravity*m())end;if iT=="tenthSecond"then local function iW()local iX=system.createData;local iY=system.createWidget;panelInterplanetary=system.createWidgetPanel("Interplanetary Helper")interplanetaryHeader=iY(panelInterplanetary,"value")interplanetaryHeaderText=iX('{"label": "Target Planet", "value": "N/A", "unit":""}')w(interplanetaryHeaderText,interplanetaryHeader)widgetDistance=iY(panelInterplanetary,"value")widgetDistanceText=iX('{"label": "distance", "value": "N/A", "unit":""}')w(widgetDistanceText,widgetDistance)widgetTravelTime=iY(panelInterplanetary,"value")widgetTravelTimeText=iX('{"label": "Travel Time", "value": "N/A", "unit":""}')w(widgetTravelTimeText,widgetTravelTime)widgetMaxMass=iY(panelInterplanetary,"value")widgetMaxMassText=iX('{"label": "Maximum Mass", "value": "N/A", "unit":""}')w(widgetMaxMassText,widgetMaxMass)widgetTargetOrbit=iY(panelInterplanetary,"value")widgetTargetOrbitText=iX('{"label": "Target Altitude", "value": "N/A", "unit":""}')w(widgetTargetOrbitText,widgetTargetOrbit)widgetCurBrakeDistance=iY(panelInterplanetary,"value")widgetCurBrakeDistanceText=iX('{"label": "Cur Brake distance", "value": "N/A", "unit":""}')widgetCurBrakeTime=iY(panelInterplanetary,"value")widgetCurBrakeTimeText=iX('{"label": "Cur Brake Time", "value": "N/A", "unit":""}')widgetMaxBrakeDistance=iY(panelInterplanetary,"value")widgetMaxBrakeDistanceText=iX('{"label": "Max Brake distance", "value": "N/A", "unit":""}')widgetMaxBrakeTime=iY(panelInterplanetary,"value")widgetMaxBrakeTimeText=iX('{"label": "Max Brake Time", "value": "N/A", "unit":""}')widgetTrajectoryAltitude=iY(panelInterplanetary,"value")widgetTrajectoryAltitudeText=iX('{"label": "Projected Altitude", "value": "N/A", "unit":""}')if not au then w(widgetCurBrakeDistanceText,widgetCurBrakeDistance)w(widgetCurBrakeTimeText,widgetCurBrakeTime)w(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)w(widgetMaxBrakeTimeText,widgetMaxBrakeTime)w(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end end;local function iZ()u(panelInterplanetary)panelInterplanetary=nil end;local function i_()if not Autopilot then if CustomTarget==nil or CustomTarget.planetname~=planet.name then AutopilotDistance=(ac.center-bN):len()else AutopilotDistance=(CustomTarget.position-bN):len()end end;local e4=bK;local j0=unit.getThrottle()/100;if AtmoSpeedAssist then j0=I end;local j1,j2=ba.computeDistanceAndTime(bK,MaxGameVelocity,m(),a:maxForceForward()*j0,warmup,0)local a8,a9;if not TurnBurn then a8,a9=iU(MaxGameVelocity)else a8,a9=iV(MaxGameVelocity)end;local _,j3;if not TurnBurn and e4>0 then _,j3=iU(e4)else _,j3=iV(e4)end;local j4=0;local j5=0;if AutopilotCruising or not Autopilot and e4>5 then j5=ba.computeTravelTime(e4,0,AutopilotDistance)elseif a8+j1<AutopilotDistance then j4=AutopilotDistance-(a8+j1)j5=ba.computeTravelTime(8333.0556,0,j4)else local j6=(AutopilotDistance-a8)/j1;j1=AutopilotDistance-a8;j2=j2*j6 end;if CustomTarget~=nil and CustomTarget.planetname==planet.name and not Autopilot then return j5 elseif AutopilotBraking then return j3 elseif AutopilotCruising then return j5+j3 else return j2+a9+j5 end end;local function j7()local j8=LastMaxBrakeInAtmo/ac:getGravity(ac.center+vec3(0,0,1)*ac.radius):len()return j8 end;if av>0 and not WasInAtmo then if not bR and AtmoSpeedAssist and(AltitudeHold or Reentry)then bU(1)M=false end end;if bQ~=nil then if t:getTargetSpeed(axisCommandId.longitudinal)~=bQ then bX(bQ,TRUE)else bQ=nil end end;if AutopilotTargetName~="None"then if panelInterplanetary==nil then iW()end;if AutopilotTargetName~=nil then local j9=CustomTarget~=nil;planetMaxMass=j7()v(interplanetaryHeaderText,'{"label": "Target", "value": "'..AutopilotTargetName..'", "unit":""}')travelTime=i_()if j9 and not Autopilot then ak=(bN-CustomTarget.position):len()else ak=(AutopilotTargetCoords-bN):len()end;if not TurnBurn then a8,a9=iU(bK)aa,ab=iU(MaxGameVelocity)else a8,a9=iV(bK)aa,ab=iV(MaxGameVelocity)end;local f5,ca=c6(ak)v(widgetDistanceText,'{"label": "distance", "value": "'..f5 ..'", "unit":"'..ca..'"}')v(widgetTravelTimeText,'{"label": "Travel Time", "value": "'..cX(travelTime)..'", "unit":""}')f5,ca=c6(a8)v(widgetCurBrakeDistanceText,'{"label": "Cur Brake distance", "value": "'..f5 ..'", "unit":"'..ca..'"}')v(widgetCurBrakeTimeText,'{"label": "Cur Brake Time", "value": "'..cX(a9)..'", "unit":""}')f5,ca=c6(aa)v(widgetMaxBrakeDistanceText,'{"label": "Max Brake distance", "value": "'..f5 ..'", "unit":"'..ca..'"}')v(widgetMaxBrakeTimeText,'{"label": "Max Brake Time", "value": "'..cX(ab)..'", "unit":""}')v(widgetMaxMassText,'{"label": "Maximum Mass", "value": "'..f("%.2f",planetMaxMass/1000)..'", "unit":" Tons"}')f5,ca=c6(AutopilotTargetOrbit)v(widgetTargetOrbitText,'{"label": "Target Orbit", "value": "'..f("%.2f",f5)..'", "unit":"'..ca..'"}')if av>0 and not WasInAtmo then system.removeDataFromWidget(widgetMaxBrakeTimeText,widgetMaxBrakeTime)system.removeDataFromWidget(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)system.removeDataFromWidget(widgetCurBrakeTimeText,widgetCurBrakeTime)system.removeDataFromWidget(widgetCurBrakeDistanceText,widgetCurBrakeDistance)system.removeDataFromWidget(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)WasInAtmo=true end;if av==0 and WasInAtmo then if v(widgetMaxBrakeTimeText,widgetMaxBrakeTime)==1 then w(widgetMaxBrakeTimeText,widgetMaxBrakeTime)end;if v(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)==1 then w(widgetMaxBrakeDistanceText,widgetMaxBrakeDistance)end;if v(widgetCurBrakeTimeText,widgetCurBrakeTime)==1 then w(widgetCurBrakeTimeText,widgetCurBrakeTime)end;if v(widgetCurBrakeDistanceText,widgetCurBrakeDistance)==1 then w(widgetCurBrakeDistanceText,widgetCurBrakeDistance)end;if v(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)==1 then w(widgetTrajectoryAltitudeText,widgetTrajectoryAltitude)end;WasInAtmo=false end end else iZ()end;if warpdrive~=nil then if g(warpdrive.getData()).destination~="Unknown"and g(warpdrive.getData()).distance>400000 then warpdrive.show()showWarpWidget=true else warpdrive.hide()showWarpWidget=false end end elseif iT=="oneSecond"then local function ja(fR,jb)if fR==nil then fR=core.g()end;fR=z(fR,5)if jb~=nil and jb or(aO==nil or aO~=fR)then local ew=core.getVelocity()local e4=vec3(ew):len()local jc=g(unit.getData()).maxBrake;if jc~=nil and jc>0 and au then jc=jc/s(e4/100,0.1,1)jc=jc/av;if av>0.10 then if LastMaxBrakeInAtmo then LastMaxBrakeInAtmo=(LastMaxBrakeInAtmo+jc)/2 else LastMaxBrakeInAtmo=jc end end end;if jc~=nil and jc>0 then LastMaxBrake=jc end;aO=fR end end;local function jd(de)local je=0;aG=""local jf=aS;local jg=0;local jh=0;local ji=0;local dF=0;local dG=""local jj=core.getElementHitPointsById;for bZ in pairs(ax)do local hu=0;local jk=0;jk=j(ax[bZ])hu=jj(ax[bZ])jg=jg+hu;if hu<jk then if hu==0 then ji=ji+1 else jh=jh+1 end;if aT and#aD==0 then position=vec3(core.getElementPositionById(ax[bZ]))local df=position.x-b1;local e7=position.y-b1;local jl=position.z-b1;table.insert(aD,core.spawnArrowSticker(df,e7,jl+1,"down"))table.insert(aD,core.spawnArrowSticker(df,e7,jl+1,"down"))core.rotateSticker(aD[2],0,0,90)table.insert(aD,core.spawnArrowSticker(df+1,e7,jl,"north"))table.insert(aD,core.spawnArrowSticker(df+1,e7,jl,"north"))core.rotateSticker(aD[4],90,90,0)table.insert(aD,core.spawnArrowSticker(df-1,e7,jl,"south"))table.insert(aD,core.spawnArrowSticker(df-1,e7,jl,"south"))core.rotateSticker(aD[6],90,-90,0)table.insert(aD,core.spawnArrowSticker(df,e7-1,jl,"east"))table.insert(aD,core.spawnArrowSticker(df,e7-1,jl,"east"))core.rotateSticker(aD[8],90,0,90)table.insert(aD,core.spawnArrowSticker(df,e7+1,jl,"west"))table.insert(aD,core.spawnArrowSticker(df,e7+1,jl,"west"))core.rotateSticker(aD[10],-90,0,90)table.insert(aD,ax[bZ])end elseif aT and#aD>0 and aD[11]==ax[bZ]then for dy in pairs(aD)do core.deleteSticker(aD[dy])end;aD={}end end;je=e(jg/jf*100)if je<100 then de[#de+1]=[[<g class="pbright txt">]]dF=e(je*2.55)dG=f("rgb(%d,%d,%d)",255-dF,dF,0)if je<100 then de[#de+1]=f([[<text class="txtbig txtmid" x=50%% y="1035" style="fill:%s">Elemental Integrity: %i %%</text>]],dG,je)if ji>0 then de[#de+1]=f([[<text class="txtbig txtmid" x=50%% y="1055" style="fill:%s">Disabled Modules: %i Damaged Modules: %i</text>]],dG,ji,jh)elseif jh>0 then de[#de+1]=f([[<text class="txtbig txtmid" x=50%% y="1055"style="fill:%s">Damaged Modules: %i</text>]],dG,jh)end end;de[#de+1]=[[<\g>]]end end;local function jm()if weapon then if WeaponPanelID==nil and(radarPanelID~=nil or GearExtended)then _autoconf.displayCategoryPanel(weapon,weapon_size,L_TEXT("ui_lua_widget_weapon", "Weapons"),"weapon",true)WeaponPanelID=_autoconf.panels[_autoconf.panels_size]elseif WeaponPanelID~=nil and radarPanelID==nil and not GearExtended then u(WeaponPanelID)WeaponPanelID=nil end end end;local function jn()local dD=r()local eU=bK;local jo=dD-ay;if eU>1.38889 then eU=eU/1000;local jp=eU*(dD-ay)TotalDistanceTravelled=TotalDistanceTravelled+jp;ad=ad+jp end;ae=ae+jo;TotalFlightTime=TotalFlightTime+jo;ay=dD end;as=false;ja(nil,true)jn()bd.UpdateRadar()jm()local de={}de=bd.DrawOdometer(de,ad,TotalDistanceTravelled,ae)if ShouldCheckDamage then jd(de)end;am=table.concat(de,"")collectgarbage("collect")elseif iT=="fiveSecond"then at=dbHud_1.getStringValue("SPBAutopilotTargetName")if at~=nil and at~=""and at~="SatNavNotChanged"then local c9=g(dbHud_1.getStringValue("SavedLocations"))if c9~=nil then _G["SavedLocations"]=c9;local cD=-1;local cE;for bZ,b_ in pairs(SavedLocations)do if b_.name and b_.name=="SatNav Location"then cD=bZ;break end end;if cD~=-1 then cE=SavedLocations[cD]cD=-1;for bZ,b_ in pairs(b3[0])do if b_.name and b_.name=="SatNav Location"then cD=bZ;break end end;if cD>-1 then b3[0][cD]=cE end;bY()a2=cE.name.." position updated"end end;for i=1,#AtlasOrdered do if AtlasOrdered[i].name==at then AutopilotTargetIndex=i;system.print("Index = "..AutopilotTargetIndex.." "..AtlasOrdered[i].name)ch()dbHud_1.setStringValue("SPBAutopilotTargetName","SatNavNotChanged")break end end end elseif iT=="msgTick"then local de={}bd.DisplayMessage(de,"empty")a2="empty"unit.stopTimer("msgTick")aj=3 elseif iT=="animateTick"then bf=true;be=false;ah=0;ai=0;unit.stopTimer("animateTick")elseif iT=="hudTick"then local function jq(de)local jr=e(s(ak/(aJ/4)*255,0,255))de[#de+1]=f("<line x1='0' y1='0' x2='%fpx' y2='%fpx' style='stroke:rgb(%d,%d,%d);stroke-width:2;transform:translate(50%%, 50%%)' />",ah,ai,e(D+0.5)+jr,e(F+0.5)-jr,e(E+0.5)-jr)end;local function js()for _,b_ in pairs(aI)do if b_.hovered then if not b_.drawCondition or b_.drawCondition()then b_.toggleFunction()end;b_.hovered=false end end end;local function jt()local function ju(jv,jw,df,e7,hC,hD)if jv>df and jv<df+hC and jw>e7 and jw<e7+hD then return true else return false end end;local df=ah+aJ/2;local e7=ai+aK/2;for _,b_ in pairs(aI)do b_.hovered=ju(df,e7,b_.x,b_.y,b_.width,b_.height)end end;local function jx(de)local function jy(de,jz,hover,df,e7,iq,jA,jB,jC,jD,jE)if type(jD)=="function"then jD=jD()end;if type(jE)=="function"then jE=jE()end;de[#de+1]=f("<rect x='%f' y='%f' width='%f' height='%f' fill='",df,e7,iq,jA)if jz then de[#de+1]=f("%s'",jB)else de[#de+1]=jC end;if hover then de[#de+1]=" style='stroke:white; stroke-width:2'"else de[#de+1]=" style='stroke:black; stroke-width:1'"end;de[#de+1]="></rect>"de[#de+1]=f("<text x='%f' y='%f' font-size='24' fill='",df+iq/2,e7+jA/2+5)if jz then de[#de+1]="black"else de[#de+1]="white"end;de[#de+1]="' text-anchor='middle' font-family='Montserrat'>"if jz then de[#de+1]=f("%s</text>",jD)else de[#de+1]=f("%s</text>",jE)end end;local jF="rgb(50,50,50)'"local jG="rgb(210,200,200)"local jH=jy;for _,b_ in pairs(aI)do local hB=b_.disableName;local hA=b_.enableName;if type(hB)=="function"then hB=hB()end;if type(hA)=="function"then hA=hA()end;if not b_.drawCondition or b_.drawCondition()then jH(de,b_.toggleVar(),b_.hovered,b_.x,b_.y,b_.width,b_.height,jG,jF,hB,hA)end end end;local de={}bd.HUDPrologue(de)if showHud then bd.UpdateHud(de)else bd.DisplayOrbitScreen(de)bd.DrawWarnings(de)end;bd.HUDEpilogue(de)de[#de+1]=f([[<svg width="100%%" height="100%%" style="position:absolute;top:0;left:0"  viewBox="0 0 %d %d">]],aJ,aK)if a2~="empty"then bd.DisplayMessage(de,a2)end;if n()==0 and userControlScheme=="virtual joystick"then if DisplayDeadZone then bd.DrawDeadZone(de)end end;if n()==1 and screen_1 and screen_1.getMouseY()~=-1 then jt()jx(de)if screen_1.getMouseState()==1 then js()end;de[#de+1]=f([[<g transform="translate(%d %d)"><circle class="cursor" cx="%fpx" cy="%fpx" r="5"/></g>]],N,O,ah,ai)elseif y()==0 then if n()==1 and a1 then jt()jx(de)if not be and not bf then local jI=table.concat(de,"")de={}de[#de+1]=f("<style>@keyframes test { from { opacity: 0; } to { opacity: 1; } }  body { animation-name: test; animation-duration: 0.5s; }</style><body><svg width='100%%' height='100%%' position='absolute' top='0' left='0'><rect width='100%%' height='100%%' x='0' y='0' position='absolute' style='fill:rgb(6,5,26);'/></svg><svg width='50%%' height='50%%' style='position:absolute;top:30%%;left:25%%' viewbox='0 0 %d %d'>",aJ,aK)de[#de+1]=b4;de[#de+1]=jI;de[#de+1]="</body>"be=true;de[#de+1]=[[</svg></body>]]unit.setTimer("animateTick",0.5)local content=table.concat(de,"")system.setScreen(content)elseif bf then local jI=table.concat(de,"")de={}de[#de+1]=f("<body style='background-color:rgb(6,5,26)'><svg width='50%%' height='50%%' style='position:absolute;top:30%%;left:25%%' viewbox='0 0 %d %d'>",aJ,aK)de[#de+1]=b4;de[#de+1]=jI;de[#de+1]="</body>"end;if not be then de[#de+1]=f([[<g transform="translate(%d %d)"><circle class="cursor" cx="%fpx" cy="%fpx" r="5"/></g>]],N,O,ah,ai)end else js()end else if not a1 and n()==0 then js()if ak>DeadZone then if DisplayDeadZone then jq(de)end end else jt()jx(de)end;de[#de+1]=f([[<g transform="translate(%d %d)"><circle class="cursor" cx="%fpx" cy="%fpx" r="5"/></g>]],N,O,ah,ai)end;de[#de+1]=[[</svg></body>]]content=table.concat(de,"")if not DidLogOutput then system.logInfo(LastContent)DidLogOutput=true end elseif iT=="apTick"then local function jJ(jK)local gx=500000;local jL,jM,jN=math.huge;local jO=false;local jP=vec3({13771471,7435803,-128971})local jQ=18000000;jL=vec3(jK):dist(jP)if jL<jQ then return true,d(jL-jQ),"Safe Zone",0 end;jM=vec3(jK):dist(vec3(planet.center))if jM<gx then jO=true end;if d(jM-gx)<d(jL-jQ)then return jO,d(jM-gx),planet.name,planet.bodyId else return jO,d(jL-jQ),"Safe Zone",0 end end;local function jR()local jS=-1;local jT=-1;if vBooster then jS=vBooster.distance()end;if hover then jT=hover.distance()end;if jS~=-1 and jT~=-1 then if jS<jT then return jS else return jT end elseif jS~=-1 then return jS elseif jT~=-1 then return jT else return-1 end end;local function jU(jV,jW,jX)jW=jW:project_on_plane(jV)jX=jX:project_on_plane(jV)return o(jW:cross(jX):dot(jV),jW:dot(jX))end;au=k()>0;av=k()aw=core.getAltitude()ar=jR()bF=r()bl=bF;if antigrav then bP=antigrav.getState()==1 end;local jY=1;local jZ=1;local j_=bF-bl;local k0=-math.deg(jU(bG,bJ,bH))local k1=math.deg(jU(bI,bJ,bH))local cl=bL*-1;bk=au and k0<-YawStallAngle or k0>YawStallAngle or k1<-PitchStallAngle or k1>PitchStallAngle;bi=system.getMouseDeltaX()bj=system.getMouseDeltaY()if InvertMouse and not a1 then bj=-bj end;V=0;Z=0;U=0;sys=b9[0]planet=sys:closestBody(core.getConstructWorldPos())kepPlanet=bc(planet)orbit=kepPlanet:orbitalParameters(core.getConstructWorldPos(),bJ)if aw==0 then aw=(bN-planet.center):len()-planet.radius end;local fR=planet:getGravity(core.getConstructWorldPos()):len()*m()bm=0;bb=core.getMaxKinematicsParametersAlongAxis("ground",core.getConstructOrientationUp())[1]if not au then G,H,_,_=jJ(bN)else G=true end;ah=ah+bi;ai=ai+bj;if n()==1 and screen_1 and screen_1.getMouseY()~=-1 then ah=screen_1.getMouseX()*aJ;ai=screen_1.getMouseY()*aK elseif y()==0 then if not n()==1 and not a1 then ah=0;ai=0 end else ak=math.sqrt(ah*ah+ai*ai)if not a1 and n()==0 then if userControlScheme=="virtual joystick"then if ah>0 and ah>DeadZone then V=V-(ah-DeadZone)*MouseXSensitivity elseif ah<0 and ah<DeadZone*-1 then V=V-(ah+DeadZone)*MouseXSensitivity else V=0 end;if ai>0 and ai>DeadZone then U=U-(ai-DeadZone)*MouseYSensitivity elseif ai<0 and ai<DeadZone*-1 then U=U-(ai+DeadZone)*MouseYSensitivity else U=0 end else ah=0;ai=0;if userControlScheme=="mouse"then U=(-utils.smoothstep(bj,-100,100)+0.5)*2*jY;V=(-utils.smoothstep(bi,-100,100)+0.5)*2*jZ end end end end;local k2=bK>8334;if bK>SpaceSpeedLimit/3.6 and not au and not Autopilot and not k2 then a2="Space Speed Engine Shutoff reached"bU(0)end;if not k2 and LastIsWarping then if not BrakeIsOn then cG()end;if Autopilot then cy()end end;LastIsWarping=k2;if au and av>0.09 then if bK>bp/3.6 and not AtmoSpeedAssist and not aA then BrakeIsOn=true;aA=true elseif not AtmoSpeedAssist and aA then if bK<bp/3.6 then BrakeIsOn=false;aA=false end end end;if BrakeIsOn then Y=1 else Y=0 end;if ProgradeIsOn then if ao then BrakeIsOn=false;local k3=false;if CustomTarget~=nil then k3=cH(CustomTarget.position-bN,0.01)else k3=cH(vec3(bJ),0.01)end;bg=true;if k3 and(d(bT)<2 or d(bS)>85)and bK>=bp/3.6-1 then BrakeIsOn=false;ProgradeIsOn=false;R=true;ao=false;aq=true;Autopilot=false;cT()elseif au and AtmoSpeedAssist then bU(1)else bX(e(bp))end elseif bK>Q then cH(vec3(bJ),0.01)end end;if RetrogradeIsOn then if au then RetrogradeIsOn=false elseif bK>Q then cH(-vec3(bJ))end end;if not ProgradeIsOn and ao and not IntoOrbit then if av==0 then R=true;cT()ao=false;aq=true else ao=false;cy()end end;if aq and CustomTarget~=nil and(aw<HoldAltitude+200 and aw>HoldAltitude-200)and bK*3.6>bp-100 and d(bM)<20 and av>=0.1 and(CustomTarget.position-bN):len()>2000+aw then cy()aq=false end;if VertTakeOff then bg=true;local k4=HoldAltitude;if bM<-30 then a2="Unable to achieve lift. Safety Landing."ag=0;bg=autoRollPreference;VertTakeOff=false;BrakeLanding=true elseif not ExternalAGG and bP or HoldAltitude<planet.spaceEngineMinAltitude then if bP then k4=antigrav.getBaseAltitude()end;if aw<k4-100 then bq=0;ag=15;BrakeIsOn=false elseif bM>0 then BrakeIsOn=true;ag=0 elseif bM<-30 then BrakeIsOn=true;ag=15 elseif aw>=k4 then if bP then if Autopilot or VectorToTarget then cd()else BrakeIsOn=true;VertTakeOff=false end;a2="Takeoff complete. Singularity engaged"else BrakeIsOn=false;a2="VTO complete. Engaging Horizontal Flight"cd()end;ag=0 end else if av>0.08 then bq=0;BrakeIsOn=false;ag=20 elseif av<0.08 and av>0 then BrakeIsOn=false;if bC then bq=0;ag=20 else ag=0;bq=36;bX(3500)end else bg=autoRollPreference;IntoOrbit=true;bA=false;CancelIntoOrbit=false;bu=false;bs=nil;bt=nil;if bz==nil then bz=planet end;by=k4;bx=true;VertTakeOff=false end end;if bq~=nil then if vTpitchPID==nil then vTpitchPID=pid.new(2*0.01,0,2*0.1)end;local k5=s(bq-bS,-PitchStallAngle*0.80,PitchStallAngle*0.80)vTpitchPID:inject(k5)local k6=s(vTpitchPID:get(),-1,1)U=k6 end end;if IntoOrbit then local cQ;local k7=false;local k8,k9=c6(by)local ka=k8 ..k9;if bz==nil then bz=planet;if VectorToTarget then bz=ac end end;if not bx then by=math.floor(bz.radius+bz.surfaceMaxAltitude+1000)if bz.hasAtmosphere then by=math.floor(bz.radius+bz.noAtmosphericDensityAltitude+1000)end;bx=true end;if bw.VectorToTarget then cQ=CustomTarget.position-bN end;local kb,kc=bc(bz):escapeAndOrbitalSpeed((bN-bz.center):len()-bz.radius)local kd=bT;if not bu then local ke=false;local kf=false;bU(0)bt=0;br="Aligning to orbital path - OrbitHeight: "..ka;if bw.VectorToTarget then cH(cQ:normalize():project_on_plane(bL))k7=bH:dot(cQ:project_on_plane(bG):normalize())>0.95 else cH(bJ)k7=k0<0.5;if bK<150 then k7=true end end;U=0;bs=0;if bS<=bs+1 and bS>=bs-1 then ke=true else ke=false end;if kd<=bt+1 and kd>=bt-1 then kf=true else kf=false end;if ke and kf and k7 then bs=nil;bt=nil;bu=true end else if bw.VectorToTarget then cH(cQ:normalize():project_on_plane(bL))elseif bK>150 then cH(bJ)end;U=0;if bw.VectorToTarget then local a8,_=ba.computeDistanceAndTime(bK,bp/3.6,m(),0,0,LastMaxBrake)if bA and cQ:len()>15000+a8+aw then br="Orbiting to Target"if orbit.periapsis.altitude<bz.noAtmosphericDensityAltitude then bA=false end elseif bA or cQ:len()<15000+a8+aw then a2="Orbit complete, proceeding with reentry"AutopilotTargetCoords=CustomTarget.position;R=true;aq=true;bw.VectorToTarget,bw.AutopilotAlign=false,false;ce()cT()end end;if orbit.periapsis~=nil and orbit.apoapsis~=nil and orbit.eccentricity<1 and aw>by*0.9 and aw<by*1.4 then if orbit.apoapsis~=nil then if orbit.periapsis.altitude>=by*0.99 and orbit.apoapsis.altitude>=by*0.99 and orbit.periapsis.altitude<orbit.apoapsis.altitude and orbit.periapsis.altitude*1.05>=orbit.apoapsis.altitude or bA then if bA then BrakeIsOn=false;bU(0)bs=0;if not bw.VectorToTarget then a2="Orbit complete"ce()end else bE=bE+1;if bE>=2 then bA=true end end else br="Adjusting Orbit - OrbitHeight: "..ka;bv=true;bX(kc*3.6+1)if VSpdPID==nil then VSpdPID=pid.new(0.5,0,10*0.1)end;local kg=bM;local kh=aw-by;local ki=d(kh)if bM<10 and d(bS)<10 and ki<100 then kg=bM*2 end;if kg<10 and d(bS)<10 and ki<100 then kg=kg*2 end;if kg<5 and d(bS)<5 and ki<100 then kg=kg*4 end;VSpdPID:inject(kg)bs=s(-VSpdPID:get(),-90,90)if OrbitAltPID==nil then OrbitAltPID=pid.new(0.15,0,5*0.1)end;OrbitAltPID:inject(kh)bs=s(bs-s(OrbitAltPID:get(),-15,15),-90,90)end end else local kj=2.75;local kk=d(q(kb*kj))local kl=kk%50;if kl>0 then kk=kk-kl+50 end;BrakeIsOn=false;if aw<by*0.8 then br="Escaping planet gravity - OrbitHeight: "..ka;bs=utils.map(bM,200,0,-15,80)elseif aw>=by*0.8 and aw<by*1.15 then br="Approaching orbital corridor - OrbitHeight: "..ka;kk=kk*0.75;bs=utils.map(bM,100,-100,-15,65)elseif aw>=by*1.15 and aw<by*1.5 then br="Approaching orbital corridor - OrbitHeight: "..ka;kk=kk*0.75;if bM<0 or bv then bs=utils.map(aw,by*1.5,by*1.01,-30,0)else bs=utils.map(aw,by*0.99,by*1.5,0,30)end elseif aw>by*1.5 then br="Reentering orbital corridor - OrbitHeight: "..ka;bs=-85;local km=utils.map(bM,-150,-400,1,0.55)kk=kk*km end;bX(e(kk))end end;if bs~=nil then if OrbitPitchPID==nil then OrbitPitchPID=pid.new(1*0.01,0,5*0.1)end;local kn=bs-bS;OrbitPitchPID:inject(kn)local ko=s(OrbitPitchPID:get(),-0.5,0.5)U=ko end end;if Autopilot and av==0 and not ao then local kp,kq=AutopilotTargetCoords,false;if CustomTarget~=nil and CustomTarget.planetname~="Space"then AutopilotRealigned=true;if not TargetSet then local kr=(CustomTarget.position-ac.center):normalize()local ks=kr:project_on_plane((ac.center-bN):normalize()):normalize()local kt=ac.center+ks*(ac.radius+AutopilotTargetOrbit)local ku=CustomTarget.position+(CustomTarget.position-ac.center):normalize()*(AutopilotTargetOrbit-ac:getAltitude(CustomTarget.position))if(bN-kt):len()<(bN-ku):len()then kp=kt;AutopilotTargetCoords=kp else kp=CustomTarget.position+(CustomTarget.position-ac.center):normalize()*(AutopilotTargetOrbit-ac:getAltitude(CustomTarget.position))AutopilotTargetCoords=kp end;cm(ac,AutopilotTargetCoords)kq=true;TargetSet=true end;AutopilotPlanetGravity=0 elseif CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotPlanetGravity=0;kq=true;TargetSet=true;AutopilotRealigned=true;kp=CustomTarget.position+(bN-CustomTarget.position)*AutopilotTargetOrbit elseif CustomTarget==nil then AutopilotPlanetGravity=0;if not TargetSet then local kr=(bN+bJ*100000-ac.center):normalize()local ks=kr:project_on_plane((ac.center-bN):normalize()):normalize()if ks:len()<1 then kr=(bN+bH*100000-ac.center):normalize()ks=kr:project_on_plane((ac.center-bN):normalize()):normalize()end;kp=ac.center+ks*(ac.radius+AutopilotTargetOrbit)AutopilotTargetCoords=kp;TargetSet=true;kq=true;AutopilotRealigned=true;cm(ac,AutopilotTargetCoords)end end;AutopilotDistance=(vec3(kp)-bN):len()local f6,f7,f8=b9:getPlanetarySystem(0):castIntersections(bN,bJ:normalize(),function(f9)if f9.noAtmosphericDensityAltitude>0 then return f9.radius+f9.noAtmosphericDensityAltitude else return f9.radius+f9.surfaceMaxAltitude*1.5 end end)local fa=f7;if f8~=nil and f7~=nil then fa=math.min(f8,f7)end;if fa~=nil and fa<AutopilotDistance and f6.name==ac.name then AutopilotDistance=fa end;local k3=true;local kv=(ac.center-(bN+vec3(bJ):normalize()*AutopilotDistance)):len()-ac.radius;local f5,ca=c6(kv)v(widgetTrajectoryAltitudeText,'{"label": "Projected Altitude", "value": "'..f5 ..'", "unit":"'..ca..'"}')local a8,a9;if not TurnBurn then a8,a9=iU(bK)else a8,a9=iV(bK)end;if bK>300 and AutopilotAccelerating then local cQ=vec3(kp)-bN;local kw=s(math.deg(jU(bG,bJ:normalize(),cQ:normalize()))*bK/500,-90,90)local kx=s(math.deg(jU(bI,bJ:normalize(),cQ:normalize()))*bK/500,-90,90)if d(kw)<20 and d(kx)<20 then kw=kw*2;kx=kx*2 end;if d(kw)<2 and d(kx)<2 then kw=kw*2;kx=kx*2 end;local k0=-math.deg(jU(bG,bH,bJ:normalize()))local k1=-math.deg(jU(bI,bH,bJ:normalize()))if apPitchPID==nil then apPitchPID=pid.new(2*0.01,0,2*0.1)end;apPitchPID:inject(kx-k1)local ky=s(apPitchPID:get(),-1,1)U=U+ky;if apYawPID==nil then apYawPID=pid.new(2*0.01,0,2*0.1)end;apYawPID:inject(kw-k0)local kz=s(apYawPID:get(),-1,1)V=V+kz;kq=true;if d(kw)>2 or d(kx)>2 then AutopilotStatus="Adjusting Trajectory"else AutopilotStatus="Accelerating"end end;if kv<AutopilotTargetOrbit*1.5 then if CustomTarget~=nil and CustomTarget.planetname=="Space"then AutopilotEndSpeed=0 elseif CustomTarget==nil then _,AutopilotEndSpeed=bc(ac):escapeAndOrbitalSpeed(kv)end end;if not AutopilotCruising and not AutopilotBraking and not kq then k3=cH((kp-bN):normalize())elseif TurnBurn and(AutopilotBraking or AutopilotCruising)then k3=cH(-vec3(bJ):normalize())end;if AutopilotAccelerating then if not P then BrakeIsOn=false;bU(AutopilotInterplanetaryThrottle)I=z(AutopilotInterplanetaryThrottle,2)P=true end;local j0=unit.getThrottle()if AtmoSpeedAssist then j0=I end;if vec3(core.getVelocity()):len()>=MaxGameVelocity or j0==0 and P then AutopilotAccelerating=false;AutopilotStatus="Cruising"AutopilotCruising=true;bU(0)end;if AutopilotDistance<=a8 then AutopilotAccelerating=false;AutopilotStatus="Braking"AutopilotBraking=true;bU(0)P=false end elseif AutopilotBraking then if AutopilotStatus~="Orbiting to Target"then BrakeIsOn=true;Y=1 end;if TurnBurn then bU(1,true)end;local _,kc=bc(ac):escapeAndOrbitalSpeed((bN-planet.center):len()-planet.radius)local cQ;if CustomTarget~=nil then cQ=CustomTarget.position-bN end;if CustomTarget~=nil and CustomTarget.planetname=="Space"and bK<50 then a2="Autopilot complete, arrived at space location"AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"elseif CustomTarget~=nil and CustomTarget.planetname~="Space"and bK<=kc and(orbit.apoapsis==nil or orbit.periapsis==nil or orbit.apoapsis.altitude<=0 or orbit.periapsis.altitude<=0)then a2="Autopilot complete, proceeding with reentry"AutopilotTargetCoords=CustomTarget.position;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"bU(0)P=false;ProgradeIsOn=true;ao=true;cm(ac,AutopilotTargetCoords)elseif orbit.periapsis~=nil and orbit.periapsis.altitude>0 and orbit.eccentricity<1 then AutopilotStatus="Circularizing"local _,kc=bc(ac):escapeAndOrbitalSpeed((bN-planet.center):len()-planet.radius)if bK<=kc then if CustomTarget~=nil then if bJ:normalize():dot(cQ:normalize())>0.4 then AutopilotStatus="Orbiting to Target"if not WaypointSet then BrakeIsOn=false;cm(ac,CustomTarget.position)WaypointSet=true end else a2="Autopilot complete, proceeding with reentry"AutopilotTargetCoords=CustomTarget.position;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"bU(0)P=false;ProgradeIsOn=true;ao=true;BrakeIsOn=false;cm(ac,CustomTarget.position)WaypointSet=false end else BrakeIsOn=false;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"a2="Autopilot completed, orbit established"Y=0;bU(0)P=false;if CustomTarget~=nil and CustomTarget.planetname~="Space"then ProgradeIsOn=true;ao=true end end end end elseif AutopilotCruising then if AutopilotDistance<=a8 then AutopilotAccelerating=false;AutopilotStatus="Braking"AutopilotBraking=true end;local j0=unit.getThrottle()if AtmoSpeedAssist then j0=I end;if j0>0 then AutopilotAccelerating=true;AutopilotStatus="Accelerating"AutopilotCruising=false end else if k3 then if not AutopilotRealigned and CustomTarget==nil or not AutopilotRealigned and CustomTarget~=nil and CustomTarget.planetname~="Space"then if not ao then AutopilotTargetCoords=vec3(ac.center)+(AutopilotTargetOrbit+ac.radius)*bI;AutopilotShipUp=bG;AutopilotShipRight=bI end;AutopilotRealigned=true elseif k3 then AutopilotAccelerating=true;AutopilotStatus="Accelerating"if not P then bU(AutopilotInterplanetaryThrottle,true)I=z(AutopilotInterplanetaryThrottle,2)P=true;BrakeIsOn=false end end end end elseif Autopilot and(CustomTarget~=nil and CustomTarget.planetname~="Space"and av>0)then a2="Autopilot complete, proceeding with reentry"AutopilotTargetCoords=CustomTarget.position;BrakeIsOn=false;AutopilotBraking=false;Autopilot=false;TargetSet=false;AutopilotStatus="Aligning"Y=0;bU(0)P=false;ProgradeIsOn=true;ao=true;cm(ac,CustomTarget.position)end;if a0 then bg=true;local kx=0;local fM=bN+vec3(unit.getMasterPlayerRelativePosition())local kA=fM-bN;local kB=vec3(kA):project_on(bH):len()local kC=vec3(kA):project_on(bI):len()local ak=math.sqrt(kB*kB+kC*kC)cH(kA:normalize())local kD=40;local kE=ak<kD;local kF=100;local kG=s((ak-kD)/2,10,kF)U=0;local k3=d(V)<0.1;if k3 and bK<kG and not kE then BrakeIsOn=false;kx=-20 else BrakeIsOn=true;kx=0 end;local kH=0;if d(kx-bS)>kH then if pitchPID==nil then pitchPID=pid.new(2*0.01,0,2*0.1)end;pitchPID:inject(kx-bS)local ky=pitchPID:get()U=ky end end;if AltitudeHold or BrakeLanding or Reentry or VectorToTarget or LockPitch~=nil then local cA=unit.getClosestPlanetInfluence()>0;local kI=HoldAltitude-aw;local kJ=500+bK;local kK=1;if AutoTakeoff then kK=s(bK/100,0.1,1)end;local kx=(utils.smoothstep(kI,-kJ,kJ)-0.5)*2*MaxPitch*kK;if not Reentry and not ao and not VectorToTarget and bH:dot(bJ:normalize())<0.99 then kx=(utils.smoothstep(kI,-kJ*s(20-19*av*10,1,20),kJ*s(20-19*av*10,1,20))-0.5)*2*MaxPitch*s(2-av*10,1,2)*kK end;if not AltitudeHold then kx=0 end;if LockPitch~=nil then if cA and not IntoOrbit then kx=LockPitch else LockPitch=nil end end;bg=true;local kL=U;if Reentry then local kM=e(bp)local kN,kO=ba.computeDistanceAndTime(bK,kM/3.6,m(),0,0,LastMaxBrake-planet.gravity*9.8*m())local kP=aw-(planet.noAtmosphericDensityAltitude+5000)if not bR and aw>planet.noAtmosphericDensityAltitude+5000 and bK<=kM/3.6 and bK>kM/3.6-10 and d(bJ:normalize():dot(bH))>0.9 then bU(0)elseif bR and(kN>-1 and kP<=kN or aw<=planet.noAtmosphericDensityAltitude+5000)then BrakeIsOn=true else BrakeIsOn=false end;bX(kM,true)if not R then kx=-80;if av>0.02 then a2="PARACHUTE DEPLOYED"Reentry=false;BrakeLanding=true;kx=0;bg=autoRollPreference end elseif planet.noAtmosphericDensityAltitude>0 and aw>planet.noAtmosphericDensityAltitude+5000 then bg=true elseif aw<=planet.noAtmosphericDensityAltitude+5000 then bX(kM)if not bR and t:getTargetSpeed(axisCommandId.longitudinal)==bp then R=false;Reentry=false;bg=true end end end;if bK>Q and not ap and not VectorToTarget and not BrakeLanding and ForceAlignment then cH(vec3(bJ))end;if(VectorToTarget or ap)and AutopilotTargetIndex>0 and av>0.01 then local cQ;if CustomTarget~=nil then cQ=CustomTarget.position-bN else cQ=ac.center-bN end;local kw=math.deg(jU(bL:normalize(),bJ,cQ))*2;local kQ=math.rad(d(bT))if bK>minRollVelocity and av>0.01 then local kR=s(90-kx*2,-90,90)bm=s(kw*2,-kR,kR)local kS=kw;kw=s(s(kw,-YawStallAngle*0.80,YawStallAngle*0.80)*math.cos(kQ)+4*(bS-kx)*math.sin(math.rad(bT)),-YawStallAngle*0.80,YawStallAngle*0.80)kx=s(s(kx*math.cos(kQ),-PitchStallAngle*0.80,PitchStallAngle*0.80)+d(s(d(kS)*math.sin(kQ),-PitchStallAngle*0.80,PitchStallAngle*0.80)),-PitchStallAngle*0.80,PitchStallAngle*0.80)else bm=0;kw=s(kw,-YawStallAngle*0.80,YawStallAngle*0.80)end;local kT=k0-kw;if not bk and bK>minRollVelocity and av>0.01 then if yawPID==nil then yawPID=pid.new(2*0.01,0,2*0.1)end;yawPID:inject(kT)local kz=s(yawPID:get(),-1,1)V=V+kz elseif au and ar>-1 or bK<minRollVelocity then cH(cQ)elseif bk and av>0.01 then if(k0<-YawStallAngle or k0>YawStallAngle)and av>0.01 then cH(bJ)end;if(k1<-PitchStallAngle or k1>PitchStallAngle)and av>0.01 then kx=s(bS-k1,bS-PitchStallAngle*0.80,bS+PitchStallAngle*0.80)end end;if CustomTarget~=nil and not ap then local k4=planet:getAltitude(CustomTarget.position)local kP=math.sqrt(cQ:len()^2-(aw-k4)^2)local kU=LastMaxBrakeInAtmo;if kU then kU=kU*s(bK/100,0.1,1)*av else kU=LastMaxBrake end;if av<0.01 then kU=LastMaxBrake end;local kV=bJ:len()-d(bM)local kW=vec3(core.getWorldAirFrictionAcceleration())local kX=math.sqrt(kW:len()-kW:project_on(cl):len())*m()if bK>100 then a8,a9=ba.computeDistanceAndTime(bK,100,m(),0,0,kU+kX)local kY,kZ=ba.computeDistanceAndTime(100,0,m(),0,0,kU/2)a8=a8+kY else a8,a9=ba.computeDistanceAndTime(bK,0,m(),0,0,kU/2)end;StrongBrakes=true;if not ap and not Reentry and kP<=a8+bK*j_/2 and(bJ:project_on_plane(bL):normalize():dot(cQ:project_on_plane(bL):normalize())>0.99 or VectorStatus=="Finalizing Approach")then VectorStatus="Finalizing Approach"bU(0)if AltitudeHold then cf()VectorToTarget=true end;BrakeIsOn=true elseif not AutoTakeoff then BrakeIsOn=false end;if VectorStatus=="Finalizing Approach"and(kV<0.1 or kP<0.1 or LastDistanceToTarget~=nil and LastDistanceToTarget<kP)then if not bP then BrakeLanding=true end;VectorToTarget=false;VectorStatus="Proceeding to Waypoint"end;LastDistanceToTarget=kP end elseif VectorToTarget and av==0 and HoldAltitude>planet.noAtmosphericDensityAltitude and not(ap or Reentry)then if CustomTarget~=nil and ac.name==planet.name then local cQ=CustomTarget.position-bN;local k4=planet:getAltitude(CustomTarget.position)local kP=math.sqrt(cQ:len()^2-(aw-k4)^2)local kU=LastMaxBrakeInAtmo;if kU then a8,a9=ba.computeDistanceAndTime(bK,0,m(),0,0,kU/2)StrongBrakes=true;if kP<=a8+bK*j_/2 and bJ:project_on_plane(bL):normalize():dot(cQ:project_on_plane(bL):normalize())>0.99 then if planet.hasAtmosphere then BrakeIsOn=false;ProgradeIsOn=false;R=true;ao=false;aq=true;Autopilot=false;cT()end end;LastDistanceToTarget=kP end end end;if av==0 and(AltitudeHold and HoldAltitude>planet.noAtmosphericDensityAltitude)and not(ap or IntoOrbit or Reentry)then if not bA and not IntoOrbit then by=HoldAltitude;bx=true;if VectorToTarget then bw.VectorToTarget=true end;ce()VectorToTarget=false;bu=true end end;if bk and av>0.01 and ar==-1 and bK>minRollVelocity and VectorStatus~="Finalizing Approach"then cH(bJ)kx=s(bS-k1,bS-PitchStallAngle*0.80,bS+PitchStallAngle*0.80)end;U=kL;local d2=-1;if BrakeLanding then kx=0;local k_=false;local l0=30;if bb~=nil and bb>0 then local kX=0;local fN=s(av,0.4,2)local kU=LastMaxBrakeInAtmo*s(bK/100,0.1,1)*fN;local l1=bb*fN+kU+kX-fR;local l2=kU/2+kX-fR;local l3=bK-math.sqrt(d(l2/2)*20/(0.5*m()))*utils.sign(l2)if l3<0 then l3=0 end;local l4;if bK>100 then local l5,_=ba.computeDistanceAndTime(bK,100,m(),0,0,kU)local l6,_=ba.computeDistanceAndTime(100,0,m(),0,0,math.sqrt(kU))l4=l5+l6 else l4=ba.computeDistanceAndTime(bK,0,m(),0,0,math.sqrt(kU))end;if l4<20 then BrakeIsOn=false else local l7=0;if l3>100 then local l8,_=ba.computeDistanceAndTime(l3,100,m(),0,0,l1)local l9,_=ba.computeDistanceAndTime(100,0,m(),0,0,bb*fN+math.sqrt(kU)+kX-fR)l7=l8+l9 else l7,_=ba.computeDistanceAndTime(l3,0,m(),0,0,bb*fN+math.sqrt(kU)+kX-fR)end;l7=(l7+15+bK*j_)*1.1;local la=CustomTarget~=nil and planet:getAltitude(CustomTarget.position)>0 and CustomTarget.safe;if la then local k4=planet:getAltitude(CustomTarget.position)local lb=aw-k4-100;local cQ=CustomTarget.position-bN;local lc=math.sqrt(cQ:len()^2-(aw-k4)^2)if lc>100 then la=false elseif lb<=l7 or l7==-1 then BrakeIsOn=true;k_=true else BrakeIsOn=false;k_=true end end;if not la and CalculateBrakeLandingSpeed then if l7>=l0 then BrakeIsOn=true else BrakeIsOn=false end;k_=true end end end;if not bR then bU(0)end;t:setTargetGroundAltitude(500)t:activateGroundEngineAltitudeStabilization(500)d2=ar;if d2>-1 then bg=autoRollPreference;if bK<1 or bJ:normalize():dot(bL)<0 then BrakeLanding=false;AltitudeHold=false;GearExtended=true;a.control.extendLandingGears()t:setTargetGroundAltitude(LandingGearGroundHeight)ag=0;BrakeIsOn=true else BrakeIsOn=true end elseif StrongBrakes and bJ:normalize():dot(-cl)<0.999 then BrakeIsOn=true elseif bM<-brakeLandingRate and not k_ then BrakeIsOn=true elseif not k_ then BrakeIsOn=false end end;if AutoTakeoff or ap then local f6,f8,f7;if AutopilotTargetCoords~=nil then f6,f8,f7=b9:getPlanetarySystem(0):castIntersections(bN,(AutopilotTargetCoords-bN):normalize(),function(f9)return f9.radius+f9.noAtmosphericDensityAltitude end)end;if bP then if aw>=HoldAltitude-50 then AutoTakeoff=false;if not Autopilot and not VectorToTarget then BrakeIsOn=true;bU(0)end else HoldAltitude=antigrav.getBaseAltitude()end elseif d(kx)<15 and aw/HoldAltitude>0.75 then AutoTakeoff=false;if not ap then if bR and not AtmoSpeedAssist then a.control.cancelCurrentControlMasterMode()end elseif ap and bK<Q then Autopilot=true;ap=false;AltitudeHold=false;AutoTakeoff=false;bU(0)elseif ap then bU(0)BrakeIsOn=true end elseif ap and av==0 and ac~=nil and(f6==nil or f6.name==ac.name)then Autopilot=true;ap=false;AltitudeHold=false;AutoTakeoff=false;if not bR then bU(0)end;AutopilotAccelerating=true end end;local ld=ar>-1;local le=bS;if(VectorToTarget or ap)and not ld and bK>minRollVelocity and av>0.01 then local kQ=math.rad(d(bT))le=bS*d(math.cos(kQ))+k1*math.sin(kQ)end;local lf=s(kx-le,-PitchStallAngle*0.80,PitchStallAngle*0.80)if av<0.01 and VectorToTarget then lf=s(kx-le,-85,MaxPitch)elseif av<0.01 then lf=s(kx-le,-MaxPitch,MaxPitch)end;if d(bT)<5 or VectorToTarget or BrakeLanding or ld or AltitudeHold then if pitchPID==nil then pitchPID=pid.new(5*0.01,0,5*0.1)end;pitchPID:inject(lf)local ky=pitchPID:get()U=U+ky end end;if antigrav~=nil and(antigrav and not ExternalAGG and aw<200000)then if AntigravTargetAltitude==nil or AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if desiredBaseAltitude~=AntigravTargetAltitude then desiredBaseAltitude=AntigravTargetAltitude;antigrav.setBaseAltitude(desiredBaseAltitude)end end end end;function script.onFlush()local function lg(lh,kG)local li=vec3()local lj=vec3()if lh==axisCommandId.longitudinal then li=vec3(core.getConstructOrientationForward())lj=bH elseif lh==axisCommandId.vertical then li=vec3(core.getConstructOrientationUp())lj=bG elseif lh==axisCommandId.lateral then li=vec3(core.getConstructOrientationRight())lj=bI else return vec3()end;local lk=vec3(core.getWorldGravity())local ll=lk:dot(lj)local lm=vec3(core.getWorldAirFrictionAcceleration())local ln=lm:dot(lj)local lo=vec3(core.getVelocity())local lp=lo:dot(li)local lq=kG*constants.kph2m;if targetSpeedPID2==nil then targetSpeedPID2=pid.new(10,0,10.0)end;targetSpeedPID2:inject(lq-lp)local lr=targetSpeedPID2:get()local ls=(lr-ln-ll)*lj;return ls end;local function lt(lh,kG)local li=vec3()local lj=vec3()if lh==axisCommandId.longitudinal then li=vec3(core.getConstructOrientationForward())lj=bH elseif lh==axisCommandId.vertical then li=vec3(core.getConstructOrientationUp())lj=bG elseif lh==axisCommandId.lateral then li=vec3(core.getConstructOrientationRight())lj=bI else return vec3()end;local lk=vec3(core.getWorldGravity())local ll=lk:dot(lj)local lm=vec3(core.getWorldAirFrictionAcceleration())local ln=lm:dot(lj)local lo=vec3(core.getVelocity())local lp=lo:dot(li)local lq=kG*constants.kph2m;if targetSpeedPID==nil then targetSpeedPID=pid.new(10,0,10.0)end;targetSpeedPID:inject(lq-lp)local lr=targetSpeedPID:get()local ls=(lr-ln-ll)*lj;return ls end;local function lu(lv,dL,c2)local lw=lv:cross(c2):normalize_inplace()local ex=math.acos(s(lw:dot(-dL),-1,1))*constants.rad2deg;if lw:cross(-dL):dot(c2)<0 then ex=-ex end;return ex end;if antigrav~=nil and(antigrav and not ExternalAGG)then if not bP and antigrav.getBaseAltitude()~=AntigravTargetAltitude then antigrav.setBaseAltitude(AntigravTargetAltitude)end end;bR=t:getAxisCommandType(0)==axisCommandType.byThrottle;if bR and M then bU(0)M=false elseif not bR and not M then I=0;M=true end;pitchSpeedFactor=math.max(pitchSpeedFactor,0.01)yawSpeedFactor=math.max(yawSpeedFactor,0.01)rollSpeedFactor=math.max(rollSpeedFactor,0.01)torqueFactor=math.max(torqueFactor,0.01)brakeSpeedFactor=math.max(brakeSpeedFactor,0.01)brakeFlatFactor=math.max(brakeFlatFactor,0.01)autoRollFactor=math.max(autoRollFactor,0.01)turnAssistFactor=math.max(turnAssistFactor,0.01)local lx=s(T+U+system.getControlDeviceForwardInput(),-1,1)local ly=s(W+Z+system.getControlDeviceYawInput(),-1,1)local lz=s(X+V-system.getControlDeviceLeftRightInput(),-1,1)local lA=Y;bL=vec3(core.getWorldVertical())if bL==nil or bL:len()==0 then bL=(planet.center-bN):normalize()end;bN=vec3(core.getConstructWorldPos())bG=vec3(core.getConstructWorldOrientationUp())bH=vec3(core.getConstructWorldOrientationForward())bI=vec3(core.getConstructWorldOrientationRight())bJ=vec3(core.getWorldVelocity())bK=vec3(bJ):len()bM=-bL:dot(bJ)bT=getRoll(bL,bH,bI)local lB=bT/180*math.pi;local lC=math.cos(lB)local lD=math.sin(lB)bS=lu(bL,bH,bI*lC+bG*lD)local lE=bJ:normalize()local lF=getRoll(bL,bH,bI)local lG=d(lF)local lH=utils.sign(lF)local lI=vec3(core.getWorldAngularVelocity())local lJ=lx*pitchSpeedFactor*bI+ly*rollSpeedFactor*bH+lz*yawSpeedFactor*bG;if bL:len()>0.01 and(av>0.0 or ProgradeIsOn or Reentry or ao or AltitudeHold or IntoOrbit)then if bg==true and d(bm-lF)>autoRollRollThreshold and ly==0 and d(bS)<85 then local lK=bm;local lL=autoRollFactor;if av==0 then lL=lL/4;bm=0;lK=0 end;if rollPID==nil then rollPID=pid.new(lL*0.01,0,lL*0.1)end;rollPID:inject(lK-lF)local lM=rollPID:get()lJ=lJ+lM*bH end end;if bL:len()>0.01 and av>0.0 then local lN=20.0;if turnAssist==true and lG>lN and lx==0 and lz==0 then local lO=turnAssistFactor*0.1;local lP=turnAssistFactor*0.025;local lQ=(lG-lN)/(180-lN)*180;local lR=0;if lQ<90 then lR=lQ/90 elseif lQ<180 then lR=(180-lQ)/90 end;lR=lR*lR;local lS=-lH*lP*(1.0-lR)local lT=lO*lR;lJ=lJ+lT*bI+lS*bG end end;local lU=1;local lV=0;local lW=1;if system.getMouseWheel()>0 then if AltIsOn then if av>0 or Reentry then bp=s(bp+speedChangeLarge,0,AtmoSpeedLimit)elseif Autopilot then MaxGameVelocity=s(MaxGameVelocity+speedChangeLarge/3.6*100,0,8333.00)end else I=z(s(I+speedChangeLarge/100,-1,1),2)end elseif system.getMouseWheel()<0 then if AltIsOn then if av>0 or Reentry then bp=s(bp-speedChangeLarge,0,AtmoSpeedLimit)elseif Autopilot then MaxGameVelocity=s(MaxGameVelocity-speedChangeLarge/3.6*100,0,8333.00)end else I=z(s(I-speedChangeLarge/100,-1,1),2)end end;J=0;if au and AtmoSpeedAssist and bR then if throttlePID==nil then throttlePID=pid.new(0.5,0,1)end;throttlePID:inject(bp/3.6-bJ:dot(bH))local lX=throttlePID:get()L=s(lX,-1,1)if L<I and av>0.005 then K=true;t:setThrottleCommand(axisCommandId.longitudinal,s(L,0.01,1))else K=false;t:setThrottleCommand(axisCommandId.longitudinal,I)end;if brakePID==nil then brakePID=pid.new(1*0.01,0,1*0.1)end;brakePID:inject(bJ:len()-bp/3.6)local lY=s(brakePID:get(),0,1)if av>0 and bM<-80 or av>0.005 then J=lY end;if J>0 then if K and L==0.01 then t:setThrottleCommand(axisCommandId.longitudinal,0)end else L=s(L,0.01,1)end;local lZ=''local l_=vec3()local m0=lg(axisCommandId.vertical,ag*1000)a:setEngineForceCommand("vertical airfoil , vertical ground ",m0,lV)local m1='thrust analog longitudinal 'if ExtraLongitudeTags~="none"then m1=m1 ..ExtraLongitudeTags end;local m2=t:getAxisCommandType(axisCommandId.longitudinal)local m3=t:composeAxisAccelerationFromThrottle(m1,axisCommandId.longitudinal)local m4=lt(axisCommandId.lateral,LeftAmount*1000)lZ=lZ..' , '.."lateral airfoil , lateral ground "l_=l_+m4;if l_:len()>constants.epsilon then a:setEngineForceCommand(lZ,l_,lV,'','','',lW)end;a:setEngineForceCommand(m1,m3,lU)local m5='thrust analog vertical fueled 'local m6='thrust analog lateral fueled 'if ExtraLateralTags~="none"then m6=m6 ..ExtraLateralTags end;if ExtraVerticalTags~="none"then m5=m5 ..ExtraVerticalTags end;if ag~=0 or BrakeLanding and BrakeIsOn then a:setEngineForceCommand(m5,m0,lU)else a:setEngineForceCommand(m5,vec3(),lU)end;if LeftAmount~=0 then a:setEngineForceCommand(m6,m4,lU)else a:setEngineForceCommand(m6,vec3(),lU)end;if lA==0 then lA=J end;local m7=-lA*(brakeSpeedFactor*bJ+brakeFlatFactor*lE)a:setEngineForceCommand('brake',m7)else if AtmoSpeedAssist then t:setThrottleCommand(axisCommandId.longitudinal,I)end;local kG=unit.getAxisCommandValue(0)if not bR then if brakePID==nil then brakePID=pid.new(1*0.01,0,1*0.1)end;brakePID:inject(bJ:len()-kG/3.6)local lY=s(brakePID:get(),0,1)lA=s(lA+lY,0,1)end;local m7=-lA*(brakeSpeedFactor*bJ+brakeFlatFactor*lE)a:setEngineForceCommand('brake',m7)local lZ=''local l_=vec3()local m8=false;local m1='thrust analog longitudinal 'if ExtraLongitudeTags~="none"then m1=m1 ..ExtraLongitudeTags end;local m2=t:getAxisCommandType(axisCommandId.longitudinal)if m2==axisCommandType.byThrottle then local m3=t:composeAxisAccelerationFromThrottle(m1,axisCommandId.longitudinal)a:setEngineForceCommand(m1,m3,lU)elseif m2==axisCommandType.byTargetSpeed then local m3=t:composeAxisAccelerationFromTargetSpeed(axisCommandId.longitudinal)lZ=lZ..' , '..m1;l_=l_+m3;if t:getTargetSpeed(axisCommandId.longitudinal)==0 or t:getCurrentToTargetDeltaSpeed(axisCommandId.longitudinal)<-t:getTargetSpeedCurrentStep(axisCommandId.longitudinal)*0.5 then m8=true end end;local m6='thrust analog lateral 'if ExtraLateralTags~="none"then m6=m6 ..ExtraLateralTags end;local m9=t:getAxisCommandType(axisCommandId.lateral)if m9==axisCommandType.byThrottle then local ma=t:composeAxisAccelerationFromThrottle(m6,axisCommandId.lateral)a:setEngineForceCommand(m6,ma,lU)elseif m9==axisCommandType.byTargetSpeed then local m4=t:composeAxisAccelerationFromTargetSpeed(axisCommandId.lateral)lZ=lZ..' , '..m6;l_=l_+m4 end;local m5='thrust analog vertical 'if ExtraVerticalTags~="none"then m5=m5 ..ExtraVerticalTags end;local mb=t:getAxisCommandType(axisCommandId.vertical)if mb==axisCommandType.byThrottle then local m0=t:composeAxisAccelerationFromThrottle(m5,axisCommandId.vertical)if ag~=0 or BrakeLanding and BrakeIsOn then a:setEngineForceCommand(m5,m0,lU,'airfoil','ground','',lW)else a:setEngineForceCommand(m5,vec3(),lU)a:setEngineForceCommand('airfoil vertical',m0,lU,'airfoil','','',lW)a:setEngineForceCommand('ground vertical',m0,lU,'ground','','',lW)end elseif mb==axisCommandType.byTargetSpeed then if ag<0 then a:setEngineForceCommand('hover',vec3(),lU)end;local mc=t:composeAxisAccelerationFromTargetSpeed(axisCommandId.vertical)lZ=lZ..' , '..m5;l_=l_+mc end;if l_:len()>constants.epsilon then if Y~=0 or m8 or d(lE:dot(bH))<0.8 then lZ=lZ..', brake'end;a:setEngineForceCommand(lZ,l_,lV,'','','',lW)end end;local md=torqueFactor*(lJ-lI)local me=vec3(core.getWorldAirFrictionAngularAcceleration())md=md-me;a:setEngineTorqueCommand('torque',md,lU,'airfoil','','',lW)a:setBoosterCommand('rocket_engine')if a7 and not VanillaRockets then local e4=vec3(core.getVelocity()):len()local mf=0.15;if not bR then local mg=t:getTargetSpeed(axisCommandId.longitudinal)if e4*3.6>mg*(1-mf)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif e4*3.6<mg*(1-mf)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end else local j0=unit.getThrottle()if AtmoSpeedAssist then j0=I*100 end;local kG=j0/100;if k==0 then kG=kG*MaxGameVelocity;if e4>=kG*(1-mf)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif e4<kG*(1-mf)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end else local kM=e(bp)kG=kG*kM/3.6;if e4>=kG*(1-mf)and IsRocketOn then IsRocketOn=false;a:toggleBoosters()elseif e4<kG*(1-mf)and not IsRocketOn then IsRocketOn=true;a:toggleBoosters()end end end end end;function script.onUpdate()if not SetupComplete then local _,c9=coroutine.resume(beginSetup)if c9 then SetupComplete=true end else a:update()if not be and content~=LastContent then system.setScreen(content)end;LastContent=content end end;function script.onActionStart(mh)local C=1;local function mi(mj)if mj then C=-1 end;if not ExternalAGG and bP then if AntigravTargetAltitude~=nil then AntigravTargetAltitude=AntigravTargetAltitude+C*a4;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if AltitudeHold and AntigravTargetAltitude<HoldAltitude+10 and AntigravTargetAltitude>HoldAltitude-10 then HoldAltitude=AntigravTargetAltitude end else AntigravTargetAltitude=desiredBaseAltitude+C*100 end elseif AltitudeHold or VertTakeOff or IntoOrbit then if IntoOrbit then by=by+C*a3;if by<planet.noAtmosphericDensityAltitude then by=planet.noAtmosphericDensityAltitude end else HoldAltitude=HoldAltitude+C*a3 end else t:updateTargetGroundAltitudeFromActionStart(C*1.0)end end;local function mk(mj)if mj then C=-1 end;if not a1 then if AtmoSpeedAssist and not AltIsOn then I=s(I+C*speedChangeLarge/100,-1,1)else t:updateCommandFromActionStart(axisCommandId.longitudinal,C*speedChangeLarge)end else if mj then C=1 else C=nil end;ck(C)end end;if mh=="gear"then GearExtended=not GearExtended;if GearExtended then VectorToTarget=false;LockPitch=nil;bU(0)if(vBooster or hover)and ar==-1 then StrongBrakes=true;Reentry=false;AutoTakeoff=false;VertTakeOff=false;AltitudeHold=false;BrakeLanding=true;bg=true;GearExtended=false else BrakeIsOn=true;a.control.extendLandingGears()t:setTargetGroundAltitude(LandingGearGroundHeight)end;if S and not BrakeLanding then a.control.extendLandingGears()end else if S then a.control.retractLandingGears()end;t:setTargetGroundAltitude(TargetHoverHeight)end elseif mh=="light"then if a.control.isAnyHeadlightSwitchedOn()==1 then a.control.switchOffHeadlights()else a.control.switchOnHeadlights()end elseif mh=="forward"then T=T-1 elseif mh=="backward"then T=T+1 elseif mh=="left"then W=W-1 elseif mh=="right"then W=W+1 elseif mh=="yawright"then X=X-1 elseif mh=="yawleft"then X=X+1 elseif mh=="straferight"then t:updateCommandFromActionStart(axisCommandId.lateral,1.0)LeftAmount=1 elseif mh=="strafeleft"then t:updateCommandFromActionStart(axisCommandId.lateral,-1.0)LeftAmount=-1 elseif mh=="up"then ag=ag+1;t:deactivateGroundEngineAltitudeStabilization()t:updateCommandFromActionStart(axisCommandId.vertical,1.0)elseif mh=="down"then ag=ag-1;t:deactivateGroundEngineAltitudeStabilization()t:updateCommandFromActionStart(axisCommandId.vertical,-1.0)elseif mh=="groundaltitudeup"then mi()elseif mh=="groundaltitudedown"then mi(true)elseif mh=="option1"then ck()toggleView=false elseif mh=="option2"then ck(1)toggleView=false elseif mh=="option3"then local function ml()aH=not aH;if not aH then unit.show()core.show()if atmofueltank_size>0 then _autoconf.displayCategoryPanel(atmofueltank,atmofueltank_size,L_TEXT("ui_lua_widget_atmofuel", "Atmo Fuel"),"fuel_container")fuelPanelID=_autoconf.panels[_autoconf.panels_size]end;if spacefueltank_size>0 then _autoconf.displayCategoryPanel(spacefueltank,spacefueltank_size,L_TEXT("ui_lua_widget_spacefuel", "Space Fuel"),"fuel_container")spacefuelPanelID=_autoconf.panels[_autoconf.panels_size]end;if rocketfueltank_size>0 then _autoconf.displayCategoryPanel(rocketfueltank,rocketfueltank_size,L_TEXT("ui_lua_widget_rocketfuel", "Rocket Fuel"),"fuel_container")rocketfuelPanelID=_autoconf.panels[_autoconf.panels_size]end else unit.hide()core.hide()if fuelPanelID~=nil then u(fuelPanelID)fuelPanelID=nil end;if spacefuelPanelID~=nil then u(spacefuelPanelID)spacefuelPanelID=nil end;if rocketfuelPanelID~=nil then u(rocketfuelPanelID)rocketfuelPanelID=nil end end end;if hideHudOnToggleWidgets then if showHud then showHud=false else showHud=true end end;ml()toggleView=false elseif mh=="option4"then cy()toggleView=false elseif mh=="option5"then local function mm()if LockPitch==nil then LockPitch=bS;AutoTakeoff=false;AltitudeHold=false;BrakeLanding=false else LockPitch=nil end end;mm()toggleView=false elseif mh=="option6"then cf()toggleView=false elseif mh=="option7"then toggleView=false elseif mh=="option8"then cg()toggleView=false elseif mh=="option9"then if gyro~=nil then gyro.toggle()az=gyro.getState()==1 end;toggleView=false elseif mh=="lshift"then if y()==1 then a1=true;PrevViewLock=y()x(1)elseif n()==1 and ShiftShowsRemoteButtons then a1=true;bf=false;be=false end elseif mh=="brake"then if BrakeToggleStatus then cG()elseif not BrakeIsOn then cG()else BrakeIsOn=true end elseif mh=="lalt"then AltIsOn=true;if n()==0 and not freeLookToggle and userControlScheme=="keyboard"then x(1)end elseif mh=="booster"then if VanillaRockets then a:toggleBoosters()elseif not a7 then if not IsRocketOn then a:toggleBoosters()IsRocketOn=true end;a7=true else if IsRocketOn then a:toggleBoosters()IsRocketOn=false end;a7=false end elseif mh=="stopengines"then local function mn()if as then as=false;AutopilotAccelerating=false;AutopilotBraking=false;AutopilotCruising=false;Autopilot=false;AutopilotRealigned=false;AutopilotStatus="Aligning"RetrogradeIsOn=false;ProgradeIsOn=false;AltitudeHold=false;Reentry=false;BrakeLanding=false;BrakeIsOn=false;AutoTakeoff=false;VertTakeOff=false;a0=false;P=false;ao=false;ap=false;R=false;bg=autoRollPreference;VectorToTarget=false;TurnBurn=false;az=false;LockPitch=nil;IntoOrbit=false else as=true end end;t:resetCommand(axisCommandId.longitudinal)mn()I=0 elseif mh=="speedup"then mk()elseif mh=="speeddown"then mk(true)elseif mh=="antigravity"and not ExternalAGG then if antigrav~=nil then cW()end end end;function script.onActionStop(mh)local function mo()if not ExternalAGG and bP then a6=a4 end;if AltitudeHold or VertTakeOff or IntoOrbit then a5=a3 end end;if mh=="forward"then T=0 elseif mh=="backward"then T=0 elseif mh=="left"then W=0 elseif mh=="right"then W=0 elseif mh=="yawright"then X=0 elseif mh=="yawleft"then X=0 elseif mh=="straferight"then t:updateCommandFromActionStop(axisCommandId.lateral,-1.0)LeftAmount=0 elseif mh=="strafeleft"then t:updateCommandFromActionStop(axisCommandId.lateral,1.0)LeftAmount=0 elseif mh=="up"then ag=0;t:updateCommandFromActionStop(axisCommandId.vertical,-1.0)t:activateGroundEngineAltitudeStabilization(currentGroundAltitudeStabilization)a:setEngineForceCommand('hover',vec3(),1)elseif mh=="down"then ag=0;t:updateCommandFromActionStop(axisCommandId.vertical,1.0)t:activateGroundEngineAltitudeStabilization(currentGroundAltitudeStabilization)a:setEngineForceCommand('hover',vec3(),1)elseif mh=="groundaltitudeup"then mo()toggleView=false elseif mh=="groundaltitudedown"then mo()toggleView=false elseif mh=="lshift"then if y()==1 then a1=false;ah=0;ai=0;x(PrevViewLock)elseif n()==1 and ShiftShowsRemoteButtons then a1=false;bf=false;be=false end elseif mh=="brake"then if not BrakeToggleStatus then if BrakeIsOn then cG()else BrakeIsOn=false end end elseif mh=="lalt"then if n()==0 and freeLookToggle then if toggleView then if y()==1 then x(0)else x(1)end else toggleView=true end elseif n()==0 and not freeLookToggle and userControlScheme=="keyboard"then x(0)end;AltIsOn=false end end;function script.onActionLoop(mh)local C=1;local function mp(mj)if mj then C=-1 end;if not ExternalAGG and bP then if AntigravTargetAltitude~=nil then AntigravTargetAltitude=AntigravTargetAltitude+C*a6;if AntigravTargetAltitude<1000 then AntigravTargetAltitude=1000 end;if AltitudeHold and AntigravTargetAltitude<HoldAltitude+10 and AntigravTargetAltitude>HoldAltitude-10 then HoldAltitude=AntigravTargetAltitude end;a6=a6*1.05;BrakeIsOn=false else AntigravTargetAltitude=desiredBaseAltitude+C*100;BrakeIsOn=false end elseif AltitudeHold or VertTakeOff or IntoOrbit then if IntoOrbit then by=by+C*a5;if by<planet.noAtmosphericDensityAltitude then by=planet.noAtmosphericDensityAltitude end else HoldAltitude=HoldAltitude+C*a5 end;a5=a5*1.05 else t:updateTargetGroundAltitudeFromActionLoop(C*1.0)end end;local function mq(mj)if mj then C=-1 end;if not a1 then if AtmoSpeedAssist and not AltIsOn then I=s(I+C*speedChangeSmall/100,-1,1)else t:updateCommandFromActionLoop(axisCommandId.longitudinal,C*speedChangeSmall)end end end;if mh=="groundaltitudeup"then mp()elseif mh=="groundaltitudedown"then mp(true)elseif mh=="speedup"then mq()elseif mh=="speeddown"then mq(true)end end;function script.onInputText(cU)local function mr()for bZ,b_ in pairs(b)do dbHud_1.setStringValue(b_,h(nil))end;for bZ,b_ in pairs(c)do if b_~="SavedLocations"then dbHud_1.setStringValue(b_,h(nil))end end;a2="Databank wiped except Save Locations. New variables will save after re-enter seat and exit"aj=5;aL=false;af=true end;local function ms(mt,planet,fM)local function mu(fM)local A=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local gi='::pos{'..A..','..A..','..A..','..A..','..A..'}'local gv,gw,cu,cv,ct=p(fM,gi)if gv=="0"and gw=="0"then return vec3(tonumber(cu),tonumber(cv),tonumber(ct))end;cv=math.rad(cv)cu=math.rad(cu)local planet=b3[tonumber(gv)][tonumber(gw)]local hg=math.cos(cu)local mv=vec3(hg*math.cos(cv),hg*math.sin(cv),math.sin(cu))return planet.center+(planet.radius+ct)*mv end;if dbHud_1 then local cE={}local position=mu(fM)if planet.name=="Space"then cE={position=position,name=mt,atmosphere=0,planetname=planet.name,gravity=planet.gravity}else cE={position=position,name=mt,atmosphere=planet.atmosphericDensityAboveSurface,planetname=planet.name,gravity=planet.gravity}end;SavedLocations[#SavedLocations+1]=cE;table.insert(b3[0],cE)bY()else a2="Databank must be installed to save locations"end end;local i;local mw="/commands /setname /G /agg /addlocation /copydatabank /wipedatabank"local mx,my=nil,nil;local mz="Command List:\n/commands \n/setname <newname> - Updates current selected saved position name\n/G VariableName newValue - Updates global variable to new value\n".."/G dump - shows all updatable variables with /G\n/agg <targetheight> - Manually set agg target height\n".."/addlocation savename ::pos{0,2,46.4596,-155.1799,22.6572} - adds a saved location by waypoint, not as accurate as making one at location\n".."/copydatabank - copies dbHud databank to a blank databank\n/wipedatabank - wipes the databank of all hud variables but not save variables"i=string.find(cU," ")mx=cU;if i~=nil then mx=string.sub(cU,0,i-1)my=string.sub(cU,i+1)end;if mx=="/help"or mx=="/commands"then for fX in string.gmatch(mz,"([^\n]+)")do system.print(fX)end;return elseif mx=="/setname"then if my==nil or my==""then a2="Usage: ah-setname Newname"return end;if AutopilotTargetIndex>0 and CustomTarget~=nil then cB(my)else a2="Select a saved target to rename first"end elseif mx=="/addlocation"then if my==nil or my==""or string.find(my,"::")==nil then a2="Usage: ah-addlocation savename ::pos{0,2,46.4596,-155.1799,22.6572}"return end;i=string.find(my,"::")local mt=string.sub(my,1,i-2)local fM=string.sub(my,i)local A=' *([+-]?%d+%.?%d*e?[+-]?%d*)'local gi='::pos{'..A..','..A..','..A..','..A..','..A..'}'local gv,gw,cu,cv,ct=p(fM,gi)local planet=b3[tonumber(gv)][tonumber(gw)]ms(mt,planet,fM)a2="Added "..mt.." to saved locations,\nplanet "..planet.name.." at "..fM;aj=5 elseif mx=="/agg"then if my==nil or my==""then a2="Usage: ah-agg targetheight"return end;my=tonumber(my)if my<1000 then my=1000 end;AntigravTargetAltitude=my;a2="AGG Target Height set to "..my elseif mx=="/G"then if my==nil or my==""then a2="Usage: ah-G VariableName variablevalue\nah-G dump - shows all variables"return end;if my=="dump"then for bZ,b_ in pairs(b)do if type(_G[b_])=="boolean"then if _G[b_]==true then system.print(b_.." true")else system.print(b_.." false")end elseif _G[b_]==nil then system.print(b_.." nil")else system.print(b_.." ".._G[b_])end end;return end;i=string.find(my," ")local mA=string.sub(my,0,i-1)local mB=string.sub(my,i+1)for bZ,b_ in pairs(b)do if b_==mA then a2="Variable "..mA.." changed to "..mB;local mC=type(_G[b_])if mC=="number"then mB=tonumber(mB)elseif mC=="boolean"then if string.lower(mB)=="true"then mB=true else mB=false end end;_G[b_]=mB;return end end;a2="No such global variable: "..mA elseif mx=="/copydatabank"then if dbHud_2 then d3(true)else a2="Spare Databank required to copy databank"end elseif mx=="/wipedatabank"then if dbHud_1 then mr()else a2="No databank found."end end end;script.onStart()
        
        
        -- error handling code added by wrap.lua
        end, __wrap_lua__traceback)
        if not ok then
          __wrap_lua__error(message)
          if not script then script = {} end
        end
    stop:
      lua: |
        if not __wrap_lua__stopped and script.onStop then
          local ok, message = xpcall(script.onStop,__wrap_lua__traceback,unit)
          if not ok then __wrap_lua__error(message) end
        end
    tick(timerId):
      lua: |
        if not __wrap_lua__stopped and script.onTick then
          local ok, message = xpcall(script.onTick,__wrap_lua__traceback,timerId,unit)
          if not ok then __wrap_lua__error(message) end
        end
  system:
    actionStart(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionStart then
          local ok, message = xpcall(script.onActionStart,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    actionStop(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionStop then
          local ok, message = xpcall(script.onActionStop,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    actionLoop(action):
      lua: |
        if not __wrap_lua__stopped and script.onActionLoop then
          local ok, message = xpcall(script.onActionLoop,__wrap_lua__traceback,action,system)
          if not ok then __wrap_lua__error(message) end
        end
    update:
      lua: |
        if not __wrap_lua__stopped and script.onUpdate then
          local ok, message = xpcall(script.onUpdate,__wrap_lua__traceback,system)
          if not ok then __wrap_lua__error(message) end
        end
    flush:
      lua: |
        if not __wrap_lua__stopped and script.onFlush then
          local ok, message = xpcall(script.onFlush,__wrap_lua__traceback,system)
          if not ok then __wrap_lua__error(message) end
        end
    inputText(text):
      lua: |
        if not __wrap_lua__stopped and script.onInputText then
          local ok, message = xpcall(script.onInputText,__wrap_lua__traceback,text,system)
          if not ok then __wrap_lua__error(message) end
        end
